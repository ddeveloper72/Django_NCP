{% load i18n %}
{% load static %}

<!DOCTYPE html>
<html lang="{{ document.language|default:'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Interoperable Healthcare Document" %} - {{ document.patient_information.demographics.name|default:patient_id }}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Healthcare CSS -->
    <link rel="stylesheet" href="{% static 'css/healthcare_document.css' %}">

    <style>
        .healthcare-document {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .document-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .patient-info-card {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 0 8px 8px 0;
        }

        .clinical-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .clinical-section-header {
            background: #e9ecef;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
        }

        .clinical-section-body {
            padding: 1.5rem;
        }

        .clinical-entry {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .code-display {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .metadata-section {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .resource-type-cda {
            background: #d4edda;
            color: #155724;
        }

        .resource-type-fhir {
            background: #d1ecf1;
            color: #0c5460;
        }

        .no-data {
            color: #6c757d;
            font-style: italic;
        }

        .accordion-button:not(.collapsed) {
            background-color: #e7f3ff;
            color: #0d6efd;
        }

        @media (max-width: 768px) {
            .document-header {
                padding: 1rem;
            }
            .patient-info-card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="healthcare-document">
    <div class="container-fluid px-4 py-3">

        <!-- Document Header -->
        <div class="document-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h2 mb-2">
                        <i class="bi bi-file-medical me-2"></i>
                        {{ document.document_headers.document_title|default:"Healthcare Document" }}
                    </h1>
                    <p class="mb-1 opacity-90">
                        {% trans "Document Type" %}:
                        <span class="status-badge resource-type-{{ document.document_type|lower }}">
                            {{ document.document_type }}
                        </span>
                    </p>
                    <p class="mb-0 opacity-75">
                        {% trans "Extracted" %}: {{ document.extraction_timestamp|date:"F j, Y \a\t g:i A" }}
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="d-flex flex-column align-items-md-end">
                        <span class="text-light opacity-75">{% trans "Patient ID" %}</span>
                        <span class="h4 mb-0">{{ patient_id }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Information -->
        {% if document.patient_information %}
        <div class="patient-info-card">
            <div class="row">
                <div class="col-md-6">
                    <h3 class="h5 text-success mb-3">
                        <i class="bi bi-person-circle me-2"></i>
                        {% trans "Patient Information" %}
                    </h3>

                    {% with demo=document.patient_information.demographics %}
                    <div class="mb-3">
                        <strong>{% trans "Name" %}:</strong>
                        {{ demo.name|default:"Not specified" }}
                    </div>
                    <div class="mb-3">
                        <strong>{% trans "Birth Date" %}:</strong>
                        {{ demo.birth_date|default:"Not specified" }}
                    </div>
                    <div class="mb-3">
                        <strong>{% trans "Gender" %}:</strong>
                        {{ demo.gender|default:"Not specified" }}
                    </div>
                    <div class="mb-3">
                        <strong>{% trans "Marital Status" %}:</strong>
                        {{ demo.marital_status|default:"Not specified" }}
                    </div>
                    {% endwith %}
                </div>

                <div class="col-md-6">
                    <h5 class="text-success mb-3">
                        <i class="bi bi-geo-alt me-2"></i>
                        {% trans "Contact Information" %}
                    </h5>

                    {% if document.patient_information.contact_information.addresses %}
                        {% for address in document.patient_information.contact_information.addresses %}
                        <div class="mb-2">
                            <small class="text-muted">{% trans "Address" %} {{ forloop.counter }}:</small><br>
                            {{ address|default:"Address not available" }}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-data">{% trans "No address information available" %}</div>
                    {% endif %}

                    {% if document.patient_information.contact_information.telecom %}
                        <div class="mt-3">
                            <small class="text-muted">{% trans "Contact" %}:</small><br>
                            {% for contact in document.patient_information.contact_information.telecom %}
                                {{ contact }}<br>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Clinical Sections -->
        {% if document.clinical_sections %}
        <div class="clinical-sections">
            <h3 class="mb-4">
                <i class="bi bi-clipboard-data me-2"></i>
                {% trans "Clinical Information" %}
                <span class="badge bg-primary ms-2">{{ document.clinical_sections|length }} {% trans "sections" %}</span>
            </h3>

            <div class="accordion" id="clinicalSectionsAccordion">
                {% for section in document.clinical_sections %}
                <div class="clinical-section">
                    <div class="clinical-section-header">
                        <button class="btn btn-link text-decoration-none fw-semibold text-dark w-100 text-start p-0"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#section{{ forloop.counter }}"
                                aria-expanded="true"
                                aria-controls="section{{ forloop.counter }}">
                            <i class="bi bi-chevron-down me-2"></i>
                            {{ section.section_title|default:"Clinical Section" }}
                            {% if section.section_code %}
                            <span class="code-display ms-2">{{ section.section_code }}</span>
                            {% endif %}
                            {% if section.entries %}
                            <span class="badge bg-secondary ms-2">{{ section.entries|length }} {% trans "entries" %}</span>
                            {% endif %}
                        </button>
                    </div>

                    <div id="section{{ forloop.counter }}"
                         class="collapse {% if forloop.first %}show{% endif %}"
                         data-bs-parent="#clinicalSectionsAccordion">
                        <div class="clinical-section-body">

                            <!-- Section Text -->
                            {% if section.section_text %}
                            <div class="mb-3">
                                <h6 class="text-muted">{% trans "Section Description" %}</h6>
                                <p>{{ section.section_text }}</p>
                            </div>
                            {% endif %}

                            <!-- Clinical Entries -->
                            {% if section.entries %}
                            <h6 class="text-muted mb-3">{% trans "Clinical Entries" %}</h6>

                            {% for entry in section.entries %}
                            <div class="clinical-entry">
                                <div class="row">
                                    <div class="col-md-6">
                                        {% if entry.clinical_statement.code %}
                                        <div class="mb-2">
                                            <strong>{% trans "Code" %}:</strong>
                                            <span class="code-display">{{ entry.clinical_statement.code }}</span>
                                        </div>
                                        {% endif %}

                                        {% if entry.clinical_statement.display_name %}
                                        <div class="mb-2">
                                            <strong>{% trans "Description" %}:</strong>
                                            {{ entry.clinical_statement.display_name }}
                                        </div>
                                        {% endif %}

                                        {% if entry.clinical_statement.value %}
                                        <div class="mb-2">
                                            <strong>{% trans "Value" %}:</strong>
                                            {{ entry.clinical_statement.value }}
                                            {% if entry.clinical_statement.unit %}
                                                {{ entry.clinical_statement.unit }}
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        {% if entry.effective_time %}
                                        <div class="mb-2">
                                            <strong>{% trans "Date" %}:</strong>
                                            {{ entry.effective_time }}
                                        </div>
                                        {% endif %}

                                        {% if entry.status %}
                                        <div class="mb-2">
                                            <strong>{% trans "Status" %}:</strong>
                                            {{ entry.status }}
                                        </div>
                                        {% endif %}

                                        {% if entry.clinical_statement.interpretation %}
                                        <div class="mb-2">
                                            <strong>{% trans "Interpretation" %}:</strong>
                                            {{ entry.clinical_statement.interpretation }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Participants -->
                                {% if entry.participants %}
                                <div class="mt-2 pt-2 border-top">
                                    <small class="text-muted">{% trans "Participants" %}:</small>
                                    {% for participant in entry.participants %}
                                        <span class="badge bg-light text-dark me-1">{{ participant }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}

                            {% else %}
                            <div class="no-data">
                                <i class="bi bi-info-circle me-2"></i>
                                {% trans "No clinical entries available for this section" %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            {% trans "No clinical sections available in this document" %}
        </div>
        {% endif %}

        <!-- Document Metadata -->
        {% if document.document_metadata %}
        <div class="metadata-section">
            <h4 class="mb-3">
                <i class="bi bi-info-square me-2"></i>
                {% trans "Document Metadata" %}
            </h4>

            <div class="row">
                <div class="col-md-6">
                    {% if document.document_metadata.document_class %}
                    <div class="mb-2">
                        <strong>{% trans "Document Class" %}:</strong>
                        <span class="code-display">{{ document.document_metadata.document_class }}</span>
                    </div>
                    {% endif %}

                    {% if document.document_metadata.template_ids %}
                    <div class="mb-2">
                        <strong>{% trans "Template IDs" %}:</strong>
                        {% for template_id in document.document_metadata.template_ids %}
                            <span class="code-display me-1">{{ template_id }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if document.document_metadata.version_number %}
                    <div class="mb-2">
                        <strong>{% trans "Version" %}:</strong>
                        {{ document.document_metadata.version_number }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    {% if document.document_headers.author %}
                    <div class="mb-2">
                        <strong>{% trans "Author" %}:</strong>
                        {{ document.document_headers.author.name|default:"Not specified" }}
                    </div>
                    {% endif %}

                    {% if document.document_headers.custodian %}
                    <div class="mb-2">
                        <strong>{% trans "Custodian" %}:</strong>
                        {{ document.document_headers.custodian.organization.name|default:"Not specified" }}
                    </div>
                    {% endif %}

                    {% if document.language %}
                    <div class="mb-2">
                        <strong>{% trans "Language" %}:</strong>
                        <span class="code-display">{{ document.language }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
            <div>
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>
                    {% trans "Print Document" %}
                </button>

                <a href="?format=json" class="btn btn-outline-info ms-2" target="_blank">
                    <i class="bi bi-filetype-json me-2"></i>
                    {% trans "View as JSON" %}
                </a>
            </div>

            <div>
                <span class="text-muted">
                    {% trans "Rendered via Interoperable Healthcare Service" %}
                </span>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Enhance accordion behavior
        document.addEventListener('DOMContentLoaded', function() {
            // Update chevron icons on accordion toggle
            const accordionButtons = document.querySelectorAll('[data-bs-toggle="collapse"]');

            accordionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const chevron = this.querySelector('.bi-chevron-down, .bi-chevron-right');
                    if (chevron) {
                        setTimeout(() => {
                            const isExpanded = this.getAttribute('aria-expanded') === 'true';
                            chevron.className = isExpanded ? 'bi bi-chevron-down me-2' : 'bi bi-chevron-right me-2';
                        }, 50);
                    }
                });
            });

            console.log('Interoperable Healthcare Document loaded:', {
                patient_id: '{{ patient_id }}',
                document_type: '{{ document.document_type }}',
                sections: {{ document.clinical_sections|length }},
                extraction_time: '{{ document.extraction_timestamp }}'
            });
        });
    </script>
</body>
</html>
