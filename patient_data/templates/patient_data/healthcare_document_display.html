{% load i18n %}
{% load static %}

<!DOCTYPE html>
<html lang="{{ document.language|default:'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Healthcare Document" %} - {{ document.patient_information.demographics.name|default:patient_id }}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Healthcare Document CSS -->
    <link rel="stylesheet" href="{% static 'css/components/healthcare-document.css' %}">
</head>
<body class="healthcare-document">
    <div class="container-fluid px-4 py-3">

        <!-- Document Header -->
        <div class="document-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="document-header__title">
                        <i class="bi bi-file-medical icon"></i>
                        {{ document.document_headers.document_title|default:"Healthcare Document" }}
                    </h1>
                    <p class="document-header__meta">
                        {% trans "Document Type" %}:
                        <span class="status-badge status-badge--{{ document.document_type|lower }}">
                            {{ document.document_type }}
                        </span>
                    </p>
                    <p class="document-header__meta document-header__meta--secondary">
                        {% trans "Extracted" %}: {{ document.extraction_timestamp|date:"F j, Y \a\t g:i A" }}
                    </p>
                </div>
                <div class="col-md-4">
                    <div class="document-header__patient-info">
                        <div class="text-light opacity-75">{% trans "Patient ID" %}</div>
                        <div class="patient-id">{{ patient_id }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Information -->
        {% if document.patient_information %}
        <div class="patient-info-card">
            <div class="row">
                <div class="col-md-6">
                    <h3 class="patient-info-card__section-title">
                        <i class="bi bi-person-circle icon"></i>
                        {% trans "Patient Information" %}
                    </h3>

                    {% with demo=document.patient_information.demographics %}
                    <div class="patient-info-card__field">
                        <strong>{% trans "Name" %}:</strong>
                        {{ demo.name|default:"Not specified" }}
                    </div>
                    <div class="patient-info-card__field">
                        <strong>{% trans "Birth Date" %}:</strong>
                        {{ demo.birth_date|default:"Not specified" }}
                    </div>
                    <div class="patient-info-card__field">
                        <strong>{% trans "Gender" %}:</strong>
                        {{ demo.gender|default:"Not specified" }}
                    </div>
                    <div class="patient-info-card__field">
                        <strong>{% trans "Marital Status" %}:</strong>
                        {{ demo.marital_status|default:"Not specified" }}
                    </div>
                    {% endwith %}
                </div>

                <div class="col-md-6">
                    <h5 class="patient-info-card__section-title">
                        <i class="bi bi-geo-alt icon"></i>
                        {% trans "Contact Information" %}
                    </h5>

                    {% if document.patient_information.contact_information.addresses %}
                        {% for address in document.patient_information.contact_information.addresses %}
                        <div class="patient-info-card__field">
                            <small class="text-muted">{% trans "Address" %} {{ forloop.counter }}:</small><br>
                            {{ address|default:"Address not available" }}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="patient-info-card__no-data">{% trans "No address information available" %}</div>
                    {% endif %}

                    {% if document.patient_information.contact_information.telecom %}
                        <div class="patient-info-card__field">
                            <small class="text-muted">{% trans "Contact" %}:</small><br>
                            {% for contact in document.patient_information.contact_information.telecom %}
                                {{ contact }}<br>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Clinical Sections -->
        {% if document.clinical_sections %}
        <div class="clinical-sections">
            <h3 class="clinical-sections__title">
                <i class="bi bi-clipboard-data icon"></i>
                {% trans "Clinical Information" %}
                <span class="badge">{{ document.clinical_sections|length }} {% trans "sections" %}</span>
            </h3>

            <div class="accordion" id="clinicalSectionsAccordion">
                {% for section in document.clinical_sections %}
                <div class="clinical-section">
                    <div class="clinical-section__header">
                        <button class="btn btn-link"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#section{{ forloop.counter }}"
                                aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                                aria-controls="section{{ forloop.counter }}">
                            <i class="bi bi-chevron-down icon"></i>
                            {{ section.section_title|default:"Clinical Section" }}
                            {% if section.section_code %}
                            <span class="code-display">{{ section.section_code }}</span>
                            {% endif %}
                            {% if section.entries %}
                            <span class="badge">{{ section.entries|length }} {% trans "entries" %}</span>
                            {% endif %}
                        </button>
                    </div>

                    <div id="section{{ forloop.counter }}"
                         class="collapse {% if forloop.first %}show{% endif %}"
                         data-bs-parent="#clinicalSectionsAccordion">
                        <div class="clinical-section__body">

                            <!-- Section Text -->
                            {% if section.section_text %}
                            <div class="clinical-section__description">
                                <h6>{% trans "Section Description" %}</h6>
                                <p>{{ section.section_text }}</p>
                            </div>
                            {% endif %}

                            <!-- Clinical Entries -->
                            {% if section.entries %}
                            <h6 class="text-muted mb-3">{% trans "Clinical Entries" %}</h6>

                            {% for entry in section.entries %}
                            <div class="clinical-entry">
                                <div class="row">
                                    <div class="col-md-6">
                                        {% if entry.clinical_statement.code %}
                                        <div class="clinical-entry__field">
                                            <strong>{% trans "Code" %}:</strong>
                                            <span class="code-display">{{ entry.clinical_statement.code }}</span>
                                        </div>
                                        {% endif %}

                                        {% if entry.clinical_statement.display_name %}
                                        <div class="clinical-entry__field">
                                            <strong>{% trans "Description" %}:</strong>
                                            {{ entry.clinical_statement.display_name }}
                                        </div>
                                        {% endif %}

                                        {% if entry.clinical_statement.value %}
                                        <div class="clinical-entry__field">
                                            <strong>{% trans "Value" %}:</strong>
                                            {{ entry.clinical_statement.value }}
                                            {% if entry.clinical_statement.unit %}
                                                {{ entry.clinical_statement.unit }}
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        {% if entry.effective_time %}
                                        <div class="clinical-entry__field">
                                            <strong>{% trans "Date" %}:</strong>
                                            {{ entry.effective_time }}
                                        </div>
                                        {% endif %}

                                        {% if entry.status %}
                                        <div class="clinical-entry__field">
                                            <strong>{% trans "Status" %}:</strong>
                                            {{ entry.status }}
                                        </div>
                                        {% endif %}

                                        {% if entry.clinical_statement.interpretation %}
                                        <div class="clinical-entry__field">
                                            <strong>{% trans "Interpretation" %}:</strong>
                                            {{ entry.clinical_statement.interpretation }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Participants -->
                                {% if entry.participants %}
                                <div class="clinical-entry__participants">
                                    <small class="text-muted">{% trans "Participants" %}:</small>
                                    {% for participant in entry.participants %}
                                        <span class="badge">{{ participant }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}

                            {% else %}
                            <div class="no-data">
                                <i class="bi bi-info-circle icon"></i>
                                {% trans "No clinical entries available for this section" %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            {% trans "No clinical sections available in this document" %}
        </div>
        {% endif %}

        <!-- Document Metadata -->
        {% if document.document_metadata %}
        <div class="metadata-section">
            <h4 class="metadata-section__title">
                <i class="bi bi-info-square icon"></i>
                {% trans "Document Metadata" %}
            </h4>

            <div class="row">
                <div class="col-md-6">
                    {% if document.document_metadata.document_class %}
                    <div class="metadata-section__field">
                        <strong>{% trans "Document Class" %}:</strong>
                        <span class="code-display">{{ document.document_metadata.document_class }}</span>
                    </div>
                    {% endif %}

                    {% if document.document_metadata.template_ids %}
                    <div class="metadata-section__field">
                        <strong>{% trans "Template IDs" %}:</strong>
                        {% for template_id in document.document_metadata.template_ids %}
                            <span class="code-display">{{ template_id }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if document.document_metadata.version_number %}
                    <div class="metadata-section__field">
                        <strong>{% trans "Version" %}:</strong>
                        {{ document.document_metadata.version_number }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    {% if document.document_headers.author %}
                    <div class="metadata-section__field">
                        <strong>{% trans "Author" %}:</strong>
                        {{ document.document_headers.author.name|default:"Not specified" }}
                    </div>
                    {% endif %}

                    {% if document.document_headers.custodian %}
                    <div class="metadata-section__field">
                        <strong>{% trans "Custodian" %}:</strong>
                        {{ document.document_headers.custodian.organization.name|default:"Not specified" }}
                    </div>
                    {% endif %}

                    {% if document.language %}
                    <div class="metadata-section__field">
                        <strong>{% trans "Language" %}:</strong>
                        <span class="code-display">{{ document.language }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="document-actions">
            <div class="document-actions__buttons">
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>
                    {% trans "Print Document" %}
                </button>

                <a href="?format=json" class="btn btn-outline-info" target="_blank">
                    <i class="bi bi-filetype-json me-2"></i>
                    {% trans "View as JSON" %}
                </a>
            </div>

            <div class="document-actions__info">
                {% trans "Rendered via Healthcare Service" %}
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Healthcare Document JS -->
    <script src="{% static 'js/components/healthcare-document.js' %}"></script>
</body>
</html>
