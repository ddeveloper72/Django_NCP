{% extends "base.html" %}

{% block title %}{{ patient_info.given_name }} {{ patient_info.family_name }} - Uploaded CDA Document{% endblock %}

{% block content %}
<div class="uploaded-document-view">
    <div class="country-header">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                üìÑ {{ document_info.original_filename }}
            </h1>
            <div class="header-actions">
                <a href="{% url 'patient_data:uploaded_documents' %}" class="btn btn-light ms-2">
                    ‚Üê Back to Documents
                </a>
            </div>
        </div>
    </div>

    <!-- Patient Information Section -->
    <div class="patient-info-section">
        <div class="info-card">
            <h4>üë§ Patient Information</h4>
            <div class="patient-details-grid">
                <div class="detail-item">
                    <span class="label">Full Name:</span>
                    <span class="value">{{ patient_info.given_name }} {{ patient_info.family_name }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Patient ID:</span>
                    <span class="value">{{ patient_info.patient_id }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Birth Date:</span>
                    <span class="value">{{ patient_info.birth_date | default('Not specified') }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Gender:</span>
                    <span class="value">{{ patient_info.gender | default('Not specified') }}</span>
                </div>
                {% if patient_info.address %}
                <div class="detail-item">
                    <span class="label">Address:</span>
                    <span class="value">{{ patient_info.address }}</span>
                </div>
                {% endif %}
                {% if patient_info.country %}
                <div class="detail-item">
                    <span class="label">Country:</span>
                    <span class="value">{{ patient_info.country }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Document Information -->
    <div class="document-info-section">
        <div class="info-card">
            <h4>üìã Document Information</h4>
            <div class="document-details-grid">
                <div class="detail-item">
                    <span class="label">Original Filename:</span>
                    <span class="value">{{ document_info.original_filename }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Upload Date:</span>
                    <span class="value">{{ document_info.upload_date }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Processing Status:</span>
                    <span class="value">
                        {% if document_info.processed %}
                        <span class="status-badge success">‚úÖ Processed</span>
                        {% else %}
                        <span class="status-badge pending">‚è≥ Pending</span>
                        {% endif %}
                    </span>
                </div>
                <div class="detail-item">
                    <span class="label">Sections Found:</span>
                    <span class="value">{{ sections | length }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Clinical Sections -->
    {% if sections %}
    <div class="sections-container">
        <h4>üè• Clinical Sections</h4>

        {% for section in sections %}
        <div class="section-card">
            <div class="section-header">
                <h5 class="section-title">
                    {{ section.title | default('Untitled Section') }}
                </h5>
                {% if section.code %}
                <span class="section-code">Code: {{ section.code }}</span>
                {% endif %}
            </div>

            <div class="section-content">
                {% if section.content %}
                {% if is_single_language %}
                <!-- Single Language Content (English documents) -->
                <div class="single-language-content">
                    {{ section.content | safe }}
                </div>
                {% elif section.content.original and section.content.translated %}
                <!-- Dual Language Content (Non-English documents) -->
                <div class="dual-language-content">
                    <div class="language-tabs">
                        <button class="tab-button active" onclick="showLanguage({{ loop.index0 }}, 'original')">
                            Original
                        </button>
                        <button class="tab-button" onclick="showLanguage({{ loop.index0 }}, 'translated')">
                            English
                        </button>
                    </div>

                    <div id="section-{{ loop.index0 }}-original" class="language-content active">
                        {{ section.content.original | safe }}
                    </div>

                    <div id="section-{{ loop.index0 }}-translated" class="language-content">
                        {{ section.content.translated | safe }}
                    </div>
                </div>
                {% else %}
                <!-- Fallback Single Language Content -->
                <div class="single-language-content">
                    {{ section.content | safe }}
                </div>
                {% endif %}
                {% else %}
                <p class="no-content">No content available for this section.</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-sections">
        <div class="empty-state">
            <h4>üìÇ No Clinical Sections Found</h4>
            <p>This document does not contain any recognizable clinical sections.</p>
        </div>
    </div>
    {% endif %}
</div>

{% block extra_js %}
<!-- Document viewing functionality is now externalized -->
<script src="{% static 'js/document_viewer.js' %}"></script>
{% endblock %}

{% block extra_css %}
<!-- Document viewer styles are now externalized to _document_viewer.scss -->
{% endblock %}
