{% extends "base.html" %}
{% load patient_date_filters %}

{# Django replacement for Jinja2 macro - use |document_date filter instead #}
{# format_medical_date functionality moved to patient_date_filters.py #}

{% block title %}Enhanced CDA Display - {{ patient_identity.given_name }} {{ patient_identity.family_name }}{% endblock %}

{% block extra_css %}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="breadcrumb-nav">
    <ol class="breadcrumb breadcrumb-enhanced mb-0">
        <li class="breadcrumb-item">
            <a href="{% url 'home' %}" class="text-decoration-none">
                <i class="fas fa-home me-1"></i>Home
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'patient_data:patient_data_form' %}" class="text-decoration-none">
                <i class="fas fa-search me-1"></i>Patient Search
            </a>
        </li>
        {% if patient_identity.patient_id %}
        <li class="breadcrumb-item">
            <a href="{% url 'patient_data:patient_details' patient_identity.url_patient_id|default:patient_identity.patient_id %}"
                class="text-decoration-none">
                <i class="fas fa-user me-1"></i>{{ patient_identity.given_name }} {{
                patient_identity.family_name }}
            </a>
        </li>
        {% endif %}
        <li class="breadcrumb-item active" aria-current="page">
            <i class="fas fa-file-medical me-1"></i>CDA Document
        </li>
    </ol>
</nav>
{% endblock %}

{% block page_context %}
<div class="page-context-content">
    <div class="page-info">
        <span class="page-location">
            <i class="fa fa-file-medical"></i> CDA Document
        </span>
    </div>
    <div class="page-actions">
        {% if patient_identity.patient_id %}
        <a href="{% url 'patient_data:patient_details' patient_identity.url_patient_id|default:patient_identity.patient_id %}"
            class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-arrow-left"></i> Back to Patient
        </a>
        {% else %}
        <a href="{% url 'patient_data:patient_data_form' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-arrow-left"></i> Back to Search
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Patient Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">
                        <i class="fas fa-user-injured me-2"></i>
                        {# Django: Fix Jinja2 syntax - no ~ concatenation or |default() with args #}
                        {% if patient_identity.full_name %}
                        {{ patient_identity.full_name }}
                        {% elif patient_identity.given_name or patient_identity.family_name %}
                        {{ patient_identity.given_name|default:"" }} {{ patient_identity.family_name|default:"" }}
                        {% else %}
                        Patient
                        {% endif %}
                    </h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Birth Date:</strong>
                                {% if patient_identity.birth_date_formatted %}
                                {{ patient_identity.birth_date_formatted }}
                                {% elif patient_identity.birth_date %}
                                {{ patient_identity.birth_date|document_date }}
                                {% else %}
                                Unknown
                                {% endif %}
                            </p>
                            <p><strong>Gender:</strong> {{ patient_identity.gender|default:"Unknown" }}</p>
                            <p><strong>Patient ID:</strong> {{ patient_identity.patient_id }}</p>
                            {% if patient_identity.secondary_patient_id %}
                            <p><strong>Secondary ID:</strong> {{ patient_identity.secondary_patient_id }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <p><strong>Source Country:</strong> {{ source_country }}</p>
                            <p><strong>CDA Type:</strong> {{ cda_type }}</p>
                            <p><strong>Translation Quality:</strong>
                                <span class="badge bg-success">{{ translation_quality }}</span>
                            </p>
                            {% if patient_identity.document_metadata %}
                            {# Django: Use direct access instead of {% set %} #}
                            {% if patient_identity.document_metadata.title %}
                            <p><strong>Document:</strong> {{ patient_identity.document_metadata.title }}</p>
                            {% endif %}
                            {% if patient_identity.document_metadata.language_code %}
                            <p><strong>Language:</strong> {{ patient_identity.document_metadata.language_code }}</p>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- CDA Type Toggle Buttons -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="btn-group" role="group" aria-label="CDA Type Selection">
                                {# Django: Replace {% set %} with conditional class assignment #}
                                <a href="{% url 'patient_data:patient_cda_view_typed' patient_identity.url_patient_id|default:patient_identity.patient_id 'L1' %}"
                                    class="{% if cda_type == 'L1' %}btn btn-primary{% else %}btn btn-outline-primary{% endif %} {% if not has_l1_cda %} disabled{% endif %}">
                                    <i class="fas fa-file-medical me-1"></i>L1 Original Document
                                    {% if not has_l1_cda %}<small>(Not Available)</small>{% endif %}
                                </a>
                                {# Django: Replace {% set %} with conditional class assignment #}
                                <a href="{% url 'patient_data:patient_cda_view_typed' patient_identity.url_patient_id|default:patient_identity.patient_id 'L3' %}"
                                    class="{% if cda_type == 'L3' %}btn btn-primary{% else %}btn btn-outline-primary{% endif %} {% if not has_l3_cda %} disabled{% endif %}">
                                    <i class="fas fa-language me-1"></i>L3 Patient Summary
                                    {% if not has_l3_cda %}<small>(Not Available)</small>{% endif %}
                                </a>
                            </div>
                            <small class="text-muted d-block mt-1">
                                <strong>L1:</strong> Original clinical document from source country |
                                <strong>L3:</strong> Standardized European Patient Summary
                                {% if cda_type == 'L1' and has_l1_cda %}
                                | Currently viewing: <strong>Original clinical data</strong>
                                {% elif cda_type == 'L3' and has_l3_cda %}
                                | Currently viewing: <strong>European Patient Summary</strong>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Debug Modal Component -->
    {% include 'patient_data/components/debug_modal.html' %}

    <!-- Extended Header Information Section -->
    {% include 'patient_data/components/extended_patient_info.html' %}

    <!-- Enhanced Medication Information Section -->
    {% if medications and medications|length > 0 %}
    <div class="medical-section">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-pills me-2"></i>
                    Comprehensive Medication Analysis
                    <span class="badge bg-primary ms-2">{{ medications|length }} medication(s)</span>
                </h4>
            </div>
            <div class="card-body">
                {% for medication in medications %}
                <div class="medication-entry border-bottom pb-3 mb-3">
                    <div class="row">
                        <!-- Main Medication Info -->
                        <div class="col-lg-6">
                            <h5 class="text-primary mb-2">
                                <i class="fas fa-prescription-bottle me-2"></i>
                                {# Django: Convert .get() calls to attribute access #}
                                {{ medication.fields.Medication_Name.value|default:"Unknown Medication" }}
                            </h5>

                            <div class="medication-details">
                                {% if medication.fields.Active_Ingredient_Name.value %}
                                <p class="mb-2"><strong>Active Ingredient:</strong>
                                    {{ medication.fields.Active_Ingredient_Name.value }}
                                </p>
                                {% endif %}

                                {% if medication.fields.Dose_Form_Name.value %}
                                <p class="mb-2"><strong>Dose Form:</strong>
                                    {{ medication.fields.Dose_Form_Name.value }}
                                </p>
                                {% endif %}

                                {% if medication.fields.Route_Name.value %}
                                <p class="mb-2"><strong>Route:</strong>
                                    {{ medication.fields.Route_Name.value }}
                                </p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Dosing and Timing -->
                        <div class="col-lg-6">
                            <h6 class="text-secondary mb-2">
                                <i class="fas fa-clock me-2"></i>
                                Dosing & Timing
                            </h6>

                            <div class="dosing-info">
                                {% if medication.fields.Frequency_Period_Value.value and medication.fields.Frequency_Period_Unit.value %}
                                <p class="mb-2"><strong>Frequency:</strong>
                                    {{ medication.fields.Frequency_Period_Value.value }}
                                    time(s) per {{ medication.fields.Frequency_Period_Unit.value
                                    }}
                                </p>
                                {% endif %}

                                {% if medication.fields.Treatment_Start_Date.value %}
                                <p class="mb-2"><strong>Start Date:</strong>
                                    {{ medication.fields.Treatment_Start_Date.value|document_date }}
                                </p>
                                {% endif %}

                                {% if medication.fields.Treatment_End_Date.value %}
                                <p class="mb-2"><strong>End Date:</strong>
                                    {{ medication.fields.Treatment_End_Date.value|document_date }}
                                </p>
                                {% endif %}

                                {% if medication.fields.Status_Code.value %}
                                {# Django: Replace {% set %} with conditional class assignment #}
                                <p class="mb-2"><strong>Status:</strong>
                                    <span class="badge {% if medication.fields.Status_Code.value == 'Active' %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ medication.fields.Status_Code.value }}
                                    </span>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Pharmaceutical Information -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-secondary mb-2">
                                <i class="fas fa-info-circle me-2"></i>
                                Pharmaceutical Details
                            </h6>

                            <div class="row">
                                <div class="col-md-6">
                                    {% if medication.fields.Ingredient_Strength_Numerator.value and medication.fields.Ingredient_Strength_Numerator_Unit.value %}
                                    <small class="text-muted d-block">
                                        <strong>Strength:</strong>
                                        {{ medication.fields.Ingredient_Strength_Numerator.value
                                        }}
                                        {{ medication.fields.Ingredient_Strength_Numerator_Unit.value }}
                                        {% if medication.fields.Ingredient_Strength_Denominator.value and medication.fields.Ingredient_Strength_Denominator_Unit.value %}
                                        / {{ medication.fields.Ingredient_Strength_Denominator.value }}
                                        {{ medication.fields.Ingredient_Strength_Denominator_Unit.value }}
                                        {% endif %}
                                    </small>
                                    {% endif %}

                                    {% if medication.fields.Package_Quantity.value and medication.fields.Package_Unit.value %}
                                    <small class="text-muted d-block">
                                        <strong>Package:</strong>
                                        {{ medication.fields.Package_Quantity.value }}
                                        {{ medication.fields.Package_Unit.value }}
                                    </small>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    {% if medication.fields.Medication_Code.value %}
                                    <small class="text-muted d-block">
                                        <strong>Code:</strong> {{ medication.fields.Medication_Code.value }}
                                    </small>
                                    {% endif %}

                                    {% if medication.fields.Indication_Code.value %}
                                    <small class="text-muted d-block">
                                        <strong>Indication:</strong> {{ medication.fields.Indication_Code.value }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Clinical Sections -->
    {% if processed_sections and processed_sections|length > 0 %}
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h3 class="mb-0">
                <i class="fas fa-clipboard-list me-2"></i>
                Clinical Sections ({{ processed_sections|length }} sections)
            </h3>
        </div>
        <div class="card-body">
            {% for section in processed_sections %}
            {# Django: Use forloop.counter0 instead of {% set %} #}

            <!-- Modular Clinical Section Router - Enhanced Version -->
            {% include 'patient_data/sections/clinical_section_router.html' %}

            {% endfor %}

            <div class="text-end mt-3">
                <span class="badge bg-success fs-6">
                    <i class="fas fa-check-circle me-1"></i>
                    Enhanced Clinical Sections Loaded ({{ processed_sections|length }})
                </span>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <h4>No Medical Data Available</h4>
        <p>No clinical sections could be processed from the CDA document.</p>
    </div>
    {% endif %}

    <!-- Summary Stats -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>Processing Summary</h4>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="h2 text-primary">{{ sections_count }}</div>
                            <div>Total Sections</div>
                        </div>
                        <div class="col-md-3">
                            <div class="h2 text-success">{{ medical_terms_count }}</div>
                            <div>Medical Terms</div>
                        </div>
                        <div class="col-md-3">
                            <div class="h2 text-info">{{ coded_sections_count }}</div>
                            <div>Coded Sections</div>
                        </div>
                        <div class="col-md-3">
                            <div class="h2 text-warning">{{ coded_sections_percentage|floatformat:0 }}%</div>
                            <div>Terminology Coverage</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Extended Patient Info Tabs Enhancement -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('ðŸ” Initializing Extended Patient Info tabs with custom system...');

        // Initialize with contact tab active by default
        setTimeout(() => {
            showExtendedPatientTab('contact');
            console.log('ðŸŽ¯ Extended Patient Info tabs initialized with contact tab active');
        }, 100);

        // Enhanced hover effects for contact links
        const contactLinks = document.querySelectorAll('.contact-link');
        contactLinks.forEach(function (link) {
            link.addEventListener('mouseenter', function () {
                this.style.transform = 'scale(1.02)';
            });

            link.addEventListener('mouseleave', function () {
                this.style.transform = 'scale(1)';
            });
        });

        console.log('âœ… Extended Patient Info tabs initialized successfully');
    });
</script>

<!-- Section Tabs JavaScript -->
<script>
    // Date formatting function for various medical date formats
    function formatMedicalDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return dateStr;

        // Remove any whitespace
        dateStr = dateStr.trim();

        // Handle various CDA date formats
        let parsedDate = null;

        // Format: YYYYMMDDHHMMSS (e.g., 20130317124500)
        if (/^\d{14}$/.test(dateStr)) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            const hour = dateStr.substring(8, 10);
            const minute = dateStr.substring(10, 12);
            const second = dateStr.substring(12, 14);
            parsedDate = new Date(year, month - 1, day, hour, minute, second);
        }
        // Format: YYYYMMDD (e.g., 20130317)
        else if (/^\d{8}$/.test(dateStr)) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            parsedDate = new Date(year, month - 1, day);
        }
        // Format: YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS (ISO format)
        else if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) {
            parsedDate = new Date(dateStr);
        }

        // If we successfully parsed a date, format it as MM/DD/YYYY HH:MM
        if (parsedDate && !isNaN(parsedDate.getTime())) {
            const month = String(parsedDate.getMonth() + 1).padStart(2, '0');
            const day = String(parsedDate.getDate()).padStart(2, '0');
            const year = parsedDate.getFullYear();
            const hour = String(parsedDate.getHours()).padStart(2, '0');
            const minute = String(parsedDate.getMinutes()).padStart(2, '0');

            // If it's just a date (no time component), don't show time
            if (/^\d{8}$/.test(dateStr.trim()) || /^\d{4}-\d{2}-\d{2}$/.test(dateStr.trim())) {
                return `${month}/${day}/${year}`;
            } else {
                return `${month}/${day}/${year} ${hour}:${minute}`;
            }
        }        // Return original string if we couldn't parse it
        return dateStr;
    }

    // Function to apply date formatting to elements with date-like content
    function formatDateElements() {
        // Format dates in original clinical data
        document.querySelectorAll('.original-value').forEach(element => {
            const text = element.textContent.trim();
            if (text && text !== 'N/A') {
                const formatted = formatMedicalDate(text);
                if (formatted !== text) {
                    element.innerHTML = `<span class="formatted-date" title="Original: ${text}">${formatted}</span>`;
                }
            }
        });

        // Format dates in structured data that contain date-like patterns
        document.querySelectorAll('td, div').forEach(element => {
            const text = element.textContent.trim();
            // Look for date patterns in cells that might contain dates
            if (/^\d{8,14}$/.test(text) || /^\d{4}-\d{2}-\d{2}/.test(text)) {
                const formatted = formatMedicalDate(text);
                if (formatted !== text && element.children.length === 0) {
                    element.innerHTML = `<span class="formatted-date" title="Original: ${text}">${formatted}</span>`;
                }
            }
        });
    }

    function showTab(sectionId, tabType) {
        // Hide all tab contents for this section
        const structuredTab = document.getElementById(sectionId + '_structured');
        const originalTab = document.getElementById(sectionId + '_original');

        // Find the parent container that contains the tabs
        const tabContainer = structuredTab ? structuredTab.closest('.card-body') :
            (originalTab ? originalTab.closest('.card-body') : null);

        if (!tabContainer) return; // Exit if we can't find the container

        const buttons = tabContainer.querySelectorAll('.tab-button');

        // Remove active class from all tabs and buttons in this section
        if (structuredTab) structuredTab.classList.remove('active');
        if (originalTab) originalTab.classList.remove('active');
        buttons.forEach(btn => btn.classList.remove('active'));

        // Show selected tab and activate corresponding button
        if (tabType === 'structured') {
            if (structuredTab) structuredTab.classList.add('active');
            if (buttons[0]) buttons[0].classList.add('active');
        } else if (tabType === 'original') {
            if (originalTab) originalTab.classList.add('active');
            if (buttons[1]) buttons[1].classList.add('active');
        }
    }

    // Enhanced function for clinical sections with more specific targeting
    function showClinicalTab(sectionId, tabType) {
        // Hide all tab contents for this specific clinical section
        const structuredTab = document.getElementById(sectionId + '_structured');
        const originalTab = document.getElementById(sectionId + '_original');

        // Find the parent clinical section container
        const clinicalContainer = structuredTab ? structuredTab.closest('.medical-section') :
            (originalTab ? originalTab.closest('.medical-section') : null);

        if (!clinicalContainer) {
            console.log('Clinical container not found for:', sectionId);
            return; // Exit if we can't find the container
        }

        const buttons = clinicalContainer.querySelectorAll('.tab-button');

        // Remove active class from all clinical tabs and buttons in this section
        if (structuredTab) structuredTab.classList.remove('active');
        if (originalTab) originalTab.classList.remove('active');
        buttons.forEach(btn => btn.classList.remove('active'));

        // Show selected clinical tab and activate corresponding button
        if (tabType === 'structured') {
            if (structuredTab) {
                structuredTab.classList.add('active');
                structuredTab.style.display = 'block';
            }
            if (buttons[0]) buttons[0].classList.add('active');
        } else if (tabType === 'original') {
            if (originalTab) {
                originalTab.classList.add('active');
                originalTab.style.display = 'block';
            }
            if (buttons[1]) buttons[1].classList.add('active');
        }

        console.log('Clinical tab switched:', sectionId, tabType);
    }

    // Extended Patient Info tab switching function (matches clinical sections pattern)
    function showExtendedPatientTab(tabType) {
        console.log('ðŸ” Extended Patient Tab switching to:', tabType);

        // Get all tab panes and buttons
        const contactTab = document.getElementById('extended-contact');
        const healthcareTab = document.getElementById('extended-healthcare');
        const documentTab = document.getElementById('extended-document');

        const contactButton = document.getElementById('contact-tab');
        const healthcareButton = document.getElementById('healthcare-tab');
        const documentButton = document.getElementById('document-tab');

        // Hide all tabs and remove active classes
        [contactTab, healthcareTab, documentTab].forEach(tab => {
            if (tab) {
                tab.classList.remove('active');
                tab.style.display = 'none';
            }
        });

        [contactButton, healthcareButton, documentButton].forEach(btn => {
            if (btn) {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            }
        });

        // Show selected tab and activate corresponding button
        if (tabType === 'contact' && contactTab && contactButton) {
            contactTab.classList.add('active');
            contactTab.style.display = 'block';
            contactButton.classList.add('active');
            contactButton.setAttribute('aria-selected', 'true');
            console.log('âœ… Contact tab activated');
        } else if (tabType === 'healthcare' && healthcareTab && healthcareButton) {
            healthcareTab.classList.add('active');
            healthcareTab.style.display = 'block';
            healthcareButton.classList.add('active');
            healthcareButton.setAttribute('aria-selected', 'true');
            console.log('âœ… Healthcare tab activated');
        } else if (tabType === 'document' && documentTab && documentButton) {
            documentTab.classList.add('active');
            documentTab.style.display = 'block';
            documentButton.classList.add('active');
            documentButton.setAttribute('aria-selected', 'true');
            console.log('âœ… Document tab activated');
        }
    }

    // Initialize tooltips and any other interactive elements
    document.addEventListener('DOMContentLoaded', function () {
        // Format dates throughout the document
        formatDateElements();

        // Add any other initialization code here
        console.log('Enhanced CDA Display with tabs and date formatting initialized');
    });
</script>
{% endblock %}

</html>
