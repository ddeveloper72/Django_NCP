{% load patient_filters %}
{% load patient_filters %}
{% load patient_date_filters %}
{# Original Content Template - Shared by all section types #}
<div class="original-content">
    <h4>Original Clinical Data from NCPeH-A{% if section.title %} - {{ section.title|extract_section_title }}{% endif %}</h4>

    {% if section.structured_data %}
    <div class="alert alert-info mb-3">
        <small><i class="fa-solid fa-info-circle me-1"></i><strong>This shows the original clinical data</strong> extracted
            from the CDA document structure. Data may include coded values, timestamps, and hierarchical medical
            information.</small>
    </div>

    {% if section.structured_data %}
    {% with section.structured_data.0 as first_entry %}
    {% if first_entry and first_entry.fields and first_entry.fields|length > 1 %}
    <!-- Original Clinical Data Table -->
    <div class="original-clinical-table">
        <table class="table table-bordered table-hover">
            <thead class="table-primary">
                <tr>
                    {% for field_name, field_data in first_entry.fields|dict_items %}
                    <th class="text-center">
                        {{ field_name|default:"Field" }}
                        {% if field_data|safe_get:"has_valueset" %}
                        <span class="badge bg-warning ms-1">Coded</span>
                        {% endif %}
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for entry in section.structured_data %}
                <tr>
                    {% for field_name, field_data in entry.fields|dict_items %}
                    <td>
                        {% if 'date' in field_name|lower or 'time' in field_name|lower %}
                        <div class="clinical-value">{{ field_data|safe_get:"value"|default:"N/A"|document_date }}</div>
                        {% else %}
                        <div class="clinical-value">{{ field_data|safe_get:"value"|default:"N/A" }}</div>
                        {% endif %}

                        {# Only show essential clinical information - remove technical clutter #}
                        {% if field_data|safe_get:"has_valueset" and field_data|safe_get:"code" %}
                        <div class="clinical-code mt-1">
                            <small class="text-muted">Code: <span class="badge bg-secondary">{{ field_data|safe_get:"code" }}</span></small>
                        </div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Table Summary -->
        <div class="card-footer bg-light">
            <div class="row text-center">
                <div class="col-md-6">
                    <small class="text-muted">
                        <i class="fa-solid fa-database me-1"></i>
                        <strong>{{ section.structured_data|length }}</strong> original entries
                    </small>
                </div>
                <div class="col-md-6">
                    <small class="text-muted">
                        <i class="fa-solid fa-file-code me-1"></i>
                        Direct CDA extraction
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endwith %}

    {% elif section.content and section.content.original %}
    <div class="alert alert-warning mb-3">
        <small><i class="fa-solid fa-exclamation-triangle me-1"></i>Structured data not available. Showing raw XML content
            from the CDA document.</small>
    </div>
    <pre
        class="xml-content">{{ section.content.original|truncatechars:2000 }}</pre>

    {% elif section.content %}
    <div class="alert alert-warning mb-3">
        <small><i class="fa-solid fa-file-text me-1"></i>Structured data not available. Showing processed content from the
            CDA document.</small>
    </div>
    <div class="original-text-content">
        {% if section.content is string %}
        <pre class="text-content">{{ section.content|truncatechars:3000 }}</pre>
        {% else %}
        <pre class="xml-content">{{ section.content }}</pre>
        {% endif %}
    </div>

    {% elif section.entries and section.entries|length > 0 %}
    <div class="alert alert-info mb-3">
        <small><i class="fa-solid fa-table me-1"></i>Structured data not available. Showing entry-level information.</small>
    </div>
    <div class="original-entries-content">
        <table class="table table-sm table-bordered">
            <thead>
                <tr>
                    <th>Entry #</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in section.entries|slice:":10" %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        {% if entry is mapping %}
                        <pre class="json-content">{{ entry }}</pre>
                        {% else %}
                        {{ entry }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if section.entries|length > 10 %}
                <tr>
                    <td colspan="2" class="text-muted text-center">
                        ... and {{ section.entries|length|subtract:10 }} more entries
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% else %}
    <p class="text-muted">No original clinical data available for this section.</p>
    {% endif %}
    {% endif %}
</div>
