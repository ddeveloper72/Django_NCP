{% load patient_filters %}

{# Enhanced Clinical Section Template - Rich Data Display #}

<!-- Enhanced Clinical Section with Rich Data Analysis -->
<div class="medical-section enhanced-clinical-section"
    id="{{ section.section_id|default:'enhanced-section' }}">
    <div class="card clinical-section-card">
        <!-- Enhanced Section Header with Metrics -->
        <div class="card-header bg-gradient-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">
                        <i class="{% if section.section_type == 'allergies' %}fa-solid fa-exclamation-triangle{% elif section.section_type == 'medications' %}fa-solid fa-pills{% elif section.section_type == 'problems' %}fa-solid fa-stethoscope{% elif section.section_type == 'vitals' %}fa-solid fa-heartbeat{% elif section.section_type == 'procedures' %}fa-solid fa-user-md{% elif section.section_type == 'immunizations' %}fa-solid fa-syringe{% elif section.section_type == 'results' %}fa-solid fa-flask{% elif section.section_type == 'social_history' %}fa-solid fa-users{% elif section.section_type == 'family_history' %}fa-solid fa-family{% elif section.section_type == 'care_plan' %}fa-solid fa-clipboard-list{% else %}fa-solid fa-file-medical{% endif %} me-2"></i>
                        {{ section.display_name|extract_section_title|default:section.title|extract_section_title }}
                    </h5>
                    {% if section.original and section.translated %}
                    <small class="opacity-75">
                        {% if section.original != section.translated %}
                            Original: "{{ section.original }}" → Translated: "{{ section.translated }}"
                        {% else %}
                            {{ section.original }}
                        {% endif %}
                    </small>
                    {% endif %}
                </div>
                <div class="clinical-metrics">
                    {% if section.structured_entries %}
                    <span class="badge bg-light text-dark me-1">
                        <i class="fa-solid fa-list me-1"></i>{{ section.structured_entries|length }} entries
                    </span>
                    {% endif %}
                    {% if section.clinical_codes %}
                    <span class="badge bg-success me-1">
                        <i class="fa-solid fa-code me-1"></i>{{ section.clinical_codes|length }} codes
                    </span>
                    {% endif %}
                    {% if section.coding_density %}
                    <span class="badge bg-info">
                        <i class="fa-solid fa-chart-line me-1"></i>{{ section.coding_density|floatformat:1 }}% coded
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Enhanced Clinical Section Content -->
        <div class="card-body">
            {% if not hide_tabs %}
            <!-- Enhanced Section Tabs -->
            <div class="section-tabs mb-3">
                <button class="tab-button active" onclick="showClinicalTab('enhanced_{{ section_index }}', 'structured')"
                        data-bs-toggle="tooltip" title="View structured clinical data with codes and relationships">
                    <i class="fa-solid fa-sitemap me-1"></i> Rich Data View
                </button>
                <button class="tab-button" onclick="showClinicalTab('enhanced_{{ section_index }}', 'codes')"
                        data-bs-toggle="tooltip" title="View clinical coding systems and terminology">
                    <i class="fa-solid fa-tags me-1"></i> Clinical Codes
                </button>
                <button class="tab-button" onclick="showClinicalTab('enhanced_{{ section_index }}', 'original')"
                        data-bs-toggle="tooltip" title="View original CDA XML content">
                    <i class="fa-solid fa-file-code me-1"></i> Original XML
                </button>
            </div>
            {% endif %}

            <!-- Rich Data View Tab -->
            <div id="enhanced_{{ section_index }}_structured" class="clinical-tab-content active">
                {% if section.structured_entries %}
                <div class="structured-entries">
                    <h6 class="text-primary mb-3">
                        <i class="fa-solid fa-database me-2"></i>
                        Structured Clinical Entries ({{ section.structured_entries|length }})
                    </h6>

                    {% for entry in section.structured_entries %}
                    <div class="clinical-entry mb-3 p-3 border rounded {% if entry.entry_type == 'observation' %}border-primary{% elif entry.entry_type == 'act' %}border-success{% elif entry.entry_type == 'procedure' %}border-warning{% elif entry.entry_type == 'substanceAdministration' %}border-info{% else %}border-secondary{% endif %}">
                        <!-- Entry Header with nullFlavor-aware display -->
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">
                                    {{ entry|safe_clinical_display:"display_name" }}
                                </h6>
                                {% if entry.entry_type %}
                                <span class="badge bg-secondary mb-2">{{ entry.entry_type|title }}</span>
                                {% endif %}
                            </div>
                            {% if entry.status_code %}
                            <span class="badge {% if entry.status_code == 'completed' %}bg-success{% elif entry.status_code == 'active' %}bg-primary{% elif entry.status_code == 'suspended' %}bg-warning{% else %}bg-secondary{% endif %}">
                                {{ entry.status_code|handle_null_flavor|title }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Entry Details with improved nullFlavor handling -->
                        <div class="entry-details">
                            {% if entry.effective_time %}
                            <div class="mb-2">
                                <strong><i class="fa-solid fa-calendar me-1 text-primary"></i>Effective Time:</strong>
                                <span class="text-muted">{{ entry.effective_time|format_clinical_value:"date" }}</span>
                            </div>
                            {% endif %}

                            {% if entry.participant_substances %}
                            <div class="mb-2">
                                <strong><i class="fa-solid fa-flask me-1 text-success"></i>Substances:</strong>
                                {% for substance in entry.participant_substances %}
                                <span class="badge bg-light text-dark me-1 mb-1">{{ substance|handle_null_flavor }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if entry.entry_relationships %}
                            <div class="mb-2">
                                <strong><i class="fa-solid fa-project-diagram me-1 text-warning"></i>Relationships:</strong>
                                <div class="ms-3">
                                    {% for relationship in entry.entry_relationships %}
                                    <div class="small text-muted">
                                        → {{ relationship.type|handle_null_flavor|title }}: {{ relationship.target|handle_null_flavor }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            {% if entry.dosage_instruction %}
                            <div class="mb-2">
                                <strong><i class="fa-solid fa-prescription-bottle me-1 text-info"></i>Dosage:</strong>
                                <span class="text-muted">{{ entry.dosage_instruction|handle_null_flavor }}</span>
                            </div>
                            {% endif %}

                            {% if entry.clinical_codes %}
                            <div class="clinical-codes-inline mt-2">
                                <strong><i class="fa-solid fa-barcode me-1"></i>Codes:</strong>
                                {% for code in entry.clinical_codes %}
                                <span class="coding-badge {% if 'snomed' in code.system|lower %}snomed{% elif 'loinc' in code.system|lower %}loinc{% elif 'icd' in code.system|lower %}icd{% else %}other-code{% endif %} me-1 mb-1">
                                    {{ code.code|handle_null_flavor }}
                                    {% if code.display %}
                                        <small>({{ code|format_clinical_value:"code"|truncatechars:30 }})</small>
                                    {% elif code.displayName %}
                                        <small>({{ code|format_clinical_value:"code"|truncatechars:30 }})</small>
                                    {% endif %}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Entry Value/Result with nullFlavor handling -->
                        {% if entry.value or entry.result %}
                        <div class="entry-value mt-2 p-2 bg-light rounded">
                            <strong><i class="fa-solid fa-chart-bar me-1"></i>Value/Result:</strong>
                            <span class="fw-bold">{{ entry|format_clinical_value:"numeric" }}</span>
                        </div>
                        {% endif %}

                        <!-- Entry Text Content with nullFlavor handling -->
                        {% if entry.text_content %}
                        <div class="entry-text mt-2">
                            <strong><i class="fa-solid fa-align-left me-1"></i>Description:</strong>
                            <div class="text-content p-2 bg-light rounded">
                                {{ entry.text_content|handle_null_flavor|truncatewords:50 }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    No structured entries available for this section.
                </div>
                {% endif %}
            </div>

            <!-- Clinical Codes Tab -->
            <div id="enhanced_{{ section_index }}_codes" class="clinical-tab-content">
                {% if section.clinical_codes %}
                <div class="clinical-codes-section">
                    <h6 class="text-primary mb-3">
                        <i class="fa-solid fa-tags me-2"></i>
                        Clinical Terminology & Coding Systems ({{ section.clinical_codes|length }})
                    </h6>

                    <!-- Coding System Statistics -->
                    <div class="coding-stats mb-4">
                        <div class="row">
                            {% if section.snomed_codes %}
                            <div class="col-md-4">
                                <div class="p-3 border rounded bg-success text-white">
                                    <i class="fa-solid fa-medical-kit me-2"></i>
                                    <strong>SNOMED CT:</strong> {{ section.snomed_codes|length }} codes
                                </div>
                            </div>
                            {% endif %}
                            {% if section.loinc_codes %}
                            <div class="col-md-4">
                                <div class="p-3 border rounded bg-primary text-white">
                                    <i class="fa-solid fa-flask me-2"></i>
                                    <strong>LOINC:</strong> {{ section.loinc_codes|length }} codes
                                </div>
                            </div>
                            {% endif %}
                            {% if section.icd_codes %}
                            <div class="col-md-4">
                                <div class="p-3 border rounded bg-warning text-dark">
                                    <i class="fa-solid fa-list-alt me-2"></i>
                                    <strong>ICD:</strong> {{ section.icd_codes|length }} codes
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- All Clinical Codes with nullFlavor handling -->
                    <div class="all-codes">
                        {% for code in section.clinical_codes %}
                        <div class="code-item mb-2 p-2 border rounded {% if 'snomed' in code.system|lower %}border-success bg-success bg-opacity-10{% elif 'loinc' in code.system|lower %}border-primary bg-primary bg-opacity-10{% elif 'icd' in code.system|lower %}border-warning bg-warning bg-opacity-10{% else %}border-secondary bg-light{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold">{{ code.code|handle_null_flavor }}</div>
                                    <div class="text-muted">{{ code|format_clinical_value:"code" }}</div>
                                </div>
                                <div class="text-end">
                                    <span class="coding-badge {% if 'snomed' in code.system|lower %}snomed{% elif 'loinc' in code.system|lower %}loinc{% elif 'icd' in code.system|lower %}icd{% else %}other-code{% endif %}">
                                        {{ code.system|handle_null_flavor|truncatechars:20 }}
                                    </span>
                                    {% if code.version %}
                                    <div><small class="text-muted">v{{ code.version|handle_null_flavor }}</small></div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fa-solid fa-exclamation-triangle me-2"></i>
                    No clinical codes available for this section.
                </div>
                {% endif %}
            </div>

            <!-- Original XML Tab -->
            <div id="enhanced_{{ section_index }}_original" class="clinical-tab-content">
                {% if section.narrative_text %}
                <div class="original-content">
                    <h6 class="text-primary mb-3">
                        <i class="fa-solid fa-file-code me-2"></i>
                        Original CDA Content
                    </h6>
                    <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                        <pre class="mb-0"><code>{{ section.narrative_text }}</code></pre>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    No original narrative text available for this section.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Enhanced CSS for clinical coding badges -->
<style>
.coding-badge {
    display: inline-block;
    padding: 0.25em 0.5em;
    font-size: 0.75em;
    font-weight: 600;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
}

.coding-badge.snomed {
    color: #fff;
    background-color: #28a745;
    border: 1px solid #28a745;
}

.coding-badge.loinc {
    color: #fff;
    background-color: #007bff;
    border: 1px solid #007bff;
}

.coding-badge.icd {
    color: #212529;
    background-color: #ffc107;
    border: 1px solid #ffc107;
}

.coding-badge.other-code {
    color: #fff;
    background-color: #6c757d;
    border: 1px solid #6c757d;
}

.clinical-entry {
    transition: all 0.3s ease;
}

.clinical-entry:hover {
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
}

.entry-details strong {
    color: #495057;
}

.clinical-metrics .badge {
    font-size: 0.7em;
}

.section-tabs .tab-button {
    position: relative;
}

.section-tabs .tab-button[data-bs-toggle="tooltip"] {
    cursor: help;
}
</style>
