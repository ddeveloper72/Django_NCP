{# Enhanced Allergies Section Template with Fallback Support #}
{# Handles both enhanced (allergy.data.allergen.display_value) and legacy (allergy.allergen) data structures #}

<div class="clinical-section allergies-section" id="allergies">
    {% with allergies_list=section_data %}
    
    {% if allergies_list %}
    <div class="section-header">
        <h3 class="section-title">
            <i class="fa-solid fa-exclamation-triangle me-2 text-warning"></i>
            Allergies & Intolerances
            <span class="badge bg-primary ms-2">{{ allergies_list|length }} Found</span>
        </h3>
    </div>

    <div class="allergies-content">
        <div class="allergies-list">
            {% for allergy in allergies_list %}
            <div class="allergy-card card mb-3">
                <div class="card-body">
                    
                    {# Main Allergy Header #}
                    <div class="allergy-header d-flex justify-content-between align-items-center mb-3">
                        <div class="allergen-info">
                            <h5 class="allergen-name mb-1">
                                <i class="fa-solid fa-triangle-exclamation me-2 text-warning"></i>
                                {# Enhanced allergen name with fallback #}
                                {% if allergy.data.allergen.display_value and allergy.data.allergen.display_value != "Unknown" %}
                                    {{ allergy.data.allergen.display_value }}
                                {% elif allergy.allergen %}
                                    {{ allergy.allergen }}
                                {% else %}
                                    Unknown Allergen
                                {% endif %}
                            </h5>
                            
                            {# Allergy Type/Category #}
                            {% if allergy.data.category.display_value or allergy.category %}
                            <div class="allergen-category">
                                <small class="text-muted">
                                    Category: 
                                    {% if allergy.data.category.display_value %}
                                        {{ allergy.data.category.display_value }}
                                    {% elif allergy.category %}
                                        {{ allergy.category }}
                                    {% endif %}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                        
                        {# Severity Badge #}
                        <div class="severity-badge">
                            {% if allergy.data.severity.display_value and allergy.data.severity.display_value != "Unknown" %}
                                {% if "High" in allergy.data.severity.display_value or "Severe" in allergy.data.severity.display_value %}
                                    <span class="badge bg-danger fs-6">{{ allergy.data.severity.display_value }}</span>
                                {% elif "Moderate" in allergy.data.severity.display_value %}
                                    <span class="badge bg-warning fs-6">{{ allergy.data.severity.display_value }}</span>
                                {% elif "Low" in allergy.data.severity.display_value or "Mild" in allergy.data.severity.display_value %}
                                    <span class="badge bg-success fs-6">{{ allergy.data.severity.display_value }}</span>
                                {% else %}
                                    <span class="badge bg-secondary fs-6">{{ allergy.data.severity.display_value }}</span>
                                {% endif %}
                            {% elif allergy.severity %}
                                <span class="badge bg-secondary fs-6">{{ allergy.severity }}</span>
                            {% else %}
                                <span class="badge bg-secondary fs-6">Unknown Severity</span>
                            {% endif %}
                        </div>
                    </div>

                    {# Clinical Information Grid #}
                    <div class="row g-3">
                        
                        {# Reaction Information #}
                        <div class="col-lg-6">
                            <div class="field-group">
                                <div class="field-header">
                                    <i class="fa-solid fa-stethoscope me-2 text-primary"></i>
                                    <span class="field-label">Reaction</span>
                                </div>
                                <div class="field-content">
                                    {% if allergy.data.reaction.display_value and allergy.data.reaction.display_value != "Not specified" %}
                                        <div class="field-value">{{ allergy.data.reaction.display_value }}</div>
                                    {% elif allergy.reaction %}
                                        <div class="field-value">{{ allergy.reaction }}</div>
                                    {% else %}
                                        <div class="field-value text-muted">Not specified</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {# Severity Details #}
                        <div class="col-lg-6">
                            <div class="field-group">
                                <div class="field-header">
                                    <i class="fa-solid fa-thermometer-half me-2 text-primary"></i>
                                    <span class="field-label">Severity Level</span>
                                </div>
                                <div class="field-content">
                                    {% if allergy.data.severity.display_value and allergy.data.severity.display_value != "Not specified" %}
                                        <div class="field-value">{{ allergy.data.severity.display_value }}</div>
                                    {% elif allergy.severity %}
                                        <div class="field-value">{{ allergy.severity }}</div>
                                    {% else %}
                                        <div class="field-value text-muted">Not specified</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {# Status Information #}
                        {% if allergy.status or allergy.data.status %}
                        <div class="col-lg-6">
                            <div class="field-group">
                                <div class="field-header">
                                    <i class="fa-solid fa-info-circle me-2 text-primary"></i>
                                    <span class="field-label">Status</span>
                                </div>
                                <div class="field-content">
                                    {% if allergy.data.status.display_value %}
                                        <div class="field-value">{{ allergy.data.status.display_value }}</div>
                                    {% elif allergy.status %}
                                        <div class="field-value">{{ allergy.status }}</div>
                                    {% else %}
                                        <div class="field-value text-muted">Active</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {# Date Information #}
                        {% if allergy.onset_date or allergy.data.onset_date %}
                        <div class="col-lg-6">
                            <div class="field-group">
                                <div class="field-header">
                                    <i class="fa-solid fa-calendar me-2 text-primary"></i>
                                    <span class="field-label">First Observed</span>
                                </div>
                                <div class="field-content">
                                    {% if allergy.data.onset_date.display_value %}
                                        <div class="field-value">{{ allergy.data.onset_date.display_value }}</div>
                                    {% elif allergy.onset_date %}
                                        <div class="field-value">{{ allergy.onset_date }}</div>
                                    {% else %}
                                        <div class="field-value text-muted">Not recorded</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {# Medical Codes Section #}
                    {% if allergy.codes or allergy.medical_codes %}
                    <div class="medical-codes-section mt-3 pt-3 border-top">
                        <div class="field-header mb-2">
                            <i class="fa-solid fa-code me-2 text-primary"></i>
                            <span class="field-label">Medical Codes</span>
                        </div>
                        <div class="medical-codes-container">
                            {% if allergy.codes %}
                                {% for code in allergy.codes %}
                                    <span class="medical-code me-2 mb-1" title="Medical Code: {{ code }}">{{ code }}</span>
                                {% endfor %}
                            {% elif allergy.medical_codes %}
                                {% for code in allergy.medical_codes %}
                                    <span class="medical-code me-2 mb-1" title="Medical Code: {{ code }}">{{ code }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {# Notes Section #}
                    {% if allergy.notes or allergy.comments or allergy.data.notes %}
                    <div class="notes-section mt-3 pt-3 border-top">
                        <div class="field-header mb-2">
                            <i class="fa-solid fa-sticky-note me-2 text-primary"></i>
                            <span class="field-label">Notes</span>
                        </div>
                        <div class="notes-content">
                            {% if allergy.data.notes.display_value %}
                                <div class="field-value text-muted">{{ allergy.data.notes.display_value }}</div>
                            {% elif allergy.notes %}
                                <div class="field-value text-muted">{{ allergy.notes }}</div>
                            {% elif allergy.comments %}
                                <div class="field-value text-muted">{{ allergy.comments }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    {% else %}
    {# Empty State - No Allergies #}
    <div class="clinical-section">
        <div class="empty-clinical-state text-center p-5">
            <i class="fa-solid fa-exclamation-triangle fa-4x text-muted mb-4"></i>
            <h4 class="text-muted mb-3">No Allergies Recorded</h4>
            <p class="text-muted mb-0">No allergies or intolerances have been reported for this patient.</p>
        </div>
    </div>
    {% endif %}
    
    {% endwith %}
</div>