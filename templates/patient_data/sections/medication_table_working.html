{% load patient_filters %}
{% load medication_filters %}
{# Working Medication Table Template - Based on successful main branch pattern #}

<div class="clinical-section">
    <div class="collapsible-wrapper">
        <input id="toggle-medications" class="toggle-input" type="checkbox" checked>
        <label for="toggle-medications" class="collapsible-label-title">
            <div class="clinical-section-title-row">
                <div class="clinical-section-title">
                    <i class="fa-solid fa-pills me-2"></i>
                    <span>Medications</span>
                </div>
                <div class="clinical-badge-container">
                    <span class="clinical-badge populated">{{ section_data|length }} Found</span>
                </div>
            </div>
            <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
        </label>
        <div class="collapsible-content-title">
            <div class="content-inner-title">
                <p class="mb-3 text-muted">Medications: {{ section_data|length }} items found</p>
                
                {# Professional Medications Table #}
                <div class="medications-table-container bg-white border rounded-3 shadow-sm overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 medications-table">
                            <thead class="table-primary">
                                <tr>
                                    <th scope="col" class="fw-bold">
                                        <i class="fa-solid fa-pills me-2"></i>Medication Name
                                    </th>
                                    <th scope="col" class="fw-bold">
                                        <i class="fa-solid fa-flask me-2"></i>Active Ingredient
                                    </th>
                                    <th scope="col" class="fw-bold">
                                        <i class="fa-solid fa-capsules me-2"></i>Form
                                    </th>
                                    <th scope="col" class="fw-bold">
                                        <i class="fa-solid fa-balance-scale me-2"></i>Dosage
                                    </th>
                                    <th scope="col" class="fw-bold">
                                        <i class="fa-solid fa-route me-2"></i>Route
                                    </th>
                                    <th scope="col" class="fw-bold">
                                        <i class="fa-solid fa-clock me-2"></i>Frequency
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for med in section_data %}
                                <tr class="medication-row">
                                    {# Medication Name Column #}
                                    <td class="medication-name-cell">
                                        <div class="medication-name-container">
                                            <div class="medication-title fw-bold text-primary mb-1">
                                                {% if med.medication_name %}
                                                    {{ med.medication_name }}
                                                {% elif med.name %}
                                                    {{ med.name }}
                                                {% elif med.display_name %}
                                                    {{ med.display_name }}
                                                {% elif med.medication.name %}
                                                    {{ med.medication.name }}
                                                {% else %}
                                                    Medication
                                                {% endif %}
                                            </div>
                                            {% if med.active_ingredients %}
                                                <div class="medication-code text-muted small">
                                                    <i class="fa-solid fa-barcode me-1"></i>
                                                    Ingredient: {{ med.active_ingredients.coded|default:med.active_ingredients }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    
                                    {# Active Ingredient Column - Enhanced to bypass fallbacks #}
                                    <td class="ingredient-cell">
                                        {% if med.active_ingredients and "Not specified" not in med.active_ingredients %}
                                            <span class="badge bg-success text-wrap fw-normal">{{ med.active_ingredients }}</span>
                                        {% elif med.data.ingredient_display and "Not specified" not in med.data.ingredient_display %}
                                            <span class="badge bg-success text-wrap fw-normal">{{ med.data.ingredient_display }}</span>
                                        {% elif med.active_ingredients.translated %}
                                            <span class="badge bg-success text-wrap fw-normal">{{ med.active_ingredients.translated }}</span>
                                        {% elif med.active_ingredients.coded %}
                                            <span class="badge bg-success text-wrap fw-normal">{{ med.active_ingredients.coded }}</span>
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </td>
                                    
                                    {# Pharmaceutical Form Column #}
                                    <td class="form-cell">
                                        {% if med.pharmaceutical_form and "Not specified" not in med.pharmaceutical_form %}
                                            <span class="badge bg-info text-wrap fw-normal">{{ med.pharmaceutical_form }}</span>
                                        {% elif med.data.pharmaceutical_form and "Not specified" not in med.data.pharmaceutical_form %}
                                            <span class="badge bg-info text-wrap fw-normal">{{ med.data.pharmaceutical_form }}</span>
                                        {% elif med.pharmaceutical_form.display_value %}
                                            <span class="badge bg-info text-wrap fw-normal">{{ med.pharmaceutical_form.display_value }}</span>
                                        {% elif med.pharmaceutical_form.value %}
                                            <span class="badge bg-info text-wrap fw-normal">{{ med.pharmaceutical_form.value }}</span>
                                        {% elif med.pharmaceutical_form.translated %}
                                            <span class="badge bg-info text-wrap fw-normal">{{ med.pharmaceutical_form.translated }}</span>
                                        {% elif med.pharmaceutical_form.coded %}
                                            <span class="badge bg-info text-wrap fw-normal">{{ med.pharmaceutical_form.coded }}</span>
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </td>
                                    
                                    {# Dosage Column - Enhanced to detect actual enhanced data #}
                                    <td class="dosage-cell">
                                        {% if med.dose_quantity and "Dose not specified" not in med.dose_quantity %}
                                            <span class="fw-bold text-success">{{ med.dose_quantity }}</span>
                                        {% elif med.data.dose_quantity and "Dose not specified" not in med.data.dose_quantity %}
                                            <span class="fw-bold text-success">{{ med.data.dose_quantity }}</span>
                                        {% elif med.dose_quantity.display_value %}
                                            <span class="fw-bold text-success">{{ med.dose_quantity.display_value }}</span>
                                        {% elif med.dose_quantity.value %}
                                            <span class="fw-bold text-success">{{ med.dose_quantity.value }}</span>
                                        {% elif med.dose.value %}
                                            <span class="fw-bold text-success">{{ med.dose.value }} {{ med.dose.unit|default:"" }}</span>
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </td>
                                    
                                    {# Administration Route Column - Enhanced to detect actual enhanced data #}
                                    <td class="route-cell">
                                        {% if med.route and "Administration route not specified" not in med.route %}
                                            <span class="badge bg-warning text-dark fw-normal">{{ med.route }}</span>
                                        {% elif med.data.route and "Administration route not specified" not in med.data.route %}
                                            <span class="badge bg-warning text-dark fw-normal">{{ med.data.route }}</span>
                                        {% elif med.data.route_display and "NOT_FOUND" not in med.data.route_display %}
                                            <span class="badge bg-warning text-dark fw-normal">{{ med.data.route_display }}</span>
                                        {% elif med.route.display_value %}
                                            <span class="badge bg-warning text-dark fw-normal">{{ med.route.display_value }}</span>
                                        {% elif med.route.value %}
                                            <span class="badge bg-warning text-dark fw-normal">{{ med.route.value }}</span>
                                        {% elif med.route.displayName %}
                                            <span class="badge bg-warning text-dark fw-normal">{{ med.route.displayName }}</span>
                                        {% elif med.route.translated %}
                                            <span class="badge bg-warning text-dark fw-normal">{{ med.route.translated }}</span>
                                        {% elif med.route.coded %}
                                            <span class="badge bg-warning text-dark fw-normal">{{ med.route.coded }}</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark fw-normal">Not specified</span>
                                        {% endif %}
                                    </td>
                                    
                                    {# Frequency Column - Enhanced to detect actual enhanced data #}
                                    <td class="frequency-cell">
                                        {% if med.schedule and "Schedule not specified" not in med.schedule %}
                                            <span class="badge bg-secondary text-wrap fw-normal">{{ med.schedule }}</span>
                                        {% elif med.data.schedule and "Schedule not specified" not in med.data.schedule %}
                                            <span class="badge bg-secondary text-wrap fw-normal">{{ med.data.schedule }}</span>
                                        {% elif med.frequency and "NOT_FOUND" not in med.frequency %}
                                            <span class="badge bg-secondary text-wrap fw-normal">{{ med.frequency }}</span>
                                        {% elif med.data.frequency_display and "NOT_FOUND" not in med.data.frequency_display %}
                                            <span class="badge bg-secondary text-wrap fw-normal">{{ med.data.frequency_display }}</span>
                                        {% elif med.schedule.display_value %}
                                            <span class="badge bg-secondary text-wrap fw-normal">{{ med.schedule.display_value }}</span>
                                        {% elif med.schedule.value %}
                                            <span class="badge bg-secondary text-wrap fw-normal">{{ med.schedule.value }}</span>
                                        {% elif med.schedule.translated %}
                                            <span class="badge bg-secondary text-wrap fw-normal">{{ med.schedule.translated }}</span>
                                        {% elif med.schedule.coded %}
                                            <span class="badge bg-secondary text-wrap fw-normal">{{ med.schedule.coded }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary text-wrap fw-normal">Not specified</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>