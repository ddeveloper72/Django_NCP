{% extends 'patient_data/sections/base_clinical_section.html' %}
{% load patient_filters %}

{% block section_content %}
{# Procedures Section Template - Enhanced Pipeline Data #}

{% if section_data %}
    {% for procedure in section_data %}
    <div class="field-group">
        <div class="field-group-header">
            <div class="field-primary">
                <i class="fas fa-user-md me-2" style="color: var(--primary-color);"></i>
                <span class="field-title">{{ procedure.display_name|default:procedure.name|default:"Procedure" }}</span>
                {% if procedure.status %}
                <span class="clinical-badge status-{{ procedure.status|slugify }}">{{ procedure.status }}</span>
                {% endif %}
            </div>
        </div>
        
        <div class="field-group-content">
            {% if procedure.description %}
            <div class="field-row">
                <div class="field-label">
                    <i class="fas fa-info-circle me-1"></i>
                    Description
                </div>
                <div class="field-value">{{ procedure.description }}</div>
            </div>
            {% endif %}
            
            {% if procedure.date %}
            <div class="field-row">
                <div class="field-label">
                    <i class="fas fa-calendar me-1"></i>
                    Date
                </div>
                <div class="field-value">{{ procedure.date }}</div>
            </div>
            {% endif %}
            
            {% if procedure.target_site or procedure.location %}
            <div class="field-row">
                <div class="field-label">
                    <i class="fas fa-location-dot me-1"></i>
                    {% if procedure.target_site %}Target Site{% else %}Location{% endif %}
                </div>
                <div class="field-value">
                    {{ procedure.target_site|default:procedure.location }}
                    {% if procedure.laterality %}
                    <span class="badge bg-info ms-2">{{ procedure.laterality }}</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% if procedure.provider and procedure.provider != "Not specified" %}
            <div class="field-row">
                <div class="field-label">
                    <i class="fas fa-user-doctor me-1"></i>
                    Performer
                </div>
                <div class="field-value">{{ procedure.provider }}</div>
            </div>
            {% endif %}
            
            {% if procedure.procedure_code or procedure.code_system %}
            <div class="field-row">
                <div class="field-label">
                    <i class="fas fa-code me-1"></i>
                    Code
                </div>
                <div class="field-value">
                    {% if procedure.procedure_code %}
                    <span class="medical-code">{{ procedure.procedure_code }}</span>
                    {% if procedure.code_system %}
                    <span class="text-muted ms-1">({{ procedure.code_system }})</span>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if procedure.template_id or procedure.procedure_id %}
            <div class="field-row">
                <div class="field-label">
                    <i class="fas fa-id-card me-1"></i>
                    Technical Info
                </div>
                <div class="field-value">
                    {% if procedure.template_id %}
                    <div class="small text-muted">Template: <code>{{ procedure.template_id }}</code></div>
                    {% endif %}
                    {% if procedure.procedure_id %}
                    <div class="small text-muted">ID: <code>{{ procedure.procedure_id }}</code></div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="no-data-message">
        <i class="fas fa-user-md me-2"></i>
        No procedure information available
    </div>
{% endif %}
{% endblock %}
                                <div class="field-value">
                                    <span class="text-secondary">{{ procedure.date|default:procedure.effective_time|date:"M d, Y" }}</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if procedure.performer or procedure.provider %}
                            <div class="clinical-field mb-2">
                                <div class="field-label">
                                    <strong class="text-muted small">Performer</strong>
                                    <i class="fa-solid fa-user-doctor ms-1 terminology-indicator text-muted" title="Performing Provider"></i>
                                </div>
                                <div class="field-value">
                                    <span class="text-secondary">{{ procedure.performer|default:procedure.provider }}</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if procedure.location %}
                            <div class="clinical-field mb-2">
                                <div class="field-label">
                                    <strong class="text-muted small">Location</strong>
                                    <i class="fa-solid fa-location-dot ms-1 terminology-indicator text-muted" title="Location"></i>
                                </div>
                                <div class="field-value">
                                    <span class="text-secondary">{{ procedure.location }}</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if procedure.notes or procedure.description %}
                            <div class="clinical-field">
                                <div class="field-label">
                                    <strong class="text-muted small">Notes</strong>
                                    <i class="fa-solid fa-note-sticky ms-1 terminology-indicator text-muted" title="Notes"></i>
                                </div>
                                <div class="field-value">
                                    <small class="text-muted">{{ procedure.notes|default:procedure.description }}</small>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {# Desktop Table Layout for Procedures #}
            <div class="d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover clinical-table-desktop">
                        <thead class="table-info">
                            <tr>
                                <th scope="col">
                                    <i class="fa-solid fa-user-md me-1"></i>Procedure
                                </th>
                                <th scope="col">
                                    <i class="fa-solid fa-check-circle me-1"></i>Status
                                </th>
                                <th scope="col">
                                    <i class="fa-solid fa-calendar me-1"></i>Date
                                </th>
                                <th scope="col">
                                    <i class="fa-solid fa-user-doctor me-1"></i>Performer
                                </th>
                                <th scope="col">
                                    <i class="fa-solid fa-location-dot me-1"></i>Location
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for procedure in section_entries %}
                            <tr>
                                <td>
                                    <div class="procedure-info">
                                        <strong>{{ procedure.name|default:procedure.display_name|default:procedure.procedure_name|default:"Procedure" }}</strong>
                                        {% if procedure.code %}
                                        <div class="medical-terminology">
                                            <span class="terminology-display">
                                                <span class="terminology-code">{{ procedure.code }}</span>
                                                <span class="terminology-system text-muted">{{ procedure.coding_system|default:"" }}</span>
                                            </span>
                                        </div>
                                        {% endif %}
                                        {% if procedure.notes or procedure.description %}
                                        <div class="text-muted small">{{ procedure.notes|default:procedure.description|truncatewords:15 }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if procedure.status %}
                                    <span class="status-badge status-{{ procedure.status|lower }}">{{ procedure.status|title }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if procedure.date or procedure.effective_time %}
                                    <span class="text-secondary">{{ procedure.date|default:procedure.effective_time|date:"M d, Y" }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if procedure.performer or procedure.provider %}
                                    <span class="text-secondary">{{ procedure.performer|default:procedure.provider }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if procedure.location %}
                                    <span class="text-secondary">{{ procedure.location }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        {# No procedures data available #}
        <div class="alert alert-info">
            <h6><i class="fa-solid fa-info-circle me-2"></i>No Procedures Available</h6>
            <p class="mb-0">No procedure information was found for this patient.</p>
        </div>
    {% endif %}
</div>