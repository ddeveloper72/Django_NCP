<!-- Extended Patient Information Main Component -->
{% if patient_extended_data %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card extended-patient-info">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">
                    <i class="fas fa-address-book me-2"></i>
                    Extended Patient Information
                </h4>
            </div>
            <div class="card-body">

                <!-- DEBUG: Show what data is available -->
                <div class="alert alert-info mb-3">
                    <h6><i class="fas fa-bug me-2"></i>DEBUG: Available Extended Data</h6>
                    <p><strong>Data Keys:</strong> 
                        {% for key, value in patient_extended_data.items %}{{ key }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </p>
                    {% if patient_extended_data.patient_contact %}
                    <p><strong>Patient Contact Keys:</strong> 
                        {% for key, value in patient_extended_data.patient_contact.items %}{{ key }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </p>
                    {% endif %}
                    {% if patient_extended_data.healthcare_team %}
                    <p><strong>Healthcare Team Keys:</strong> 
                        {% for key, value in patient_extended_data.healthcare_team.items %}{{ key }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </p>
                    {% endif %}
                    {% if patient_extended_data.document_info %}
                    <p><strong>Document Info Keys:</strong> 
                        {% for key, value in patient_extended_data.document_info.items %}{{ key }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </p>
                    {% endif %}
                </div>

                <!-- Extended Info Navigation Tabs -->
                <ul class="nav nav-tabs" id="extendedInfoTabs" role="tablist">
                    <!-- Contact Details Tab -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if first_tab == 'contact' %}active{% endif %}" id="contact-tab"
                            data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab"
                            aria-controls="contact" {% if first_tab == 'contact' %}aria-selected="true"{% else %}aria-selected="false"{% endif %}>
                            <i class="fas fa-address-card me-1"></i>Contact Details
                            {% if contact_tab_available %}
                            <span class="badge bg-primary ms-1">1</span>
                            {% endif %}
                        </button>
                    </li>

                    <!-- Healthcare Team Tab -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if first_tab == 'healthcare' %}active{% endif %}" id="healthcare-tab"
                            data-bs-toggle="tab" data-bs-target="#healthcare" type="button" role="tab"
                            aria-controls="healthcare" {% if first_tab == 'healthcare' %}aria-selected="true"{% else %}aria-selected="false"{% endif %}>
                            <i class="fas fa-stethoscope me-1"></i>Healthcare Team
                            {% if healthcare_tab_available %}
                            <span class="badge bg-success ms-1">
                                {% set team_count = 0 %}
                                {% if patient_extended_data.get('authors') %}{% set team_count = team_count +
                                patient_extended_data.authors|length %}{% endif %}
                                {% if patient_extended_data.get('legal_authenticator') %}{% set team_count =
                                team_count + 1 %}{% endif %}
                                {% if patient_extended_data.get('custodian') %}{% set team_count = team_count + 1
                                %}{% endif %}
                                {{ team_count }}
                            </span>
                            {% endif %}
                        </button>
                    </li>

                    <!-- Document Info Tab -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if first_tab == 'document' %}active{% endif %}" id="document-tab"
                            data-bs-toggle="tab" data-bs-target="#document" type="button" role="tab"
                            aria-controls="document" {% if first_tab == 'document' %}aria-selected="true"{% else %}aria-selected="false"{% endif %}>
                            <i class="fas fa-file-medical-alt me-1"></i>Document Info
                        </button>
                    </li>
                </ul>

                <!-- Extended Info Tab Content -->
                <div class="tab-content mt-3" id="extendedInfoTabContent">

                    {% set tabs_available = [] %}
                    {% set contact_tab_available = patient_extended_data and (
                    patient_extended_data.get('patient_contact') or
                    patient_extended_data.get('contact_info')
                    ) %}
                    {% set healthcare_tab_available = patient_extended_data and (
                    patient_extended_data.get('healthcare_team') or
                    patient_extended_data.get('authors') or
                    patient_extended_data.get('legal_authenticator') or
                    patient_extended_data.get('custodian')
                    ) %}
                    {% set document_tab_available = patient_extended_data and (
                    patient_extended_data.get('document_info') or
                    patient_extended_data.get('metadata')
                    ) %}

                    {% if contact_tab_available %}{% set tabs_available = tabs_available + ['contact'] %}{% endif %}
                    {% if healthcare_tab_available %}{% set tabs_available = tabs_available + ['healthcare'] %}{%
                    endif %}
                    {% if document_tab_available %}{% set tabs_available = tabs_available + ['document'] %}{% endif
                    %}

                    {% set first_tab = tabs_available[0] if tabs_available else 'contact' %}

                    <!-- Include Child Components with Error Handling -->
                    {% include 'patient_data/components/extended_patient_contact.html' %}

                    {% include 'patient_data/components/extended_patient_healthcare.html' %}

                    {% include 'patient_data/components/extended_patient_document.html' %}

                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- No Extended Data Available -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <h6><i class="fas fa-info-circle me-2"></i>Extended Patient Information</h6>
            <p>No extended patient data available for this patient. The system attempted to extract extended information
                from the CDA document but none was found.</p>
            <p><strong>Debug Info:</strong> patient_extended_data = {{ patient_extended_data }}</p>
        </div>
    </div>
</div>
{% endif %}