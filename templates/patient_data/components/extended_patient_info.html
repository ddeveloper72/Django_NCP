<!-- Extended Patient Information Main Component -->
{% load patient_filters %}
{% if patient_extended_data or administrative_data or contact_data or healthcare_data %}

<!-- Clinical-style Tab Navigation -->
<div class="clinical-section" id="extendedPatientSection">
    <!-- Tab Navigation Buttons -->
    <div class="tab-navigation mb-3">
        <button class="tab-button active" onclick="showExtendedTab('extended_patient', 'personal')"
                type="button">
            <i class="fas fa-user me-1"></i>Personal Information
            {% if contact_data and contact_data.addresses or contact_data.telecoms %}
            <span class="badge bg-primary ms-2">
                {{ contact_data.addresses|length|add:contact_data.telecoms|length }}
            </span>
            {% endif %}
        </button>

        <button class="tab-button" onclick="showExtendedTab('extended_patient', 'healthcare')"
                type="button">
            <i class="fas fa-stethoscope me-1"></i>Healthcare Team
            {% if healthcare_data %}
            <span class="badge bg-success ms-2">
                {% if healthcare_data.author_hcp %}1{% endif %}{% if healthcare_data.organization %}{% if healthcare_data.author_hcp %}+{% endif %}1{% endif %}{% if healthcare_data.legal_authenticator %}{% if healthcare_data.author_hcp or healthcare_data.organization %}+{% endif %}1{% endif %}
            </span>
            {% endif %}
        </button>

        <button class="tab-button" onclick="showExtendedTab('extended_patient', 'system')"
                type="button">
            <i class="fas fa-server me-1"></i>System & Documentation
            <span class="badge bg-info ms-2">3</span>
        </button>

        <button class="tab-button" onclick="showExtendedTab('extended_patient', 'clinical')"
                type="button">
            <i class="fas fa-notes-medical me-1"></i>Clinical Information
            {% if medications or allergies or problems or vital_signs or procedures %}
            <span class="badge bg-warning ms-2">
                {% with total_clinical=medications|length|add:allergies|length|add:problems|length|add:vital_signs|length|add:procedures|length %}
                {{ total_clinical }}
                {% endwith %}
            </span>
            {% endif %}
        </button>
    </div>

    <!-- Tab Content Containers -->
    <div class="extended-tab-content-container">

    <!-- Personal Information Tab Content -->
    <div class="clinical-tab-content active" id="extended_patient_personal">
        <div class="row g-3">
            <!-- Patient Contact Information Card -->
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-address-book me-2"></i>Contact Information
                        </h5>
                    </div>
                    <div class="card-body">
                        {% include 'patient_data/components/extended_patient_contact_clean.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Healthcare Team Tab Content -->
    <div class="clinical-tab-content" id="extended_patient_healthcare">
        <div class="row g-3">
            <!-- Healthcare Provider Information Card -->
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-md me-2"></i>Healthcare Provider Information
                        </h5>
                    </div>
                    <div class="card-body">
                        {% include 'patient_data/components/extended_patient_healthcare_clean.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System & Documentation Tab Content -->
    <div class="clinical-tab-content" id="extended_patient_system">
        <div class="row g-3">
            <!-- Administrative Information Card -->
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>Administrative & System Information
                        </h5>
                    </div>
                    <div class="card-body">
                        {% include 'patient_data/components/extended_patient_document_clean.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clinical Information Tab Content -->
    <div class="clinical-tab-content" id="extended_patient_clinical">
        <!-- Direct Clinical Content - No Wrapper Card -->
        {% include 'patient_data/components/clinical_information_content.html' %}
    </div>
</div> <!-- End Clinical Section -->

<script>
// Extended Patient Tab Management Function
function showExtendedTab(sectionId, tabType) {
    console.log('ðŸŽ¯ Switching Extended Patient tab:', sectionId, tabType);

    // Hide all tab contents for the extended patient section
    const personalTab = document.getElementById(sectionId + '_personal');
    const healthcareTab = document.getElementById(sectionId + '_healthcare');
    const systemTab = document.getElementById(sectionId + '_system');
    const clinicalTab = document.getElementById(sectionId + '_clinical');

    // Find the parent extended patient container
    const extendedContainer = personalTab ? personalTab.closest('.clinical-section') :
        (healthcareTab ? healthcareTab.closest('.clinical-section') :
        (systemTab ? systemTab.closest('.clinical-section') :
        (clinicalTab ? clinicalTab.closest('.clinical-section') : null)));

    if (!extendedContainer) {
        console.error('âŒ Extended patient container not found for:', sectionId);
        return;
    }

    const buttons = extendedContainer.querySelectorAll('.tab-button');
    const allTabs = [personalTab, healthcareTab, systemTab, clinicalTab].filter(tab => tab !== null);

    // Remove active class and hide all tabs
    allTabs.forEach(tab => {
        if (tab) {
            tab.classList.remove('active');
            tab.style.display = 'none';
        }
    });

    // Remove active class from all buttons
    buttons.forEach(btn => btn.classList.remove('active'));

    // Show selected tab and activate corresponding button
    let activeTab = null;
    let activeButtonIndex = -1;

    if (tabType === 'personal' && personalTab) {
        activeTab = personalTab;
        activeButtonIndex = 0;
    } else if (tabType === 'healthcare' && healthcareTab) {
        activeTab = healthcareTab;
        activeButtonIndex = 1;
    } else if (tabType === 'system' && systemTab) {
        activeTab = systemTab;
        activeButtonIndex = 2;
    } else if (tabType === 'clinical' && clinicalTab) {
        activeTab = clinicalTab;
        activeButtonIndex = 3;
    }

    if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.display = 'block';
        console.log('âœ… Activated tab:', activeTab.id);
    }

    if (activeButtonIndex >= 0 && buttons[activeButtonIndex]) {
        buttons[activeButtonIndex].classList.add('active');
        console.log('âœ… Activated button:', activeButtonIndex);
    }

    console.log('âœ… Extended patient tab switch completed:', sectionId, tabType);
}

// Initialize Extended Patient Tabs on load
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸŽ¯ Initializing Extended Patient tabs...');

    // Ensure the first tab is properly displayed
    setTimeout(() => {
        const firstPersonalTab = document.getElementById('extended_patient_personal');
        if (firstPersonalTab && !firstPersonalTab.classList.contains('active')) {
            console.log('ðŸ”§ Auto-activating first tab...');
            showExtendedTab('extended_patient', 'personal');
        }
    }, 100);
});
</script>

{% else %}
<!-- No Extended Data Available -->
<div class="alert alert-info">
    <h6><i class="fas fa-info-circle me-2"></i>Extended Patient Information</h6>
    <p class="mb-0">Extended patient information is not available for this document. The system was unable to extract additional patient data from the CDA content.</p>
</div>
{% endif %}
