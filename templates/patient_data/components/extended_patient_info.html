{# Extended Patient Information Main Component #}
{% load patient_filters %}
{% if patient_extended_data or administrative_data or contact_data or healthcare_data %}

{# Clinical-style Tab Navigation #}
<div class="clinical-section" id="extendedPatientSection" data-patient-id="{{ patient_id|default:'' }}">
    <!-- Tab Navigation Buttons -->
    <div class="tab-navigation mb-3">
        <button class="tab-button active" data-action="show-extended-tab" data-section-id="extended_patient" data-tab-type="personal"
                type="button">
            <i class="fa-solid fa-user me-1"></i>Personal Information
            {# Show badge if any contact information exists #}
            {% if contact_data.addresses or contact_data.telecoms or administrative_data.patient_contact_info.addresses or administrative_data.patient_contact_info.telecoms or administrative_data.guardian.contact_info.addresses or administrative_data.guardian.contact_info.telecoms or administrative_data.other_contacts %}
            <span class="badge bg-primary ms-2">
                {# Calculate contact count: primary + admin + guardian + other contacts #}
                {% with primary_count=contact_data.addresses|length|add:contact_data.telecoms|length %}
                {% with admin_count=administrative_data.patient_contact_info.addresses|length|add:administrative_data.patient_contact_info.telecoms|length %}
                {% with guardian_count=administrative_data.guardian.contact_info.addresses|length|add:administrative_data.guardian.contact_info.telecoms|length %}
                {% with other_contacts_count=administrative_data.other_contacts|length %}
                    {# Each other contact typically has 1-2 contact methods (address + phone), so multiply by 2 as estimate #}
                    {{ primary_count|add:admin_count|add:guardian_count|add:other_contacts_count|add:other_contacts_count }}
                {% endwith %}
                {% endwith %}
                {% endwith %}
                {% endwith %}
            </span>
            {% endif %}
        </button>

        <button class="tab-button" data-action="show-extended-tab" data-section-id="extended_patient" data-tab-type="healthcare"
                type="button">
            <i class="fa-solid fa-stethoscope me-1"></i>Healthcare Team
            {% if healthcare_data %}
            <span class="badge bg-success ms-2">1</span>
            {% endif %}
        </button>

        <button class="tab-button" data-action="show-extended-tab" data-section-id="extended_patient" data-tab-type="system"
                type="button">
            <i class="fa-solid fa-server me-1"></i>System & Documentation
            <span class="badge bg-warning ms-2">3</span>
        </button>

        <button id="clinical-tab-btn" class="tab-button{% if has_l1_cda and not has_l3_cda or not processed_sections or processed_sections|length == 0 %} text-muted{% endif %}"
                data-action="show-extended-tab"
                data-section-id="extended_patient"
                data-tab-type="clinical"
                {% if has_l1_cda and not has_l3_cda %}data-disabled="true" data-reason="Clinical data not available for L1 CDA documents"{% elif not processed_sections or processed_sections|length == 0 %}data-disabled="true" data-reason="No structured clinical data available"{% endif %}
                type="button"
                {% if has_l1_cda and not has_l3_cda %}disabled title="Clinical data not available for L1 CDA documents"{% elif not processed_sections or processed_sections|length == 0 %}disabled title="No structured clinical data available"{% endif %}>
            <i class="fa-solid fa-notes-medical me-1"></i>Clinical Information
            {% if medications or allergies or problems or vital_signs or procedures %}
            <span class="badge bg-warning ms-2">
                {% with total_clinical=medications|length|add:allergies|length|add:problems|length|add:vital_signs|length|add:procedures|length %}
                {{ total_clinical }}
                {% endwith %}
            </span>
            {% elif processed_sections and processed_sections|length > 0 %}
            <span class="badge bg-info ms-2">{{ processed_sections|length }}</span>
            {% else %}
            <span class="badge bg-secondary ms-2">0</span>
            {% endif %}
        </button>

        <button id="pdf-tab-btn" class="tab-button{% if has_l3_cda and not has_embedded_pdfs %} text-muted{% endif %}"
                data-action="show-extended-tab"
                data-section-id="extended_patient"
                data-tab-type="pdfs"
                {% if has_l3_cda and not has_embedded_pdfs %}data-disabled="true" data-reason="No PDF documents available for this L3 CDA"{% elif not has_embedded_pdfs %}data-disabled="true" data-reason="No PDF documents available"{% endif %}
                type="button"
                {% if has_l3_cda and not has_embedded_pdfs %}disabled title="No PDF documents available for this L3 CDA"{% elif not has_embedded_pdfs %}disabled title="No PDF documents available"{% endif %}>
            <i class="fa-solid fa-file-pdf me-1"></i>PDF Documents
            {% if has_embedded_pdfs %}
            <span class="badge bg-healthcare-teal ms-2">{{ embedded_pdfs|length }}</span>
            {% else %}
            <span class="badge bg-secondary ms-2">0</span>
            {% endif %}
        </button>
    </div>

    {# Tab Content Containers #}
    <div class="extended-tab-content-container clinical-tabs-container">

    {# Personal Information Tab Content #}
    <div class="clinical-tab-content active" id="extended_patient_personal">
        {# Direct inclusion of contact component with its responsive card grid #}
        {% include 'patient_data/components/extended_patient_contact_clean.html' %}
    </div>

    {# Healthcare Team Tab Content #}
    <div class="clinical-tab-content" id="extended_patient_healthcare">
        <div class="row g-3">
            {# Healthcare Provider Information Card #}
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fa-solid fa-user-md me-2"></i>Healthcare Provider Information
                        </h5>
                    </div>
                    <div class="card-body">
                        {% include 'patient_data/components/extended_patient_healthcare_clean.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# System & Documentation Tab Content #}
    <div class="clinical-tab-content" id="extended_patient_system">
        <div class="row g-3">
            {# Administrative Information Card #}
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fa-solid fa-cogs me-2"></i>Administrative & System Information
                        </h5>
                    </div>
                    <div class="card-body">
                        {% include 'patient_data/components/extended_patient_document_clean.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Clinical Information Tab Content #}
    <div class="clinical-tab-content" id="extended_patient_clinical">
        {# Direct Clinical Content - No Wrapper Card #}
        {% include 'patient_data/components/clinical_information_content.html' %}
    </div>

    {# PDF Documents Tab Content #}
    <div class="clinical-tab-content" id="extended_patient_pdfs">
        <div class="row g-3">
            {# PDF Documents Card #}
            <div class="col-12">
                <div class="card border-healthcare-teal">
                    <div class="card-header bg-healthcare-teal text-white">
                        <h5 class="mb-0">
                            <i class="fa-solid fa-file-pdf me-2"></i>Embedded PDF Documents
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if has_embedded_pdfs and embedded_pdfs %}
                        <p class="text-muted mb-3">
                            <i class="fa-solid fa-info-circle me-1"></i>
                            This L1 CDA document contains {{ embedded_pdfs|length }} embedded PDF document{{ embedded_pdfs|length|pluralize }}.
                            These are the original clinical documents from the source healthcare system.
                        </p>

                        {% for pdf in embedded_pdfs %}
                        <div class="pdf-document-item mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fa-solid fa-file-pdf text-healthcare-teal me-2"></i>
                                        {{ pdf.filename|default:"Clinical Document" }}
                                    </h6>
                                    <small class="text-muted">
                                        Size: {{ pdf.size|filesizeformat|default:"Unknown" }}
                                        {% if pdf.media_type %} | Type: {{ pdf.media_type }}{% endif %}
                                    </small>
                                </div>
                                <div>
                                    {% if pdf.content_base64 %}
                                    <a href="{% url 'patient_data:download_pdf' patient_id=patient_id pdf_index=forloop.counter0 %}"
                                       download="{{ pdf.filename|default:'clinical_document.pdf' }}"
                                       class="btn btn-sm btn-outline-primary me-2">
                                        <i class="fa-solid fa-download me-1"></i>Download
                                    </a>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-primary"
                                            data-action="show-pdf-viewer" data-pdf-index="{{ forloop.counter0 }}">
                                        <i class="fa-solid fa-eye me-1"></i>View
                                    </button>
                                </div>
                            </div>

                            {# PDF Viewer Container (initially hidden) #}
                            <div id="pdf-viewer-{{ forloop.counter0 }}" class="pdf-viewer-container mt-3 hidden">
                                <div class="border rounded pdf-viewer-background">
                                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                        <span class="text-muted">
                                            <i class="fa-solid fa-file-pdf text-healthcare-teal me-1"></i>
                                            {{ pdf.filename|default:"Clinical Document" }}
                                        </span>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    data-action="open-pdf-fullscreen" data-pdf-index="{{ forloop.counter0 }}"
                                                    title="Open in fullscreen">
                                                <i class="fa-solid fa-expand"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                    data-action="hide-pdf-viewer" data-pdf-index="{{ forloop.counter0 }}"
                                                    title="Close viewer">
                                                <i class="fa-solid fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% if pdf.content_base64 %}
                                    {# Primary PDF viewer using iframe #}
                                    <div id="pdf-iframe-container-{{ forloop.counter0 }}">
                                        <iframe id="pdf-frame-{{ forloop.counter0 }}"
                                                src="{% url 'patient_data:view_pdf' patient_id=patient_id pdf_index=forloop.counter0 %}"
                                                width="100%"
                                                height="600px"
                                                frameborder="0"
                                                allow="fullscreen"
                                                loading="lazy"
                                                class="pdf-frame-rounded"
                                                onerror="handlePDFLoadError({{ forloop.counter0 }})">
                                            <p>Your browser does not support PDFs.
                                               <a href="{% url 'patient_data:download_pdf' patient_id=patient_id pdf_index=forloop.counter0 %}" download="{{ pdf.filename|default:'clinical_document.pdf' }}">Download the PDF</a>
                                            </p>
                                        </iframe>
                                    </div>

                                    {# Fallback PDF viewer for blocked content #}
                                    <div id="pdf-fallback-{{ forloop.counter0 }}" class="pdf-fallback hidden text-center p-4 border rounded">
                                        <div class="alert alert-info">
                                            <i class="fa-solid fa-info-circle me-2"></i>
                                            <strong>PDF Content Blocked</strong>
                                            <p class="mb-3 mt-2">Your browser's security settings are preventing the PDF from displaying inline. You can:</p>
                                            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                                <a href="{% url 'patient_data:download_pdf' patient_id=patient_id pdf_index=forloop.counter0 %}"
                                                   download="{{ pdf.filename|default:'clinical_document.pdf' }}"
                                                   class="btn btn-primary">
                                                    <i class="fa-solid fa-download me-2"></i>Download PDF
                                                </a>
                                                <button type="button"
                                                        class="btn btn-outline-secondary"
                                                        data-action="open-pdf-new-tab" data-pdf-index="{{ forloop.counter0 }}">
                                                    <i class="fa-solid fa-external-link-alt me-2"></i>Open in New Tab
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="text-center p-4">
                                        <i class="fa-solid fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                                        <p class="text-muted">PDF content could not be loaded.</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        {% else %}
                        <div class="alert alert-info">
                            <h6><i class="fa-solid fa-info-circle me-2"></i>No PDF Documents Available</h6>
                            {% if has_l1_cda %}
                            <p class="mb-0">This L1 CDA document does not contain any embedded PDF documents.</p>
                            {% elif has_l3_cda %}
                            <p class="mb-0">This L3 CDA document contains structured clinical data only. PDF documents are typically found in L1 CDA documents.</p>
                            {% else %}
                            <p class="mb-0">No embedded PDF documents were found in this CDA document.</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div> {# End extended-tab-content-container #}
</div> {# End Clinical Section #}




{% else %}
{# No Extended Data Available #}
<div class="alert alert-info">
    <h6>Extended Patient Information</h6>
    <p class="mb-0">Extended patient information is not available for this document. The system was unable to extract additional patient data from the CDA content.</p>
</div>
{% endif %}
