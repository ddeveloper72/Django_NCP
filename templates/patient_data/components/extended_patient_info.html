{# Extended Patient Information Main Component #}
{% load patient_filters %}
{% if patient_extended_data or administrative_data or contact_data or healthcare_data %}

{# Clinical-style Tab Navigation #}
<div class="clinical-section" id="extendedPatientSection" data-patient-id="{{ patient_id|default:'' }}">
    <!-- Tab Navigation Buttons -->
    <div class="tab-navigation mb-3">
        <button class="tab-button active" data-action="show-extended-tab" data-section-id="extended_patient" data-tab-type="personal"
                type="button">
            <i class="fa-solid fa-user me-1"></i>Personal Information
            {# Show badge if any contact information exists #}
            {% if contact_data.addresses or contact_data.telecoms or administrative_data.patient_contact_info.addresses or administrative_data.patient_contact_info.telecoms or administrative_data.guardian.contact_info.addresses or administrative_data.guardian.contact_info.telecoms or administrative_data.other_contacts %}
            <span class="badge bg-primary ms-2">
                {# Calculate contact count: primary + admin + guardian + other contacts #}
                {% with primary_count=contact_data.addresses|length|add:contact_data.telecoms|length %}
                {% with admin_count=administrative_data.patient_contact_info.addresses|length|add:administrative_data.patient_contact_info.telecoms|length %}
                {% with guardian_count=administrative_data.guardian.contact_info.addresses|length|add:administrative_data.guardian.contact_info.telecoms|length %}
                {% with other_contacts_count=administrative_data.other_contacts|length %}
                    {# Each other contact typically has 1-2 contact methods (address + phone), so multiply by 2 as estimate #}
                    {{ primary_count|add:admin_count|add:guardian_count|add:other_contacts_count|add:other_contacts_count }}
                {% endwith %}
                {% endwith %}
                {% endwith %}
                {% endwith %}
            </span>
            {% endif %}
        </button>

        <button class="tab-button" data-action="show-extended-tab" data-section-id="extended_patient" data-tab-type="healthcare"
                type="button">
            <i class="fa-solid fa-stethoscope me-1"></i>Healthcare Team
            {% if healthcare_data %}
            <span class="badge bg-success ms-2">1</span>
            {% endif %}
        </button>

        <button class="tab-button" data-action="show-extended-tab" data-section-id="extended_patient" data-tab-type="system"
                type="button">
            <i class="fa-solid fa-server me-1"></i>System & Documentation
            <span class="badge bg-warning ms-2">3</span>
        </button>

        {# Only show Clinical Information tab for L3 CDA documents - hide for L1 #}
        {% if has_l3_cda and cda_type != "L1" %}
        <button id="clinical-tab-btn" class="tab-button{% if not processed_sections or processed_sections|length == 0 %} text-muted{% endif %}"
                data-action="show-extended-tab"
                data-section-id="extended_patient"
                data-tab-type="clinical"
                {% if not processed_sections|length and not enhanced_allergies|length and not medications|length and not allergies|length and not problems|length and not procedures|length and not vital_signs|length %}data-disabled="true" data-reason="No structured clinical data available"{% endif %}
                type="button"
                {% if not processed_sections|length and not enhanced_allergies|length and not medications|length and not allergies|length and not problems|length and not procedures|length and not vital_signs|length %}disabled title="No structured clinical data available"{% endif %}>
            <i class="fa-solid fa-notes-medical me-1"></i>Clinical Information
            
            {# Count all clinical sections that have content - including extended sections #}
            {% with has_medications=medications|length|yesno:"1,0" %}
            {% with has_allergies=allergies|length|yesno:"1,0" %}
            {% with has_problems=problems|length|yesno:"1,0" %}
            {% with has_procedures=procedures|length|yesno:"1,0" %}
            {% with has_vital_signs=vital_signs|length|yesno:"1,0" %}
            {% with has_immunizations=immunizations|length|yesno:"1,0" %}
            {% with has_history_of_past_illness=history_of_past_illness|length|yesno:"1,0" %}
            {% with has_medical_devices=medical_devices|length|yesno:"1,0" %}
            {% with has_social_history=social_history|length|yesno:"1,0" %}
            {% with has_physical_findings=physical_findings|length|yesno:"1,0" %}
            {% with has_coded_results=coded_results.blood_group|length|add:coded_results.diagnostic_results|length|yesno:"1,0" %}
            {% with has_lab_results=lab_results|length|yesno:"1,0" %}
            {% with has_pregnancy_history=pregnancy_history|yesno:"1,0" %}
            {% with has_functional_status=functional_status|length|yesno:"1,0" %}
            {% with base_count=has_medications|add:has_allergies|add:has_problems|add:has_procedures|add:has_vital_signs %}
            {% with extended_count=has_immunizations|add:has_history_of_past_illness|add:has_medical_devices|add:has_social_history|add:has_physical_findings|add:has_coded_results|add:has_lab_results|add:has_pregnancy_history|add:has_functional_status %}
            {% with total_section_count=base_count|add:extended_count %}
            
            {% if total_section_count > 0 %}
            <span class="badge bg-warning ms-2">{{ total_section_count }}</span>
            {% elif enhanced_allergies|length > 0 %}
            <span class="badge bg-success ms-2">1</span>
            {% elif processed_sections|length > 0 %}
            <span class="badge bg-info ms-2">1</span>
            {% else %}
            <span class="badge bg-secondary ms-2">0</span>
            {% endif %}
            
            {% endwith %} {# total_section_count #}
            {% endwith %} {# extended_count #}
            {% endwith %} {# base_count #}
            {% endwith %} {# has_functional_status #}
            {% endwith %} {# has_pregnancy_history #}
            {% endwith %} {# has_lab_results #}
            {% endwith %} {# has_coded_results #}
            {% endwith %} {# has_physical_findings #}
            {% endwith %} {# has_social_history #}
            {% endwith %} {# has_medical_devices #}
            {% endwith %} {# has_history_of_past_illness #}
            {% endwith %} {# has_immunizations #}
            {% endwith %} {# has_vital_signs #}
            {% endwith %} {# has_procedures #}
            {% endwith %} {# has_problems #}
            {% endwith %} {# has_allergies #}
            {% endwith %} {# has_medications #}
        </button>
        {% endif %} {# End conditional for Clinical Information tab - only show for L3 CDA #}

        {# Original Clinical Document tab - only show for L1 CDA documents #}
        {% if has_l1_cda and cda_type == "L1" %}
        <button id="pdf-tab-btn" class="tab-button"
                data-action="show-extended-tab"
                data-section-id="extended_patient"
                data-tab-type="pdfs"
                type="button">
            <i class="fa-solid fa-file-pdf me-1"></i>Original Clinical Document
            <span class="badge bg-healthcare-grey ms-2">1</span>
        </button>
        {% endif %}
    </div>

    {# Tab Content Containers #}
    <div class="extended-tab-content-container clinical-tabs-container">

    {# Personal Information Tab Content #}
    <div class="clinical-tab-content active" id="extended_patient_personal">
        {# Direct inclusion of contact component with its responsive card grid #}
        {% include 'patient_data/components/extended_patient_contact_clean.html' %}
    </div>

    {# Healthcare Team Tab Content #}
    <div class="clinical-tab-content" id="extended_patient_healthcare">
        <div class="row g-3">
            {# Healthcare Provider Information Card #}
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fa-solid fa-user-md me-2"></i>Healthcare Provider Information
                        </h5>
                    </div>
                    <div class="card-body">
                        {% include 'patient_data/components/extended_patient_healthcare_clean.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# System & Documentation Tab Content #}
    <div class="clinical-tab-content" id="extended_patient_system">
        <div class="row g-3">
            {# Administrative Information Card #}
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fa-solid fa-cogs me-2"></i>Administrative & System Information
                        </h5>
                    </div>
                    <div class="card-body">
                        {% include 'patient_data/components/extended_patient_document_clean.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Clinical Information Tab Content - only show for L3 CDA documents #}
    {% if has_l3_cda and cda_type != "L1" %}
    <div class="clinical-tab-content" id="extended_patient_clinical">
        {# RESTORED WITH MINIMAL CLEAN STRUCTURE #}
        {% include 'patient_data/components/clinical_information_content.html' %}
    </div>
    {% endif %}

    {# Original Clinical Documents Tab Content - only show for L1 CDA documents #}
    {% if has_l1_cda and cda_type == "L1" %}
    <div class="clinical-tab-content" id="extended_patient_pdfs">
        <div class="row g-3">
            {# Original Clinical Documents Card #}
            <div class="col-12">
                <div class="card border-healthcare-teal">
                    <div class="card-header bg-healthcare-teal text-white">
                        <h5 class="mb-0">
                            <i class="fa-solid fa-file-pdf me-2"></i>Original Clinical Documents
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if has_embedded_pdfs and embedded_pdfs %}
                        <p class="text-muted mb-3">
                            <i class="fa-solid fa-info-circle me-1"></i>
                            This L1 CDA document contains {{ embedded_pdfs|length }} Original Clinical Document{{ embedded_pdfs|length|pluralize }} (OrCD).
                            These are the original clinical documents from the source healthcare system in their native format.
                        </p>

                        {% for pdf in embedded_pdfs %}
                        <div class="pdf-document-item mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fa-solid fa-file-pdf text-healthcare-teal me-2"></i>
                                        {{ pdf.filename|default:"Clinical Document" }}
                                    </h6>
                                    <small class="text-muted">
                                        Size: {{ pdf.size|filesizeformat|default:"Unknown" }}
                                        {% if pdf.media_type %} | Type: {{ pdf.media_type }}{% endif %}
                                    </small>
                                </div>
                                <div>
                                    {% if pdf.content_base64 and session_id %}
                                    <a href="{% url 'patient_data:download_pdf' patient_id=session_id pdf_index=forloop.counter0 %}"
                                       download="{{ pdf.filename|default:'clinical_document.pdf' }}"
                                       class="btn btn-sm btn-outline-primary me-2">
                                        <i class="fa-solid fa-download me-1"></i>Download
                                    </a>
                                    {% elif pdf.content_base64 and patient_id %}
                                    <a href="{% url 'patient_data:download_pdf' patient_id=patient_id pdf_index=forloop.counter0 %}"
                                       download="{{ pdf.filename|default:'clinical_document.pdf' }}"
                                       class="btn btn-sm btn-outline-primary me-2">
                                        <i class="fa-solid fa-download me-1"></i>Download
                                    </a>
                                    {% elif pdf.content_base64 %}
                                    <div class="btn btn-sm btn-outline-secondary me-2 disabled">
                                        <i class="fa-solid fa-exclamation-triangle me-1"></i>Session Error
                                    </div>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-primary"
                                            data-action="show-pdf-viewer" data-pdf-index="{{ forloop.counter0 }}">
                                        <i class="fa-solid fa-eye me-1"></i>View
                                    </button>
                                </div>
                            </div>

                            {# PDF Viewer Container (initially hidden) #}
                            <div id="pdf-viewer-{{ forloop.counter0 }}" class="pdf-viewer-container mt-3 hidden">
                                <div class="border rounded pdf-viewer-background">
                                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                        <span class="text-muted">
                                            <i class="fa-solid fa-file-pdf text-healthcare-teal me-1"></i>
                                            {{ pdf.filename|default:"Clinical Document" }}
                                        </span>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    data-action="open-pdf-fullscreen" data-pdf-index="{{ forloop.counter0 }}"
                                                    title="Open in fullscreen">
                                                <i class="fa-solid fa-expand"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                    data-action="hide-pdf-viewer" data-pdf-index="{{ forloop.counter0 }}"
                                                    title="Close viewer">
                                                <i class="fa-solid fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% if pdf.content_base64 %}
                                    {# Primary PDF viewer using iframe #}
                                    <div id="pdf-iframe-container-{{ forloop.counter0 }}">
                                        {% if session_id %}
                                        <iframe id="pdf-frame-{{ forloop.counter0 }}"
                                                src="{% url 'patient_data:view_pdf' patient_id=session_id pdf_index=forloop.counter0 %}"
                                                width="100%"
                                                height="600px"
                                                frameborder="0"
                                                allow="fullscreen"
                                                loading="lazy"
                                                class="pdf-frame-rounded"
                                                onerror="handlePDFLoadError({{ forloop.counter0 }})">
                                            <p>Your browser does not support PDFs.
                                               <a href="{% url 'patient_data:download_pdf' patient_id=session_id pdf_index=forloop.counter0 %}" download="{{ pdf.filename|default:'clinical_document.pdf' }}">Download the PDF</a>
                                            </p>
                                        </iframe>
                                        {% elif patient_id %}
                                        <iframe id="pdf-frame-{{ forloop.counter0 }}"
                                                src="{% url 'patient_data:view_pdf' patient_id=patient_id pdf_index=forloop.counter0 %}"
                                                width="100%"
                                                height="600px"
                                                frameborder="0"
                                                allow="fullscreen"
                                                loading="lazy"
                                                class="pdf-frame-rounded"
                                                onerror="handlePDFLoadError({{ forloop.counter0 }})">
                                            <p>Your browser does not support PDFs.
                                               <a href="{% url 'patient_data:download_pdf' patient_id=patient_id pdf_index=forloop.counter0 %}" download="{{ pdf.filename|default:'clinical_document.pdf' }}">Download the PDF</a>
                                            </p>
                                        </iframe>
                                        {% else %}
                                        <div class="alert alert-warning text-center p-4">
                                            <i class="fa-solid fa-exclamation-triangle me-2"></i>
                                            <strong>Session Error</strong>
                                            <p class="mb-0 mt-2">Unable to load PDF due to session error. Please restart your session.</p>
                                        </div>
                                        {% endif %}
                                    </div>

                                    {# Fallback PDF viewer for blocked content #}
                                    <div id="pdf-fallback-{{ forloop.counter0 }}" class="pdf-fallback hidden text-center p-4 border rounded">
                                        <div class="alert alert-info">
                                            <i class="fa-solid fa-info-circle me-2"></i>
                                            <strong>PDF Content Blocked</strong>
                                            <p class="mb-3 mt-2">Your browser's security settings are preventing the PDF from displaying inline. You can:</p>
                                            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                                {% if session_id %}
                                                <a href="{% url 'patient_data:download_pdf' patient_id=session_id pdf_index=forloop.counter0 %}"
                                                   download="{{ pdf.filename|default:'clinical_document.pdf' }}"
                                                   class="btn btn-primary">
                                                    <i class="fa-solid fa-download me-2"></i>Download PDF
                                                </a>
                                                {% elif patient_id %}
                                                <a href="{% url 'patient_data:download_pdf' patient_id=patient_id pdf_index=forloop.counter0 %}"
                                                   download="{{ pdf.filename|default:'clinical_document.pdf' }}"
                                                   class="btn btn-primary">
                                                    <i class="fa-solid fa-download me-2"></i>Download PDF
                                                </a>
                                                {% else %}
                                                <div class="btn btn-secondary disabled">
                                                    <i class="fa-solid fa-exclamation-triangle me-2"></i>Session Error
                                                </div>
                                                {% endif %}
                                                <button type="button"
                                                        class="btn btn-outline-secondary"
                                                        data-action="open-pdf-new-tab" data-pdf-index="{{ forloop.counter0 }}">
                                                    <i class="fa-solid fa-external-link-alt me-2"></i>Open in New Tab
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="text-center p-4">
                                        <i class="fa-solid fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                                        <p class="text-muted">PDF content could not be loaded.</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        {% else %}
                        <div class="alert alert-info">
                            <div class="alert-heading">
                                <i class="fa-solid fa-info-circle"></i>
                                No Original Clinical Documents Available
                            </div>
                            <div class="alert-content">
                                {% if has_l1_cda %}
                                <p class="mb-0">This L1 CDA document does not contain any Original Clinical Documents (OrCD).</p>
                                {% elif has_l3_cda %}
                                <p class="mb-0">This L3 CDA document contains structured clinical data only. Original Clinical Documents (OrCD) are typically found in L1 CDA documents.</p>
                                {% else %}
                                <p class="mb-0">No Original Clinical Documents (OrCD) were found in this CDA document.</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div> {# End card-body #}
                </div> {# End card border-healthcare-teal #}
            </div> {# End col-12 #}
        </div> {# End row g-3 #}
    </div> {# End clinical-tab-content extended_patient_pdfs #}
    {% endif %} {# End conditional for Original Clinical Documents tab - only show for L1 CDA #}

    </div> {# End extended-tab-content-container #}
</div> {# End Clinical Section #}




{% else %}
{# No Extended Data Available #}
<div class="card border-info mb-4">
    <div class="card-body">
        <div class="d-flex align-items-start">
            <div class="flex-shrink-0 me-3">
                <div class="rounded-circle bg-info bg-opacity-10 p-3">
                    <i class="fa-solid fa-info-circle text-info" style="font-size: 1.5rem;"></i>
                </div>
            </div>
            <div class="flex-grow-1">
                <h5 class="card-title text-info mb-2">
                    <i class="fa-solid fa-user-doctor me-2"></i>
                    Extended Patient Information
                </h5>
                <p class="card-text text-muted mb-3">
                    Extended patient information is not available for this document. 
                    The system was unable to extract additional patient data from the CDA content.
                </p>
                <div class="alert alert-light border-start border-info border-3 ps-3 mb-0">
                    <small class="text-muted">
                        <i class="fa-solid fa-lightbulb me-1 text-warning"></i>
                        <strong>Note:</strong> Extended information includes administrative data, contact details, 
                        healthcare provider information, and document metadata. This may be available in other document types or formats.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
