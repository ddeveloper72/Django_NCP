<!-- Extended Patient Information Main Component -->
{% load patient_filters %}
{% if patient_extended_data or administrative_data %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card extended-patient-info">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">
                    <i class="fas fa-address-book me-2"></i>
                    Extended Patient Information
                </h4>
            </div>
            <div class="card-body">

                <!-- DEBUG: Show what data is available -->
                <div class="alert alert-info mb-3">
                    <h6><i class="fas fa-bug me-2"></i>DEBUG: Available Extended Data</h6>
                    <p><strong>Patient Extended Data:</strong> {{ patient_extended_data|default:"None" }}</p>
                    <p><strong>Administrative Data:</strong> {{ administrative_data|default:"None" }}</p>
                    {% if patient_extended_data %}
                    <p><strong>Patient Extended Keys:</strong>
                        {% for key, value in patient_extended_data|dict_items %}{{ key }}{% if not forloop.last %}, {% endif %} {% endfor %}
                    </p>
                    {% endif %}
                    {% if administrative_data %}
                    <p><strong>Administrative Data Keys:</strong>
                        {% for key, value in administrative_data|dict_items %}{{ key }}{% if not forloop.last %}, {% endif %} {% endfor %}
                    </p>
                    {% endif %}
                </div>
                </div>

                <!-- Extended Info Navigation Tabs -->
                <ul class="nav nav-tabs" id="extendedInfoTabs" role="tablist">
                    <!-- Contact Details Tab -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="contact-tab"
                            data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab"
                            aria-controls="contact" aria-selected="true">
                            <i class="fas fa-address-card me-1"></i>Contact Details
                            {% if patient_extended_data|safe_get:"patient_contact" or administrative_data|safe_get:"patient_contact_info" %}
                            <span class="badge bg-primary ms-1">1</span>
                            {% endif %}
                        </button>
                    </li>

                    <!-- Healthcare Team Tab -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="healthcare-tab"
                            data-bs-toggle="tab" data-bs-target="#healthcare" type="button" role="tab"
                            aria-controls="healthcare" aria-selected="false">
                            <i class="fas fa-stethoscope me-1"></i>Healthcare Team
                            {% if patient_extended_data|safe_get:"authors" or administrative_data|safe_get:"authors" %}
                            <span class="badge bg-success ms-1">
                                {# Django: Calculate team count using template logic #}
                                {% if patient_extended_data|safe_get:"authors" %}{{ patient_extended_data|safe_get:"authors"|length }}{% elif administrative_data|safe_get:"authors" %}{{ administrative_data|safe_get:"authors"|length }}{% else %}0{% endif %}
                                {% if patient_extended_data|safe_get:"legal_authenticator" or administrative_data|safe_get:"legal_authenticator" %}+1{% endif %}
                                {% if patient_extended_data|safe_get:"custodian" or administrative_data|safe_get:"custodians" %}+1{% endif %}
                            </span>
                            {% endif %}
                        </button>
                    </li>

                    <!-- Document Info Tab -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="document-tab"
                            data-bs-toggle="tab" data-bs-target="#document" type="button" role="tab"
                            aria-controls="document" aria-selected="false">
                            <i class="fas fa-file-medical-alt me-1"></i>Document Info
                        </button>
                    </li>
                </ul>

                <!-- Extended Info Tab Content -->
                <div class="tab-content mt-3" id="extendedInfoTabContent">

                    {# Django: Replace {% set %} with conditional logic #}
                    {# Tab availability checks - Django compatible #}
                    {% comment %}
                    Django doesn't support {% set %} variables.
                    Instead, use direct conditional checks in template logic.
                    Tab order: contact -> healthcare -> document
                    {% endcomment %}

                    <!-- Include Child Components with Error Handling -->
                    {% include 'patient_data/components/extended_patient_contact.html' %}

                    {% include 'patient_data/components/extended_patient_healthcare.html' %}

                    {% include 'patient_data/components/extended_patient_document.html' %}

                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- No Extended Data Available -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <h6><i class="fas fa-info-circle me-2"></i>Extended Patient Information</h6>
            <p>No extended patient data or administrative data available for this patient. The system attempted to extract extended information
                from the CDA document but none was found.</p>
            <p><strong>Debug Info:</strong></p>
            <ul>
                <li>patient_extended_data = {{ patient_extended_data|default:"None" }}</li>
                <li>administrative_data = {{ administrative_data|default:"None" }}</li>
            </ul>
        </div>
    </div>
</div>
{% endif %}
