{% load patient_filters %}

{% comment %}
================================================================================================
COMPONENT: Extended Patient Contact Information
================================================================================================
PURPOSE: Displays contact information for patients, guardians, and emergency contacts in a
         responsive card grid layout optimized for mobile-first design.

DEPENDENCIES:
- patient_filters (Django template tags)
- Bootstrap 5 grid system
- Healthcare Organisation color palette classes
- FontAwesome icons

DATA STRUCTURE:
- contact_data: Primary patient contact information
- administrative_data: Administrative contact data including guardian and emergency contacts
- administrative_data.patient_languages: Communication language preferences

RESPONSIVE BEHAVIOR:
- Mobile (col-12): Single column stack
- Tablet (col-md-6): Two column layout
- Desktop (col-lg-4): Three column grid

SECURITY: No personal data in template logic - all data passed via context
================================================================================================
{% endcomment %}

{% comment %}
BUSINESS LOGIC NOTE: Patient and guardian contact information may legitimately be identical
in valid clinical scenarios (e.g., minor patients, caregiver arrangements, family members).
This is not data duplication but necessary clinical context preservation.
{% endcomment %}



{% if contact_data or patient_identity %}

{% comment %} RESPONSIVE CONTACT GRID: Mobile-first card layout {% endcomment %}
<div class="contact-info-grid">
    <div class="row g-3">
        {% comment %} PATIENT DEMOGRAPHICS CARD: Basic personal information {% endcomment %}
        {% if patient_identity or patient_extended_data %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card service-card border-info h-100">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fa-solid fa-user me-2"></i>Patient Demographics
                    </h6>
                </div>
                <div class="card-body d-flex flex-column">
                    {% if patient_identity.given_name or patient_identity.family_name %}
                    <div class="mb-2">
                        <strong class="text-secondary-accessible">
                            {{ patient_identity.given_name|default:"" }} {{ patient_identity.family_name|default:"" }}
                        </strong>
                    </div>
                    {% endif %}

                    <div class="flex-grow-1">
                        {% if patient_identity.birth_date %}
                        <div class="mb-2">
                            <small class="text-secondary-accessible">
                                <i class="fa-solid fa-calendar text-info me-1"></i>
                                <strong>Birth Date:</strong><br>
                                {{ patient_identity.birth_date|default:"Unknown" }}
                            </small>
                        </div>
                        {% endif %}

                        {% if patient_identity.gender %}
                        <div class="mb-2">
                            <small class="text-secondary-accessible">
                                <i class="fa-solid fa-venus-mars text-info me-1"></i>
                                <strong>Gender:</strong><br>
                                {{ patient_identity.gender|capfirst }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% comment %} PATIENT IDENTIFIERS CARD: Medical record numbers and IDs {% endcomment %}
        {% if patient_identity.patient_identifiers or patient_identity.patient_id %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card service-card border-secondary h-100">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="fa-solid fa-id-card me-2"></i>Patient Identifiers
                    </h6>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="flex-grow-1">
                        {% if patient_identity.patient_identifiers %}
                        {% for identifier in patient_identity.patient_identifiers %}
                        <div class="mb-2">
                            <small class="text-secondary-accessible">
                                <i class="fa-solid fa-fingerprint text-secondary me-1"></i>
                                {% if identifier.assigningAuthorityName %}
                                <strong>{{ identifier.assigningAuthorityName }}:</strong><br>
                                {% elif identifier.root %}
                                <strong>{{ identifier.root|truncatechars:20 }}:</strong><br>
                                {% else %}
                                <strong>Patient ID:</strong><br>
                                {% endif %}
                                <code class="small">{{ identifier.extension }}</code>
                            </small>
                        </div>
                        {% if not forloop.last %}<hr class="my-2">{% endif %}
                        {% endfor %}
                        {% elif patient_identity.patient_id %}
                        <div class="mb-2">
                            <small class="text-secondary-accessible">
                                <i class="fa-solid fa-fingerprint text-secondary me-1"></i>
                                <strong>Patient ID:</strong><br>
                                <code class="small">{{ patient_identity.patient_id }}</code>
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% comment %} ADMINISTRATIVE INFO CARD: Country, healthcare system details {% endcomment %}
        {% if administrative_data.patient_country or administrative_data.home_member_state or patient_identity.country %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card service-card border-dark h-100">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0">
                        <i class="fa-solid fa-globe-europe me-2"></i>Administrative
                    </h6>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="flex-grow-1">
                        {% if administrative_data.patient_country %}
                        <div class="mb-2">
                            <small class="text-secondary-accessible">
                                <i class="fa-solid fa-flag text-dark me-1"></i>
                                <strong>Patient Country:</strong><br>
                                {{ administrative_data.patient_country }}
                            </small>
                        </div>
                        {% endif %}

                        {% if administrative_data.home_member_state %}
                        <div class="mb-2">
                            <small class="text-secondary-accessible">
                                <i class="fa-solid fa-hospital text-dark me-1"></i>
                                <strong>Member State:</strong><br>
                                {{ administrative_data.home_member_state }}
                            </small>
                        </div>
                        {% endif %}

                        {% if patient_identity.country and not administrative_data.patient_country %}
                        <div class="mb-2">
                            <small class="text-secondary-accessible">
                                <i class="fa-solid fa-flag text-dark me-1"></i>
                                <strong>Country:</strong><br>
                                {{ patient_identity.country }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% comment %} PATIENT ADDRESS CARD: Primary residential/postal addresses {% endcomment %}
        {% if contact_data.addresses or administrative_data.patient_contact_info.addresses %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card service-card border-primary h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="fa-solid fa-map-marker-alt me-2"></i>Patient Address
                    </h6>
                </div>
                <div class="card-body d-flex flex-column">
                    {% if contact_data.addresses %}
                        {% for address in contact_data.addresses %}
                        <div class="mb-2 flex-grow-1">
                            <small class="text-secondary-accessible">
                                {% if address.street_lines %}
                                    {% for line in address.street_lines %}{{ line }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                {% elif address.street %}
                                    {{ address.street }}
                                {% endif %}
                                {% if address.city or address.postal_code or address.postalCode or address.country %}
                                    {% if address.street_lines or address.street %}<br>{% endif %}
                                    {% if address.city %}{{ address.city }}{% endif %}{% if address.postal_code or address.postalCode %}{% if address.city %}, {% endif %}{{ address.postal_code|default:address.postalCode }}{% endif %}{% if address.country %}{% if address.city or address.postal_code or address.postalCode %}<br>{% endif %}{{ address.country|country_name }}{% endif %}
                                {% endif %}
                            </small>
                        </div>
                        {% if not forloop.last %}<hr class="my-2">{% endif %}
                        {% endfor %}
                    {% elif administrative_data.patient_contact_info.addresses %}
                        {% for address in administrative_data.patient_contact_info.addresses %}
                        <div class="mb-2 flex-grow-1">
                            <small class="text-secondary-accessible">
                                {% if address.street_lines %}
                                    {% for line in address.street_lines %}{{ line }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                {% elif address.street %}
                                    {{ address.street }}
                                {% endif %}
                                {% if address.city or address.postal_code or address.country %}
                                    {% if address.street_lines or address.street %}<br>{% endif %}
                                    {% if address.city %}{{ address.city }}{% endif %}{% if address.postal_code or address.postalCode %}{% if address.city %}, {% endif %}{{ address.postal_code|default:address.postalCode }}{% endif %}{% if address.country %}{% if address.city or address.postal_code or address.postalCode %}<br>{% endif %}{{ address.country }}{% endif %}
                                {% endif %}
                            </small>
                        </div>
                        {% if not forloop.last %}<hr class="my-2">{% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        {% comment %} PATIENT CONTACT METHODS CARD: Phone, email, fax communication channels {% endcomment %}
        {% if contact_data.telecoms or administrative_data.patient_contact_info.telecoms %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card service-card border-info h-100">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fa-solid fa-phone me-2"></i>Contact Methods
                    </h6>
                </div>
                <div class="card-body d-flex flex-column">
                    {% if contact_data.telecoms %}
                        {% for telecom in contact_data.telecoms %}
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                {% if telecom.type == 'phone' %}
                                <i class="fa-solid fa-phone text-info me-2"></i>
                                {% elif telecom.type == 'email' %}
                                <i class="fa-solid fa-envelope text-info me-2"></i>
                                {% elif telecom.type == 'fax' %}
                                <i class="fa-solid fa-fax text-info me-2"></i>
                                {% else %}
                                <i class="fa-solid fa-info-circle text-info me-2"></i>
                                {% endif %}
                                <small class="text-secondary-accessible flex-grow-1">
                                    <strong>{{ telecom.display_value }}</strong>
                                    {% if telecom.use %}<br><em>{{ telecom.use|capfirst }}</em>{% endif %}
                                </small>
                            </div>
                        </div>
                        {% if not forloop.last %}<hr class="my-2">{% endif %}
                        {% endfor %}
                    {% elif administrative_data.patient_contact_info.telecoms %}
                        {% for telecom in administrative_data.patient_contact_info.telecoms %}
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                {% if telecom.system == 'phone' %}
                                <i class="fa-solid fa-phone text-info me-2"></i>
                                {% elif telecom.system == 'email' %}
                                <i class="fa-solid fa-envelope text-info me-2"></i>
                                {% elif telecom.system == 'fax' %}
                                <i class="fa-solid fa-fax text-info me-2"></i>
                                {% else %}
                                <i class="fa-solid fa-info-circle text-info me-2"></i>
                                {% endif %}
                                <small class="text-secondary-accessible flex-grow-1">
                                    <strong>{{ telecom.value }}</strong>
                                    {% if telecom.use %}<br><em>{{ telecom.use|capfirst }}</em>{% endif %}
                                </small>
                            </div>
                        </div>
                        {% if not forloop.last %}<hr class="my-2">{% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        {% comment %} PATIENT LANGUAGES CARD: Communication language preferences {% endcomment %}
        {% if patient_identity.patient_languages or administrative_data.patient_languages %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card service-card border-success h-100">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fa-solid fa-globe me-2"></i>Patient Languages
                    </h6>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="flex-grow-1">
                        {% if patient_identity.patient_languages %}
                            {% for language in patient_identity.patient_languages %}
                            <span class="badge bg-light text-dark me-2 mb-2">
                                <i class="fa-solid fa-language me-1"></i>{{ language }}
                            </span>
                            {% endfor %}
                        {% elif administrative_data.patient_languages %}
                            {% for language in administrative_data.patient_languages %}
                            <span class="badge bg-light text-dark me-2 mb-2">
                                <i class="fa-solid fa-language me-1"></i>{{ language }}
                            </span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <small class="text-secondary-accessible mt-auto">
                        <i class="fa-solid fa-info-circle me-1"></i>Communication Languages
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
        {% comment %} GUARDIAN INFORMATION CARD: Legal guardian or next-of-kin contact details {% endcomment %}
        {% if administrative_data.guardian and administrative_data.guardian.family_name %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card service-card border-warning h-100">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fa-solid fa-user-shield me-2"></i>Guardian / Next of Kin
                    </h6>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="mb-2">
                        <strong class="text-secondary-accessible">
                            {% if administrative_data.guardian.given_name %}{{ administrative_data.guardian.given_name }} {% endif %}{{ administrative_data.guardian.family_name }}
                        </strong>
                        {% if administrative_data.guardian.relationship %}
                        <br><span class="badge bg-info">{{ administrative_data.guardian.relationship }}</span>
                        {% elif administrative_data.guardian.role %}
                        <br><span class="badge bg-info">{{ administrative_data.guardian.role }}</span>
                        {% endif %}
                    </div>

                    {% if administrative_data.guardian.contact_info %}
                    <div class="flex-grow-1">
                        {% if administrative_data.guardian.contact_info.addresses %}
                        {% for address in administrative_data.guardian.contact_info.addresses %}
                        <div class="mb-2">
                            <small class="text-secondary-accessible">
                                <i class="fa-solid fa-map-marker-alt text-warning me-1"></i>
                                {% if address.street %}{{ address.street }}{% endif %}
                                {% if address.city %}<br>{{ address.city }}{% endif %}
                                {% if address.postalCode %} {{ address.postalCode }}{% endif %}
                                {% if address.country %}<br>
                                {{ address.country|country_name }}
                                {% endif %}
                            </small>
                        </div>
                        {% endfor %}
                        {% endif %}

                        {% if administrative_data.guardian.contact_info.telecoms %}
                        {% for telecom in administrative_data.guardian.contact_info.telecoms %}
                        <div class="mb-1">
                            <small class="text-secondary-accessible">
                                {% if telecom.type == 'phone' %}
                                <i class="fa-solid fa-phone text-warning me-1"></i>
                                {% elif telecom.type == 'email' %}
                                <i class="fa-solid fa-envelope text-warning me-1"></i>
                                {% else %}
                                <i class="fa-solid fa-info-circle text-warning me-1"></i>
                                {% endif %}
                                {{ telecom.display_value }}
                            </small>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        {% comment %} EMERGENCY CONTACTS CARDS: Additional emergency contact persons {% endcomment %}
        {% if administrative_data.other_contacts %}
        {% for contact in administrative_data.other_contacts %}
        {% if contact.given_name or contact.family_name %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card service-card border-secondary h-100">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="fa-solid fa-users me-2"></i>Emergency Contact
                    </h6>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="mb-2">
                        <strong class="text-secondary-accessible">
                            {% if contact.given_name %}{{ contact.given_name }} {% endif %}{{ contact.family_name }}
                        </strong>
                        {% if contact.relationship %}
                        <br><span class="badge bg-info">{{ contact.relationship }}</span>
                        {% elif contact.contact_type %}
                        <br><span class="badge bg-info">{{ contact.contact_type }}</span>
                        {% elif contact.role %}
                        <br><span class="badge bg-info">{{ contact.role }}</span>
                        {% endif %}
                    </div>

                    {% if contact.contact_info %}
                    <div class="flex-grow-1">
                        {% if contact.contact_info.addresses %}
                        {% for address in contact.contact_info.addresses %}
                        <div class="mb-2">
                            <small class="text-secondary-accessible">
                                <i class="fa-solid fa-map-marker-alt text-secondary me-1"></i>
                                {% if address.street %}{{ address.street }}{% endif %}
                                {% if address.city %}<br>{{ address.city }}{% endif %}
                                {% if address.postalCode %} {{ address.postalCode }}{% endif %}
                                {% if address.country %}<br>
                                {{ address.country|country_name }}
                                {% endif %}
                            </small>
                        </div>
                        {% endfor %}
                        {% endif %}

                        {% if contact.contact_info.telecoms %}
                        {% for telecom in contact.contact_info.telecoms %}
                        <div class="mb-1">
                            <small class="text-secondary-accessible">
                                {% if telecom.type == 'phone' %}
                                <i class="fa-solid fa-phone text-secondary me-1"></i>
                                {% elif telecom.type == 'email' %}
                                <i class="fa-solid fa-envelope text-secondary me-1"></i>
                                {% else %}
                                <i class="fa-solid fa-info-circle text-secondary me-1"></i>
                                {% endif %}
                                {{ telecom.display_value }}
                            </small>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        {% endif %}

    </div> {# End row g-3 #}
</div> {# End contact-info-grid #}

{% else %}
<div class="text-center py-5">
    <i class="fa-solid fa-address-card fa-3x text-muted mb-3"></i>
    <h6 class="text-muted">No Contact Information Available</h6>
    <p class="text-muted small">No contact details or addresses were found in the patient record.</p>
</div>
{% endif %}
