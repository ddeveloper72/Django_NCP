{# Clinical Information Content - Collapsible Version #}
{% load patient_filters %}
{% load medication_filters %}

<div class="clinical-information-container">
    {# Check if we have any clinical data #}
    {% if medications or allergies or problems or vital_signs or procedures or immunizations %}
        
        {# Main Clinical Sections Container #}
        <div class="collapsible-wrapper">
            <input id="toggle-clinical-sections" class="toggle-input" type="checkbox" checked>
            <label for="toggle-clinical-sections" class="collapsible-label-main">
                <i class="fa-solid fa-stethoscope me-2"></i>Clinical Information
            </label>
            <div class="collapsible-content-main">
                <div class="content-inner-main">
                    
                    {# Medical Problems Section #}
                    {% if problems and problems|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-medical-problems" class="toggle-input" type="checkbox" checked>
                            <label for="toggle-medical-problems" class="collapsible-label-title">
                                <i class="fa-solid fa-triangle-exclamation me-2"></i>Medical Problems
                                <span class="badge bg-light text-dark ms-2">{{ problems|length }}</span>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    <p class="mb-3 text-muted">Medical Problems: {{ problems|length }} items found</p>
                                    
                                    {# Professional Medical Problems Table #}
                                    <div class="medical-problems-table-container bg-white border rounded-3 shadow-sm overflow-hidden">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover mb-0 medical-problems-table">
                                                <thead class="table-primary">
                                                    <tr>
                                                        <th scope="col" class="fw-bold">
                                                            <i class="fa-solid fa-triangle-exclamation me-2"></i>Active Problem
                                                        </th>
                                                        <th scope="col" class="fw-bold">
                                                            <i class="fa-solid fa-tags me-2"></i>Problem Type
                                                        </th>
                                                        <th scope="col" class="fw-bold">
                                                            <i class="fa-solid fa-clock me-2"></i>Time
                                                        </th>
                                                        <th scope="col" class="fw-bold">
                                                            <i class="fa-solid fa-info-circle me-2"></i>Problem Status
                                                        </th>
                                                        <th scope="col" class="fw-bold">
                                                            <i class="fa-solid fa-thermometer-half me-2"></i>Severity
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for problem in problems %}
                                                    <tr class="problem-row">
                                                        {# Active Problem Column #}
                                                        <td class="problem-name-cell">
                                                            <div class="problem-name-container">
                                                                <div class="problem-title fw-bold text-danger mb-1">
                                                                    {% if problem.name %}
                                                                        {{ problem.name }}
                                                                    {% elif problem.problem.name %}
                                                                        {{ problem.problem.name }}
                                                                    {% elif problem.problem.code.displayName %}
                                                                        {{ problem.problem.code.displayName }}
                                                                    {% else %}
                                                                        Medical Problem
                                                                    {% endif %}
                                                                </div>
                                                                {% if problem.code %}
                                                                    <div class="problem-code text-muted small">
                                                                        <i class="fa-solid fa-barcode me-1"></i>
                                                                        {{ problem.code }}
                                                                        {% if problem.code_system %} ({{ problem.code_system }}){% endif %}
                                                                    </div>
                                                                {% elif problem.problem.code.code %}
                                                                    <div class="problem-code text-muted small">
                                                                        <i class="fa-solid fa-barcode me-1"></i>
                                                                        {{ problem.problem.code.code }}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                        
                                                        {# Problem Type Column #}
                                                        <td class="problem-type-cell">
                                                            {% if problem.type %}
                                                                {% if "Active Problem" in problem.type or "active" in problem.type|lower %}
                                                                    <span class="badge bg-danger me-1">{{ problem.type }}</span>
                                                                {% elif "Resolved Problem" in problem.type or "resolved" in problem.type|lower or "completed" in problem.type|lower %}
                                                                    <span class="badge bg-success me-1">{{ problem.type }}</span>
                                                                {% elif "Clinical finding" in problem.type or "Finding" in problem.type %}
                                                                    <span class="badge bg-info me-1">{{ problem.type }}</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary me-1">{{ problem.type }}</span>
                                                                {% endif %}
                                                                {% if problem.type_code_system %}
                                                                    {% if "2.16.840.1.113883.6.96" in problem.type_code_system %}
                                                                        <div class="small text-muted mt-1">SNOMED CT</div>
                                                                    {% elif "2.16.840.1.113883.6.1" in problem.type_code_system %}
                                                                        <div class="small text-muted mt-1">LOINC</div>
                                                                    {% else %}
                                                                        <div class="small text-muted mt-1">{{ problem.type_code_system|truncatechars:15 }}</div>
                                                                    {% endif %}
                                                                {% elif problem.code_system %}
                                                                    <div class="small text-muted mt-1">{{ problem.code_system }}</div>
                                                                {% endif %}
                                                            {% elif problem.problem.code.codeSystem %}
                                                                {% if problem.problem.code.codeSystem == "2.16.840.1.113883.6.96" %}
                                                                    <span class="badge bg-success me-1">Clinical finding</span>
                                                                    <div class="small text-muted mt-1">SNOMED CT</div>
                                                                {% elif problem.problem.code.codeSystem == "2.16.840.1.113883.6.90" %}
                                                                    <span class="badge bg-info me-1">Clinical finding</span>
                                                                    <div class="small text-muted mt-1">ICD-10</div>
                                                                {% elif problem.problem.code.codeSystem == "2.16.840.1.113883.6.103" %}
                                                                    <span class="badge bg-warning me-1">Clinical finding</span>
                                                                    <div class="small text-muted mt-1">ICD-9</div>
                                                                {% else %}
                                                                    <span class="badge bg-secondary me-1">Problem</span>
                                                                    <div class="small text-muted mt-1">Other</div>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="text-muted">Clinical finding</span>
                                                            {% endif %}
                                                        </td>
                                                        
                                                        {# Time Column #}
                                                        <td class="problem-time-cell">
                                                            {% if problem.time_display %}
                                                                <div class="time-info text-primary fw-bold">
                                                                    {{ problem.time_display }}
                                                                </div>
                                                            {% elif problem.onset %}
                                                                <div class="time-info text-primary fw-bold">
                                                                    since {{ problem.onset }}
                                                                </div>
                                                                {% if problem.resolution %}
                                                                    <div class="end-time text-muted small mt-1">
                                                                        until {{ problem.resolution }}
                                                                    </div>
                                                                {% endif %}
                                                            {% elif problem.effective_time.low_formatted %}
                                                                <div class="time-info text-primary fw-bold">
                                                                    since {{ problem.effective_time.low_formatted }}
                                                                </div>
                                                                {% if problem.effective_time.high_formatted %}
                                                                    <div class="end-time text-muted small mt-1">
                                                                        until {{ problem.effective_time.high_formatted }}
                                                                    </div>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        
                                                        {# Problem Status Column #}
                                                        <td class="problem-status-cell text-center">
                                                            {% if problem.status %}
                                                                {% if problem.status|lower == "active" %}
                                                                    <span class="badge bg-danger status-badge">
                                                                        <i class="fa-solid fa-exclamation-circle me-1"></i>{{ problem.status|capfirst }}
                                                                    </span>
                                                                {% elif problem.status|lower == "resolved" or problem.status|lower == "completed" %}
                                                                    <span class="badge bg-success status-badge">
                                                                        <i class="fa-solid fa-check-circle me-1"></i>{{ problem.status|capfirst }}
                                                                    </span>
                                                                {% elif problem.status|lower == "inactive" %}
                                                                    <span class="badge bg-secondary status-badge">
                                                                        <i class="fa-solid fa-pause-circle me-1"></i>{{ problem.status|capfirst }}
                                                                    </span>
                                                                {% else %}
                                                                    <span class="badge bg-info status-badge">
                                                                        <i class="fa-solid fa-info-circle me-1"></i>{{ problem.status|capfirst }}
                                                                    </span>
                                                                {% endif %}
                                                            {% elif problem.statusCode.code %}
                                                                {% if problem.statusCode.code == "active" %}
                                                                    <span class="badge bg-danger status-badge">
                                                                        <i class="fa-solid fa-exclamation-circle me-1"></i>active
                                                                    </span>
                                                                {% elif problem.statusCode.code == "completed" or problem.statusCode.code == "resolved" %}
                                                                    <span class="badge bg-success status-badge">
                                                                        <i class="fa-solid fa-check-circle me-1"></i>resolved
                                                                    </span>
                                                                {% elif problem.statusCode.code == "inactive" %}
                                                                    <span class="badge bg-secondary status-badge">
                                                                        <i class="fa-solid fa-pause-circle me-1"></i>inactive
                                                                    </span>
                                                                {% else %}
                                                                    <span class="badge bg-warning status-badge">
                                                                        <i class="fa-solid fa-question-circle me-1"></i>{{ problem.statusCode.code }}
                                                                    </span>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        
                                                        {# Severity Column #}
                                                        <td class="problem-severity-cell text-center">
                                                            {% if problem.severity %}
                                                                <span class="severity-badge fw-bold 
                                                                    {% if problem.severity|lower == 'severe' %}text-danger
                                                                    {% elif problem.severity|lower == 'moderate' %}text-warning  
                                                                    {% else %}text-success
                                                                    {% endif %}">
                                                                    {{ problem.severity|title }}
                                                                </span>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {# Medications Section #}
                    {% if medications and medications|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-medications" class="toggle-input" type="checkbox">
                            <label for="toggle-medications" class="collapsible-label-title">
                                <i class="fa-solid fa-pills me-2"></i>Medications
                                <span class="badge bg-light text-dark ms-2">{{ medications|length }}</span>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    <p class="mb-3 text-muted">Medications: {{ medications|length }} items found</p>
                                    {% for med in medications %}
                                    {# Enhanced Medication Card - Professional Medical Display #}
                                    <div class="medication-card mb-4 p-4 border rounded shadow-sm bg-white">
                                        
                                        {# Comprehensive Medication Summary - Like XML Notepad Output #}
                                        {% if med.data.medication_summary %}
                                        <div class="medication-summary-banner mb-4 p-3 bg-primary bg-gradient text-white rounded">
                                            <div class="d-flex align-items-center">
                                                <i class="fa-solid fa-prescription-bottle fa-2x me-3"></i>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1 fw-bold">Comprehensive Medication Summary</h6>
                                                    <div class="medication-summary-text fs-6">
                                                        {{ med.data.medication_summary }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {# Header Section - Medication Name & Class #}
                                        <div class="medication-header mb-3 pb-3 border-bottom">
                                            <div class="d-flex flex-wrap align-items-start justify-content-between">
                                                <div class="medication-name-section flex-grow-1 me-3">
                                                    <h5 class="medication-name text-primary mb-1 fw-bold">
                                                        <i class="fa-solid fa-pills me-2"></i>
                                                        {% if med.data.medication_name %}
                                                            {{ med.data.medication_name }}
                                                        {% elif med.medication.name %}
                                                            {{ med.medication.name }}
                                                        {% elif med.medication.code.displayName %}
                                                            {{ med.medication.code.displayName }}
                                                        {% else %}
                                                            Medication (Code: {{ med.medication.code.code|default:"Unknown" }})
                                                        {% endif %}
                                                    </h5>
                                                    {% if med.medication.code.code %}
                                                        <div class="medication-code text-muted small mb-2">
                                                            <i class="fa-solid fa-barcode me-1"></i>
                                                            <strong>Code:</strong> {{ med.medication.code.code }}
                                                            {% if med.medication.code.codeSystem %}
                                                                <span class="text-muted">{% if med.medication.code.codeSystem == "2.16.840.1.113883.6.96" %}(SNOMED CT){% else %}({{ med.medication.code.codeSystem }}){% endif %}</span>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="medication-status-section text-end">
                                                    {% if med.statusCode.code %}
                                                        {% if med.statusCode.code == "active" %}
                                                            <span class="badge bg-success fs-6 medication-status-badge">
                                                                <i class="fa-solid fa-check-circle me-1"></i>Active
                                                            </span>
                                                        {% elif med.statusCode.code == "completed" %}
                                                            <span class="badge bg-secondary fs-6 medication-status-badge">
                                                                <i class="fa-solid fa-flag-checkered me-1"></i>Completed
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-warning fs-6 medication-status-badge">
                                                                <i class="fa-solid fa-question-circle me-1"></i>{{ med.statusCode.code|title }}
                                                            </span>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {# Main Information Grid - Responsive Layout #}
                                        <div class="medication-details">
                                            <div class="row g-3">
                                                
                                                {# Left Column - Primary Information #}
                                                <div class="col-lg-6 col-md-12">
                                                    
                                                    {# 2. Active Ingredients [Strength] #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-flask text-info me-2"></i>
                                                            <strong class="text-dark">Active Ingredients [Strength]</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% if med.data.ingredient_display %}
                                                                <div class="ingredient-container">
                                                                    <span class="active-ingredient fw-bold text-success">
                                                                        {{ med.data.ingredient_display }}{% if med.data.strength %} {{ med.data.strength }}{% endif %}
                                                                    </span>
                                                                    {% if med.data.ingredient_code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            ATC Code: {{ med.data.ingredient_code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif med.active_ingredient %}
                                                                <div class="ingredient-container">
                                                                    <span class="active-ingredient fw-bold text-success">
                                                                        {% if med.active_ingredient.display_name and med.active_ingredient.display_name != med.active_ingredient.code %}
                                                                            {{ med.active_ingredient.display_name }}
                                                                        {% else %}
                                                                            {{ med.active_ingredient.code|title }}
                                                                        {% endif %}
                                                                        {% if med.strength %} {{ med.strength }}{% endif %}
                                                                    </span>
                                                                    {% if med.active_ingredient.display_name and med.active_ingredient.display_name != med.active_ingredient.code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            ATC Code: {{ med.active_ingredient.code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif med.substance %}
                                                                <div class="ingredient-container">
                                                                    <span class="active-ingredient fw-bold text-success">
                                                                        {% if med.substance.display_name and med.substance.display_name != med.substance.code %}
                                                                            {{ med.substance.display_name }}
                                                                        {% else %}
                                                                            {{ med.substance.code|title }}
                                                                        {% endif %}
                                                                        {% if med.strength %} {{ med.strength }}{% endif %}
                                                                    </span>
                                                                    {% if med.substance.display_name and med.substance.display_name != med.substance.code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            Substance Code: {{ med.substance.code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif med.medication.name %}
                                                                <span class="text-warning">
                                                                    <i class="fa-solid fa-exclamation-triangle me-1"></i>
                                                                    {{ med.medication.name }} (Brand name - active ingredient not resolved)
                                                                </span>
                                                            {% else %}
                                                                {% with fallback_ingredient=med|extract_active_ingredient %}
                                                                    {% if fallback_ingredient and fallback_ingredient != "" %}
                                                                        <div class="ingredient-container">
                                                                            <span class="active-ingredient fw-bold text-success">
                                                                                {{ fallback_ingredient }}
                                                                            </span>
                                                                            <br>
                                                                            <small class="text-muted mt-1">
                                                                                <i class="fa-solid fa-magic-wand-sparkles me-1"></i>
                                                                                Inferred from medication name
                                                                            </small>
                                                                        </div>
                                                                    {% else %}
                                                                        <span class="text-muted">
                                                                            <i class="fa-solid fa-info-circle me-1"></i>
                                                                            Active ingredient information not specified
                                                                        </span>
                                                                    {% endif %}
                                                                {% endwith %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    {# 3. Pharmaceutical Form #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-layer-group text-warning me-2"></i>
                                                            <strong class="text-dark">Pharmaceutical Form</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% if med.data.pharmaceutical_form %}
                                                                <span class="pharmaceutical-form fw-bold text-info">
                                                                    {{ med.data.pharmaceutical_form }}
                                                                </span>
                                                                {% if med.data.pharmaceutical_form_code %}
                                                                    <br>
                                                                    <small class="text-muted mt-1 d-block">
                                                                        <i class="fa-solid fa-hashtag me-1"></i>
                                                                        Form Code: {{ med.data.pharmaceutical_form_code }}
                                                                    </small>
                                                                {% endif %}
                                                            {% elif med.pharmaceutical_form %}
                                                                <div class="pharmaceutical-form-container">
                                                                    <span class="pharmaceutical-form fw-bold text-info">
                                                                        {% if med.pharmaceutical_form.displayName and med.pharmaceutical_form.displayName != med.pharmaceutical_form.code %}
                                                                            {{ med.pharmaceutical_form.displayName }}
                                                                        {% else %}
                                                                            {{ med.pharmaceutical_form.code|title }}
                                                                        {% endif %}
                                                                    </span>
                                                                    {% if med.pharmaceutical_form.displayName and med.pharmaceutical_form.displayName != med.pharmaceutical_form.code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1 d-block">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            Form Code: {{ med.pharmaceutical_form.code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif med.form %}
                                                                <div class="pharmaceutical-form-container">
                                                                    <span class="pharmaceutical-form fw-bold text-info">
                                                                        {% if med.form.displayName and med.form.displayName != med.form.code %}
                                                                            {{ med.form.displayName }}
                                                                        {% else %}
                                                                            {{ med.form.code|title }}
                                                                        {% endif %}
                                                                    </span>
                                                                    {% if med.form.displayName and med.form.displayName != med.form.code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1 d-block">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            Form Code: {{ med.form.code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% else %}
                                                                {% with fallback_form=med|smart_dose_form %}
                                                                    {% if fallback_form and fallback_form != "Form not specified" %}
                                                                        <div class="pharmaceutical-form-container">
                                                                            <span class="pharmaceutical-form fw-bold text-info">
                                                                                {{ fallback_form }}
                                                                            </span>
                                                                            <br>
                                                                            <small class="text-muted mt-1">
                                                                                <i class="fa-solid fa-magic-wand-sparkles me-1"></i>
                                                                                Inferred from medication name
                                                                            </small>
                                                                        </div>
                                                                    {% else %}
                                                                        <span class="text-muted">
                                                                            <i class="fa-solid fa-info-circle me-1"></i>
                                                                            Pharmaceutical form not specified
                                                                        </span>
                                                                    {% endif %}
                                                                {% endwith %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    {# 4. Dose Quantity #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-prescription-bottle text-success me-2"></i>
                                                            <strong class="text-dark">Dose Quantity</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% if med.data.dose_quantity %}
                                                                <span class="dose-amount fw-bold text-primary fs-5">
                                                                    {{ med.data.dose_quantity }}
                                                                </span>
                                                                <small class="text-muted d-block mt-1">
                                                                    Per administration
                                                                </small>
                                                            {% elif med.dose %}
                                                                {% if med.dose.value and med.dose.unit %}
                                                                    <span class="dose-amount fw-bold text-primary">
                                                                        {{ med.dose.value }} {{ med.dose.unit }}
                                                                    </span>
                                                                {% elif med.dose.value %}
                                                                    <span class="dose-amount fw-bold text-primary">
                                                                        {{ med.dose.value }}
                                                                    </span>
                                                                {% else %}
                                                                    <span class="text-muted">
                                                                        <i class="fa-solid fa-info-circle me-1"></i>
                                                                        Dose quantity not specified
                                                                    </span>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="text-muted">
                                                                    <i class="fa-solid fa-info-circle me-1"></i>
                                                                    Dose not specified
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                </div>
                                                
                                                {# Right Column - Secondary Information #}
                                                <div class="col-lg-6 col-md-12">
                                                    
                                                    {# 5. Dosage (Frequency/Schedule) #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-clock text-primary me-2"></i>
                                                            <strong class="text-dark">Dosage Schedule</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% load medication_filters %}
                                                            {% with schedule=med|extract_dosage_schedule %}
                                                                {% if schedule and schedule != "Schedule not specified" %}
                                                                    {% with clean_schedule=schedule|cut:" Code: ACM"|cut:" Code:ACM"|cut:"Code: ACM"|cut:"Code:ACM" %}
                                                                    <span class="frequency fw-bold text-warning">
                                                                        {{ clean_schedule }}
                                                                    </span>
                                                                    {% endwith %}
                                                                    {% if "before breakfast" in schedule or "ACM" in schedule %}
                                                                        <br>
                                                                        <small class="text-muted d-block mt-1">
                                                                            <i class="fa-solid fa-code me-1"></i>
                                                                            Code: ACM
                                                                        </small>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">
                                                                        <i class="fa-solid fa-info-circle me-1"></i>
                                                                        Schedule not specified
                                                                    </span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        </div>
                                                    </div>
                                                    
                                                    {# 6. Time (Start - Finish) #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-calendar-alt text-info me-2"></i>
                                                            <strong class="text-dark">Treatment Period</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% load medication_filters %}
                                                            {% with treatment_period=med|format_treatment_period %}
                                                                {% if "not specified" not in treatment_period %}
                                                                    <div class="time-range">
                                                                        <i class="fa-solid fa-calendar-check text-success me-2"></i>
                                                                        <strong>{{ treatment_period }}</strong>
                                                                    </div>
                                                                {% else %}
                                                                    <span class="text-muted">
                                                                        <i class="fa-solid fa-info-circle me-1"></i>
                                                                        Treatment timing not specified
                                                                    </span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        </div>
                                                    </div>
                                                    
                                                    {# 7. Route #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-route text-danger me-2"></i>
                                                            <strong class="text-dark">Administration Route</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% if med.data.route_display %}
                                                                <div class="route-display-container">
                                                                    <span class="route fw-bold text-danger">{{ med.data.route_display }}</span>
                                                                    {% if med.data.route_code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            Route Code: {{ med.data.route_code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif med.route_display %}
                                                                <span class="route fw-bold text-danger">{{ med.route_display }}</span>
                                                            {% elif med.route %}
                                                                <div class="route-display-container">
                                                                    <span class="route fw-bold text-danger">
                                                                        {% if med.route.displayName and med.route.displayName != med.route.code %}
                                                                            {{ med.route.displayName }}
                                                                        {% else %}
                                                                            {{ med.route.code|title }}
                                                                        {% endif %}
                                                                    </span>
                                                                    {% if med.route.displayName and med.route.displayName != med.route.code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            Route Code: {{ med.route.code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% else %}
                                                                <span class="text-muted">
                                                                    <i class="fa-solid fa-info-circle me-1"></i>
                                                                    Administration route not specified
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                </div>
                                            </div>
                                            
                                            {# 8. Medical Reason - Full Width Bottom Section #}
                                            <div class="medication-reason mt-3 pt-3 border-top">
                                                <div class="field-header d-flex align-items-center mb-2">
                                                    <i class="fa-solid fa-notes-medical text-primary me-2"></i>
                                                    <strong class="text-dark">Medical Reason / Indication</strong>
                                                </div>
                                                <div class="field-content bg-light p-3 rounded">
                                                    {# Extract medical reason from medication name if present #}
                                                    {% if "diabetes" in med.medication.name|lower %}
                                                        Type 2 diabetes mellitus management
                                                    {% elif "Type 2 diabetes" in med.medication.name %}
                                                        {{ med.medication.name|cut:"Type 2 diabetes mellitus" }}
                                                    {% elif "hypertension" in med.medication.name|lower %}
                                                        Blood pressure management / Hypertension treatment
                                                    {% elif "Hypertension" in med.medication.name %}
                                                        {{ med.medication.name|cut:"Hypertension" }}
                                                    {% elif "cholesterol" in med.medication.name|lower %}
                                                        Cholesterol management / Lipid regulation
                                                    {% else %}
                                                        <span class="text-muted">
                                                            <i class="fa-solid fa-info-circle me-1"></i>
                                                            Medical indication not specified in available data
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {# Allergies Section - MANDATORY (always displayed) #}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-allergies" class="toggle-input" type="checkbox">
                            <label for="toggle-allergies" class="collapsible-label-title">
                                <i class="fa-solid fa-triangle-exclamation me-2"></i>Allergies & Intolerances
                                {% if allergies and allergies|length > 0 %}
                                    {# Use custom filter to count allergies correctly based on data structure #}
                                    <span class="badge bg-light text-dark ms-2">{{ allergies|count_allergy_observations }}</span>
                                {% else %}
                                    <span class="badge bg-secondary text-white ms-2">Mandatory</span>
                                {% endif %}
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    {% if allergies and allergies|length > 0 %}
                                        <p class="mb-3 text-muted">Allergies: {{ allergies|count_allergy_observations }} items found</p>
                                        
                                        {# PRIORITY 1: Check if allergies data has clinical_table structure (NEW 9-COLUMN FORMAT) #}
                                        {% if allergies.0.clinical_table %}
                                            {# Continue with existing clinical table structure... #}
                                        {# NEW 9-COLUMN CLINICAL TABLE STRUCTURE from Enhanced CDA Processor #}
                                        <div class="clinical-table">
                                            {# Desktop Table Layout #}
                                            <div class="d-none d-md-block">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover clinical-data-table">
                                                        <thead class="table-warning">
                                                            <tr>
                                                                {% for header in allergies.0.clinical_table.headers %}
                                                                <th scope="col" class="clinical-header fw-bold">
                                                                    {% if header.type == 'allergen' %}
                                                                    <i class="fa-solid fa-bug me-2"></i>
                                                                    {% elif header.type == 'reaction' %}
                                                                    <i class="fa-solid fa-fire me-2"></i>
                                                                    {% elif header.type == 'severity' %}
                                                                    <i class="fa-solid fa-thermometer-full me-2"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar me-2"></i>
                                                                    {% elif header.type == 'status' %}
                                                                    <i class="fa-solid fa-info-circle me-2"></i>
                                                                    {% elif header.type == 'code' %}
                                                                    <i class="fa-solid fa-hashtag me-2"></i>
                                                                    {% else %}
                                                                    <i class="fa-solid fa-stethoscope me-2"></i>
                                                                    {% endif %}
                                                                    {{ header.label }}
                                                                </th>
                                                                {% endfor %}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for allergy in allergies %}
                                                            {% if allergy.clinical_table %}
                                                            {% for row in allergy.clinical_table.rows %}
                                                            <tr class="clinical-row">
                                                                {% for header in allergy.clinical_table.headers %}
                                                                {% with row.data|get_item:header.key as cell_data %}
                                                                <td class="clinical-cell">
                                                                    {% if header.primary %}
                                                                    <strong class="text-dark">
                                                                        {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                    </strong>
                                                                    {% else %}
                                                                    <div>
                                                                        <span class="text-muted">
                                                                            {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                        </span>
                                                                        
                                                                        {# Add clinical codes for manifestation and agent fields #}
                                                                        {% if header.type == 'reaction' and header.key == 'manifestation' and cell_data.code %}
                                                                            <div class="problem-code text-muted small">
                                                                                <i class="fa-solid fa-barcode me-1"></i>
                                                                                {{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </div>
                                                                        {% elif header.type == 'allergen' and header.key == 'agent' and cell_data.code %}
                                                                            <div class="problem-code text-muted small">
                                                                                <i class="fa-solid fa-barcode me-1"></i>
                                                                                {{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                </td>
                                                                {% endwith %}
                                                                {% endfor %}
                                                            </tr>
                                                            {% endfor %}
                                                            {% endif %}
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            
                                            {# Mobile Card Layout #}
                                            <div class="d-block d-md-none">
                                                <div class="clinical-cards-container">
                                                    {% for allergy in allergies %}
                                                    {% if allergy.clinical_table %}
                                                    {% for row in allergy.clinical_table.rows %}
                                                    <div class="card clinical-card mb-3 border-warning">
                                                        <div class="card-body">
                                                            {% for header in allergy.clinical_table.headers %}
                                                            {% with row.data|get_item:header.key as cell_data %}
                                                            <div class="clinical-field mb-2 {% if header.primary %}primary-field-mobile{% endif %}">
                                                                <div class="field-label d-flex align-items-center mb-1">
                                                                    <strong class="text-muted small">{{ header.label }}</strong>
                                                                    {% if header.type == 'allergen' %}
                                                                    <i class="fa-solid fa-bug ms-1 terminology-indicator text-muted" title="Allergen"></i>
                                                                    {% elif header.type == 'reaction' %}
                                                                    <i class="fa-solid fa-fire ms-1 terminology-indicator text-muted" title="Reaction"></i>
                                                                    {% elif header.type == 'severity' %}
                                                                    <i class="fa-solid fa-thermometer-full ms-1 terminology-indicator text-muted" title="Severity"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar ms-1 terminology-indicator text-muted" title="Date"></i>
                                                                    {% elif header.type == 'status' %}
                                                                    <i class="fa-solid fa-info-circle ms-1 terminology-indicator text-muted" title="Status"></i>
                                                                    {% elif header.type == 'code' %}
                                                                    <i class="fa-solid fa-hashtag ms-1 terminology-indicator text-muted" title="Medical Code"></i>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="field-value">
                                                                    {% if header.primary %}
                                                                    <strong class="text-dark">{% firstof cell_data.display_value cell_data.value "N/A" %}</strong>
                                                                    {% else %}
                                                                    <div>
                                                                        <span class="text-muted">{% firstof cell_data.display_value cell_data.value "N/A" %}</span>
                                                                        
                                                                        {# Add clinical codes for manifestation and agent fields in mobile layout #}
                                                                        {% if header.type == 'reaction' and header.key == 'manifestation' and cell_data.code %}
                                                                            <div class="problem-code text-muted small mt-1">
                                                                                <i class="fa-solid fa-barcode me-1"></i>
                                                                                {{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </div>
                                                                        {% elif header.type == 'allergen' and header.key == 'agent' and cell_data.code %}
                                                                            <div class="problem-code text-muted small mt-1">
                                                                                <i class="fa-solid fa-barcode me-1"></i>
                                                                                {{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% endwith %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        {# FALLBACK: Original card format for backward compatibility #}
                                        {% for allergy in allergies %}
                                        <div class="allergy-card mb-3 p-3 border rounded bg-white">
                                            <div class="d-flex align-items-start">
                                                <div class="allergy-icon me-3">
                                                    <i class="fa-solid fa-triangle-exclamation text-warning fs-4"></i>
                                                </div>
                                                <div class="allergy-details flex-grow-1">
                                                    <h6 class="allergy-name text-dark mb-1">
                                                        {% if allergy.allergen.name %}
                                                            {{ allergy.allergen.name }}
                                                        {% elif allergy.allergen.code.displayName %}
                                                            {{ allergy.allergen.code.displayName }}
                                                        {% else %}
                                                            Allergen (Code: {{ allergy.allergen.code.code|default:"Unknown" }})
                                                        {% endif %}
                                                    </h6>
                                                    {% if allergy.reaction %}
                                                    <div class="text-muted mb-1">
                                                        <i class="fa-solid fa-exclamation-circle me-1"></i>
                                                        <strong>Reaction:</strong> {{ allergy.reaction.name|default:allergy.reaction.code.displayName|default:"Not specified" }}
                                                    </div>
                                                    {% endif %}
                                                    {% if allergy.severity %}
                                                    <div class="text-muted">
                                                        <i class="fa-solid fa-thermometer-half me-1"></i>
                                                        <strong>Severity:</strong> {{ allergy.severity.name|default:allergy.severity.code.displayName|default:"Not specified" }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    {# Empty state for mandatory allergies section #}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-allergies" class="toggle-input" type="checkbox">
                            <label for="toggle-allergies" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fas fa-exclamation-triangle fa-lg me-2" aria-hidden="true"></i>
                                        <span>Allergies and Intolerances</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge mandatory">Mandatory</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content">
                                <div class="clinical-content">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        No allergies or intolerances data available in the patient record.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {# Procedures Section - MANDATORY #}
                    {% if procedures and procedures|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-procedures" class="toggle-input" type="checkbox">
                            <label for="toggle-procedures" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-user-md me-2"></i>
                                        <span>Medical Procedures</span>
                                        {# Use custom filter to count procedures correctly based on data structure #}
                                        <span class="badge bg-light text-dark ms-2">{{ procedures|count_procedure_observations }}</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge populated">{{ procedures|count_procedure_observations }} Found</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    <p class="mb-3 text-muted">Procedures: {{ procedures|count_procedure_observations }} items found</p>
                                    
                                    {# PRIORITY 1: Check if procedures data has clinical_table structure (NEW 3-COLUMN FORMAT) #}
                                    {% if procedures.0.clinical_table %}
                                        {# NEW 3-COLUMN CLINICAL TABLE STRUCTURE from Enhanced CDA Processor #}
                                        <div class="clinical-table">
                                            {# Desktop Table Layout #}
                                            <div class="d-none d-md-block">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover clinical-data-table">
                                                        <thead class="table-info">
                                                            <tr>
                                                                {% for header in procedures.0.clinical_table.headers %}
                                                                <th scope="col" class="clinical-header fw-bold">
                                                                    {% if header.type == 'procedure' %}
                                                                    <i class="fa-solid fa-user-md me-2"></i>
                                                                    {% elif header.type == 'target_site' %}
                                                                    <i class="fa-solid fa-location-dot me-2"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar me-2"></i>
                                                                    {% else %}
                                                                    <i class="fa-solid fa-stethoscope me-2"></i>
                                                                    {% endif %}
                                                                    {{ header.label }}
                                                                </th>
                                                                {% endfor %}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for procedure in procedures %}
                                                            {% if procedure.clinical_table %}
                                                            {% for row in procedure.clinical_table.rows %}
                                                            <tr class="clinical-row">
                                                                {% for header in procedure.clinical_table.headers %}
                                                                {% with row.data|get_item:header.key as cell_data %}
                                                                <td class="clinical-cell">
                                                                    {% if header.primary or header.type == 'procedure' %}
                                                                    <strong class="text-dark">
                                                                        {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                    </strong>
                                                                    {% else %}
                                                                    <div>
                                                                        <span class="text-muted">
                                                                            {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                        </span>
                                                                        
                                                                        {# Add clinical codes for procedure fields #}
                                                                        {% if header.type == 'procedure' and cell_data.code %}
                                                                        <div class="mt-1">
                                                                            <span class="badge bg-secondary text-white small">
                                                                                <i class="fa-solid fa-code me-1"></i>{{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </span>
                                                                        </div>
                                                                        {% endif %}
                                                                        
                                                                        {% if header.type == 'target_site' and cell_data.code %}
                                                                        <div class="mt-1">
                                                                            <span class="badge bg-info text-white small">
                                                                                <i class="fa-solid fa-location-dot me-1"></i>{{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </span>
                                                                        </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                </td>
                                                                {% endwith %}
                                                                {% endfor %}
                                                            </tr>
                                                            {% endfor %}
                                                            {% endif %}
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            
                                            {# Mobile Card Layout #}
                                            <div class="d-block d-md-none">
                                                <div class="clinical-cards-container">
                                                    {% for procedure in procedures %}
                                                    {% if procedure.clinical_table %}
                                                    {% for row in procedure.clinical_table.rows %}
                                                    <div class="card clinical-card mb-3 border-info">
                                                        <div class="card-body">
                                                            {% for header in procedure.clinical_table.headers %}
                                                            {% with row.data|get_item:header.key as cell_data %}
                                                            <div class="clinical-field mb-2 {% if header.primary or header.type == 'procedure' %}primary-field-mobile{% endif %}">
                                                                <div class="field-label d-flex align-items-center mb-1">
                                                                    <strong class="text-muted small">{{ header.label }}</strong>
                                                                    {% if header.type == 'procedure' %}
                                                                    <i class="fa-solid fa-user-md ms-1 terminology-indicator text-muted" title="Medical Procedure"></i>
                                                                    {% elif header.type == 'target_site' %}
                                                                    <i class="fa-solid fa-location-dot ms-1 terminology-indicator text-muted" title="Target Site"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar ms-1 terminology-indicator text-muted" title="Date"></i>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="field-value">
                                                                    <span class="{% if header.primary or header.type == 'procedure' %}fw-bold text-dark{% else %}text-muted{% endif %}">
                                                                        {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                    </span>
                                                                    
                                                                    {# Mobile clinical codes #}
                                                                    {% if cell_data.code %}
                                                                    <div class="clinical-codes-mobile mt-1">
                                                                        <span class="badge {% if header.type == 'procedure' %}bg-secondary{% elif header.type == 'target_site' %}bg-info{% else %}bg-light text-dark{% endif %} small">
                                                                            <i class="fa-solid fa-code me-1"></i>{{ cell_data.code }}
                                                                            {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                        </span>
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% endwith %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    
                                    {# FALLBACK: Display procedures in original card format if no clinical_table #}
                                    {% else %}
                                        {% for procedure in procedures %}
                                        <div class="procedure-card mb-3 p-3 border rounded bg-white">
                                            <div class="d-flex align-items-start">
                                                <div class="procedure-icon me-3">
                                                    <i class="fa-solid fa-user-md text-info fs-4"></i>
                                                </div>
                                                <div class="procedure-details flex-grow-1">
                                                    <h6 class="procedure-name text-dark mb-1">
                                                        {% if procedure.procedure.name %}
                                                            {{ procedure.procedure.name }}
                                                        {% elif procedure.procedure.code.displayName %}
                                                            {{ procedure.procedure.code.displayName }}
                                                        {% else %}
                                                            Procedure (Code: {{ procedure.procedure.code.code|default:"Unknown" }})
                                                        {% endif %}
                                                    </h6>
                                                    {% if procedure.statusCode.code %}
                                                    <div class="text-muted mb-1">
                                                        <i class="fa-solid fa-info-circle me-1"></i>
                                                        <strong>Status:</strong> {{ procedure.statusCode.code|title }}
                                                    </div>
                                                    {% endif %}
                                                    {% if procedure.effective_time.low_formatted %}
                                                    <div class="text-muted">
                                                        <i class="fa-solid fa-calendar me-1"></i>
                                                        <strong>Date:</strong> {{ procedure.effective_time.low_formatted }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    {# Empty state for mandatory procedures section #}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-procedures" class="toggle-input" type="checkbox">
                            <label for="toggle-procedures" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-user-md me-2" aria-hidden="true"></i>
                                        <span>Medical Procedures</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge mandatory">Mandatory</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content">
                                <div class="clinical-content">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        No medical procedures data available in the patient record.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {# Medical Devices Section - MANDATORY #}
                    {% if medical_devices and medical_devices|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-medical-devices" class="toggle-input" type="checkbox">
                            <label for="toggle-medical-devices" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-heartbeat me-2"></i>
                                        <span>Medical Devices</span>
                                        {# Use custom filter to count medical devices correctly based on data structure #}
                                        <span class="badge bg-light text-dark ms-2">{{ medical_devices|count_medical_device_observations }}</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge populated">{{ medical_devices|count_medical_device_observations }} Found</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    <p class="mb-3 text-muted">Medical Devices: {{ medical_devices|count_medical_device_observations }} items found</p>
                                    
                                    {# PRIORITY 1: Check if medical devices data has clinical_table structure (NEW 3-COLUMN FORMAT) #}
                                    {% if medical_devices.0.clinical_table %}
                                        {# NEW 3-COLUMN CLINICAL TABLE STRUCTURE from Enhanced CDA Processor #}
                                        <div class="clinical-table">
                                            {# Desktop Table Layout #}
                                            <div class="d-none d-md-block">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover clinical-data-table">
                                                        <thead class="table-info">
                                                            <tr>
                                                                {% for header in medical_devices.0.clinical_table.headers %}
                                                                <th scope="col" class="clinical-header fw-bold">
                                                                    {% if header.type == 'device' %}
                                                                    <i class="fa-solid fa-heartbeat me-2"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar me-2"></i>
                                                                    {% elif header.type == 'status' %}
                                                                    <i class="fa-solid fa-info-circle me-2"></i>
                                                                    {% else %}
                                                                    <i class="fa-solid fa-stethoscope me-2"></i>
                                                                    {% endif %}
                                                                    {{ header.label }}
                                                                </th>
                                                                {% endfor %}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for device in medical_devices %}
                                                            {% if device.clinical_table %}
                                                            {% for row in device.clinical_table.rows %}
                                                            <tr class="clinical-row">
                                                                {% for header in device.clinical_table.headers %}
                                                                {% with row.data|get_item:header.key as cell_data %}
                                                                <td class="clinical-cell">
                                                                    {% if header.primary or header.type == 'device' %}
                                                                    <strong class="text-dark">
                                                                        {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                    </strong>
                                                                    {% else %}
                                                                    <div>
                                                                        <span class="text-muted">
                                                                            {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                        </span>
                                                                        
                                                                        {# Add clinical codes for device fields #}
                                                                        {% if header.type == 'device' and cell_data.code %}
                                                                        <div class="mt-1">
                                                                            <span class="badge bg-secondary text-white small">
                                                                                <i class="fa-solid fa-code me-1"></i>{{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </span>
                                                                        </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                </td>
                                                                {% endwith %}
                                                                {% endfor %}
                                                            </tr>
                                                            {% endfor %}
                                                            {% endif %}
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            
                                            {# Mobile Card Layout #}
                                            <div class="d-block d-md-none">
                                                <div class="clinical-cards-container">
                                                    {% for device in medical_devices %}
                                                    {% if device.clinical_table %}
                                                    {% for row in device.clinical_table.rows %}
                                                    <div class="card clinical-card mb-3 border-info">
                                                        <div class="card-body">
                                                            {% for header in device.clinical_table.headers %}
                                                            {% with row.data|get_item:header.key as cell_data %}
                                                            <div class="clinical-field mb-2 {% if header.primary or header.type == 'device' %}primary-field-mobile{% endif %}">
                                                                <div class="field-label d-flex align-items-center mb-1">
                                                                    <strong class="text-muted small">{{ header.label }}</strong>
                                                                    {% if header.type == 'device' %}
                                                                    <i class="fa-solid fa-heartbeat ms-1 terminology-indicator text-muted" title="Medical Device"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar ms-1 terminology-indicator text-muted" title="Date"></i>
                                                                    {% elif header.type == 'status' %}
                                                                    <i class="fa-solid fa-info-circle ms-1 terminology-indicator text-muted" title="Status"></i>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="field-value">
                                                                    <span class="{% if header.primary or header.type == 'device' %}fw-bold text-dark{% else %}text-muted{% endif %}">
                                                                        {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                    </span>
                                                                    
                                                                    {# Mobile clinical codes #}
                                                                    {% if cell_data.code %}
                                                                    <div class="clinical-codes-mobile mt-1">
                                                                        <span class="badge {% if header.type == 'device' %}bg-secondary{% else %}bg-light text-dark{% endif %} small">
                                                                            <i class="fa-solid fa-code me-1"></i>{{ cell_data.code }}
                                                                            {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                        </span>
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% endwith %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    
                                    {# FALLBACK: Display medical devices in original card format if no clinical_table #}
                                    {% else %}
                                        {% for device in medical_devices %}
                                        <div class="device-card mb-3 p-3 border rounded bg-white">
                                            <div class="d-flex align-items-start">
                                                <div class="device-icon me-3">
                                                    <i class="fa-solid fa-heartbeat text-info fs-4"></i>
                                                </div>
                                                <div class="device-details flex-grow-1">
                                                    <h6 class="device-name text-dark mb-1">
                                                        {% if device.device.name %}
                                                            {{ device.device.name }}
                                                        {% elif device.device.code.displayName %}
                                                            {{ device.device.code.displayName }}
                                                        {% else %}
                                                            Medical Device (Code: {{ device.device.code.code|default:"Unknown" }})
                                                        {% endif %}
                                                    </h6>
                                                    {% if device.statusCode.code %}
                                                    <div class="text-muted mb-1">
                                                        <i class="fa-solid fa-info-circle me-1"></i>
                                                        <strong>Status:</strong> {{ device.statusCode.code|title }}
                                                    </div>
                                                    {% endif %}
                                                    {% if device.effective_time.low_formatted %}
                                                    <div class="text-muted">
                                                        <i class="fa-solid fa-calendar me-1"></i>
                                                        <strong>Date:</strong> {{ device.effective_time.low_formatted }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    {# Empty state for mandatory medical devices section #}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-medical-devices" class="toggle-input" type="checkbox">
                            <label for="toggle-medical-devices" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-heartbeat me-2" aria-hidden="true"></i>
                                        <span>Medical Devices</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge mandatory">Mandatory</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content">
                                <div class="clinical-content">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        No medical device usage documented in the patient record.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {# Vital Signs Section #}
                    {% if vital_signs and vital_signs|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-vital-signs" class="toggle-input" type="checkbox">
                            <label for="toggle-vital-signs" class="collapsible-label-title">
                                <i class="fa-solid fa-chart-line me-2"></i>Vital Signs
                                <span class="badge bg-light text-dark ms-2">{{ vital_signs|length }}</span>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    <p class="mb-3 text-muted">Vital Signs: {{ vital_signs|length }} items found</p>
                                    {% for vital in vital_signs %}
                                    <div class="vital-card mb-3 p-3 border rounded bg-white">
                                        <h6 class="vital-name text-dark mb-2">
                                            {% if vital.vital.name %}
                                                {{ vital.vital.name }}
                                            {% elif vital.vital.code.displayName %}
                                                {{ vital.vital.code.displayName }}
                                            {% else %}
                                                Vital Sign (Code: {{ vital.vital.code.code|default:"Unknown" }})
                                            {% endif %}
                                        </h6>
                                        
                                        {# Value #}
                                        {% if vital.value %}
                                        <div class="text-muted mb-1">
                                            <i class="fa-solid fa-chart-line me-1"></i>
                                            <strong>Value:</strong> {{ vital.value }}
                                            {% if vital.unit %} {{ vital.unit }}{% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        {# Date Recorded #}
                                        {% if vital.effective_time.low_formatted %}
                                        <div class="text-muted">
                                            <i class="fa-solid fa-calendar me-1"></i>
                                            <strong>Recorded:</strong> {{ vital.effective_time.low_formatted }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                </div>
            </div>
        </div>
        
    {% else %}
        <div class="alert alert-info" role="alert">
            <i class="fa-solid fa-info-circle me-2"></i>
            No clinical information available for this patient.
        </div>
    {% endif %}
</div>