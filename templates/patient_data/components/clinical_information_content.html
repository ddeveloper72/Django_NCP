{# Clinical Information Content - Flat Structure for Clinical Information Tab #}
{% load patient_filters %}
{% load medication_filters %}

<div class="clinical-information-container">
    {# Clinical Sections - Each as standalone accordion #}
                
                    {# Medical Problems Section #}
                    {% if problems and problems|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-medical-problems" class="toggle-input" type="checkbox" checked>
                            <label for="toggle-medical-problems" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-triangle-exclamation me-2"></i>
                                        <span>Medical Problems</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge populated">{{ problems|length }} Found</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    <p class="mb-3 text-muted">Medical Problems: {{ problems|length }} items found</p>
                                    
                                    {# Professional Medical Problems Table #}
                                    <div class="medical-problems-table-container bg-white border rounded-3 shadow-sm overflow-hidden">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover mb-0 medical-problems-table">
                                                <thead class="table-primary">
                                                    <tr>
                                                        <th scope="col" class="fw-bold">
                                                            <i class="fa-solid fa-triangle-exclamation me-2"></i>Active Problem
                                                        </th>
                                                        <th scope="col" class="fw-bold">
                                                            <i class="fa-solid fa-tags me-2"></i>Problem Type
                                                        </th>
                                                        <th scope="col" class="fw-bold">
                                                            <i class="fa-solid fa-clock me-2"></i>Time
                                                        </th>
                                                        <th scope="col" class="fw-bold">
                                                            <i class="fa-solid fa-info-circle me-2"></i>Problem Status
                                                        </th>
                                                        <th scope="col" class="fw-bold">
                                                            <i class="fa-solid fa-thermometer-half me-2"></i>Severity
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for problem in problems %}
                                                    <tr class="problem-row">
                                                        {# Active Problem Column #}
                                                        <td class="problem-name-cell">
                                                            <div class="problem-name-container">
                                                                <div class="problem-title fw-bold text-danger mb-1">
                                                                    {% if problem.name %}
                                                                        {{ problem.name }}
                                                                    {% elif problem.problem.name %}
                                                                        {{ problem.problem.name }}
                                                                    {% elif problem.problem.code.displayName %}
                                                                        {{ problem.problem.code.displayName }}
                                                                    {% else %}
                                                                        Medical Problem
                                                                    {% endif %}
                                                                </div>
                                                                {% if problem.code %}
                                                                    <div class="problem-code text-muted small">
                                                                        <i class="fa-solid fa-barcode me-1"></i>
                                                                        {{ problem.code }}
                                                                        {% if problem.code_system %} ({{ problem.code_system }}){% endif %}
                                                                    </div>
                                                                {% elif problem.problem.code.code %}
                                                                    <div class="problem-code text-muted small">
                                                                        <i class="fa-solid fa-barcode me-1"></i>
                                                                        {{ problem.problem.code.code }}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                        
                                                        {# Problem Type Column #}
                                                        <td class="problem-type-cell">
                                                            {% if problem.type %}
                                                                {% if "Active Problem" in problem.type or "active" in problem.type|lower %}
                                                                    <span class="badge bg-danger me-1">{{ problem.type }}</span>
                                                                {% elif "Resolved Problem" in problem.type or "resolved" in problem.type|lower or "completed" in problem.type|lower %}
                                                                    <span class="badge bg-success me-1">{{ problem.type }}</span>
                                                                {% elif "Clinical finding" in problem.type or "Finding" in problem.type %}
                                                                    <span class="badge bg-info me-1">{{ problem.type }}</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary me-1">{{ problem.type }}</span>
                                                                {% endif %}
                                                                {% if problem.type_code_system %}
                                                                    {% if "2.16.840.1.113883.6.96" in problem.type_code_system %}
                                                                        <div class="small text-muted mt-1">SNOMED CT</div>
                                                                    {% elif "2.16.840.1.113883.6.1" in problem.type_code_system %}
                                                                        <div class="small text-muted mt-1">LOINC</div>
                                                                    {% else %}
                                                                        <div class="small text-muted mt-1">{{ problem.type_code_system|truncatechars:15 }}</div>
                                                                    {% endif %}
                                                                {% elif problem.code_system %}
                                                                    <div class="small text-muted mt-1">{{ problem.code_system }}</div>
                                                                {% endif %}
                                                            {% elif problem.problem.code.codeSystem %}
                                                                {% if problem.problem.code.codeSystem == "2.16.840.1.113883.6.96" %}
                                                                    <span class="badge bg-success me-1">Clinical finding</span>
                                                                    <div class="small text-muted mt-1">SNOMED CT</div>
                                                                {% elif problem.problem.code.codeSystem == "2.16.840.1.113883.6.90" %}
                                                                    <span class="badge bg-info me-1">Clinical finding</span>
                                                                    <div class="small text-muted mt-1">ICD-10</div>
                                                                {% elif problem.problem.code.codeSystem == "2.16.840.1.113883.6.103" %}
                                                                    <span class="badge bg-warning me-1">Clinical finding</span>
                                                                    <div class="small text-muted mt-1">ICD-9</div>
                                                                {% else %}
                                                                    <span class="badge bg-secondary me-1">Problem</span>
                                                                    <div class="small text-muted mt-1">Other</div>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="text-muted">Clinical finding</span>
                                                            {% endif %}
                                                        </td>
                                                        
                                                        {# Time Column #}
                                                        <td class="problem-time-cell">
                                                            {% if problem.time_display %}
                                                                <div class="time-info text-primary fw-bold">
                                                                    {{ problem.time_display }}
                                                                </div>
                                                            {% elif problem.onset %}
                                                                <div class="time-info text-primary fw-bold">
                                                                    since {{ problem.onset }}
                                                                </div>
                                                                {% if problem.resolution %}
                                                                    <div class="end-time text-muted small mt-1">
                                                                        until {{ problem.resolution }}
                                                                    </div>
                                                                {% endif %}
                                                            {% elif problem.effective_time.low_formatted %}
                                                                <div class="time-info text-primary fw-bold">
                                                                    since {{ problem.effective_time.low_formatted }}
                                                                </div>
                                                                {% if problem.effective_time.high_formatted %}
                                                                    <div class="end-time text-muted small mt-1">
                                                                        until {{ problem.effective_time.high_formatted }}
                                                                    </div>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        
                                                        {# Problem Status Column #}
                                                        <td class="problem-status-cell text-center">
                                                            {% if problem.status %}
                                                                {% if problem.status|lower == "active" %}
                                                                    <span class="badge bg-danger status-badge">
                                                                        <i class="fa-solid fa-exclamation-circle me-1"></i>{{ problem.status|capfirst }}
                                                                    </span>
                                                                {% elif problem.status|lower == "resolved" or problem.status|lower == "completed" %}
                                                                    <span class="badge bg-success status-badge">
                                                                        <i class="fa-solid fa-check-circle me-1"></i>{{ problem.status|capfirst }}
                                                                    </span>
                                                                {% elif problem.status|lower == "inactive" %}
                                                                    <span class="badge bg-secondary status-badge">
                                                                        <i class="fa-solid fa-pause-circle me-1"></i>{{ problem.status|capfirst }}
                                                                    </span>
                                                                {% else %}
                                                                    <span class="badge bg-info status-badge">
                                                                        <i class="fa-solid fa-info-circle me-1"></i>{{ problem.status|capfirst }}
                                                                    </span>
                                                                {% endif %}
                                                            {% elif problem.statusCode.code %}
                                                                {% if problem.statusCode.code == "active" %}
                                                                    <span class="badge bg-danger status-badge">
                                                                        <i class="fa-solid fa-exclamation-circle me-1"></i>active
                                                                    </span>
                                                                {% elif problem.statusCode.code == "completed" or problem.statusCode.code == "resolved" %}
                                                                    <span class="badge bg-success status-badge">
                                                                        <i class="fa-solid fa-check-circle me-1"></i>resolved
                                                                    </span>
                                                                {% elif problem.statusCode.code == "inactive" %}
                                                                    <span class="badge bg-secondary status-badge">
                                                                        <i class="fa-solid fa-pause-circle me-1"></i>inactive
                                                                    </span>
                                                                {% else %}
                                                                    <span class="badge bg-warning status-badge">
                                                                        <i class="fa-solid fa-question-circle me-1"></i>{{ problem.statusCode.code }}
                                                                    </span>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        
                                                        {# Severity Column #}
                                                        <td class="problem-severity-cell text-center">
                                                            {% if problem.severity %}
                                                                <span class="severity-badge fw-bold 
                                                                    {% if problem.severity|lower == 'severe' %}text-danger
                                                                    {% elif problem.severity|lower == 'moderate' %}text-warning  
                                                                    {% else %}text-success
                                                                    {% endif %}">
                                                                    {{ problem.severity|title }}
                                                                </span>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {# Medications Section #}
                    {% if medications and medications|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-medications" class="toggle-input" type="checkbox">
                            <label for="toggle-medications" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-pills me-2"></i>
                                        <span>Medications</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge populated">{{ medications|length }} Found</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    <p class="mb-3 text-muted">Medications: {{ medications|length }} items found</p>
                                    {% for med in medications %}
                                    {# Enhanced Medication Card - Professional Medical Display #}
                                    <div class="medication-card mb-4 p-4 border rounded shadow-sm bg-white">
                                        
                                        {# Comprehensive Medication Summary - Like XML Notepad Output #}
                                        {% if med.data.medication_summary %}
                                        <div class="medication-summary-banner mb-4 p-3 bg-primary bg-gradient text-white rounded">
                                            <div class="d-flex align-items-center">
                                                <i class="fa-solid fa-prescription-bottle fa-2x me-3"></i>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1 fw-bold">Comprehensive Medication Summary</h6>
                                                    <div class="medication-summary-text fs-6">
                                                        {{ med.data.medication_summary }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {# Header Section - Medication Name & Class #}
                                        <div class="medication-header mb-3 pb-3 border-bottom">
                                            <div class="d-flex flex-wrap align-items-start justify-content-between">
                                                <div class="medication-name-section flex-grow-1 me-3">
                                                    <h5 class="medication-name text-primary mb-1 fw-bold">
                                                        <i class="fa-solid fa-pills me-2"></i>
                                                        {% if med.data.medication_name %}
                                                            {{ med.data.medication_name }}
                                                        {% elif med.medication.name %}
                                                            {{ med.medication.name }}
                                                        {% elif med.medication.code.displayName %}
                                                            {{ med.medication.code.displayName }}
                                                        {% else %}
                                                            Medication (Code: {{ med.medication.code.code|default:"Unknown" }})
                                                        {% endif %}
                                                    </h5>
                                                    {% if med.medication.code.code %}
                                                        <div class="medication-code text-muted small mb-2">
                                                            <i class="fa-solid fa-barcode me-1"></i>
                                                            <strong>Code:</strong> {{ med.medication.code.code }}
                                                            {% if med.medication.code.codeSystem %}
                                                                <span class="text-muted">{% if med.medication.code.codeSystem == "2.16.840.1.113883.6.96" %}(SNOMED CT){% else %}({{ med.medication.code.codeSystem }}){% endif %}</span>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="medication-status-section text-end">
                                                    {% if med.statusCode.code %}
                                                        {% if med.statusCode.code == "active" %}
                                                            <span class="badge bg-success fs-6 medication-status-badge">
                                                                <i class="fa-solid fa-check-circle me-1"></i>Active
                                                            </span>
                                                        {% elif med.statusCode.code == "completed" %}
                                                            <span class="badge bg-secondary fs-6 medication-status-badge">
                                                                <i class="fa-solid fa-flag-checkered me-1"></i>Completed
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-warning fs-6 medication-status-badge">
                                                                <i class="fa-solid fa-question-circle me-1"></i>{{ med.statusCode.code|title }}
                                                            </span>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {# Main Information Grid - Responsive Layout #}
                                        <div class="medication-details">
                                            <div class="row g-3">
                                                
                                                {# Left Column - Primary Information #}
                                                <div class="col-lg-6 col-md-12">
                                                    
                                                    {# 2. Active Ingredients [Strength] #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-flask text-info me-2"></i>
                                                            <strong class="text-dark">Active Ingredients [Strength]</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% if med.data.ingredient_display %}
                                                                <div class="ingredient-container">
                                                                    <span class="active-ingredient fw-bold text-success">
                                                                        {{ med.data.ingredient_display }}{% if med.data.strength %} {{ med.data.strength }}{% endif %}
                                                                    </span>
                                                                    {% if med.data.ingredient_code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            ATC Code: {{ med.data.ingredient_code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif med.active_ingredient %}
                                                                <div class="ingredient-container">
                                                                    <span class="active-ingredient fw-bold text-success">
                                                                        {% if med.active_ingredient.display_name and med.active_ingredient.display_name != med.active_ingredient.code %}
                                                                            {{ med.active_ingredient.display_name }}
                                                                        {% else %}
                                                                            {{ med.active_ingredient.code|title }}
                                                                        {% endif %}
                                                                        {% if med.strength %} {{ med.strength }}{% endif %}
                                                                    </span>
                                                                    {% if med.active_ingredient.display_name and med.active_ingredient.display_name != med.active_ingredient.code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            ATC Code: {{ med.active_ingredient.code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif med.substance %}
                                                                <div class="ingredient-container">
                                                                    <span class="active-ingredient fw-bold text-success">
                                                                        {% if med.substance.display_name and med.substance.display_name != med.substance.code %}
                                                                            {{ med.substance.display_name }}
                                                                        {% else %}
                                                                            {{ med.substance.code|title }}
                                                                        {% endif %}
                                                                        {% if med.strength %} {{ med.strength }}{% endif %}
                                                                    </span>
                                                                    {% if med.substance.display_name and med.substance.display_name != med.substance.code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            Substance Code: {{ med.substance.code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif med.medication.name %}
                                                                <span class="text-warning">
                                                                    <i class="fa-solid fa-exclamation-triangle me-1"></i>
                                                                    {{ med.medication.name }} (Brand name - active ingredient not resolved)
                                                                </span>
                                                            {% else %}
                                                                {% with fallback_ingredient=med|extract_active_ingredient %}
                                                                    {% if fallback_ingredient and fallback_ingredient != "" %}
                                                                        <div class="ingredient-container">
                                                                            <span class="active-ingredient fw-bold text-success">
                                                                                {{ fallback_ingredient }}
                                                                            </span>
                                                                            <br>
                                                                            <small class="text-muted mt-1">
                                                                                <i class="fa-solid fa-magic-wand-sparkles me-1"></i>
                                                                                Inferred from medication name
                                                                            </small>
                                                                        </div>
                                                                    {% else %}
                                                                        <span class="text-muted">
                                                                            <i class="fa-solid fa-info-circle me-1"></i>
                                                                            Active ingredient information not specified
                                                                        </span>
                                                                    {% endif %}
                                                                {% endwith %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    {# 3. Pharmaceutical Form #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-layer-group text-warning me-2"></i>
                                                            <strong class="text-dark">Pharmaceutical Form</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% if med.data.pharmaceutical_form %}
                                                                <span class="pharmaceutical-form fw-bold text-info">
                                                                    {{ med.data.pharmaceutical_form }}
                                                                </span>
                                                                {% if med.data.pharmaceutical_form_code %}
                                                                    <br>
                                                                    <small class="text-muted mt-1 d-block">
                                                                        <i class="fa-solid fa-hashtag me-1"></i>
                                                                        Form Code: {{ med.data.pharmaceutical_form_code }}
                                                                    </small>
                                                                {% endif %}
                                                            {% elif med.pharmaceutical_form %}
                                                                <div class="pharmaceutical-form-container">
                                                                    <span class="pharmaceutical-form fw-bold text-info">
                                                                        {% if med.pharmaceutical_form.displayName and med.pharmaceutical_form.displayName != med.pharmaceutical_form.code %}
                                                                            {{ med.pharmaceutical_form.displayName }}
                                                                        {% else %}
                                                                            {{ med.pharmaceutical_form.code|title }}
                                                                        {% endif %}
                                                                    </span>
                                                                    {% if med.pharmaceutical_form.displayName and med.pharmaceutical_form.displayName != med.pharmaceutical_form.code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1 d-block">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            Form Code: {{ med.pharmaceutical_form.code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif med.form %}
                                                                <div class="pharmaceutical-form-container">
                                                                    <span class="pharmaceutical-form fw-bold text-info">
                                                                        {% if med.form.displayName and med.form.displayName != med.form.code %}
                                                                            {{ med.form.displayName }}
                                                                        {% else %}
                                                                            {{ med.form.code|title }}
                                                                        {% endif %}
                                                                    </span>
                                                                    {% if med.form.displayName and med.form.displayName != med.form.code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1 d-block">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            Form Code: {{ med.form.code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% else %}
                                                                {% with fallback_form=med|smart_dose_form %}
                                                                    {% if fallback_form and fallback_form != "Form not specified" %}
                                                                        <div class="pharmaceutical-form-container">
                                                                            <span class="pharmaceutical-form fw-bold text-info">
                                                                                {{ fallback_form }}
                                                                            </span>
                                                                            <br>
                                                                            <small class="text-muted mt-1">
                                                                                <i class="fa-solid fa-magic-wand-sparkles me-1"></i>
                                                                                Inferred from medication name
                                                                            </small>
                                                                        </div>
                                                                    {% else %}
                                                                        <span class="text-muted">
                                                                            <i class="fa-solid fa-info-circle me-1"></i>
                                                                            Pharmaceutical form not specified
                                                                        </span>
                                                                    {% endif %}
                                                                {% endwith %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    {# 4. Dose Quantity #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-prescription-bottle text-success me-2"></i>
                                                            <strong class="text-dark">Dose Quantity</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% if med.data.dose_quantity %}
                                                                <span class="dose-amount fw-bold text-primary fs-5">
                                                                    {{ med.data.dose_quantity }}
                                                                </span>
                                                                <small class="text-muted d-block mt-1">
                                                                    Per administration
                                                                </small>
                                                            {% elif med.dose %}
                                                                {% if med.dose.value and med.dose.unit %}
                                                                    <span class="dose-amount fw-bold text-primary">
                                                                        {{ med.dose.value }} {{ med.dose.unit }}
                                                                    </span>
                                                                {% elif med.dose.value %}
                                                                    <span class="dose-amount fw-bold text-primary">
                                                                        {{ med.dose.value }}
                                                                    </span>
                                                                {% else %}
                                                                    <span class="text-muted">
                                                                        <i class="fa-solid fa-info-circle me-1"></i>
                                                                        Dose quantity not specified
                                                                    </span>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="text-muted">
                                                                    <i class="fa-solid fa-info-circle me-1"></i>
                                                                    Dose not specified
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                </div>
                                                
                                                {# Right Column - Secondary Information #}
                                                <div class="col-lg-6 col-md-12">
                                                    
                                                    {# 5. Dosage (Frequency/Schedule) #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-clock text-primary me-2"></i>
                                                            <strong class="text-dark">Dosage Schedule</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% load medication_filters %}
                                                            {% with schedule=med|extract_dosage_schedule %}
                                                                {% if schedule and schedule != "Schedule not specified" %}
                                                                    {% with clean_schedule=schedule|cut:" Code: ACM"|cut:" Code:ACM"|cut:"Code: ACM"|cut:"Code:ACM" %}
                                                                    <span class="frequency fw-bold text-warning">
                                                                        {{ clean_schedule }}
                                                                    </span>
                                                                    {% endwith %}
                                                                    {% if "before breakfast" in schedule or "ACM" in schedule %}
                                                                        <br>
                                                                        <small class="text-muted d-block mt-1">
                                                                            <i class="fa-solid fa-code me-1"></i>
                                                                            Code: ACM
                                                                        </small>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">
                                                                        <i class="fa-solid fa-info-circle me-1"></i>
                                                                        Schedule not specified
                                                                    </span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        </div>
                                                    </div>
                                                    
                                                    {# 6. Time (Start - Finish) #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-calendar-alt text-info me-2"></i>
                                                            <strong class="text-dark">Treatment Period</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% load medication_filters %}
                                                            {% with treatment_period=med|format_treatment_period %}
                                                                {% if "not specified" not in treatment_period %}
                                                                    <div class="time-range">
                                                                        <i class="fa-solid fa-calendar-check text-success me-2"></i>
                                                                        <strong>{{ treatment_period }}</strong>
                                                                    </div>
                                                                {% else %}
                                                                    <span class="text-muted">
                                                                        <i class="fa-solid fa-info-circle me-1"></i>
                                                                        Treatment timing not specified
                                                                    </span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        </div>
                                                    </div>
                                                    
                                                    {# 7. Route #}
                                                    <div class="medication-field mb-3">
                                                        <div class="field-header d-flex align-items-center mb-2">
                                                            <i class="fa-solid fa-route text-danger me-2"></i>
                                                            <strong class="text-dark">Administration Route</strong>
                                                        </div>
                                                        <div class="field-content bg-light p-2 rounded">
                                                            {% if med.data.route_display %}
                                                                <div class="route-display-container">
                                                                    <span class="route fw-bold text-danger">{{ med.data.route_display }}</span>
                                                                    {% if med.data.route_code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            Route Code: {{ med.data.route_code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif med.route_display %}
                                                                <span class="route fw-bold text-danger">{{ med.route_display }}</span>
                                                            {% elif med.route %}
                                                                <div class="route-display-container">
                                                                    <span class="route fw-bold text-danger">
                                                                        {% if med.route.displayName and med.route.displayName != med.route.code %}
                                                                            {{ med.route.displayName }}
                                                                        {% else %}
                                                                            {{ med.route.code|title }}
                                                                        {% endif %}
                                                                    </span>
                                                                    {% if med.route.displayName and med.route.displayName != med.route.code %}
                                                                        <br>
                                                                        <small class="text-muted mt-1">
                                                                            <i class="fa-solid fa-hashtag me-1"></i>
                                                                            Route Code: {{ med.route.code }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            {% else %}
                                                                <span class="text-muted">
                                                                    <i class="fa-solid fa-info-circle me-1"></i>
                                                                    Administration route not specified
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                </div>
                                            </div>
                                            
                                            {# 8. Medical Reason - Full Width Bottom Section #}
                                            <div class="medication-reason mt-3 pt-3 border-top">
                                                <div class="field-header d-flex align-items-center mb-2">
                                                    <i class="fa-solid fa-notes-medical text-primary me-2"></i>
                                                    <strong class="text-dark">Medical Reason / Indication</strong>
                                                </div>
                                                <div class="field-content bg-light p-3 rounded">
                                                    {# Extract medical reason from medication name if present #}
                                                    {% if "diabetes" in med.medication.name|lower %}
                                                        Type 2 diabetes mellitus management
                                                    {% elif "Type 2 diabetes" in med.medication.name %}
                                                        {{ med.medication.name|cut:"Type 2 diabetes mellitus" }}
                                                    {% elif "hypertension" in med.medication.name|lower %}
                                                        Blood pressure management / Hypertension treatment
                                                    {% elif "Hypertension" in med.medication.name %}
                                                        {{ med.medication.name|cut:"Hypertension" }}
                                                    {% elif "cholesterol" in med.medication.name|lower %}
                                                        Cholesterol management / Lipid regulation
                                                    {% else %}
                                                        <span class="text-muted">
                                                            <i class="fa-solid fa-info-circle me-1"></i>
                                                            Medical indication not specified in available data
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {# Allergies Section - MANDATORY (always displayed) #}
                    {% if allergies and allergies|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-allergies" class="toggle-input" type="checkbox">
                            <label for="toggle-allergies" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-triangle-exclamation me-2"></i>
                                        <span>Allergies & Intolerances</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        {% if allergies and allergies|length > 0 %}
                                            <span class="clinical-badge populated">{{ allergies|count_allergy_observations }} Found</span>
                                        {% else %}
                                            <span class="clinical-badge mandatory">Mandatory</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    {% if allergies and allergies|length > 0 %}
                                        <p class="mb-3 text-muted">Allergies: {{ allergies|count_allergy_observations }} items found</p>
                                        
                                        {# PRIORITY 1: Check if allergies data has clinical_table structure (NEW 9-COLUMN FORMAT) #}
                                        {% if allergies.0.clinical_table %}
                                        {# NEW 9-COLUMN CLINICAL TABLE STRUCTURE from Enhanced CDA Processor #}
                                        <div class="clinical-table">
                                            {# Desktop Table Layout #}
                                            <div class="d-none d-md-block">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover clinical-data-table">
                                                        <thead class="table-warning">
                                                            <tr>
                                                                {% for header in allergies.0.clinical_table.headers %}
                                                                <th scope="col" class="clinical-header fw-bold">
                                                                    {% if header.type == 'allergen' %}
                                                                    <i class="fa-solid fa-bug me-2"></i>
                                                                    {% elif header.type == 'reaction' %}
                                                                    <i class="fa-solid fa-fire me-2"></i>
                                                                    {% elif header.type == 'severity' %}
                                                                    <i class="fa-solid fa-thermometer-full me-2"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar me-2"></i>
                                                                    {% elif header.type == 'status' %}
                                                                    <i class="fa-solid fa-info-circle me-2"></i>
                                                                    {% elif header.type == 'code' %}
                                                                    <i class="fa-solid fa-hashtag me-2"></i>
                                                                    {% else %}
                                                                    <i class="fa-solid fa-stethoscope me-2"></i>
                                                                    {% endif %}
                                                                    {{ header.label }}
                                                                </th>
                                                                {% endfor %}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for allergy in allergies %}
                                                            {% if allergy.clinical_table %}
                                                            {% for row in allergy.clinical_table.rows %}
                                                            <tr class="clinical-row">
                                                                {% for header in allergy.clinical_table.headers %}
                                                                {% with row.data|get_item:header.key as cell_data %}
                                                                <td class="clinical-cell">
                                                                    {% if header.primary %}
                                                                    <strong class="text-dark">
                                                                        {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                    </strong>
                                                                    {% else %}
                                                                    <div>
                                                                        <span class="text-muted">
                                                                            {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                        </span>
                                                                        
                                                                        {# Add clinical codes for manifestation and agent fields #}
                                                                        {% if header.type == 'reaction' and header.key == 'manifestation' and cell_data.code %}
                                                                            <div class="problem-code text-muted small">
                                                                                <i class="fa-solid fa-barcode me-1"></i>
                                                                                {{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </div>
                                                                        {% elif header.type == 'allergen' and header.key == 'agent' and cell_data.code %}
                                                                            <div class="problem-code text-muted small">
                                                                                <i class="fa-solid fa-barcode me-1"></i>
                                                                                {{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                </td>
                                                                {% endwith %}
                                                                {% endfor %}
                                                            </tr>
                                                            {% endfor %}
                                                            {% endif %}
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            
                                            {# Mobile Card Layout #}
                                            <div class="d-block d-md-none">
                                                <div class="clinical-cards-container">
                                                    {% for allergy in allergies %}
                                                    {% if allergy.clinical_table %}
                                                    {% for row in allergy.clinical_table.rows %}
                                                    <div class="card clinical-card mb-3 border-warning">
                                                        <div class="card-body">
                                                            {% for header in allergy.clinical_table.headers %}
                                                            {% with row.data|get_item:header.key as cell_data %}
                                                            <div class="clinical-field mb-2 {% if header.primary %}primary-field-mobile{% endif %}">
                                                                <div class="field-label d-flex align-items-center mb-1">
                                                                    <strong class="text-muted small">{{ header.label }}</strong>
                                                                    {% if header.type == 'allergen' %}
                                                                    <i class="fa-solid fa-bug ms-1 terminology-indicator text-muted" title="Allergen"></i>
                                                                    {% elif header.type == 'reaction' %}
                                                                    <i class="fa-solid fa-fire ms-1 terminology-indicator text-muted" title="Reaction"></i>
                                                                    {% elif header.type == 'severity' %}
                                                                    <i class="fa-solid fa-thermometer-full ms-1 terminology-indicator text-muted" title="Severity"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar ms-1 terminology-indicator text-muted" title="Date"></i>
                                                                    {% elif header.type == 'status' %}
                                                                    <i class="fa-solid fa-info-circle ms-1 terminology-indicator text-muted" title="Status"></i>
                                                                    {% elif header.type == 'code' %}
                                                                    <i class="fa-solid fa-hashtag ms-1 terminology-indicator text-muted" title="Medical Code"></i>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="field-value">
                                                                    {% if header.primary %}
                                                                    <strong class="text-dark">{% firstof cell_data.display_value cell_data.value "N/A" %}</strong>
                                                                    {% else %}
                                                                    <div>
                                                                        <span class="text-muted">{% firstof cell_data.display_value cell_data.value "N/A" %}</span>
                                                                        
                                                                        {# Add clinical codes for manifestation and agent fields in mobile layout #}
                                                                        {% if header.type == 'reaction' and header.key == 'manifestation' and cell_data.code %}
                                                                            <div class="problem-code text-muted small mt-1">
                                                                                <i class="fa-solid fa-barcode me-1"></i>
                                                                                {{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </div>
                                                                        {% elif header.type == 'allergen' and header.key == 'agent' and cell_data.code %}
                                                                            <div class="problem-code text-muted small mt-1">
                                                                                <i class="fa-solid fa-barcode me-1"></i>
                                                                                {{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% endwith %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        {# FALLBACK: Original card format for backward compatibility #}
                                        {% for allergy in allergies %}
                                        <div class="allergy-card mb-3 p-3 border rounded bg-white">
                                            <div class="d-flex align-items-start">
                                                <div class="allergy-icon me-3">
                                                    <i class="fa-solid fa-triangle-exclamation text-warning fs-4"></i>
                                                </div>
                                                <div class="allergy-details flex-grow-1">
                                                    <h6 class="allergy-name text-dark mb-1">
                                                        {% if allergy.allergen.name %}
                                                            {{ allergy.allergen.name }}
                                                        {% elif allergy.allergen.code.displayName %}
                                                            {{ allergy.allergen.code.displayName }}
                                                        {% else %}
                                                            Allergen (Code: {{ allergy.allergen.code.code|default:"Unknown" }})
                                                        {% endif %}
                                                    </h6>
                                                    {% if allergy.reaction %}
                                                    <div class="text-muted mb-1">
                                                        <i class="fa-solid fa-exclamation-circle me-1"></i>
                                                        <strong>Reaction:</strong> {{ allergy.reaction.name|default:allergy.reaction.code.displayName|default:"Not specified" }}
                                                    </div>
                                                    {% endif %}
                                                    {% if allergy.severity %}
                                                    <div class="text-muted">
                                                        <i class="fa-solid fa-thermometer-half me-1"></i>
                                                        <strong>Severity:</strong> {{ allergy.severity.name|default:allergy.severity.code.displayName|default:"Not specified" }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% else %}
                    {# Only show empty mandatory allergies section if no related extended section exists #}
                    {% if not hide_mandatory_allergies %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-allergies" class="toggle-input" type="checkbox">
                            <label for="toggle-allergies" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fas fa-exclamation-triangle fa-lg me-2" aria-hidden="true"></i>
                                        <span>Allergies and Intolerances</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge mandatory">Mandatory</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content">
                                <div class="clinical-content">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        No allergies or intolerances data available in the patient record.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    {# Procedures Section - MANDATORY #}
                    {% if procedures and procedures|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-procedures" class="toggle-input" type="checkbox">
                            <label for="toggle-procedures" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-user-md me-2"></i>
                                        <span>Medical Procedures</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge populated">{{ procedures|count_procedure_observations }} Found</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    <p class="mb-3 text-muted">Procedures: {{ procedures|count_procedure_observations }} items found</p>
                                    
                                    {# PRIORITY 1: Check if procedures data has clinical_table structure (NEW 3-COLUMN FORMAT) #}
                                    {% if procedures.0.clinical_table %}
                                        {# NEW 3-COLUMN CLINICAL TABLE STRUCTURE from Enhanced CDA Processor #}
                                        <div class="clinical-table">
                                            {# Desktop Table Layout #}
                                            <div class="d-none d-md-block">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover clinical-data-table">
                                                        <thead class="table-info">
                                                            <tr>
                                                                {% for header in procedures.0.clinical_table.headers %}
                                                                <th scope="col" class="clinical-header fw-bold">
                                                                    {% if header.type == 'procedure' %}
                                                                    <i class="fa-solid fa-user-md me-2"></i>
                                                                    {% elif header.type == 'target_site' %}
                                                                    <i class="fa-solid fa-location-dot me-2"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar me-2"></i>
                                                                    {% else %}
                                                                    <i class="fa-solid fa-stethoscope me-2"></i>
                                                                    {% endif %}
                                                                    {{ header.label }}
                                                                </th>
                                                                {% endfor %}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for procedure in procedures %}
                                                            {% if procedure.clinical_table %}
                                                            {% for row in procedure.clinical_table.rows %}
                                                            <tr class="clinical-row">
                                                                {% for header in procedure.clinical_table.headers %}
                                                                {% with row.data|get_item:header.key as cell_data %}
                                                                <td class="clinical-cell">
                                                                    {% if header.primary or header.type == 'procedure' %}
                                                                    <strong class="text-dark">
                                                                        {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                    </strong>
                                                                    {% else %}
                                                                    <div>
                                                                        <span class="text-muted">
                                                                            {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                        </span>
                                                                        
                                                                        {# Add clinical codes for procedure fields #}
                                                                        {% if header.type == 'procedure' and cell_data.code %}
                                                                        <div class="mt-1">
                                                                            <span class="badge bg-secondary text-white small">
                                                                                <i class="fa-solid fa-code me-1"></i>{{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </span>
                                                                        </div>
                                                                        {% endif %}
                                                                        
                                                                        {% if header.type == 'target_site' and cell_data.code %}
                                                                        <div class="mt-1">
                                                                            <span class="badge bg-info text-white small">
                                                                                <i class="fa-solid fa-location-dot me-1"></i>{{ cell_data.code }}
                                                                                {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                            </span>
                                                                        </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                </td>
                                                                {% endwith %}
                                                                {% endfor %}
                                                            </tr>
                                                            {% endfor %}
                                                            {% endif %}
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            
                                            {# Mobile Card Layout #}
                                            <div class="d-block d-md-none">
                                                <div class="clinical-cards-container">
                                                    {% for procedure in procedures %}
                                                    {% if procedure.clinical_table %}
                                                    {% for row in procedure.clinical_table.rows %}
                                                    <div class="card clinical-card mb-3 border-info">
                                                        <div class="card-body">
                                                            {% for header in procedure.clinical_table.headers %}
                                                            {% with row.data|get_item:header.key as cell_data %}
                                                            <div class="clinical-field mb-2 {% if header.primary or header.type == 'procedure' %}primary-field-mobile{% endif %}">
                                                                <div class="field-label d-flex align-items-center mb-1">
                                                                    <strong class="text-muted small">{{ header.label }}</strong>
                                                                    {% if header.type == 'procedure' %}
                                                                    <i class="fa-solid fa-user-md ms-1 terminology-indicator text-muted" title="Medical Procedure"></i>
                                                                    {% elif header.type == 'target_site' %}
                                                                    <i class="fa-solid fa-location-dot ms-1 terminology-indicator text-muted" title="Target Site"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar ms-1 terminology-indicator text-muted" title="Date"></i>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="field-value">
                                                                    <span class="{% if header.primary or header.type == 'procedure' %}fw-bold text-dark{% else %}text-muted{% endif %}">
                                                                        {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                    </span>
                                                                    
                                                                    {# Mobile clinical codes #}
                                                                    {% if cell_data.code %}
                                                                    <div class="clinical-codes-mobile mt-1">
                                                                        <span class="badge {% if header.type == 'procedure' %}bg-secondary{% elif header.type == 'target_site' %}bg-info{% else %}bg-light text-dark{% endif %} small">
                                                                            <i class="fa-solid fa-code me-1"></i>{{ cell_data.code }}
                                                                            {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                        </span>
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% endwith %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    
                                    {# FALLBACK: Display procedures in original card format if no clinical_table #}
                                    {% else %}
                                        {% for procedure in procedures %}
                                        <div class="procedure-card mb-3 p-3 border rounded bg-white">
                                            <div class="d-flex align-items-start">
                                                <div class="procedure-icon me-3">
                                                    <i class="fa-solid fa-user-md text-info fs-4"></i>
                                                </div>
                                                <div class="procedure-details flex-grow-1">
                                                    <h6 class="procedure-name text-dark mb-1">
                                                        {% if procedure.procedure.name %}
                                                            {{ procedure.procedure.name }}
                                                        {% elif procedure.procedure.code.displayName %}
                                                            {{ procedure.procedure.code.displayName }}
                                                        {% else %}
                                                            Procedure (Code: {{ procedure.procedure.code.code|default:"Unknown" }})
                                                        {% endif %}
                                                    </h6>
                                                    {% if procedure.statusCode.code %}
                                                    <div class="text-muted mb-1">
                                                        <i class="fa-solid fa-info-circle me-1"></i>
                                                        <strong>Status:</strong> {{ procedure.statusCode.code|title }}
                                                    </div>
                                                    {% endif %}
                                                    {% if procedure.effective_time.low_formatted %}
                                                    <div class="text-muted">
                                                        <i class="fa-solid fa-calendar me-1"></i>
                                                        <strong>Date:</strong> {{ procedure.effective_time.low_formatted }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    {# Only show empty mandatory procedures section if no related extended section exists #}
                    {% if not hide_mandatory_procedures %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-procedures" class="toggle-input" type="checkbox">
                            <label for="toggle-procedures" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-user-md me-2" aria-hidden="true"></i>
                                        <span>Medical Procedures</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge mandatory">Mandatory</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content">
                                <div class="clinical-content">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        No medical procedures data available in the patient record.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    {# Medical Devices Section - MANDATORY #}
                    {% if medical_devices and medical_devices|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-medical-devices" class="toggle-input" type="checkbox">
                            <label for="toggle-medical-devices" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-heartbeat me-2"></i>
                                        <span>Medical Devices</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge populated">{{ medical_devices|count_medical_device_observations }} Found</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    <p class="mb-3 text-muted">Medical Devices: {{ medical_devices|count_medical_device_observations }} items found</p>
                                    
                                    {# PRIORITY 1: Check if medical devices data has clinical_table structure (NEW 3-COLUMN FORMAT) #}
                                    {% if medical_devices.0.clinical_table %}
                                        {# NEW 3-COLUMN CLINICAL TABLE STRUCTURE from Enhanced CDA Processor #}
                                        <div class="clinical-table">
                                            {# Desktop Table Layout #}
                                            <div class="d-none d-md-block">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover clinical-data-table">
                                                        <thead class="table-info">
                                                            <tr>
                                                                {% for header in medical_devices.0.clinical_table.headers %}
                                                                <th scope="col" class="clinical-header fw-bold">
                                                                    {% if header.type == 'device' %}
                                                                    <i class="fa-solid fa-heartbeat me-2"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar me-2"></i>
                                                                    {% elif header.type == 'status' %}
                                                                    <i class="fa-solid fa-info-circle me-2"></i>
                                                                    {% else %}
                                                                    <i class="fa-solid fa-stethoscope me-2"></i>
                                                                    {% endif %}
                                                                    {{ header.label }}
                                                                </th>
                                                                {% endfor %}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for device in medical_devices %}
                                                            {% if device.clinical_table %}
                                                            {% for row in device.clinical_table.rows %}
                                                            <tr class="clinical-row">
                                                                {% for header in device.clinical_table.headers %}
                                                                {% with row.data|get_item:header.key as cell_data %}
                                                                <td class="clinical-cell">
                                                                    {% if header.primary or header.type == 'device' %}
                                                                    <div>
                                                                        <strong class="text-dark">
                                                                            {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                        </strong>
                                                                        
                                                                        {# Add SNOMED CT device codes below device type using medical problems pattern #}
                                                                        {% if header.type == 'device' and cell_data.device_code %}
                                                                        <div class="device-code text-muted small">
                                                                            <i class="fa-solid fa-barcode me-1"></i>
                                                                            {{ cell_data.device_code }}
                                                                            {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                        </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% else %}
                                                                    <div>
                                                                        <span class="text-muted">
                                                                            {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                        </span>
                                                                    </div>
                                                                    {% endif %}
                                                                </td>
                                                                {% endwith %}
                                                                {% endfor %}
                                                            </tr>
                                                            {% endfor %}
                                                            {% endif %}
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            
                                            {# Mobile Card Layout #}
                                            <div class="d-block d-md-none">
                                                <div class="clinical-cards-container">
                                                    {% for device in medical_devices %}
                                                    {% if device.clinical_table %}
                                                    {% for row in device.clinical_table.rows %}
                                                    <div class="card clinical-card mb-3 border-info">
                                                        <div class="card-body">
                                                            {% for header in device.clinical_table.headers %}
                                                            {% with row.data|get_item:header.key as cell_data %}
                                                            <div class="clinical-field mb-2 {% if header.primary or header.type == 'device' %}primary-field-mobile{% endif %}">
                                                                <div class="field-label d-flex align-items-center mb-1">
                                                                    <strong class="text-muted small">{{ header.label }}</strong>
                                                                    {% if header.type == 'device' %}
                                                                    <i class="fa-solid fa-heartbeat ms-1 terminology-indicator text-muted" title="Medical Device"></i>
                                                                    {% elif header.type == 'date' %}
                                                                    <i class="fa-solid fa-calendar ms-1 terminology-indicator text-muted" title="Date"></i>
                                                                    {% elif header.type == 'status' %}
                                                                    <i class="fa-solid fa-info-circle ms-1 terminology-indicator text-muted" title="Status"></i>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="field-value">
                                                                    <span class="{% if header.primary or header.type == 'device' %}fw-bold text-dark{% else %}text-muted{% endif %}">
                                                                        {% firstof cell_data.display_value cell_data.value "N/A" %}
                                                                    </span>
                                                                    
                                                                    {# Mobile device codes using medical problems pattern #}
                                                                    {% if header.type == 'device' and cell_data.device_code %}
                                                                    <div class="device-code text-muted small mt-1">
                                                                        <i class="fa-solid fa-barcode me-1"></i>
                                                                        {{ cell_data.device_code }}
                                                                        {% if cell_data.code_system %} ({{ cell_data.code_system }}){% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% endwith %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    
                                    {# FALLBACK: Display medical devices in original card format if no clinical_table #}
                                    {% else %}
                                        {% for device in medical_devices %}
                                        <div class="device-card mb-3 p-3 border rounded bg-white">
                                            <div class="d-flex align-items-start">
                                                <div class="device-icon me-3">
                                                    <i class="fa-solid fa-heartbeat text-info fs-4"></i>
                                                </div>
                                                <div class="device-details flex-grow-1">
                                                    <h6 class="device-name text-dark mb-1">
                                                        {% if device.device.name %}
                                                            {{ device.device.name }}
                                                        {% elif device.device.code.displayName %}
                                                            {{ device.device.code.displayName }}
                                                        {% else %}
                                                            Medical Device (Code: {{ device.device.code.code|default:"Unknown" }})
                                                        {% endif %}
                                                    </h6>
                                                    {% if device.statusCode.code %}
                                                    <div class="text-muted mb-1">
                                                        <i class="fa-solid fa-info-circle me-1"></i>
                                                        <strong>Status:</strong> {{ device.statusCode.code|title }}
                                                    </div>
                                                    {% endif %}
                                                    {% if device.effective_time.low_formatted %}
                                                    <div class="text-muted">
                                                        <i class="fa-solid fa-calendar me-1"></i>
                                                        <strong>Date:</strong> {{ device.effective_time.low_formatted }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    {# Only show empty mandatory medical devices section if no related extended section exists #}
                    {% if not hide_mandatory_devices %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-medical-devices" class="toggle-input" type="checkbox">
                            <label for="toggle-medical-devices" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-heartbeat me-2" aria-hidden="true"></i>
                                        <span>Medical Devices</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge mandatory">Mandatory</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content">
                                <div class="clinical-content">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        No medical device usage documented in the patient record.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    {# Vital Signs Section #}
                    {% if vital_signs and vital_signs|length > 0 %}
                    <div class="clinical-section">
                        <div class="collapsible-wrapper">
                            <input id="toggle-vital-signs" class="toggle-input" type="checkbox">
                            <label for="toggle-vital-signs" class="collapsible-label-title">
                                <div class="clinical-section-title-row">
                                    <div class="clinical-section-title">
                                        <i class="fa-solid fa-chart-line me-2"></i>
                                        <span>Vital Signs</span>
                                    </div>
                                    <div class="clinical-badge-container">
                                        <span class="clinical-badge populated">{{ vital_signs|length }} Found</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                            </label>
                            <div class="collapsible-content-title">
                                <div class="content-inner-title">
                                    <p class="mb-3 text-muted">Vital Signs: {{ vital_signs|length }} items found</p>
                                    {% for vital in vital_signs %}
                                    <div class="vital-card mb-3 p-3 border rounded bg-white">
                                        <h6 class="vital-name text-dark mb-2">
                                            {% if vital.vital.name %}
                                                {{ vital.vital.name }}
                                            {% elif vital.vital.code.displayName %}
                                                {{ vital.vital.code.displayName }}
                                            {% else %}
                                                Vital Sign (Code: {{ vital.vital.code.code|default:"Unknown" }})
                                            {% endif %}
                                        </h6>
                                        
                                        {# Value #}
                                        {% if vital.value %}
                                        <div class="text-muted mb-1">
                                            <i class="fa-solid fa-chart-line me-1"></i>
                                            <strong>Value:</strong> {{ vital.value }}
                                            {% if vital.unit %} {{ vital.unit }}{% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        {# Date Recorded #}
                                        {% if vital.effective_time.low_formatted %}
                                        <div class="text-muted">
                                            <i class="fa-solid fa-calendar me-1"></i>
                                            <strong>Recorded:</strong> {{ vital.effective_time.low_formatted }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
            
            {# ========================================= #}
            {# EXTENDED CLINICAL SECTIONS GROUP HEADER #}
            {# ========================================= #}
            {% if history_of_past_illness or immunizations or pregnancy_history or social_history or physical_findings or laboratory_results or advance_directives or additional_sections %}
            <div class="extended-clinical-group mt-4">
                <div class="group-header mb-3">
                    <h5 class="group-title">
                        <i class="fa-solid fa-plus-circle me-2 text-info"></i>
                                Extended Clinical Information
                            </h5>
                            <p class="group-subtitle text-muted mb-0">
                                Additional clinical data available in this patient summary
                            </p>
                        </div>
                    
                        {# History of Past Illness Section #}
                        {% if history_of_past_illness and history_of_past_illness|length > 0 %}
                        <div class="clinical-section">
                            <div class="collapsible-wrapper">
                                <input id="toggle-past-illness" class="toggle-input" type="checkbox">
                                <label for="toggle-past-illness" class="collapsible-label-title">
                                    <div class="clinical-section-title-row">
                                        <div class="clinical-section-title">
                                            <i class="fa-solid fa-history me-2"></i>
                                            <span>History of Past Illness</span>
                                        </div>
                                        <div class="clinical-badge-container">
                                            <span class="clinical-badge extended">{{ history_of_past_illness|length }} Found</span>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                                </label>
                                <div class="collapsible-content-title">
                                    <div class="content-inner-title">
                                        <p class="mb-3 text-muted">History of Past Illness: {{ history_of_past_illness|length }} closed/inactive conditions</p>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead class="table-warning">
                                                    <tr>
                                                        <th scope="col" class="fw-bold">Closed/Inactive Problem</th>
                                                        <th scope="col" class="fw-bold">Problem Type</th>
                                                        <th scope="col" class="fw-bold">Time</th>
                                                        <th scope="col" class="fw-bold">Problem Status</th>
                                                        <th scope="col" class="fw-bold">Health Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for illness in history_of_past_illness %}
                                                    <tr>
                                                        <td>
                                                            <div class="d-flex align-items-start">
                                                                <i class="fa-solid fa-file-medical text-warning me-2 mt-1"></i>
                                                                <div>
                                                                    <div class="fw-medium text-dark">{{ illness.problem_name }}</div>
                                                                    {% if illness.problem_code %}
                                                                    <small class="text-muted">
                                                                        <i class="fa-solid fa-code me-1"></i>
                                                                        {{ illness.problem_code }}
                                                                        {% if illness.problem_code_system %}
                                                                            <span class="badge bg-secondary ms-1">{{ illness.problem_code_system|slice:"-6:" }}</span>
                                                                        {% endif %}
                                                                    </small>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-info text-dark">{{ illness.problem_type }}</span>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <i class="fa-solid fa-calendar text-muted me-2"></i>
                                                                <span class="text-muted">{{ illness.time_period }}</span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            {% if illness.problem_status == 'Completed' %}
                                                                <span class="badge bg-success">{{ illness.problem_status }}</span>
                                                            {% elif illness.problem_status == 'Active' %}
                                                                <span class="badge bg-warning text-dark">{{ illness.problem_status }}</span>
                                                            {% elif illness.problem_status == 'Suspended' %}
                                                                <span class="badge bg-secondary">{{ illness.problem_status }}</span>
                                                            {% else %}
                                                                <span class="badge bg-light text-dark">{{ illness.problem_status }}</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            <div class="d-flex align-items-start">
                                                                <i class="fa-solid fa-heart-pulse text-success me-2 mt-1"></i>
                                                                <div>
                                                                    <div class="text-dark">{{ illness.health_status }}</div>
                                                                    {% if illness.health_status_code %}
                                                                    <small class="text-muted">
                                                                        <i class="fa-solid fa-code me-1"></i>
                                                                        {{ illness.health_status_code }}
                                                                        {% if illness.health_status_code_system %}
                                                                            <span class="badge bg-secondary ms-1">{{ illness.health_status_code_system|slice:"-6:" }}</span>
                                                                        {% endif %}
                                                                    </small>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        {# CTS Lookup Integration #}
                                        {% if history_of_past_illness %}
                                        <div class="mt-3 p-3 bg-light rounded">
                                            <h6 class="text-muted mb-2">
                                                <i class="fa-solid fa-search me-2"></i>
                                                Clinical Terminology Integration
                                            </h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <strong>Problem Codes:</strong>
                                                        {% for illness in history_of_past_illness %}
                                                            {% if illness.problem_code %}
                                                                <span class="badge bg-primary me-1">{{ illness.problem_code }}</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <strong>Health Status Codes:</strong>
                                                        {% for illness in history_of_past_illness %}
                                                            {% if illness.health_status_code %}
                                                                <span class="badge bg-success me-1">{{ illness.health_status_code }}</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    
                        {# Pregnancy History Section - Mobile-First Multi-Tab Design #}
                        {% if pregnancy_history %}
                        <div class="clinical-section">
                            <div class="collapsible-wrapper">
                                <input id="toggle-pregnancy-history" class="toggle-input" type="checkbox">
                                <label for="toggle-pregnancy-history" class="collapsible-label-title">
                                    <div class="clinical-section-title-row">
                                        <div class="clinical-section-title">
                                            <i class="fa-solid fa-baby me-2"></i>
                                            <span>History of Pregnancies</span>
                                        </div>
                                        <div class="clinical-badge-container">
                                            {% with total_count=0 %}
                                                {% if pregnancy_history.current_pregnancy %}
                                                    {% with total_count=total_count|add:1 %}{% endwith %}
                                                {% endif %}
                                                {% if pregnancy_history.previous_pregnancies %}
                                                    {% with total_count=total_count|add:pregnancy_history.previous_pregnancies|length %}{% endwith %}
                                                {% endif %}
                                                {% if pregnancy_history.pregnancy_overview %}
                                                    {% with total_count=total_count|add:pregnancy_history.pregnancy_overview|length %}{% endwith %}
                                                {% endif %}
                                                <span class="clinical-badge extended">
                                                    {% if pregnancy_history.current_pregnancy and pregnancy_history.previous_pregnancies and pregnancy_history.pregnancy_overview %}
                                                        Complete History Available
                                                    {% elif pregnancy_history.current_pregnancy %}
                                                        Current Pregnancy
                                                    {% elif pregnancy_history.previous_pregnancies %}
                                                        {{ pregnancy_history.previous_pregnancies|length }} Previous
                                                    {% elif pregnancy_history.pregnancy_overview %}
                                                        {{ pregnancy_history.pregnancy_overview|length }} Overview
                                                    {% else %}
                                                        Data Available
                                                    {% endif %}
                                                </span>
                                            {% endwith %}
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                                </label>
                                <div class="collapsible-content-title">
                                    <div class="content-inner-title">
                                        <p class="mb-3 text-muted">Comprehensive pregnancy history with current status and previous outcomes</p>
                                        
                                        {# Mobile-First Tab Navigation #}
                                        <div class="pregnancy-tabs-container">
                                            {# Tab Navigation Buttons - Mobile-First Design #}
                                            <div class="pregnancy-tab-nav" role="tablist">
                                                {% if pregnancy_history.current_pregnancy %}
                                                <button class="pregnancy-tab-btn active" 
                                                        id="current-tab-btn" 
                                                        data-tab="current-pregnancy" 
                                                        data-action="pregnancy-tab"
                                                        type="button" 
                                                        role="tab" 
                                                        aria-controls="current-pregnancy" 
                                                        aria-selected="true">
                                                    <i class="fa-solid fa-heartbeat me-2"></i>
                                                    <span class="tab-text">Current Status</span>
                                                    <span class="tab-indicator"></span>
                                                </button>
                                                {% endif %}
                                                
                                                {% if pregnancy_history.previous_pregnancies %}
                                                <button class="pregnancy-tab-btn {% if not pregnancy_history.current_pregnancy %}active{% endif %}" 
                                                        id="previous-tab-btn" 
                                                        data-tab="previous-pregnancies" 
                                                        data-action="pregnancy-tab"
                                                        type="button" 
                                                        role="tab" 
                                                        aria-controls="previous-pregnancies" 
                                                        {% if not pregnancy_history.current_pregnancy %}aria-selected="true"{% else %}aria-selected="false"{% endif %}>
                                                    <i class="fa-solid fa-history me-2"></i>
                                                    <span class="tab-text">Previous History</span>
                                                    <span class="tab-badge">{{ pregnancy_history.previous_pregnancies|length }}</span>
                                                    <span class="tab-indicator"></span>
                                                </button>
                                                {% endif %}
                                                
                                                {% if pregnancy_history.pregnancy_overview %}
                                                <button class="pregnancy-tab-btn {% if not pregnancy_history.current_pregnancy and not pregnancy_history.previous_pregnancies %}active{% endif %}" 
                                                        id="overview-tab-btn" 
                                                        data-tab="pregnancy-overview" 
                                                        data-action="pregnancy-tab"
                                                        type="button" 
                                                        role="tab" 
                                                        aria-controls="pregnancy-overview" 
                                                        {% if not pregnancy_history.current_pregnancy and not pregnancy_history.previous_pregnancies %}aria-selected="true"{% else %}aria-selected="false"{% endif %}>
                                                    <i class="fa-solid fa-chart-line me-2"></i>
                                                    <span class="tab-text">Overview</span>
                                                    <span class="tab-badge">{{ pregnancy_history.pregnancy_overview|length }}</span>
                                                    <span class="tab-indicator"></span>
                                                </button>
                                                {% endif %}
                                            </div>
                                            
                                            {# Tab Content Panels #}
                                            <div class="pregnancy-tab-content">
                                                {# Current Pregnancy Status Tab #}
                                                {% if pregnancy_history.current_pregnancy %}
                                                <div class="pregnancy-tab-pane active" 
                                                     id="current-pregnancy" 
                                                     role="tabpanel" 
                                                     aria-labelledby="current-tab-btn">
                                                    <div class="current-pregnancy-card">
                                                        <div class="pregnancy-status-header">
                                                            <h6 class="pregnancy-card-title">
                                                                <i class="fa-solid fa-baby-carriage me-2 text-primary"></i>
                                                                Current Pregnancy Status
                                                            </h6>
                                                        </div>
                                                        
                                                        <div class="row g-3 mt-2">
                                                            <div class="col-md-6">
                                                                <div class="pregnancy-info-card">
                                                                    <div class="info-label">
                                                                        <i class="fa-solid fa-calendar-check me-2"></i>
                                                                        Observation Date
                                                                    </div>
                                                                    <div class="info-value">
                                                                        {{ pregnancy_history.current_pregnancy.observation_date|default:"Not specified" }}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="col-md-6">
                                                                <div class="pregnancy-info-card">
                                                                    <div class="info-label">
                                                                        <i class="fa-solid fa-heartbeat me-2"></i>
                                                                        Pregnancy Status
                                                                    </div>
                                                                    <div class="info-value">
                                                                        <span class="status-badge pregnant">
                                                                            {{ pregnancy_history.current_pregnancy.pregnancy_status|default:"Active" }}
                                                                        </span>
                                                                        {% if pregnancy_history.current_pregnancy.pregnancy_status_code %}
                                                                        <small class="code-reference">
                                                                            <i class="fa-solid fa-code me-1"></i>
                                                                            {{ pregnancy_history.current_pregnancy.pregnancy_status_code }}
                                                                        </small>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="col-md-6">
                                                                <div class="pregnancy-info-card">
                                                                    <div class="info-label">
                                                                        <i class="fa-solid fa-calendar-days me-2"></i>
                                                                        Delivery Date Estimated
                                                                    </div>
                                                                    <div class="info-value">
                                                                        {% if pregnancy_history.current_pregnancy.delivery_date_estimated %}
                                                                            <span class="delivery-date">
                                                                                {{ pregnancy_history.current_pregnancy.delivery_date_estimated }}
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="text-muted">Not specified</span>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                
                                                {# History of Previous Pregnancies Tab #}
                                                {% if pregnancy_history.previous_pregnancies %}
                                                <div class="pregnancy-tab-pane {% if not pregnancy_history.current_pregnancy %}active{% endif %}" 
                                                     id="previous-pregnancies" 
                                                     role="tabpanel" 
                                                     aria-labelledby="previous-tab-btn">
                                                    <div class="previous-pregnancies-container">
                                                        <div class="pregnancy-status-header">
                                                            <h6 class="pregnancy-card-title">
                                                                <i class="fa-solid fa-clock-rotate-left me-2 text-info"></i>
                                                                History of Previous Pregnancies
                                                            </h6>
                                                            <p class="pregnancy-subtitle">
                                                                {{ pregnancy_history.previous_pregnancies|length }} previous pregnancy outcome(s) recorded
                                                            </p>
                                                        </div>
                                                        
                                                        <div class="table-responsive">
                                                            <table class="table table-hover pregnancy-history-table">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th scope="col">
                                                                            <i class="fa-solid fa-flag me-2"></i>Outcome
                                                                        </th>
                                                                        <th scope="col">
                                                                            <i class="fa-solid fa-hashtag me-2"></i>Number
                                                                        </th>
                                                                        <th scope="col">
                                                                            <i class="fa-solid fa-calendar me-2"></i>Outcome Date(s)
                                                                        </th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {% for pregnancy in pregnancy_history.previous_pregnancies %}
                                                                    <tr>
                                                                        <td>
                                                                            <div class="outcome-cell">
                                                                                {% if pregnancy.outcome == "Livebirth" %}
                                                                                    <i class="fa-solid fa-baby text-success me-2"></i>
                                                                                    <span class="outcome-badge livebirth">{{ pregnancy.outcome }}</span>
                                                                                {% elif pregnancy.outcome == "Termination of pregnancy" %}
                                                                                    <i class="fa-solid fa-times-circle text-warning me-2"></i>
                                                                                    <span class="outcome-badge termination">{{ pregnancy.outcome }}</span>
                                                                                {% elif pregnancy.outcome == "Stillbirth" %}
                                                                                    <i class="fa-solid fa-heart-crack text-danger me-2"></i>
                                                                                    <span class="outcome-badge stillbirth">{{ pregnancy.outcome }}</span>
                                                                                {% elif pregnancy.outcome == "Miscarriage" %}
                                                                                    <i class="fa-solid fa-exclamation-triangle text-warning me-2"></i>
                                                                                    <span class="outcome-badge miscarriage">{{ pregnancy.outcome }}</span>
                                                                                {% else %}
                                                                                    <i class="fa-solid fa-info-circle text-info me-2"></i>
                                                                                    <span class="outcome-badge other">{{ pregnancy.outcome }}</span>
                                                                                {% endif %}
                                                                                
                                                                                {% if pregnancy.outcome_code %}
                                                                                <div class="outcome-code">
                                                                                    <small class="text-muted">
                                                                                        <i class="fa-solid fa-code me-1"></i>
                                                                                        {{ pregnancy.outcome_code }}
                                                                                    </small>
                                                                                </div>
                                                                                {% endif %}
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <span class="pregnancy-number">{{ pregnancy.number }}</span>
                                                                        </td>
                                                                        <td>
                                                                            <div class="outcome-dates">
                                                                                {% if pregnancy.outcome_dates %}
                                                                                    {% for date in pregnancy.outcome_dates %}
                                                                                        <span class="outcome-date">{{ date }}</span>{% if not forloop.last %}, {% endif %}
                                                                                    {% endfor %}
                                                                                {% else %}
                                                                                    <span class="text-muted">Not specified</span>
                                                                                {% endif %}
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                
                                                {# Previous Pregnancies Overview Tab #}
                                                {% if pregnancy_history.pregnancy_overview %}
                                                <div class="pregnancy-tab-pane {% if not pregnancy_history.current_pregnancy and not pregnancy_history.previous_pregnancies %}active{% endif %}" 
                                                     id="pregnancy-overview" 
                                                     role="tabpanel" 
                                                     aria-labelledby="overview-tab-btn">
                                                    <div class="pregnancy-overview-container">
                                                        <div class="pregnancy-status-header">
                                                            <h6 class="pregnancy-card-title">
                                                                <i class="fa-solid fa-chart-pie me-2 text-primary"></i>
                                                                Previous Pregnancies Overview
                                                            </h6>
                                                            <p class="pregnancy-subtitle">
                                                                Comprehensive summary of all pregnancy outcomes
                                                            </p>
                                                        </div>
                                                        
                                                        <div class="overview-cards-grid">
                                                            {% for overview in pregnancy_history.pregnancy_overview %}
                                                            <div class="overview-card">
                                                                <div class="overview-header">
                                                                    <h7 class="overview-title">
                                                                        <i class="fa-solid fa-calendar-alt me-2"></i>
                                                                        {{ overview.outcome }}
                                                                    </h7>
                                                                    {% if overview.outcome_code %}
                                                                    <span class="overview-code">
                                                                        <i class="fa-solid fa-code me-1"></i>
                                                                        {{ overview.outcome_code }}
                                                                    </span>
                                                                    {% endif %}
                                                                </div>
                                                                
                                                                <div class="overview-content">
                                                                    <div class="overview-dates">
                                                                        <strong>Outcome Date(s):</strong>
                                                                        {% if overview.outcome_dates %}
                                                                            <div class="dates-list">
                                                                                {% for date in overview.outcome_dates %}
                                                                                    <span class="overview-date">{{ date }}</span>{% if not forloop.last %}<br>{% endif %}
                                                                                {% endfor %}
                                                                            </div>
                                                                        {% else %}
                                                                            <span class="text-muted">Not specified</span>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        {# Clinical Terminology Integration #}
                                        <div class="clinical-terminology-summary mt-4">
                                            <h6 class="clinical-terminology-title">
                                                <i class="fa-solid fa-code-branch me-2"></i>
                                                Clinical Terminology Integration
                                            </h6>
                                            <div class="terminology-codes pregnancy-terminology">
                                                {% if pregnancy_history.current_pregnancy and pregnancy_history.current_pregnancy.pregnancy_status_code %}
                                                <div class="code-group">
                                                    <strong>Current Pregnancy Codes:</strong>
                                                    <span class="code-badge pregnancy-code">{{ pregnancy_history.current_pregnancy.pregnancy_status_code }}</span>
                                                </div>
                                                {% endif %}
                                                
                                                {% if pregnancy_history.previous_pregnancies %}
                                                <div class="code-group">
                                                    <strong>Previous Pregnancy Outcome Codes:</strong>
                                                    {% for pregnancy in pregnancy_history.previous_pregnancies %}
                                                        {% if pregnancy.outcome_code %}
                                                            <span class="code-badge outcome-code">{{ pregnancy.outcome_code }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                                
                                                {% if pregnancy_history.pregnancy_overview %}
                                                <div class="code-group">
                                                    <strong>Overview Reference Codes:</strong>
                                                    {% for overview in pregnancy_history.pregnancy_overview %}
                                                        {% if overview.outcome_code %}
                                                            <span class="code-badge overview-code">{{ overview.outcome_code }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    
                        {# Immunizations/Vaccinations Section #}
                        {% if immunizations and immunizations|length > 0 %}
                        <div class="clinical-section">
                            <div class="collapsible-wrapper">
                                <input id="toggle-immunizations" class="toggle-input" type="checkbox">
                                <label for="toggle-immunizations" class="collapsible-label-title">
                                    <div class="clinical-section-title-row">
                                        <div class="clinical-section-title">
                                            <i class="fa-solid fa-syringe me-2"></i>
                                            <span>Immunizations & Vaccinations</span>
                                        </div>
                                        <div class="clinical-badge-container">
                                            <span class="clinical-badge extended"> {{ immunizations|length }} Found</span>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                                </label>
                                <div class="collapsible-content-title">
                                    <div class="content-inner-title">
                                        <p class="mb-3 text-muted">
                                            <i class="fa-solid fa-shield-virus me-2"></i>
                                            Vaccination history: {{ immunizations|length }} immunization records
                                        </p>
                                        
                                        {# Mobile-First Responsive Design: Cards on mobile, table on desktop #}
                                        
                                        {# Mobile Card Layout (default, hidden on lg+ screens) #}
                                        <div class="d-lg-none">
                                            <div class="immunization-cards">
                                                {% for immunization in immunizations %}
                                                <div class="card mb-3 border-{% if immunization.status == 'completed' %}success{% else %}warning{% endif %}">
                                                    <div class="card-header bg-{% if immunization.status == 'completed' %}success{% else %}warning{% endif %} bg-opacity-10">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <h6 class="card-title mb-1 fw-bold text-dark">
                                                                <i class="fa-solid fa-syringe me-2 text-primary"></i>
                                                                {{ immunization.vaccination_name }}
                                                            </h6>
                                                            <span class="badge bg-{% if immunization.status == 'completed' %}success{% else %}warning{% endif %}">
                                                                {{ immunization.status|default:'Unknown'|title }}
                                                            </span>
                                                        </div>
                                                        {% if immunization.brand_name %}
                                                        <p class="card-subtitle text-muted mb-0">
                                                            <i class="fa-solid fa-pills me-1"></i>
                                                            {{ immunization.brand_name }}
                                                        </p>
                                                        {% endif %}
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row g-2">
                                                            <div class="col-6">
                                                                <small class="text-muted">Date:</small>
                                                                <div class="fw-medium">
                                                                    {% if immunization.vaccination_date %}
                                                                        <i class="fa-solid fa-calendar me-1"></i>{{ immunization.vaccination_date }}
                                                                    {% else %}
                                                                        <span class="text-muted">Not specified</span>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <small class="text-muted">Dose Number:</small>
                                                                <div class="fw-medium">
                                                                    {% if immunization.dose_number %}
                                                                        <i class="fa-solid fa-hashtag me-1"></i>{{ immunization.dose_number }}
                                                                    {% else %}
                                                                        <span class="text-muted">N/A</span>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% if immunization.agent %}
                                                            <div class="col-12">
                                                                <small class="text-muted">Agent/Target Disease:</small>
                                                                <div class="fw-medium">
                                                                    <i class="fa-solid fa-virus me-1 text-danger"></i>
                                                                    {{ immunization.agent }}
                                                                    {% if immunization.agent_code %}
                                                                    <small class="text-muted ms-2">
                                                                        <i class="fa-solid fa-code me-1"></i>{{ immunization.agent_code }}
                                                                    </small>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                            {% if immunization.marketing_authorization_holder %}
                                                            <div class="col-12">
                                                                <small class="text-muted">Manufacturer:</small>
                                                                <div class="fw-medium">
                                                                    <i class="fa-solid fa-industry me-1"></i>{{ immunization.marketing_authorization_holder }}
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                            {% if immunization.batch_lot_number %}
                                                            <div class="col-6">
                                                                <small class="text-muted">Batch/Lot:</small>
                                                                <div class="fw-medium">
                                                                    <i class="fa-solid fa-barcode me-1"></i>{{ immunization.batch_lot_number }}
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                            {% if immunization.country_of_vaccination %}
                                                            <div class="col-6">
                                                                <small class="text-muted">Country:</small>
                                                                <div class="fw-medium">
                                                                    <i class="fa-solid fa-flag me-1"></i>{{ immunization.country_of_vaccination }}
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                            {% if immunization.administering_center %}
                                                            <div class="col-12">
                                                                <small class="text-muted">Administering Center:</small>
                                                                <div class="fw-medium">
                                                                    <i class="fa-solid fa-hospital me-1"></i>{{ immunization.administering_center }}
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                            {% if immunization.health_professional_name %}
                                                            <div class="col-12">
                                                                <small class="text-muted">Health Professional:</small>
                                                                <div class="fw-medium">
                                                                    <i class="fa-solid fa-user-md me-1"></i>{{ immunization.health_professional_name }}
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        {% if immunization.vaccination_code %}
                                                        <div class="mt-2 pt-2 border-top">
                                                            <small class="text-muted">
                                                                <i class="fa-solid fa-code me-1"></i>
                                                                Clinical Code: 
                                                                <span class="badge bg-info">{{ immunization.vaccination_code }}</span>
                                                                {% if immunization.vaccination_code_system %}
                                                                <span class="badge bg-secondary ms-1">{{ immunization.vaccination_code_system|slice:"-10:" }}</span>
                                                                {% endif %}
                                                            </small>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        
                                        {# Desktop Table Layout (visible on lg+ screens) #}
                                        <div class="d-none d-lg-block">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover">
                                                    <thead class="table-info">
                                                        <tr>
                                                            <th scope="col" class="fw-bold">Vaccination</th>
                                                            <th scope="col" class="fw-bold">Brand Name</th>
                                                            <th scope="col" class="fw-bold">Date</th>
                                                            <th scope="col" class="fw-bold">Agent/Target</th>
                                                            <th scope="col" class="fw-bold">Manufacturer</th>
                                                            <th scope="col" class="fw-bold">Dose #</th>
                                                            <th scope="col" class="fw-bold">Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for immunization in immunizations %}
                                                        <tr>
                                                            <td>
                                                                <div class="d-flex align-items-start">
                                                                    <i class="fa-solid fa-syringe text-primary me-2 mt-1"></i>
                                                                    <div>
                                                                        <div class="fw-medium text-dark">{{ immunization.vaccination_name }}</div>
                                                                        {% if immunization.vaccination_code %}
                                                                        <small class="text-muted">
                                                                            <i class="fa-solid fa-code me-1"></i>
                                                                            {{ immunization.vaccination_code }}
                                                                            {% if immunization.vaccination_code_system %}
                                                                                <span class="badge bg-secondary ms-1">{{ immunization.vaccination_code_system|slice:"-6:" }}</span>
                                                                            {% endif %}
                                                                        </small>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                {% if immunization.brand_name %}
                                                                    <div class="d-flex align-items-center">
                                                                        <i class="fa-solid fa-pills text-info me-2"></i>
                                                                        <span class="fw-medium">{{ immunization.brand_name }}</span>
                                                                    </div>
                                                                    {% if immunization.batch_lot_number %}
                                                                    <small class="text-muted">
                                                                        <i class="fa-solid fa-barcode me-1"></i>Lot: {{ immunization.batch_lot_number }}
                                                                    </small>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">Not specified</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if immunization.vaccination_date %}
                                                                    <div class="d-flex align-items-center">
                                                                        <i class="fa-solid fa-calendar text-muted me-2"></i>
                                                                        <span>{{ immunization.vaccination_date }}</span>
                                                                    </div>
                                                                {% else %}
                                                                    <span class="text-muted">Not specified</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if immunization.agent %}
                                                                    <div>
                                                                        <div class="fw-medium">{{ immunization.agent }}</div>
                                                                        {% if immunization.agent_code %}
                                                                        <small class="text-muted">
                                                                            <i class="fa-solid fa-code me-1"></i>{{ immunization.agent_code }}
                                                                        </small>
                                                                        {% endif %}
                                                                    </div>
                                                                {% else %}
                                                                    <span class="text-muted">Not specified</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if immunization.marketing_authorization_holder %}
                                                                    <div class="d-flex align-items-center">
                                                                        <i class="fa-solid fa-industry text-muted me-2"></i>
                                                                        <small>{{ immunization.marketing_authorization_holder }}</small>
                                                                    </div>
                                                                {% else %}
                                                                    <span class="text-muted">Not specified</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if immunization.dose_number %}
                                                                    <span class="badge bg-primary">{{ immunization.dose_number }}</span>
                                                                {% else %}
                                                                    <span class="text-muted">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-{% if immunization.status == 'completed' %}success{% else %}warning{% endif %}">
                                                                    {{ immunization.status|default:'Unknown'|title }}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            {# Additional details collapsed section for desktop #}
                                            <div class="mt-3">
                                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#immunization-details" aria-expanded="false" aria-controls="immunization-details">
                                                    <i class="fa-solid fa-info-circle me-1"></i>
                                                    Show Additional Details
                                                </button>
                                                <div class="collapse mt-2" id="immunization-details">
                                                    <div class="card card-body bg-light">
                                                        <div class="row">
                                                            {% for immunization in immunizations %}
                                                            <div class="col-md-6 mb-3">
                                                                <h6 class="fw-bold">{{ immunization.vaccination_name }}</h6>
                                                                <ul class="list-unstyled small">
                                                                    {% if immunization.administering_center %}
                                                                    <li><i class="fa-solid fa-hospital me-2"></i><strong>Center:</strong> {{ immunization.administering_center }}</li>
                                                                    {% endif %}
                                                                    {% if immunization.health_professional_name %}
                                                                    <li><i class="fa-solid fa-user-md me-2"></i><strong>Provider:</strong> {{ immunization.health_professional_name }}</li>
                                                                    {% endif %}
                                                                    {% if immunization.country_of_vaccination %}
                                                                    <li><i class="fa-solid fa-flag me-2"></i><strong>Country:</strong> {{ immunization.country_of_vaccination }}</li>
                                                                    {% endif %}
                                                                </ul>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {# Clinical Terminology Integration #}
                                        <div class="mt-3 p-3 bg-light rounded">
                                            <h6 class="text-muted mb-2">
                                                <i class="fa-solid fa-search me-2"></i>
                                                Clinical Terminology Integration
                                            </h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <strong>Vaccination Codes:</strong>
                                                        {% for immunization in immunizations %}
                                                            {% if immunization.vaccination_code %}
                                                                <span class="badge bg-info me-1">{{ immunization.vaccination_code }}</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <strong>Agent Codes:</strong>
                                                        {% for immunization in immunizations %}
                                                            {% if immunization.agent_code %}
                                                                <span class="badge bg-danger me-1">{{ immunization.agent_code }}</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    
                        {# Pregnancy History Section #}
                        {% if pregnancy_history and pregnancy_history|length > 0 %}
                        <div class="clinical-section">
                            <div class="collapsible-wrapper">
                                <input id="toggle-pregnancy-history" class="toggle-input" type="checkbox">
                                <label for="toggle-pregnancy-history" class="collapsible-label-title">
                                    <div class="clinical-section-title-row">
                                        <div class="clinical-section-title">
                                            <i class="fa-solid fa-baby me-2"></i>
                                            <span>Pregnancy History</span>
                                        </div>
                                        <div class="clinical-badge-container">
                                            <span class="clinical-badge extended">{{ pregnancy_history|length }} Found</span>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                                </label>
                                <div class="collapsible-content-title">
                                    <div class="content-inner-title">
                                        <p class="mb-3 text-muted">Pregnancy Information: {{ pregnancy_history|length }} items found</p>
                                        {% for pregnancy in pregnancy_history %}
                                        <div class="pregnancy-card mb-3 p-3 border rounded bg-white">
                                            <h6 class="pregnancy-title text-dark mb-2">
                                                {% if pregnancy.name %}
                                                    {{ pregnancy.name }}
                                                {% else %}
                                                    Pregnancy Record
                                                {% endif %}
                                            </h6>
                                            {% if pregnancy.estimated_delivery_date %}
                                            <div class="text-muted mb-1">
                                                <i class="fa-solid fa-calendar me-1"></i>
                                                <strong>Expected Delivery:</strong> {{ pregnancy.estimated_delivery_date }}
                                            </div>
                                            {% endif %}
                                            {% if pregnancy.status %}
                                            <div class="text-muted">
                                                <i class="fa-solid fa-info-circle me-1"></i>
                                                <strong>Status:</strong> {{ pregnancy.status }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    
                        {# Social History Section #}
                        {% if social_history and social_history|length > 0 %}
                        <div class="clinical-section">
                            <div class="collapsible-wrapper">
                                <input id="toggle-social-history" class="toggle-input" type="checkbox">
                                <label for="toggle-social-history" class="collapsible-label-title">
                                    <div class="clinical-section-title-row">
                                        <div class="clinical-section-title">
                                            <i class="fa-solid fa-users me-2"></i>
                                            <span>Social History</span>
                                        </div>
                                        <div class="clinical-badge-container">
                                            <span class="clinical-badge extended">{{ social_history|length }} Found</span>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                                </label>
                                <div class="collapsible-content-title">
                                    <div class="content-inner-title">
                                        <p class="mb-3 text-muted">Social History: {{ social_history|length }} observations found</p>
                                        
                                        {# Professional Social History Table #}
                                        <div class="social-history-table-container bg-white border rounded-3 shadow-sm overflow-hidden">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover mb-0 social-history-table">
                                                    <thead class="table-primary">
                                                        <tr>
                                                            <th scope="col" class="fw-bold">
                                                                <i class="fa-solid fa-eye me-2"></i>Observation Type
                                                            </th>
                                                            <th scope="col" class="fw-bold">
                                                                <i class="fa-solid fa-chart-line me-2"></i>Observation Value
                                                            </th>
                                                            <th scope="col" class="fw-bold">
                                                                <i class="fa-solid fa-calendar me-2"></i>Observation Time
                                                            </th>
                                                            <th scope="col" class="fw-bold">
                                                                <i class="fa-solid fa-code me-2"></i>Clinical Code
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for social_item in social_history %}
                                                        <tr>
                                                            <td class="social-observation-type">
                                                                <div class="clinical-field-content">
                                                                    <strong>{{ social_item.observation_type|default:"Social History Observation" }}</strong>
                                                                    {% if social_item.status %}
                                                                        <small class="text-muted d-block">Status: {{ social_item.status }}</small>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                            <td class="social-observation-value">
                                                                <div class="clinical-field-content">
                                                                    {% if social_item.observation_value %}
                                                                        <span class="clinical-value">{{ social_item.observation_value }}</span>
                                                                    {% else %}
                                                                        <span class="text-muted">No value recorded</span>
                                                                    {% endif %}
                                                                    {% if social_item.value_numeric and social_item.value_unit %}
                                                                        <small class="text-muted d-block">
                                                                            Numeric: {{ social_item.value_numeric }} {{ social_item.value_unit }}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                            <td class="social-observation-time">
                                                                <div class="clinical-field-content">
                                                                    {% if social_item.observation_time %}
                                                                        <span class="clinical-time">{{ social_item.observation_time }}</span>
                                                                    {% else %}
                                                                        <span class="text-muted">Time not specified</span>
                                                                    {% endif %}
                                                                    {% if social_item.effective_time_low or social_item.effective_time_high %}
                                                                        <small class="text-muted d-block">
                                                                            {% if social_item.effective_time_low %}From: {{ social_item.effective_time_low }}{% endif %}
                                                                            {% if social_item.effective_time_high %} To: {{ social_item.effective_time_high }}{% endif %}
                                                                        </small>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                            <td class="social-clinical-codes">
                                                                <div class="clinical-field-content">
                                                                    {% if social_item.observation_code %}
                                                                        <div class="clinical-terminology-summary">
                                                                            <span class="medical-code-badge">
                                                                                <i class="fa-solid fa-tag me-1"></i>
                                                                                <code>{{ social_item.observation_code }}</code>
                                                                            </span>
                                                                            {% if social_item.observation_code_system %}
                                                                                <small class="text-muted d-block">
                                                                                    System: {{ social_item.observation_code_system }}
                                                                                </small>
                                                                            {% endif %}
                                                                        </div>
                                                                    {% else %}
                                                                        <span class="text-muted">No coding available</span>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        
                                        {# Clinical Terminology Summary for Social History #}
                                        <div class="clinical-terminology-summary mt-3 p-3 bg-light border rounded">
                                            <h6 class="terminology-title mb-2">
                                                <i class="fa-solid fa-code-branch me-2"></i>Clinical Terminology Summary
                                            </h6>
                                            <div class="terminology-stats">
                                                {% with coded_observations=social_history|length %}
                                                <span class="terminology-badge coded">
                                                    <i class="fa-solid fa-check-circle me-1"></i>
                                                    {{ coded_observations }} Coded Observation{{ coded_observations|pluralize }}
                                                </span>
                                                {% endwith %}
                                                <small class="terminology-note text-muted d-block mt-1">
                                                    Social history observations with standardized clinical terminology for CTS integration
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    
                        {# Physical Findings Section #}
                        {% if physical_findings and physical_findings|length > 0 %}
                        <div class="clinical-section">
                            <div class="collapsible-wrapper">
                                <input id="toggle-physical-findings" class="toggle-input" type="checkbox">
                                <label for="toggle-physical-findings" class="collapsible-label-title">
                                    <div class="clinical-section-title-row">
                                        <div class="clinical-section-title">
                                            <i class="fa-solid fa-stethoscope me-2"></i>
                                            <span>Physical Findings</span>
                                        </div>
                                        <div class="clinical-badge-container">
                                            <span class="clinical-badge extended">{{ physical_findings|length }} Found</span>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                                </label>
                                <div class="collapsible-content-title">
                                    <div class="content-inner-title">
                                        <p class="mb-3 text-muted">Physical Findings: {{ physical_findings|length }} observations found</p>
                                        
                                        {# Professional Physical Findings Table #}
                                        <div class="table-responsive mb-4">
                                            <table class="table table-striped table-hover clinical-data-table">
                                                <caption class="visually-hidden">Data table</caption>
                                                <thead class="table-light">
                                                    <tr>
                                                        <th scope="col" class="clinical-table-header">
                                                            <i class="fa-solid fa-eye me-1" aria-hidden="true"></i>
                                                            Observation Type
                                                        </th>
                                                        <th scope="col" class="clinical-table-header">
                                                            <i class="fa-solid fa-chart-line me-1" aria-hidden="true"></i>
                                                            Observation Value
                                                        </th>
                                                        <th scope="col" class="clinical-table-header">
                                                            <i class="fa-solid fa-clock me-1" aria-hidden="true"></i>
                                                            Observation Time
                                                        </th>
                                                        <th scope="col" class="clinical-table-header">
                                                            <i class="fa-solid fa-code me-1" aria-hidden="true"></i>
                                                            Clinical Code
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for physical_item in physical_findings %}
                                                    <tr>
                                                        <td class="physical-observation-type">
                                                            <div class="clinical-field-content">
                                                                <strong>{{ physical_item.observation_type|default:"Physical Finding" }}</strong>
                                                                {% if physical_item.status %}
                                                                    <small class="text-muted d-block">Status: {{ physical_item.status }}</small>
                                                                {% endif %}
                                                                {% if physical_item.organizer_type and physical_item.organizer_type != physical_item.observation_type %}
                                                                    <small class="text-info d-block">Group: {{ physical_item.organizer_type }}</small>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                        <td class="physical-observation-value">
                                                            <div class="clinical-field-content">
                                                                {% if physical_item.observation_value %}
                                                                    <span class="clinical-value">{{ physical_item.observation_value }}</span>
                                                                    {% if physical_item.value_numeric and physical_item.value_unit %}
                                                                        <small class="text-muted d-block">Numeric: {{ physical_item.value_numeric }} {{ physical_item.value_unit }}</small>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">No value recorded</span>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                        <td class="physical-observation-time">
                                                            <div class="clinical-field-content">
                                                                {% if physical_item.observation_time %}
                                                                    <span class="clinical-time">{{ physical_item.observation_time }}</span>
                                                                    {% if physical_item.effective_time and physical_item.effective_time != physical_item.observation_time %}
                                                                        <small class="text-muted d-block">From: {{ physical_item.effective_time }}</small>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">Time not specified</span>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                        <td class="physical-clinical-code">
                                                            <div class="clinical-field-content">
                                                                {% if physical_item.observation_code %}
                                                                    <div class="clinical-code-badge">
                                                                        <i class="fa-solid fa-hashtag me-1" aria-hidden="true"></i>
                                                                        <code>{{ physical_item.observation_code }}</code>
                                                                    </div>
                                                                    {% if physical_item.observation_code_system %}
                                                                        <small class="text-muted d-block">System: {{ physical_item.observation_code_system }}</small>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">No code available</span>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        {# Clinical Terminology Summary for Physical Findings #}
                                        <div class="clinical-terminology-summary mt-4">
                                            <h6 class="clinical-summary-title">
                                                <i class="fa-solid fa-code-branch me-2" aria-hidden="true"></i>
                                                Clinical Terminology Summary
                                            </h6>
                                            <div class="terminology-summary-content">
                                                {% with coded_observations=physical_findings|length %}
                                                <div class="summary-stat">
                                                    <i class="fa-solid fa-chart-bar me-1" aria-hidden="true"></i>
                                                    <strong>{{ coded_observations }} Coded Observations</strong>
                                                </div>
                                                {% endwith %}
                                                <small class="terminology-note text-muted d-block mt-1">
                                                    Physical findings with standardized clinical terminology for CTS integration
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    
                        {# Coded Results Section #}
                        {% if coded_results.blood_group or coded_results.diagnostic_results %}
                        <div class="clinical-section">
                            <div class="collapsible-wrapper">
                                <input id="toggle-coded-results" class="toggle-input" type="checkbox">
                                <label for="toggle-coded-results" class="collapsible-label-title">
                                    <div class="clinical-section-title-row">
                                        <div class="clinical-section-title">
                                            <i class="fa-solid fa-vial me-2"></i>
                                            <span>Coded Results</span>
                                        </div>
                                        <div class="clinical-badge-container">
                                            <span class="clinical-badge extended">
                                                {% with total_blood_group=coded_results.blood_group|length total_diagnostic=coded_results.diagnostic_results|length %}
                                                    {% if total_blood_group > 0 and total_diagnostic > 0 %}
                                                         {{ total_blood_group|add:total_diagnostic }} Found
                                                    {% elif total_blood_group > 0 %}
                                                         {{ total_blood_group }} Blood Group
                                                    {% elif total_diagnostic > 0 %}
                                                         {{ total_diagnostic }} Diagnostic
                                                    {% endif %}
                                                {% endwith %}
                                            </span>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                                </label>
                                <div class="collapsible-content-title">
                                    <div class="content-inner-title">
                                        <p class="mb-3 text-muted">
                                            Coded Results: 
                                            {% with total_blood_group=coded_results.blood_group|length total_diagnostic=coded_results.diagnostic_results|length %}
                                                {% if total_blood_group > 0 %}{{ total_blood_group }} blood group{% endif %}
                                                {% if total_blood_group > 0 and total_diagnostic > 0 %} + {% endif %}
                                                {% if total_diagnostic > 0 %}{{ total_diagnostic }} diagnostic result{{ total_diagnostic|pluralize }}{% endif %} found
                                            {% endwith %}
                                        </p>
                                        
                                        {# Tabbed Interface for Blood Group and Diagnostic Results #}
                                        <div class="clinical-tabs-container">
                                            <!-- Tab Navigation -->
                                            <ul class="nav nav-tabs clinical-tabs" id="codedResultsTabs" role="tablist">
                                                {% if coded_results.blood_group and coded_results.blood_group|length > 0 %}
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link clinical-tab-link active" id="blood-group-tab" data-bs-toggle="tab" data-bs-target="#blood-group-content" type="button" role="tab" aria-controls="blood-group-content" aria-selected="true">
                                                        <i class="fa-solid fa-droplet me-2"></i>
                                                        <span class="tab-label">Blood Group</span>
                                                        <span class="badge bg-primary ms-2">{{ coded_results.blood_group|length }}</span>
                                                    </button>
                                                </li>
                                                {% endif %}
                                                {% if coded_results.diagnostic_results and coded_results.diagnostic_results|length > 0 %}
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link clinical-tab-link{% if not coded_results.blood_group or coded_results.blood_group|length == 0 %} active{% endif %}" 
                                                            id="diagnostic-results-tab" data-bs-toggle="tab" data-bs-target="#diagnostic-results-content" type="button" role="tab" aria-controls="diagnostic-results-content" 
                                                            aria-selected="{% if not coded_results.blood_group or coded_results.blood_group|length == 0 %}true{% else %}false{% endif %}">
                                                        <i class="fa-solid fa-chart-line me-2"></i>
                                                        <span class="tab-label">Diagnostic Results</span>
                                                        <span class="badge bg-primary ms-2">{{ coded_results.diagnostic_results|length }}</span>
                                                    </button>
                                                </li>
                                                {% endif %}
                                            </ul>
                                            
                                            <!-- Tab Content -->
                                            <div class="tab-content clinical-tab-content" id="codedResultsTabContent">
                                                
                                                {# Blood Group Tab #}
                                                {% if coded_results.blood_group and coded_results.blood_group|length > 0 %}
                                                <div class="tab-pane fade show active" id="blood-group-content" role="tabpanel" aria-labelledby="blood-group-tab">
                                                    <div class="tab-inner-content">
                                                        <h6 class="clinical-subsection-title">
                                                            <i class="fa-solid fa-droplet me-2"></i>Blood Group Results
                                                        </h6>
                                                        
                                                        {# Blood Group Table #}
                                                        <div class="clinical-data-table-container bg-white border rounded-3 shadow-sm overflow-hidden">
                                                            <div class="table-responsive">
                                                                <table class="table table-striped table-hover mb-0 clinical-data-table">
                                                                    <thead class="table-primary">
                                                                        <tr>
                                                                            <th scope="col" class="fw-bold">Diagnostic Date</th>
                                                                            <th scope="col" class="fw-bold">Blood Group</th>
                                                                            <th scope="col" class="fw-bold">Test Type</th>
                                                                            <th scope="col" class="fw-bold">Clinical Code</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for blood_group in coded_results.blood_group %}
                                                                        <tr>
                                                                            <td>
                                                                                <span class="clinical-date">{{ blood_group.diagnostic_date|default:"Not specified" }}</span>
                                                                            </td>
                                                                            <td>
                                                                                <strong class="blood-group-value">{{ blood_group.blood_group|default:"Not determined" }}</strong>
                                                                                {% if blood_group.status %}
                                                                                <span class="status-badge badge bg-success ms-2">{{ blood_group.status|title }}</span>
                                                                                {% endif %}
                                                                            </td>
                                                                            <td>
                                                                                <span class="test-type">{{ blood_group.test_display|default:blood_group.test_code|default:"Blood typing" }}</span>
                                                                            </td>
                                                                            <td>
                                                                                {% if blood_group.blood_group_code %}
                                                                                <div class="code-info">
                                                                                    <span class="clinical-code">
                                                                                        <i class="fa-solid fa-hashtag me-1"></i>
                                                                                        <code>{{ blood_group.blood_group_code }}</code>
                                                                                    </span>
                                                                                    {% if blood_group.blood_group_system %}
                                                                                    <small class="code-system text-muted d-block">System: {{ blood_group.blood_group_system }}</small>
                                                                                    {% endif %}
                                                                                </div>
                                                                                {% else %}
                                                                                <span class="text-muted">No code available</span>
                                                                                {% endif %}
                                                                            </td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                
                                                {# Diagnostic Results Tab #}
                                                {% if coded_results.diagnostic_results and coded_results.diagnostic_results|length > 0 %}
                                                <div class="tab-pane fade{% if not coded_results.blood_group or coded_results.blood_group|length == 0 %} show active{% endif %}" 
                                                     id="diagnostic-results-content" role="tabpanel" aria-labelledby="diagnostic-results-tab">
                                                    <div class="tab-inner-content">
                                                        <h6 class="clinical-subsection-title">
                                                            <i class="fa-solid fa-chart-line me-2"></i>Diagnostic Results
                                                        </h6>
                                                        
                                                        {# Diagnostic Results Table #}
                                                        <div class="clinical-data-table-container bg-white border rounded-3 shadow-sm overflow-hidden">
                                                            <div class="table-responsive">
                                                                <table class="table table-striped table-hover mb-0 clinical-data-table">
                                                                    <thead class="table-primary">
                                                                        <tr>
                                                                            <th scope="col" class="fw-bold">Diagnostic Date</th>
                                                                            <th scope="col" class="fw-bold">Result Type</th>
                                                                            <th scope="col" class="fw-bold">Result Value</th>
                                                                            <th scope="col" class="fw-bold">Performer Reporter</th>
                                                                            <th scope="col" class="fw-bold">Comment</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for result in coded_results.diagnostic_results %}
                                                                        <tr>
                                                                            <td>
                                                                                <span class="clinical-date">{{ result.diagnostic_date|default:"Not specified" }}</span>
                                                                            </td>
                                                                            <td>
                                                                                <strong class="result-type">{{ result.result_type|default:"Diagnostic test" }}</strong>
                                                                                {% if result.status %}
                                                                                <span class="status-badge badge bg-success ms-2">{{ result.status|title }}</span>
                                                                                {% endif %}
                                                                                {% if result.result_code %}
                                                                                <div class="code-info mt-1">
                                                                                    <small class="clinical-code">
                                                                                        <i class="fa-solid fa-hashtag me-1"></i>
                                                                                        <code>{{ result.result_code }}</code>
                                                                                    </small>
                                                                                </div>
                                                                                {% endif %}
                                                                            </td>
                                                                            <td>
                                                                                {% if result.result_value %}
                                                                                <span class="result-value">{{ result.result_value }}</span>
                                                                                {% if result.interpretation %}
                                                                                <span class="interpretation-badge badge bg-info ms-2">{{ result.interpretation }}</span>
                                                                                {% endif %}
                                                                                {% if result.reference_range %}
                                                                                <small class="reference-range text-muted d-block">Range: {{ result.reference_range }}</small>
                                                                                {% endif %}
                                                                                {% else %}
                                                                                <span class="text-muted">No value recorded</span>
                                                                                {% endif %}
                                                                            </td>
                                                                            <td>
                                                                                {% if result.performer_reporter %}
                                                                                <div class="performer-info">
                                                                                    <strong>{{ result.performer_reporter }}</strong>
                                                                                    {% if result.performer_organization %}
                                                                                    <small class="organization text-muted d-block">{{ result.performer_organization }}</small>
                                                                                    {% endif %}
                                                                                </div>
                                                                                {% elif result.author_name %}
                                                                                <div class="author-info">
                                                                                    <strong>{{ result.author_name }}</strong>
                                                                                    {% if result.author_organization %}
                                                                                    <small class="organization text-muted d-block">{{ result.author_organization }}</small>
                                                                                    {% endif %}
                                                                                    {% if result.author_time %}
                                                                                    <small class="author-time text-muted d-block">{{ result.author_time }}</small>
                                                                                    {% endif %}
                                                                                </div>
                                                                                {% else %}
                                                                                <span class="text-muted">Not specified</span>
                                                                                {% endif %}
                                                                            </td>
                                                                            <td>
                                                                                {% if result.comment %}
                                                                                <span class="comment">{{ result.comment }}</span>
                                                                                {% else %}
                                                                                <span class="text-muted">No comment</span>
                                                                                {% endif %}
                                                                            </td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            {# Clinical Terminology Summary for Coded Results #}
                                            <div class="clinical-terminology-summary mt-4">
                                                <h6 class="terminology-title">
                                                    <i class="fa-solid fa-code me-2"></i>Clinical Terminology Summary
                                                </h6>
                                                <div class="terminology-content bg-light p-3 rounded">
                                                    {% with total_blood_group=coded_results.blood_group|length total_diagnostic=coded_results.diagnostic_results|length %}
                                                    <div class="terminology-stats">
                                                        <i class="fa-solid fa-chart-bar me-1" aria-hidden="true"></i>
                                                        <strong>{{ total_blood_group|add:total_diagnostic }} Coded Results</strong>
                                                        {% if total_blood_group > 0 %} ({{ total_blood_group }} Blood Group{% endif %}
                                                        {% if total_blood_group > 0 and total_diagnostic > 0 %}, {% endif %}
                                                        {% if total_diagnostic > 0 %}{{ total_diagnostic }} Diagnostic){% endif %}
                                                    </div>
                                                    {% endwith %}
                                                    <small class="terminology-note text-muted d-block mt-1">
                                                        Laboratory and diagnostic results with standardized clinical terminology for CTS integration
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    
                        {# Laboratory Results Section #}
                        {% if laboratory_results and laboratory_results|length > 0 %}
                        <div class="clinical-section">
                            <div class="collapsible-wrapper">
                                <input id="toggle-laboratory-results" class="toggle-input" type="checkbox">
                                <label for="toggle-laboratory-results" class="collapsible-label-title">
                                    <div class="clinical-section-title-row">
                                        <div class="clinical-section-title">
                                            <i class="fa-solid fa-flask me-2"></i>
                                            <span>Laboratory Results</span>
                                        </div>
                                        <div class="clinical-badge-container">
                                            <span class="clinical-badge extended">{{ laboratory_results|length }} Found</span>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                                </label>
                                <div class="collapsible-content-title">
                                    <div class="content-inner-title">
                                        <p class="mb-3 text-muted">Lab Results: {{ laboratory_results|length }} items found</p>
                                        {% for result in laboratory_results %}
                                        <div class="lab-result-card mb-3 p-3 border rounded bg-white">
                                            <h6 class="lab-test-name text-dark mb-2">
                                                {% if result.name %}
                                                    {{ result.name }}
                                                {% elif result.code.displayName %}
                                                    {{ result.code.displayName }}
                                                {% else %}
                                                    Laboratory Test
                                                {% endif %}
                                            </h6>
                                            {% if result.value %}
                                            <div class="text-muted mb-1">
                                                <i class="fa-solid fa-chart-bar me-1"></i>
                                                <strong>Result:</strong> {{ result.value }}
                                                {% if result.unit %} {{ result.unit }}{% endif %}
                                            </div>
                                            {% endif %}
                                            {% if result.reference_range %}
                                            <div class="text-muted mb-1">
                                                <i class="fa-solid fa-ruler me-1"></i>
                                                <strong>Reference Range:</strong> {{ result.reference_range }}
                                            </div>
                                            {% endif %}
                                            {% if result.effective_time %}
                                            <div class="text-muted">
                                                <i class="fa-solid fa-calendar me-1"></i>
                                                <strong>Date:</strong> {{ result.effective_time }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    
                        {# Advance Directives Section #}
                        {% if advance_directives and advance_directives|length > 0 %}
                        <div class="clinical-section">
                            <div class="collapsible-wrapper">
                                <input id="toggle-advance-directives" class="toggle-input" type="checkbox">
                                <label for="toggle-advance-directives" class="collapsible-label-title">
                                    <div class="clinical-section-title-row">
                                        <div class="clinical-section-title">
                                            <i class="fa-solid fa-file-contract me-2"></i>
                                            <span>Advance Directives</span>
                                        </div>
                                        <div class="clinical-badge-container">
                                            <span class="clinical-badge extended">{{ advance_directives|length }} Found</span>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                                </label>
                                <div class="collapsible-content-title">
                                    <div class="content-inner-title">
                                        <p class="mb-3 text-muted">Advance Directives: {{ advance_directives|length }} items found</p>
                                        {% for directive in advance_directives %}
                                        <div class="directive-card mb-3 p-3 border rounded bg-white">
                                            <h6 class="directive-title text-dark mb-2">
                                                {% if directive.name %}
                                                    {{ directive.name }}
                                                {% elif directive.code.displayName %}
                                                    {{ directive.code.displayName }}
                                                {% else %}
                                                    Advance Directive
                                                {% endif %}
                                            </h6>
                                            {% if directive.description %}
                                            <div class="text-muted mb-1">
                                                <i class="fa-solid fa-file-alt me-1"></i>
                                                <strong>Description:</strong> {{ directive.description }}
                                            </div>
                                            {% endif %}
                                            {% if directive.effective_time %}
                                            <div class="text-muted">
                                                <i class="fa-solid fa-calendar me-1"></i>
                                                <strong>Effective Date:</strong> {{ directive.effective_time }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    
                        {# Additional Sections (Dynamic) #}
                        {% if additional_sections and additional_sections|length > 0 %}
                        {% for section in additional_sections %}
                        <div class="clinical-section">
                            <div class="collapsible-wrapper">
                                <input id="toggle-additional-{{ forloop.counter }}" class="toggle-input" type="checkbox">
                                <label for="toggle-additional-{{ forloop.counter }}" class="collapsible-label-title">
                                    <div class="clinical-section-title-row">
                                        <div class="clinical-section-title">
                                            <i class="fa-solid fa-file-medical me-2"></i>
                                            <span>{{ section.title|extract_section_title|default:"Additional Clinical Section" }}</span>
                                        </div>
                                        <div class="clinical-badge-container">
                                            <span class="clinical-badge extended">Available</span>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                                </label>
                                <div class="collapsible-content-title">
                                    <div class="content-inner-title">
                                        <p class="mb-3 text-muted">{{ section.description|default:"Additional clinical information" }}</p>
                                        <div class="additional-section-content">
                                            {% if section.has_ps_table and section.ps_table_html %}
                                                {# Use professionally rendered PS Table HTML from Enhanced CDA XML Parser #}
                                                <div class="ps-table-content">
                                                    {{ section.ps_table_html|safe }}
                                                </div>
                                                {% if section.clinical_codes and section.clinical_codes|length > 0 %}
                                                    <div class="medical-terms-info mt-2">
                                                        <small class="text-muted">
                                                            <i class="fa-solid fa-stethoscope me-1"></i>
                                                            {{ section.clinical_codes|length }} medical terms identified
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            {% elif section.content.translated %}
                                                {# Fallback: Handle dual-language content structure #}
                                                <div class="dual-language-content">
                                                    <div class="translated-content">
                                                        {{ section.content.translated|safe }}
                                                    </div>
                                                    {% if section.content.original and section.content.original != section.content.translated %}
                                                        <div class="original-content mt-3 border-top pt-3">
                                                            <h6 class="text-muted">
                                                                <i class="fa-solid fa-language me-1"></i>
                                                                Original Language
                                                            </h6>
                                                            {{ section.content.original|safe }}
                                                        </div>
                                                    {% endif %}
                                                    {% if section.content.medical_terms and section.content.medical_terms > 0 %}
                                                        <div class="medical-terms-info mt-2">
                                                            <small class="text-muted">
                                                                <i class="fa-solid fa-stethoscope me-1"></i>
                                                                {{ section.content.medical_terms }} medical terms identified
                                                            </small>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                {# Fallback: Handle simple string content #}
                                                {{ section.content|safe }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
            </div>
            {% endif %}
    
    {# Global fallback message when no clinical sections have any data #}
    {# Global fallback message when no clinical sections have any data #}
    {# This checks if we have no visible clinical sections at all #}
    {% if not problems and not medications and not allergies and not procedures and not medical_devices and not vital_signs and not history_of_past_illness and not immunizations and not pregnancy_history and not social_history and not physical_findings and not coded_results.blood_group and not coded_results.diagnostic_results and not laboratory_results and not advance_directives and not additional_sections %}
        <div class="alert alert-info" role="alert">
            <i class="fa-solid fa-info-circle me-2"></i>
            No clinical information available for this patient.
        </div>
    {% endif %}
</div>