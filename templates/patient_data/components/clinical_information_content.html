{# Clinical Information Content Component - Minimal Clean Version #}
{% load patient_filters %}
{% load patient_date_filters %}

<div class="clinical-information-container">
    {# Check if we have any clinical data #}
    {% if processed_sections and processed_sections|length > 0 %}            {# Simple Clinical Information Accordion - Clean Structure #}
        <div class="accordion" id="clinicalInformationAccordion">

            {# Add ONE test clinical section with clean structure #}
            {% for section in processed_sections %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ section.code|default:forloop.counter }}">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ section.code|default:forloop.counter }}"
                            aria-expanded="true"
                            aria-controls="collapse-{{ section.code|default:forloop.counter }}">
                        <i class="fa-solid fa-file-medical me-2"></i>
                        <strong>{{ section.title|extract_section_title|default:"Clinical Section" }}</strong>
                        {% if section.code %}
                        <span class="badge bg-primary ms-2">{{ section.code }}</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="collapse-{{ section.code|default:forloop.counter }}"
                     class="accordion-collapse collapse show"
                     aria-labelledby="heading-{{ section.code|default:forloop.counter }}">
                    <div class="accordion-body">
                        {# Display actual clinical content based on section type #}
                        {% if section.title|extract_section_title == "History of Medication use Narrative" %}
                            {# Medication Section #}
                            <div class="clinical-section-content">
                                <h6 class="text-primary mb-3">
                                    <i class="fa-solid fa-pills me-2"></i>Current Medications
                                </h6>
                                {% if section.structured_entries %}
                                    {% for entry in section.structured_entries %}
                                    <div class="medication-entry border-bottom pb-2 mb-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>{{ entry.medication_name|default:"Medication" }}</strong>
                                                {% if entry.dosage %}
                                                    <span class="text-muted">- {{ entry.dosage }}</span>
                                                {% endif %}
                                            </div>
                                            {% if entry.status %}
                                                <span class="badge bg-success">{{ entry.status }}</span>
                                            {% endif %}
                                        </div>
                                        {% if entry.instructions %}
                                            <small class="text-muted d-block mt-1">{{ entry.instructions }}</small>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="alert alert-info">
                                        <i class="fa-solid fa-info-circle me-2"></i>
                                        No structured medication data available.
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            {# Generic section display for other sections #}
                            <div class="alert alert-info">
                                <i class="fa-solid fa-info-circle me-2"></i>
                                <strong>Testing Clinical Section: {{ section.title|extract_section_title|default:"Unknown" }}</strong><br>
                                Section Code: {{ section.code|default:"No code" }}<br>
                                This is a test to ensure this section stays properly contained.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            {# Fallback if no processed_sections #}
            <div class="alert alert-warning">
                <i class="fa-solid fa-exclamation-triangle me-2"></i>
                No processed_sections available for testing.
            </div>
            {% endfor %}

        </div>
        </div>

    {% else %}
        {# No Clinical Data Available #}
        <div class="no-clinical-data text-center py-5">
            <div class="text-muted">
                <i class="fa-solid fa-notes-medical fa-3x mb-3 opacity-50"></i>
                <h5 class="text-muted">No Clinical Information Available</h5>
                <p class="mb-0">No clinical sections were found in the patient's medical record.</p>
            </div>
        </div>
    {% endif %}
</div> {# Close clinical-information-container #}
