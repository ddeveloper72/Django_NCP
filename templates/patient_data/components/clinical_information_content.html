<!-- Clinical Information Content Component -->
{% load patient_filters %}
{% load patient_date_filters %}

<div class="clinical-information-container">
    <!-- Check if we have any clinical data -->
    {% if medications or allergies or problems or vital_signs or procedures or processed_sections %}

    <!-- Clinical Information Master Controls -->
    <div class="clinical-master-controls mb-3 d-flex justify-content-between align-items-center">
        <div class="control-buttons">
            <button type="button" class="btn btn-outline-primary btn-sm me-2" id="expandAllClinical">
                <i class="fas fa-expand-arrows-alt me-1"></i>
                Expand All
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="collapseAllClinical">
                <i class="fas fa-compress-arrows-alt me-1"></i>
                Collapse All
            </button>
        </div>
        <div class="section-count text-muted">
            <small>
                <i class="fas fa-info-circle me-1"></i>
                Clinical sections can be expanded/collapsed independently
            </small>
        </div>
    </div>

    <!-- Clinical Information Accordion -->
    <div class="accordion" id="clinicalInformationAccordion">

        <!-- Medications Section -->
        {% if medications and medications|length > 0 %}
        <div class="accordion-item clinical-accordion-item">
            <h2 class="accordion-header" id="headingMedications">
                <button class="accordion-button" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseMedications"
                        aria-expanded="true"
                        aria-controls="collapseMedications">
                    <i class="fas fa-pills me-2 text-info"></i>
                    <strong>Medications</strong>
                    <span class="badge bg-info ms-2">{{ medications|length }} medication(s)</span>
                </button>
            </h2>
            <div id="collapseMedications"
                 class="accordion-collapse collapse show"
                 aria-labelledby="headingMedications">
                <div class="accordion-body">
                    {% for medication in medications %}
                    <div class="medication-entry border-bottom pb-3 mb-3">
                        <div class="row">
                            <!-- Main Medication Info -->
                            <div class="col-lg-6">
                                <h5 class="text-primary mb-2">
                                    <i class="fas fa-prescription-bottle me-2"></i>
                                    {{ medication.fields.Medication_Name.value|default:"Unknown Medication" }}
                                </h5>

                                <div class="medication-details">
                                    {% if medication.fields.Active_Ingredient_Name.value %}
                                    <p class="mb-2"><strong>Active Ingredient:</strong>
                                        {{ medication.fields.Active_Ingredient_Name.value }}
                                    </p>
                                    {% endif %}

                                    {% if medication.fields.Dose_Form_Name.value %}
                                    <p class="mb-2"><strong>Dose Form:</strong>
                                        {{ medication.fields.Dose_Form_Name.value }}
                                    </p>
                                    {% endif %}

                                    {% if medication.fields.Route_Name.value %}
                                    <p class="mb-2"><strong>Route:</strong>
                                        {{ medication.fields.Route_Name.value }}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Dosing and Timing -->
                            <div class="col-lg-6">
                                <h6 class="text-secondary mb-2">
                                    <i class="fas fa-clock me-2"></i>
                                    Dosing & Timing
                                </h6>

                                <div class="dosing-info">
                                    {% if medication.fields.Frequency_Period_Value.value and medication.fields.Frequency_Period_Unit.value %}
                                    <p class="mb-2"><strong>Frequency:</strong>
                                        {{ medication.fields.Frequency_Period_Value.value }}
                                        time(s) per {{ medication.fields.Frequency_Period_Unit.value }}
                                    </p>
                                    {% endif %}

                                    {% if medication.fields.Treatment_Start_Date.value %}
                                    <p class="mb-2"><strong>Start Date:</strong>
                                        {{ medication.fields.Treatment_Start_Date.value|document_date }}
                                    </p>
                                    {% endif %}

                                    {% if medication.fields.Treatment_End_Date.value %}
                                    <p class="mb-2"><strong>End Date:</strong>
                                        {{ medication.fields.Treatment_End_Date.value|document_date }}
                                    </p>
                                    {% endif %}

                                    {% if medication.fields.Status_Code.value %}
                                    <p class="mb-2"><strong>Status:</strong>
                                        <span class="badge {% if medication.fields.Status_Code.value == 'Active' %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ medication.fields.Status_Code.value }}
                                        </span>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Pharmaceutical Information -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-secondary mb-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Pharmaceutical Details
                                </h6>

                                <div class="row">
                                    <div class="col-md-6">
                                        {% if medication.fields.Ingredient_Strength_Numerator.value and medication.fields.Ingredient_Strength_Numerator_Unit.value %}
                                        <small class="text-muted d-block">
                                            <strong>Strength:</strong>
                                            {{ medication.fields.Ingredient_Strength_Numerator.value }}
                                            {{ medication.fields.Ingredient_Strength_Numerator_Unit.value }}
                                            {% if medication.fields.Ingredient_Strength_Denominator.value and medication.fields.Ingredient_Strength_Denominator_Unit.value %}
                                            / {{ medication.fields.Ingredient_Strength_Denominator.value }}
                                            {{ medication.fields.Ingredient_Strength_Denominator_Unit.value }}
                                            {% endif %}
                                        </small>
                                        {% endif %}

                                        {% if medication.fields.Package_Quantity.value and medication.fields.Package_Unit.value %}
                                        <small class="text-muted d-block">
                                            <strong>Package:</strong>
                                            {{ medication.fields.Package_Quantity.value }}
                                            {{ medication.fields.Package_Unit.value }}
                                        </small>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        {% if medication.fields.Medication_Code.value %}
                                        <small class="text-muted d-block">
                                            <strong>Code:</strong> {{ medication.fields.Medication_Code.value }}
                                        </small>
                                        {% endif %}

                                        {% if medication.fields.Indication_Code.value %}
                                        <small class="text-muted d-block">
                                            <strong>Indication:</strong> {{ medication.fields.Indication_Code.value }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Allergies Section -->
        {% if allergies and allergies|length > 0 %}
        <div class="accordion-item clinical-accordion-item">
            <h2 class="accordion-header" id="headingAllergies">
                <button class="accordion-button" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseAllergies"
                        aria-expanded="true"
                        aria-controls="collapseAllergies">
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                    <strong>Allergies & Adverse Reactions</strong>
                    <span class="badge bg-danger ms-2">{{ allergies|length }}</span>
                </button>
            </h2>
            <div id="collapseAllergies"
                 class="accordion-collapse collapse show"
                 aria-labelledby="headingAllergies">
                <div class="accordion-body">
                    <div class="row g-3">
                        {% for allergy in allergies %}
                        <div class="col-md-6">
                            <div class="allergy-item border rounded p-3 h-100 border-danger">
                                <h6 class="text-danger mb-2">
                                    {% if allergy.agent_display %}
                                        {{ allergy.agent_display }}
                                    {% elif allergy.agent_code %}
                                        {{ allergy.agent_code }}
                                    {% else %}
                                        Allergy
                                    {% endif %}
                                </h6>
                                {% if allergy.reaction %}
                                <p class="mb-1"><strong>Reaction:</strong> {{ allergy.reaction }}</p>
                                {% endif %}
                                {% if allergy.severity %}
                                <p class="mb-1"><strong>Severity:</strong>
                                    <span class="badge bg-warning">{{ allergy.severity }}</span>
                                </p>
                                {% endif %}
                                {% if allergy.status %}
                                <p class="mb-0"><strong>Status:</strong> {{ allergy.status }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Problems/Conditions Section -->
        {% if problems and problems|length > 0 %}
        <div class="accordion-item clinical-accordion-item">
            <h2 class="accordion-header" id="headingProblems">
                <button class="accordion-button" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseProblems"
                        aria-expanded="true"
                        aria-controls="collapseProblems">
                    <i class="fas fa-notes-medical me-2 text-warning"></i>
                    <strong>Problems & Conditions</strong>
                    <span class="badge bg-warning ms-2">{{ problems|length }}</span>
                </button>
            </h2>
            <div id="collapseProblems"
                 class="accordion-collapse collapse show"
                 aria-labelledby="headingProblems">
                <div class="accordion-body">
                    <div class="row g-3">
                        {% for problem in problems %}
                        <div class="col-md-6">
                            <div class="problem-item border rounded p-3 h-100">
                                <h6 class="text-warning mb-2">
                                    {% if problem.problem_display %}
                                        {{ problem.problem_display }}
                                    {% elif problem.problem_code %}
                                        {{ problem.problem_code }}
                                    {% else %}
                                        Condition
                                    {% endif %}
                                </h6>
                                {% if problem.onset_date %}
                                <p class="mb-1"><strong>Onset:</strong> {{ problem.onset_date }}</p>
                                {% endif %}
                                {% if problem.status %}
                                <p class="mb-1"><strong>Status:</strong> {{ problem.status }}</p>
                                {% endif %}
                                {% if problem.severity %}
                                <p class="mb-0"><strong>Severity:</strong> {{ problem.severity }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Vital Signs Section -->
        {% if vital_signs and vital_signs|length > 0 %}
        <div class="accordion-item clinical-accordion-item">
            <h2 class="accordion-header" id="headingVitals">
                <button class="accordion-button" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseVitals"
                        aria-expanded="true"
                        aria-controls="collapseVitals">
                    <i class="fas fa-heartbeat me-2 text-success"></i>
                    <strong>Vital Signs</strong>
                    <span class="badge bg-success ms-2">{{ vital_signs|length }}</span>
                </button>
            </h2>
            <div id="collapseVitals"
                 class="accordion-collapse collapse show"
                 aria-labelledby="headingVitals">
                <div class="accordion-body">
                    <div class="row g-3">
                        {% for vital in vital_signs %}
                        <div class="col-md-4">
                            <div class="vital-item border rounded p-3 h-100">
                                <h6 class="text-success mb-2">
                                    {% if vital.vital_display %}
                                        {{ vital.vital_display }}
                                    {% elif vital.vital_code %}
                                        {{ vital.vital_code }}
                                    {% else %}
                                        Vital Sign
                                    {% endif %}
                                </h6>
                                {% if vital.value %}
                                <p class="mb-1"><strong>Value:</strong> {{ vital.value }}</p>
                                {% endif %}
                                {% if vital.unit %}
                                <p class="mb-1"><strong>Unit:</strong> {{ vital.unit }}</p>
                                {% endif %}
                                {% if vital.date %}
                                <p class="mb-0"><strong>Date:</strong> {{ vital.date }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Procedures Section -->
        {% if procedures and procedures|length > 0 %}
        <div class="accordion-item clinical-accordion-item">
            <h2 class="accordion-header" id="headingProcedures">
                <button class="accordion-button" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseProcedures"
                        aria-expanded="true"
                        aria-controls="collapseProcedures">
                    <i class="fas fa-procedures me-2 text-info"></i>
                    <strong>Procedures</strong>
                    <span class="badge bg-info ms-2">{{ procedures|length }}</span>
                </button>
            </h2>
            <div id="collapseProcedures"
                 class="accordion-collapse collapse show"
                 aria-labelledby="headingProcedures">
                <div class="accordion-body">
                    <div class="row g-3">
                        {% for procedure in procedures %}
                        <div class="col-md-6">
                            <div class="procedure-item border rounded p-3 h-100">
                                <h6 class="text-info mb-2">
                                    {% if procedure.procedure_display %}
                                        {{ procedure.procedure_display }}
                                    {% elif procedure.procedure_code %}
                                        {{ procedure.procedure_code }}
                                    {% else %}
                                        Procedure
                                    {% endif %}
                                </h6>
                                {% if procedure.date %}
                                <p class="mb-1"><strong>Date:</strong> {{ procedure.date }}</p>
                                {% endif %}
                                {% if procedure.performer %}
                                <p class="mb-1"><strong>Performer:</strong> {{ procedure.performer }}</p>
                                {% endif %}
                                {% if procedure.status %}
                                <p class="mb-0"><strong>Status:</strong> {{ procedure.status }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Enhanced Clinical Sections -->
        {% if processed_sections and processed_sections|length > 0 %}
            {% for section in processed_sections %}
            <div class="accordion-item clinical-accordion-item">
                <h2 class="accordion-header" id="heading-{{ section.code|default:forloop.counter }}">
                    <button class="accordion-button" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ section.code|default:forloop.counter }}"
                            aria-expanded="true"
                            aria-controls="collapse-{{ section.code|default:forloop.counter }}">
                        <i class="fas fa-stethoscope me-2 text-primary"></i>
                        <strong>{% firstof section.title section.section_title "Clinical Section" %}</strong>
                        {% if section.code %}
                        <span class="badge bg-primary ms-2">{{ section.code }}</span>
                        {% endif %}
                        {% if section.entries %}
                        <span class="badge bg-secondary ms-2">{{ section.entries|length }} entries</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="collapse-{{ section.code|default:forloop.counter }}"
                     class="accordion-collapse collapse show"
                     aria-labelledby="heading-{{ section.code|default:forloop.counter }}">
                    <div class="accordion-body">
                        <!-- Modular Clinical Section Router - Enhanced Version -->
                        {% include 'patient_data/sections/clinical_section_router.html' %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% endif %}

        <!-- Other Clinical Sections -->
        {% if clinical_sections %}
        <div class="accordion-item clinical-accordion-item">
            <h2 class="accordion-header" id="headingOtherClinical">
                <button class="accordion-button" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseOtherClinical"
                        aria-expanded="true"
                        aria-controls="collapseOtherClinical">
                    <i class="fas fa-clipboard-list me-2 text-secondary"></i>
                    <strong>Additional Clinical Information</strong>
                    <span class="badge bg-secondary ms-2">{{ clinical_sections|length }}</span>
                </button>
            </h2>
            <div id="collapseOtherClinical"
                 class="accordion-collapse collapse show"
                 aria-labelledby="headingOtherClinical">
                <div class="accordion-body">
                    {% for section in clinical_sections %}
                    <div class="clinical-section-item mb-3">
                        <h6 class="text-secondary">{{ section.title|default:"Clinical Section" }}</h6>
                        {% if section.content %}
                        <div class="section-text">{{ section.content|safe }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Processing Summary Stats -->
        <div class="accordion-item clinical-accordion-item">
            <h2 class="accordion-header" id="headingStats">
                <button class="accordion-button" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseStats"
                        aria-expanded="true"
                        aria-controls="collapseStats">
                    <i class="fas fa-chart-bar me-2 text-dark"></i>
                    <strong>Processing Summary</strong>
                </button>
            </h2>
            <div id="collapseStats"
                 class="accordion-collapse collapse show"
                 aria-labelledby="headingStats">
                <div class="accordion-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="h2 text-primary">{{ sections_count }}</div>
                            <div>Total Sections</div>
                        </div>
                        <div class="col-md-3">
                            <div class="h2 text-success">{{ medical_terms_count }}</div>
                            <div>Medical Terms</div>
                        </div>
                        <div class="col-md-3">
                            <div class="h2 text-info">{{ coded_sections_count }}</div>
                            <div>Coded Sections</div>
                        </div>
                        <div class="col-md-3">
                            <div class="h2 text-warning">{{ coded_sections_percentage|floatformat:0 }}%</div>
                            <div>Terminology Coverage</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    {% else %}
    <!-- No Clinical Data Available -->
    <div class="alert alert-info">
        <h6><i class="fas fa-info-circle me-2"></i>Clinical Information</h6>
        <p class="mb-0">No clinical information (medications, allergies, problems, vital signs, or procedures) is available in this document.</p>
    </div>
    {% endif %}
</div>

<!-- Clinical Information Master Controls JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Simple section toggle functions (inspired by reference CDA implementation)
    window.expandClinicalSection = function(button) {
        const sectionContent = button.parentElement.parentElement.querySelector('.accordion-body').parentElement;
        const icon = button.querySelector('.section-toggle-icon');

        if (sectionContent) {
            sectionContent.style.display = '';
            sectionContent.classList.add('show');
        }

        button.classList.remove('collapsed');
        button.setAttribute('aria-expanded', 'true');
        button.title = 'Collapse';

        if (icon) {
            icon.innerHTML = '▼';
        }

        // Update onclick to collapse
        button.onclick = function() { collapseClinicalSection(this); };
    };

    window.collapseClinicalSection = function(button) {
        const sectionContent = button.parentElement.parentElement.querySelector('.accordion-body').parentElement;
        const icon = button.querySelector('.section-toggle-icon');

        if (sectionContent) {
            sectionContent.style.display = 'none';
            sectionContent.classList.remove('show');
        }

        button.classList.add('collapsed');
        button.setAttribute('aria-expanded', 'false');
        button.title = 'Expand';

        if (icon) {
            icon.innerHTML = '▶';
        }

        // Update onclick to expand
        button.onclick = function() { expandClinicalSection(this); };
    };

    // Initialize all section buttons with proper onclick handlers
    const sectionButtons = document.querySelectorAll('#clinicalInformationAccordion .accordion-button');
    sectionButtons.forEach(function(button) {
        // Add toggle icon if not present
        if (!button.querySelector('.section-toggle-icon')) {
            const icon = document.createElement('span');
            icon.className = 'section-toggle-icon me-2';
            icon.innerHTML = '▼';
            button.insertBefore(icon, button.firstChild);
        }

        // Set initial onclick handler (expanded by default)
        button.onclick = function() { collapseClinicalSection(this); };
        button.title = 'Collapse';

        // Remove Bootstrap data attributes that might interfere
        button.removeAttribute('data-bs-toggle');
        button.removeAttribute('data-bs-target');
    });

    // Expand All Clinical Sections
    document.getElementById('expandAllClinical').addEventListener('click', function() {
        const sectionButtons = document.querySelectorAll('#clinicalInformationAccordion .accordion-button');

        sectionButtons.forEach(function(button) {
            expandClinicalSection(button);
        });

        // Visual feedback
        this.innerHTML = '<i class="fas fa-check me-1"></i>All Expanded';
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-expand-arrows-alt me-1"></i>Expand All';
        }, 1500);
    });

    // Collapse All Clinical Sections
    document.getElementById('collapseAllClinical').addEventListener('click', function() {
        const sectionButtons = document.querySelectorAll('#clinicalInformationAccordion .accordion-button');

        sectionButtons.forEach(function(button) {
            collapseClinicalSection(button);
        });

        // Visual feedback
        this.innerHTML = '<i class="fas fa-check me-1"></i>All Collapsed';
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-compress-arrows-alt me-1"></i>Collapse All';
        }, 1500);
    });
});
</script>
