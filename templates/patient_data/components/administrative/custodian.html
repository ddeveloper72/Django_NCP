{# CDA Custodian - Document Custodian Organization Component #}
{# Expected context: custodian_organization (DotDict with name, contact_info, identifiers) #}

{% if custodian_organization and custodian_organization.name %}
<div class="custodian-section bg-white border rounded-3 shadow-sm overflow-hidden mb-3">
    <div class="table-responsive">
        <table class="table table-bordered mb-0">
            <tbody>
                {# Custodian Row #}
                <tr>
                    <td class="table-light fw-bold" style="width: 20%;">Custodian</td>
                    <td style="width: 40%;">
                        <div class="d-flex align-items-start">
                            <i class="fa-solid fa-building-shield me-2 text-info mt-1"></i>
                            <div>
                                <strong>{{ custodian_organization.name }}</strong>
                                {% if custodian_organization.part_of %}
                                <div class="small text-muted mt-1">
                                    Part of: {{ custodian_organization.part_of.display }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="table-light fw-bold" style="width: 15%;">Contact Details</td>
                    <td style="width: 25%;">{# Contact Details from FHIR organization.contact array #}
                        {% if custodian_organization.contact %}
                            {% for contact in custodian_organization.contact %}
                                {# Address #}
                                {% if contact.address %}
                                <div class="mb-1 small">
                                    {% for line in contact.address.line %}{{ line }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                </div>
                                <div class="mb-1 small">
                                    {{ contact.address.city }} {{ contact.address.postalCode }}
                                </div>
                                <div class="mb-1 small">{{ contact.address.country }}</div>
                                {% endif %}
                                {# Telecoms #}
                                {% if contact.telecom %}
                                    {% for telecom in contact.telecom %}
                                        {% if telecom.system == 'email' %}
                                        <div class="small">Mail {{ telecom.use|title }}: {{ telecom.value }}</div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        {% elif custodian_organization.addresses %}
                            {# Fallback to top-level addresses if no contact array #}
                            {% with address=custodian_organization.addresses.0 %}
                            <div class="mb-1 small">{{ address.street }}</div>
                            <div class="mb-1 small">{{ address.city }} {{ address.postal_code }}</div>
                            <div class="mb-1 small">{{ address.country }}</div>
                            {% endwith %}
                            {% if custodian_organization.telecoms %}
                                {% for telecom in custodian_organization.telecoms %}
                                    {% if telecom.system == 'email' %}
                                    <div class="small">Mail: {{ telecom.value }}</div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endif %}
