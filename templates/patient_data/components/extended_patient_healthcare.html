{% load patient_filters %}

<!-- Extended Patient Healthcare Team Component -->
<!-- Temporary Debug Section -->
{% if 1 %}
<div class="alert alert-warning mb-3">
    <strong>Healthcare Data Debug:</strong><br>
    healthcare_data exists: {% if healthcare_data %}Yes{% else %}No{% endif %}<br>
    {% if healthcare_data %}
    healthcare_data keys: {{ healthcare_data.keys|join:", " }}<br>
    Has author_hcp: {% if healthcare_data.author_hcp %}Yes{% else %}No{% endif %}<br>
    Has organization: {% if healthcare_data.organization %}Yes{% else %}No{% endif %}
    {% endif %}
</div>
{% endif %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h5 class="mb-0"><i class="fa-solid fa-user-md me-2"></i>Healthcare Team</h5>
  {% if healthcare_data %}
    <span class="badge bg-light text-dark border">
      {% if healthcare_data.author_hcp %}Primary Author{% endif %}
      {% if healthcare_data.author_hcp and healthcare_data.organization %} â€¢ {% endif %}
      {% if healthcare_data.organization %}{{ healthcare_data.organization.name|default:"Healthcare Organization" }}{% endif %}
    </span>
  {% endif %}
</div>

<!-- Document Author HCP -->
{% if healthcare_data and healthcare_data.author_hcp %}
    {% with author_hcp=healthcare_data.author_hcp %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h6 class="card-title mb-3">
                    <i class="fa-solid fa-user-md me-2"></i>Document Author
                    <span class="badge bg-light text-dark border ms-2">Primary HCP</span>
                </h6>

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label text-muted fw-bold mb-2">
                            <i class="fa-solid fa-id-badge me-1"></i>Healthcare Provider Information
                        </label>
                        <div class="p-3 bg-light rounded">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fa-solid fa-user text-primary me-2"></i>
                                <div>
                                    <span class="fw-medium">
                                        {% if author_hcp.title %}{{ author_hcp.title }} {% endif %}
                                        {{ author_hcp.given_name|default:"" }} {{ author_hcp.family_name|default:"" }}
                                        {% if not author_hcp.given_name and not author_hcp.family_name %}Document Author{% endif %}
                                    </span>
                                </div>
                            </div>

                            {% if author_hcp.role %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fa-solid fa-briefcase text-success me-2"></i>
                                    <div>
                                        <span class="fw-medium">Role: </span>{{ author_hcp.role }}
                                    </div>
                                </div>
                            {% endif %}

                            {% if author_hcp.specialty %}
                                <div class="d-flex align-items-center">
                                    <i class="fa-solid fa-stethoscope text-info me-2"></i>
                                    <div>
                                        <span class="fw-medium">Specialty: </span>{{ author_hcp.specialty }}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        {% if author_hcp.organization and author_hcp.organization.name %}
                            <label class="form-label text-muted fw-bold mb-2">
                                <i class="fa-solid fa-building me-1"></i>Organization
                            </label>
                            <div class="p-3 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <i class="fa-solid fa-hospital text-secondary me-2"></i>
                                    <div>
                                        <span class="fw-medium">{{ author_hcp.organization.name }}</span>
                                        {% if author_hcp.organization.organization_type %}
                                            <br><small class="text-muted">{{ author_hcp.organization.organization_type }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endwith %}
{% endif %}

<!-- Legal Authenticator -->
{% if healthcare_data and healthcare_data.legal_authenticator %}
    {% with legal_auth=healthcare_data.legal_authenticator %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h6 class="card-title mb-3">
                    <i class="fa-solid fa-certificate me-2"></i>Legal Authenticator
                    <span class="badge bg-light text-dark border ms-2">Document Validator</span>
                </h6>

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label text-muted fw-bold mb-2">
                            <i class="fa-solid fa-id-badge me-1"></i>Healthcare Provider Information
                        </label>
                        <div class="p-3 bg-light rounded">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fa-solid fa-user text-primary me-2"></i>
                                <div>
                                    <span class="fw-medium">
                                        {% if legal_auth.title %}{{ legal_auth.title }} {% endif %}
                                        {{ legal_auth.given_name|default:"" }} {{ legal_auth.family_name|default:"" }}
                                        {% if not legal_auth.given_name and not legal_auth.family_name %}Legal Authenticator{% endif %}
                                    </span>
                                </div>
                            </div>

                            {% if legal_auth.role %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fa-solid fa-briefcase text-success me-2"></i>
                                    <div>
                                        <span class="fw-medium">Role: </span>{{ legal_auth.role }}
                                    </div>
                                </div>
                            {% endif %}

                            {% if legal_auth.specialty %}
                                <div class="d-flex align-items-center">
                                    <i class="fa-solid fa-stethoscope text-info me-2"></i>
                                    <div>
                                        <span class="fw-medium">Specialty: </span>{{ legal_auth.specialty }}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        {% if legal_auth.organization and legal_auth.organization.name %}
                            <label class="form-label text-muted fw-bold mb-2">
                                <i class="fa-solid fa-building me-1"></i>Organization
                            </label>
                            <div class="p-3 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <i class="fa-solid fa-hospital text-secondary me-2"></i>
                                    <div>
                                        <span class="fw-medium">{{ legal_auth.organization.name }}</span>
                                        {% if legal_auth.organization.organization_type %}
                                            <br><small class="text-muted">{{ legal_auth.organization.organization_type }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Consolidated Contact Information for Legal Authenticator -->
                {% if legal_auth.contact_info.addresses or legal_auth.contact_info.telecoms %}
                    <div class="mt-3 pt-3 border-top">
                        <label class="form-label text-muted fw-bold mb-2">
                            <i class="fa-solid fa-address-book me-1"></i>Contact Information
                        </label>
                        <div class="row">
                            {% if legal_auth.contact_info.addresses %}
                                <div class="col-md-8 mb-2">
                                    {% for address in legal_auth.contact_info.addresses %}
                                        <div class="p-2 bg-light rounded mb-2">
                                            <div class="d-flex align-items-start">
                                                <i class="fa-solid fa-map-marker-alt text-danger me-2 mt-1"></i>
                                                <address class="mb-0">
                                                    {% for line in address.streetAddressLine %}{{ line }}<br>{% endfor %}
                                                    {% if address.city %}{{ address.city }}{% endif %}
                                                    {% if address.postalCode %} {{ address.postalCode }}{% endif %}
                                                    {% if address.country %}<br>{{ address.country }}{% endif %}
                                                </address>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            {% if legal_auth.contact_info.telecoms %}
                                <div class="col-md-4 mb-2">
                                    {% for telecom in legal_auth.contact_info.telecoms %}
                                        <div class="p-2 bg-light rounded mb-2">
                                            {% if 'tel:' in telecom.value %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fa-solid fa-phone text-success me-2"></i>
                                                    <div>
                                                        <a href="{{ telecom.value }}" class="text-decoration-none fw-medium">{{ telecom.value|slice:"4:" }}</a>
                                                    </div>
                                                </div>
                                            {% elif 'mailto:' in telecom.value %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fa-solid fa-envelope text-primary me-2"></i>
                                                    <div>
                                                        <a href="{{ telecom.value }}" class="text-decoration-none fw-medium">{{ telecom.value|slice:"7:" }}</a>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fa-solid fa-address-card text-secondary me-2"></i>
                                                    <div>
                                                        <span class="fw-medium">{{ telecom.value }}</span>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endwith %}
{% endif %}

<!-- Preferred HCP Organization -->
{% if healthcare_data and healthcare_data.preferred_hcp %}
    {% with preferred_hcp=healthcare_data.preferred_hcp %}
        {% if preferred_hcp.name or preferred_hcp.addresses or preferred_hcp.telecoms %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="fa-solid fa-star me-2"></i>Preferred Healthcare Provider
                        <span class="badge bg-light text-dark border ms-2">Primary Care</span>
                    </h6>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label text-muted fw-bold mb-2">
                                <i class="fa-solid fa-building me-1"></i>Organization Information
                            </label>
                            <div class="p-3 bg-light rounded">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fa-solid fa-hospital text-primary me-2"></i>
                                    <div>
                                        <span class="fw-medium">{{ preferred_hcp.name|default:"Preferred Healthcare Organization" }}</span>
                                    </div>
                                </div>

                                {% if preferred_hcp.organization_type %}
                                    <div class="d-flex align-items-center">
                                        <i class="fa-solid fa-tag text-info me-2"></i>
                                        <div>
                                            <span class="fw-medium">Type: </span>{{ preferred_hcp.organization_type }}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Consolidated Contact Information for Preferred HCP -->
                        {% if preferred_hcp.addresses or preferred_hcp.telecoms %}
                            <div class="col-md-4 mb-3">
                                <label class="form-label text-muted fw-bold mb-2">
                                    <i class="fa-solid fa-address-book me-1"></i>Contact Information
                                </label>

                                {% if preferred_hcp.addresses %}
                                    {% for address in preferred_hcp.addresses %}
                                        <div class="p-2 bg-light rounded mb-2">
                                            <div class="d-flex align-items-start">
                                                <i class="fa-solid fa-map-marker-alt text-danger me-2 mt-1"></i>
                                                <address class="mb-0 small">
                                                    {% for line in address.streetAddressLine %}{{ line }}<br>{% endfor %}
                                                    {% if address.city %}{{ address.city }}{% endif %}
                                                    {% if address.postalCode %} {{ address.postalCode }}{% endif %}
                                                    {% if address.country %}<br>{{ address.country }}{% endif %}
                                                </address>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% endif %}

                                {% if preferred_hcp.telecoms %}
                                    {% for telecom in preferred_hcp.telecoms %}
                                        <div class="p-2 bg-light rounded mb-2">
                                            {% if 'tel:' in telecom.value %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fa-solid fa-phone text-success me-2"></i>
                                                    <div>
                                                        <a href="{{ telecom.value }}" class="text-decoration-none fw-medium small">{{ telecom.value|slice:"4:" }}</a>
                                                    </div>
                                                </div>
                                            {% elif 'mailto:' in telecom.value %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fa-solid fa-envelope text-primary me-2"></i>
                                                    <div>
                                                        <a href="{{ telecom.value }}" class="text-decoration-none fw-medium small">{{ telecom.value|slice:"7:" }}</a>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fa-solid fa-address-card text-secondary me-2"></i>
                                                    <div>
                                                        <span class="fw-medium small">{{ telecom.value }}</span>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    {% endwith %}
{% endif %}

<!-- Fallback content when no healthcare team data is available -->
{% if not healthcare_data or not healthcare_data.author_hcp and not healthcare_data.legal_authenticator and not healthcare_data.preferred_hcp %}
    <div class="alert alert-info">
        <div class="d-flex align-items-center">
            <i class="fa-solid fa-info-circle fa-2x me-3"></i>
            <div>
                <h6 class="mb-1">No Healthcare Team Information Available</h6>
                <p class="mb-0">Healthcare provider details are not available in the current document or have not been extracted from the CDA.</p>
            </div>
        </div>
    </div>
{% endif %}
