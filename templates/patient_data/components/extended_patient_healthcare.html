{% load patient_filters %}
<!-- Extended Patient Healthcare Team Component -->
<div class="tab-pane fade {% if first_tab == 'healthcare' %}show active{% endif %}" id="healthcare" role="tabpanel"
    aria-labelledby="healthcare-tab">
    <h5><i class="fas fa-stethoscope me-2"></i>Healthcare Team</h5>

    {% if patient_extended_data %}
    {# Django: Use direct access instead of {% set %} #}
    {% with healthcare_data=patient_extended_data|safe_get:"healthcare_team"|default_if_none:patient_extended_data %}

    <!-- Debug Healthcare Data -->
    <div class="alert alert-success mb-3">
        <h6>DEBUG: Healthcare Team Data Available</h6>
        <p><strong>Healthcare Data Keys:</strong>
            {% if patient_extended_data|safe_get:"healthcare_team" %}
                {% for key, value in patient_extended_data|safe_get:"healthcare_team"|dict_items %}{{ key }}{% if not forloop.last %}, {% endif %}{% endfor %}
            {% else %}
                No healthcare data
            {% endif %}
        </p>
        <p><strong>Has healthcare team:</strong> {{ patient_extended_data|safe_get:"healthcare_team"|safe_get:"has_healthcare_team"|default:False }}</p>
        <p><strong>Total count:</strong> {{ patient_extended_data|safe_get:"healthcare_team"|safe_get:"total_count"|default:0 }}</p>
    </div>

    <!-- Document Authors -->
    {% if patient_extended_data|safe_get:"authors" %}
    <div class="mb-4">
        <h6><i class="fas fa-user-md me-1"></i>Document Authors</h6>
        {# Django: Use direct access instead of {% set %} #}
        {% for author in patient_extended_data|safe_get:"authors" %}
        <div class="healthcare-member-card">
            <div class="card-body">
                <h6 class="card-title">
                    {{ author.name|default:author.person.full_name|default:"Unknown Author" }}
                </h6>
                                <div class="mb-2">
                    <span class="role-badge">{{ author|safe_get:"role"|default:author|safe_get:"type"|default:"Author" }}</span>
                </div>
                {% if author|safe_get:"organization" %}
                <div class="organization-info mb-2">
                    <strong><i class="fas fa-building me-1"></i>Organization:</strong> {{ author|safe_get:"organization" }}
                </div>
                {% endif %}
                {% if author|safe_get:"time" %}
                <div class="contact-details">
                    <strong><i class="fas fa-clock me-1"></i>Authored:</strong>
                    <span class="date-value">{{ author|safe_get:"time" }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Legal Authenticator -->
    {% if patient_extended_data|safe_get:"legal_authenticator" %}
    {# Django: Use direct access instead of {% set %} #}
    <div class="mb-4">
        <h6><i class="fas fa-gavel me-1"></i>Legal Authenticator</h6>
        <div class="healthcare-member-card">
            <div class="card-body">
                <h6 class="card-title">{{ patient_extended_data|safe_get:"legal_authenticator".name|default:"Unknown Authenticator" }}</h6>
                <div class="mb-2">
                    <span class="role-badge">{{ patient_extended_data|safe_get:"legal_authenticator".role|default:"Legal Authenticator" }}</span>
                </div>
                {% if patient_extended_data|safe_get:"legal_authenticator".organization %}
                <div class="organization-info mb-2">
                    <strong><i class="fas fa-building me-1"></i>Organization:</strong> {{ patient_extended_data|safe_get:"legal_authenticator".organization }}
                </div>
                {% endif %}
                {% if legal_auth.get('authentication_time') %}
                <div class="contact-details">
                    <strong><i class="fas fa-clock me-1"></i>Authenticated:</strong>
                    <span class="date-value">{{ legal_auth.authentication_time }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Emergency Contacts -->
    {% if patient_extended_data|safe_get:"emergency_contacts"|safe_get:"contacts" %}
    <div class="mb-4">
        <h6><i class="fas fa-ambulance me-1"></i>Emergency Contacts</h6>
        {% for contact in patient_extended_data|safe_get:"emergency_contacts"|safe_get:"contacts" %}
        <div class="healthcare-member-card">
            <div class="card-body">
                <h6 class="card-title">{{ contact|safe_get:"name"|default:"Unknown Contact" }}</h6>
                <div class="mb-2">
                    <span class="role-badge emergency-contact">Emergency Contact</span>
                </div>

                <!-- Phone Numbers -->
                {% if contact|safe_get:"phone_numbers" %}
                <div class="contact-details mb-2">
                    {% for phone in contact|safe_get:"phone_numbers" %}
                    <div class="contact-item">
                        <strong>{{ phone|safe_get:"display_label"|default:phone|safe_get:"use_label"|default:"Phone:" }}</strong>
                        <a href="tel:{{ phone|safe_get:"number"|default:"" }}" class="contact-link phone-link ms-2">
                            {{ phone|safe_get:"number"|default:"" }}
                        </a>
                        {% if phone|safe_get:"is_primary" %}
                        <span class="badge bg-success ms-1">Primary</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Email Addresses -->
                {% if contact|safe_get:"email_addresses" %}
                <div class="contact-details mb-2">
                    {% for email in contact|safe_get:"email_addresses" %}
                    <div class="contact-item">
                        <strong>{{ email|safe_get:"display_label"|default:email|safe_get:"use_label"|default:"Email:" }}</strong>
                        <a href="mailto:{{ email|safe_get:"email"|default:"" }}" class="contact-link email-link ms-2">
                            {{ email|safe_get:"email"|default:"" }}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Next of Kin -->
    {% if patient_extended_data|safe_get:"next_of_kin"|safe_get:"contacts" %}
    <div class="mb-4">
        <h6><i class="fas fa-users me-1"></i>Next of Kin</h6>
        {% for contact in patient_extended_data|safe_get:"next_of_kin"|safe_get:"contacts" %}
        <div class="healthcare-member-card">
            <div class="card-body">
                <h6 class="card-title">{{ contact|safe_get:"name"|default:"Unknown Contact" }}</h6>
                <div class="mb-2">
                    <span class="role-badge next-of-kin">{{ contact|safe_get:"relationship"|default:"Next of Kin" }}</span>
                </div>

                <!-- Phone Numbers -->
                {% if contact|safe_get:"phone_numbers" %}
                <div class="contact-details mb-2">
                    {% for phone in contact.phone_numbers %}
                    <div class="contact-item">
                        <strong>{{ phone.get('display_label', phone.get('use_label', 'Phone:')) }}</strong>
                        <a href="tel:{{ phone.get('number', '') }}" class="contact-link phone-link ms-2">
                            {{ phone.get('number', '') }}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Medical Performers -->
    {% if patient_extended_data|safe_get:"performers"|safe_get:"medical_doctors" %}
    <div class="mb-4">
        <h6><i class="fas fa-user-md me-1"></i>Medical Doctors</h6>
        {% for doctor in patient_extended_data|safe_get:"performers"|safe_get:"medical_doctors" %}
        <div class="healthcare-member-card">
            <div class="card-body">
                <h6 class="card-title">{{ doctor|safe_get:"name"|default:"Unknown Doctor" }}</h6>
                <div class="mb-2">
                    <span class="role-badge doctor">{{ doctor|safe_get:"role"|default:"Medical Doctor" }}</span>
                </div>
                {% if doctor|safe_get:"organization" %}
                <div class="organization-info mb-2">
                    <strong><i class="fas fa-building me-1"></i>Organization:</strong> {{ doctor|safe_get:"organization" }}
                </div>
                {% endif %}

                <!-- Contact Information -->
                {% if doctor.get('phone_numbers') %}
                <div class="contact-details mb-2">
                    {% for phone in doctor.phone_numbers %}
                    <div class="contact-item">
                        <strong>{{ phone.get('display_label', phone.get('use_label', 'Phone:')) }}</strong>
                        <a href="tel:{{ phone.get('number', '') }}" class="contact-link phone-link ms-2">
                            {{ phone.get('number', '') }}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Custodian Organization -->
    {% if patient_extended_data|safe_get:"custodian_organization" %}
    {# Django: Use direct access instead of {% set %} #}
    <div class="mb-4">
        <h6><i class="fas fa-building me-1"></i>Custodian Organization</h6>
        <div class="healthcare-member-card">
            <div class="card-body">
                <h6 class="card-title">{{ patient_extended_data|safe_get:"custodian_organization".name|default:"Unknown Organization" }}</h6>
                {% if patient_extended_data|safe_get:"custodian_organization".contact_info.addresses %}
                <div class="contact-details mb-2">
                    <strong><i class="fas fa-map-marker-alt me-1"></i>Address:</strong>
                    {{ patient_extended_data|safe_get:"custodian_organization".contact_info.addresses.0 }}
                </div>
                {% endif %}
                {% if custodian.get('contact_info', {}).get('phone_numbers') %}
                <div class="contact-details">
                    <strong><i class="fas fa-phone me-1"></i>Phone:</strong>
                    <a href="tel:{{ custodian.contact_info.phone_numbers[0] }}" class="contact-link phone-link">
                        {{ custodian.contact_info.phone_numbers[0] }}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Show message if no healthcare team info -->
    {% if not healthcare_data.get('authors') and not healthcare_data.get('legal_authenticator') and not
    healthcare_data.get('custodian_organization') %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>No healthcare team information available in the CDA document.
    </div>
    {% endif %}

    {% endwith %}
    {% else %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>No extended patient data available.
    </div>
    {% endif %}
</div>
