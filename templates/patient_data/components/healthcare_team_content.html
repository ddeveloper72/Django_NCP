{# Healthcare Team & Contacts Content - Phase 3B Integration #}
{% load patient_filters %}

<div class="healthcare-team-container">
    {# Check if we have any administrative, healthcare data, or healthcare team data #}
    {% if healthcare_team or administrative_data or healthcare_data or author_hcp or custodian_organization.name or guardians or participants %}
        
    {# === CDA ADMINISTRATIVE SECTIONS (Accordion Design) === #}
    {# Each administrative component in its own collapsible accordion #}
    {# Matches FHIR design system with consistent accordion pattern #}
    
    {% include 'patient_data/components/administrative/assigned_author.html' %}
    {% include 'patient_data/components/administrative/legal_authenticator.html' %}
    {% include 'patient_data/components/administrative/documentation_of.html' %}
    {% include 'patient_data/components/administrative/document_info.html' %}        {# CUSTODIAN ORGANIZATION - Collapsible Accordion #}
        {% if custodian_organization.name %}
        <div class="custodian-section mb-4">
            <div class="collapsible-wrapper">
                <input id="toggle-custodian" class="toggle-input" type="checkbox" checked>
                <label for="toggle-custodian" class="collapsible-label-title">
                    <div class="clinical-section-title-row">
                        <div class="clinical-section-title">
                            <i class="fa-solid fa-building-shield me-2"></i>
                            <span>Custodian Organization</span>
                        </div>
                        <div class="clinical-badge-container">
                            <span class="clinical-badge populated">1 Organization</span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                </label>
                <div class="collapsible-content-title">
                    <div class="content-inner-title">
                    <div class="mb-3">
                        <h6 class="text-dark mb-2">
                            <i class="fa-solid fa-hospital me-2 text-info"></i>
                            {{ custodian_organization.name }}
                        </h6>
                        {% if custodian_organization.part_of %}
                        <p class="small text-muted mb-0">
                            Part of: {{ custodian_organization.part_of.display }}
                        </p>
                        {% endif %}
                    </div>
                    
                    <div class="contact-details">
                        <h6 class="mb-2"><i class="fa-solid fa-address-book me-2"></i>Contact Details:</h6>
                        {% if custodian_organization.contact %}
                            {% for contact in custodian_organization.contact %}
                                {% if contact.address %}
                                <p class="mb-1">
                                    <i class="fa-solid fa-location-dot me-2 text-muted"></i>
                                    {% for line in contact.address.line %}{{ line }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                </p>
                                <p class="mb-1 ms-4">{{ contact.address.city }} {{ contact.address.postalCode }}</p>
                                <p class="mb-2 ms-4">{{ contact.address.country }}</p>
                                {% endif %}
                                {% if contact.telecom %}
                                    {% for telecom in contact.telecom %}
                                        {% if telecom.system == 'email' %}
                                        <p class="mb-1">
                                            <i class="fa-solid fa-envelope me-2 text-muted"></i>
                                            <strong>Email:</strong> {{ telecom.value }}
                                        </p>
                                        {% elif telecom.system == 'phone' %}
                                        <p class="mb-1">
                                            <i class="fa-solid fa-phone me-2 text-muted"></i>
                                            <strong>Phone:</strong> {{ telecom.value }}
                                        </p>
                                        {% elif telecom.system == 'url' %}
                                        <p class="mb-1">
                                            <i class="fa-solid fa-globe me-2 text-muted"></i>
                                            <strong>Web:</strong> <a href="{{ telecom.value }}" target="_blank" rel="noopener">{{ telecom.value }}</a>
                                        </p>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Healthcare Team Section - Collapsible Accordion (Mobile-First) #}
        {% if healthcare_team %}
        <div class="healthcare-team-section mb-4">
            <div class="collapsible-wrapper">
                <input id="toggle-healthcare-team-new" class="toggle-input" type="checkbox" checked>
                <label for="toggle-healthcare-team-new" class="collapsible-label-title">
                    <div class="clinical-section-title-row">
                        <div class="clinical-section-title">
                            <i class="fa-solid fa-user-doctor me-2"></i>
                            <span>Healthcare Team</span>
                        </div>
                        <div class="clinical-badge-container">
                            <span class="clinical-badge {% if healthcare_team|length > 0 %}populated{% else %}empty{% endif %}">
                                {{ healthcare_team|length }} Provider{{ healthcare_team|length|pluralize }}
                            </span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                </label>
                <div class="collapsible-content-title">
                    <div class="content-inner-title">
                    
                    {# Healthcare Team Members - Card Style #}
                    {% for member in healthcare_team %}
                    <div class="{% if not forloop.last %}border-bottom pb-3 mb-3{% endif %}">
                        <div class="mb-2">
                            <h6 class="text-dark mb-1">
                                <i class="fa-solid fa-user-md me-2 text-primary"></i>
                                {{ member.name|default:"Unknown Provider" }}
                            </h6>
                            {# Role & Specialty Badges #}
                            {% if member.role %}
                            <span class="badge bg-primary">{{ member.role }}</span>
                            {% endif %}
                            {% if member.specialty %}
                            <span class="badge bg-info ms-1">{{ member.specialty }}</span>
                            {% endif %}
                            {% if not member.role and not member.specialty %}
                            <span class="badge bg-secondary">Healthcare Provider</span>
                            {% endif %}
                        </div>
                        
                        {# Organization #}
                        {% if member.organization %}
                        <p class="mb-2 small text-muted">
                            <i class="fa-solid fa-building me-2"></i>
                            {{ member.organization }}
                        </p>
                        {% endif %}
                        
                        {# Contact Information #}
                        <div class="contact-info">
                            <h6 class="mb-2 small"><i class="fa-solid fa-address-book me-2"></i>Contact Information:</h6>
                            {% if member.addresses %}
                                {% for address in member.addresses %}
                                <p class="mb-1 small">
                                    <i class="fa-solid fa-location-dot me-2 text-muted"></i>
                                    {% for line in address.line %}{{ line }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                </p>
                                <p class="mb-1 small ms-4">
                                    {% if address.city %}{{ address.city }}{% endif %}
                                    {% if address.postal_code %} {{ address.postal_code }}{% endif %}
                                </p>
                                <p class="mb-2 small ms-4">{% if address.country %}{{ address.country }}{% endif %}</p>
                                {% endfor %}
                            {% endif %}
                            
                            {% if member.telecoms %}
                                {% for telecom in member.telecoms %}
                                    {% if telecom.system == 'phone' %}
                                    <p class="mb-1 small">
                                        <i class="fa-solid fa-phone me-2 text-muted"></i>
                                        <strong>Phone:</strong> {{ telecom.value }}
                                    </p>
                                    {% elif telecom.system == 'email' %}
                                    <p class="mb-1 small">
                                        <i class="fa-solid fa-envelope me-2 text-muted"></i>
                                        <strong>Email:</strong> {{ telecom.value }}
                                    </p>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                        
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Healthcare Team Section - Legacy Format with SCSS Design System #}
        {% if healthcare_data.practitioners or administrative_data.healthcare_providers %}
        <div class="healthcare-team-section mb-4">
            <div class="collapsible-wrapper">
                <input id="toggle-healthcare-team" class="toggle-input" type="checkbox" checked>
                <label for="toggle-healthcare-team" class="collapsible-label-title">
                    <div class="clinical-section-title-row">
                        <div class="clinical-section-title">
                            <i class="fa-solid fa-user-doctor me-2"></i>
                            <span>Healthcare Team</span>
                        </div>
                        <div class="clinical-badge-container">
                            {% with team_count=healthcare_data.practitioners|length %}
                            {% with provider_count=administrative_data.healthcare_providers|length %}
                            {% with total_team=team_count|add:provider_count %}
                            <span class="clinical-badge {% if total_team > 0 %}populated{% else %}empty{% endif %}">
                                {{ total_team }} Provider{{ total_team|pluralize }}
                            </span>
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                        </div>
                    </div>
                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                </label>
                <div class="collapsible-content-title">
                    <div class="content-inner-title">
                        
                        {# Healthcare Practitioners - Card Style (Mobile-First) #}
                        {% if healthcare_data.practitioners %}
                        <div class="practitioners-card-container mb-4">
                            {% for practitioner in healthcare_data.practitioners %}
                            <div class="practitioner-card {% if not forloop.last %}border-bottom pb-3 mb-3{% endif %}">
                                <div class="mb-2">
                                    <h6 class="text-dark mb-1">
                                        <i class="fa-solid fa-user-md me-2 text-primary"></i>
                                        {{ practitioner.name|default:"Unknown Practitioner" }}
                                    </h6>
                                    {% if practitioner.identifiers %}
                                    <p class="text-muted small mb-2">
                                        <i class="fa-solid fa-id-badge me-1"></i>
                                        ID: {{ practitioner.identifiers.0.value }}
                                    </p>
                                    {% endif %}
                                    
                                    {# Role & Specialty Badges #}
                                    <div class="mb-2">
                                        {% if practitioner.roles %}
                                            {% for role in practitioner.roles %}
                                                <span class="badge bg-primary me-1 mb-1">{{ role }}</span>
                                            {% endfor %}
                                        {% elif practitioner.role %}
                                            <span class="badge bg-primary">{{ practitioner.role }}</span>
                                        {% endif %}
                                        {% if practitioner.specialty %}
                                            <span class="badge bg-info ms-1">{{ practitioner.specialty }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {# Organization #}
                                {% if practitioner.organization %}
                                <p class="mb-2 small text-muted">
                                    <i class="fa-solid fa-building me-2"></i>
                                    {{ practitioner.organization }}
                                </p>
                                {% endif %}
                                
                                {# Contact Information #}
                                {% if practitioner.telecoms %}
                                <div class="contact-info">
                                    <h6 class="mb-2 small"><i class="fa-solid fa-address-book me-2"></i>Contact Information:</h6>
                                    {% for telecom in practitioner.telecoms %}
                                        {% if telecom.system == "phone" %}
                                        <p class="mb-1 small">
                                            <i class="fa-solid fa-phone me-2 text-muted"></i>
                                            <strong>Phone:</strong> {{ telecom.value }}
                                        </p>
                                        {% elif telecom.system == "email" %}
                                        <p class="mb-1 small">
                                            <i class="fa-solid fa-envelope me-2 text-muted"></i>
                                            <strong>Email:</strong> {{ telecom.value }}
                                        </p>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {# Legal Authenticators #}
                        {% if administrative_data.legal_authenticators %}
                        <div class="legal-authenticators-group mb-4">
                            <h5 class="text-success mb-3">
                                <i class="fa-solid fa-certificate me-2"></i>Legal Authenticators & Document Signers
                            </h5>
                            <div class="row">
                                {% for authenticator in administrative_data.legal_authenticators %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <h6 class="card-title text-success">
                                                {{ authenticator.full_name|default:"Unknown Authenticator" }}
                                            </h6>
                                            <p class="text-muted small mb-2">Legal Authenticator</p>
                                            {% if authenticator.authentication_time %}
                                                <p class="mb-2 small">
                                                    <strong>Authentication:</strong> {{ authenticator.authentication_time }}
                                                </p>
                                            {% endif %}
                                            {% if authenticator.organization_name %}
                                                <p class="mb-0 small">
                                                    <strong>Organization:</strong> {{ authenticator.organization_name }}
                                                </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Healthcare Organizations Section - Collapsible Accordion #}
        {% if healthcare_data.organizations or administrative_data.organizations %}
        <div class="healthcare-organizations-section mb-4">
            <div class="collapsible-wrapper">
                <input id="toggle-healthcare-organizations" class="toggle-input" type="checkbox" checked>
                <label for="toggle-healthcare-organizations" class="collapsible-label-title">
                    <div class="clinical-section-title-row">
                        <div class="clinical-section-title">
                            <i class="fa-solid fa-hospital me-2"></i>
                            <span>Healthcare Organizations</span>
                        </div>
                        <div class="clinical-badge-container">
                            {% with org_count=healthcare_data.organizations|length %}
                            {% with admin_org_count=administrative_data.organizations|length %}
                            {% with total_orgs=org_count|add:admin_org_count %}
                            <span class="clinical-badge {% if total_orgs > 0 %}populated{% else %}empty{% endif %}">
                                {{ total_orgs }} Organization{{ total_orgs|pluralize }}
                            </span>
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                        </div>
                    </div>
                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                </label>
                <div class="collapsible-content-title">
                    <div class="content-inner-title">
                    
                    {# Display Organizations - Card Style #}
                    {% for organization in healthcare_data.organizations %}
                    <div class="{% if not forloop.last %}border-bottom pb-3 mb-3{% endif %}">
                        <div class="mb-2">
                            <h6 class="text-dark mb-1">
                                <i class="fa-solid fa-building me-2 text-secondary"></i>
                                {{ organization.name|default:"Unknown Organization" }}
                            </h6>
                            {% if organization.type %}
                                {% for org_type in organization.type %}
                                    <span class="badge bg-secondary me-1">{{ org_type.text|default:"Healthcare Organization" }}</span>
                                {% endfor %}
                            {% endif %}
                            {% if organization.part_of %}
                            <p class="small text-muted mb-0 mt-1">
                                Part of: {{ organization.part_of.display }}
                            </p>
                            {% endif %}
                        </div>
                        
                        {# Contact Information #}
                        <div class="contact-info">
                            <h6 class="mb-2 small"><i class="fa-solid fa-address-book me-2"></i>Contact Details:</h6>
                            {% if organization.contact %}
                                {% for contact in organization.contact %}
                                    {% if contact.address %}
                                    <p class="mb-1 small">
                                        <i class="fa-solid fa-location-dot me-2 text-muted"></i>
                                        {% for line in contact.address.line %}{{ line }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                    </p>
                                    <p class="mb-1 small ms-4">{{ contact.address.city }} {{ contact.address.postalCode }}</p>
                                    <p class="mb-2 small ms-4">{{ contact.address.country }}</p>
                                    {% endif %}
                                    {% if contact.telecom %}
                                        {% for telecom in contact.telecom %}
                                            {% if telecom.system == 'phone' %}
                                            <p class="mb-1 small">
                                                <i class="fa-solid fa-phone me-2 text-muted"></i>
                                                <strong>Tel {{ telecom.use|title }}:</strong> {{ telecom.value }}
                                            </p>
                                            {% elif telecom.system == 'email' %}
                                            <p class="mb-1 small">
                                                <i class="fa-solid fa-envelope me-2 text-muted"></i>
                                                <strong>Mail {{ telecom.use|title }}:</strong> {{ telecom.value }}
                                            </p>
                                            {% elif telecom.system == 'url' %}
                                            <p class="mb-1 small">
                                                <i class="fa-solid fa-globe me-2 text-muted"></i>
                                                <strong>Web:</strong> <a href="{{ telecom.value }}" target="_blank" rel="noopener">{{ telecom.value }}</a>
                                            </p>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            {% elif organization.addresses %}
                                {# Fallback to top-level addresses #}
                                {% with address=organization.addresses.0 %}
                                <p class="mb-1 small">
                                    <i class="fa-solid fa-location-dot me-2 text-muted"></i>
                                    {% for line in address.line %}{{ line }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                    {% if not address.line and address.street %}{{ address.street }}{% endif %}
                                </p>
                                <p class="mb-1 small ms-4">{{ address.city }} {{ address.postal_code }}</p>
                                <p class="mb-2 small ms-4">{{ address.country }}</p>
                                {% endwith %}
                                {% if organization.telecoms %}
                                    {% for telecom in organization.telecoms %}
                                        {% if telecom.system == 'phone' %}
                                        <p class="mb-1 small">
                                            <i class="fa-solid fa-phone me-2 text-muted"></i>
                                            <strong>Tel:</strong> {{ telecom.value }}
                                        </p>
                                        {% elif telecom.system == 'email' %}
                                        <p class="mb-1 small">
                                            <i class="fa-solid fa-envelope me-2 text-muted"></i>
                                            <strong>Mail:</strong> {{ telecom.value }}
                                        </p>
                                        {% elif telecom.system == 'url' %}
                                        <p class="mb-1 small">
                                            <i class="fa-solid fa-globe me-2 text-muted"></i>
                                            <strong>Web:</strong> <a href="{{ telecom.value }}" target="_blank" rel="noopener">{{ telecom.value }}</a>
                                        </p>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    {# Legacy administrative organizations #}
                    {% for organization in administrative_data.organizations %}
                    <div class="{% if not forloop.last %}border-bottom pb-3 mb-3{% endif %}">
                        <div class="mb-2">
                            <h6 class="text-dark mb-1">
                                <i class="fa-solid fa-building me-2 text-secondary"></i>
                                {{ organization.name|default:"Unknown Organization" }}
                            </h6>
                            {% if organization.organization_type %}
                            <span class="badge bg-secondary">{{ organization.organization_type }}</span>
                            {% endif %}
                        </div>
                        {% if organization.address or organization.telecom %}
                        <div class="contact-info">
                            <h6 class="mb-2 small"><i class="fa-solid fa-address-book me-2"></i>Contact Details:</h6>
                            {% if organization.address %}
                            <p class="mb-1 small">{{ organization.address }}</p>
                            {% endif %}
                            {% if organization.telecom %}
                            <p class="mb-1 small">{{ organization.telecom }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Document Metadata Section #}
        {% if administrative_data %}
        <div class="document-metadata-section mb-4">
            <div class="collapsible-wrapper">
                <input id="toggle-document-metadata" class="toggle-input" type="checkbox">
                <label for="toggle-document-metadata" class="collapsible-label-title">
                    <div class="clinical-section-title-row">
                        <div class="clinical-section-title">
                            <i class="fa-solid fa-file-medical me-2"></i>
                            <span>Document Metadata</span>
                        </div>
                        <div class="clinical-badge-container">
                            <span class="clinical-badge extended">Metadata</span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
                </label>
                <div class="collapsible-content-title">
                    <div class="content-inner-title">
                        
                        <div class="document-metadata-grid">
                            <div class="row">
                                {% if administrative_data.document_metadata.creation_date %}
                                <div class="col-md-6 mb-3">
                                    <div class="metadata-item">
                                        <strong>Creation Date:</strong>
                                        <span class="text-muted">{{ administrative_data.document_metadata.creation_date }}</span>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if administrative_data.document_metadata.last_update %}
                                <div class="col-md-6 mb-3">
                                    <div class="metadata-item">
                                        <strong>Last Update:</strong>
                                        <span class="text-muted">{{ administrative_data.document_metadata.last_update }}</span>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if administrative_data.document_metadata.version %}
                                <div class="col-md-6 mb-3">
                                    <div class="metadata-item">
                                        <strong>Version:</strong>
                                        <span class="text-muted">{{ administrative_data.document_metadata.version }}</span>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if administrative_data.document_metadata.custodian.name %}
                                <div class="col-md-6 mb-3">
                                    <div class="metadata-item">
                                        <strong>Custodian:</strong>
                                        <span class="text-muted">{{ administrative_data.document_metadata.custodian.name }}</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    {% else %}
        {# No administrative or healthcare data available #}
        <div class="alert alert-warning">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>
            <strong>Administrative Data Processing</strong>
            <p class="mb-0">
                Healthcare team and contact information is being processed. 
                This may include emergency contacts, healthcare providers, and organizational details.
            </p>
        </div>
    {% endif %}

</div>