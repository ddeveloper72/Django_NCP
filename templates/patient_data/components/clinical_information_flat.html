{# Clinical Information Content - Flat Structure for Clinical Information Tab #}
{% load patient_filters %}
{% load medication_filters %}

{# Check if we have any clinical data - including extended sections #}
{% if medications or allergies or problems or vital_signs or procedures or immunizations or history_of_past_illness or pregnancy_history or social_history or physical_findings or coded_results or laboratory_results or advance_directives or additional_sections %}
    
    {# Medical Problems Section #}
    {% if problems and problems.has_entries %}
    <div class="clinical-section">
        <div class="collapsible-wrapper">
            <input id="toggle-medical-problems" class="toggle-input" type="checkbox" checked>
            <label for="toggle-medical-problems" class="collapsible-label-title">
                <div class="clinical-section-title-row">
                    <div class="clinical-section-title">
                        <i class="fa-solid fa-triangle-exclamation me-2"></i>
                        <span>Medical Problems</span>
                    </div>
                    <div class="clinical-badge-container">
                        <span class="clinical-badge populated">✓ {{ problems|length }} Found</span>
                    </div>
                </div>
                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
            </label>
            <div class="collapsible-content-title">
                <div class="content-inner-title">
                    <p class="mb-3 text-muted">Medical Problems: {{ problems|length }} items found</p>
                    
                    {# Professional Medical Problems Table #}
                    <div class="medical-problems-table-container bg-white border rounded-3 shadow-sm overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 medical-problems-table">
                                <thead class="table-primary">
                                    <tr>
                                        <th scope="col" class="fw-bold">
                                            <i class="fa-solid fa-triangle-exclamation me-2"></i>Active Problem
                                        </th>
                                        <th scope="col" class="fw-bold">
                                            <i class="fa-solid fa-tags me-2"></i>Problem Type
                                        </th>
                                        <th scope="col" class="fw-bold">
                                            <i class="fa-solid fa-clock me-2"></i>Time
                                        </th>
                                        <th scope="col" class="fw-bold">
                                            <i class="fa-solid fa-check-circle me-2"></i>Problem Status
                                        </th>
                                        <th scope="col" class="fw-bold">
                                            <i class="fa-solid fa-exclamation-triangle me-2"></i>Severity
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for problem_entry in problems.entries %}
                                    <tr class="problem-row">
                                        {# Active Problem Column #}
                                        <td class="active-problem-cell">
                                            <div class="active-problem-content">
                                                <div class="problem-name text-primary fw-bold">
                                                    {{ problem_entry.problem_name|default:"Medical Problem" }}
                                                </div>
                                                {% if problem_entry.problem_code %}
                                                    <div class="problem-code text-muted small">
                                                        <i class="fa-solid fa-barcode me-1"></i>
                                                        {{ problem_entry.problem_code }}
                                                        {% if problem_entry.problem_code_system %} ({{ problem_entry.problem_code_system }}){% endif %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        
                                        {# Problem Type Column #}
                                        <td class="problem-type-cell">
                                            {% if problem_entry.problem_type %}
                                                <span class="badge bg-info me-1">{{ problem_entry.problem_type }}</span>
                                            {% else %}
                                                <span class="text-muted">Clinical finding</span>
                                            {% endif %}
                                        </td>
                                        
                                        {# Time Column #}
                                        <td class="problem-time-cell">
                                            {% if problem_entry.time_period %}
                                                <div class="time-info text-primary fw-bold">
                                                    {{ problem_entry.time_period }}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        
                                        {# Problem Status Column #}
                                        <td class="problem-status-cell">
                                            {% if problem_entry.problem_status %}
                                                {% if "active" in problem_entry.problem_status|lower %}
                                                    <span class="badge bg-danger text-white">
                                                        <i class="fa-solid fa-circle-exclamation me-1"></i>{{ problem_entry.problem_status }}
                                                    </span>
                                                {% elif "completed" in problem_entry.problem_status|lower or "resolved" in problem_entry.problem_status|lower %}
                                                    <span class="badge bg-success text-white">
                                                        <i class="fa-solid fa-check-circle me-1"></i>{{ problem_entry.problem_status }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary text-white">
                                                        <i class="fa-solid fa-info-circle me-1"></i>{{ problem_entry.problem_status }}
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        
                                        {# Severity Column #}
                                        <td class="severity-cell">
                                            {% if problem_entry.health_status %}
                                                {% if "severe" in problem_entry.health_status|lower %}
                                                    <span class="badge bg-danger text-white">
                                                        <i class="fa-solid fa-exclamation-triangle me-1"></i>{{ problem_entry.health_status }}
                                                    </span>
                                                {% elif "moderate" in problem_entry.health_status|lower %}
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="fa-solid fa-exclamation-triangle me-1"></i>{{ problem_entry.health_status }}
                                                    </span>
                                                {% elif "mild" in problem_entry.health_status|lower %}
                                                    <span class="badge bg-info text-white">
                                                        <i class="fa-solid fa-info-circle me-1"></i>{{ problem_entry.health_status }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary text-white">{{ problem_entry.health_status }}</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# Allergies & Intolerances Section #}
    <div class="clinical-section">
        <div class="collapsible-wrapper">
            <input id="toggle-allergies" class="toggle-input" type="checkbox">
            <label for="toggle-allergies" class="collapsible-label-title">
                <div class="clinical-section-title-row">
                    <div class="clinical-section-title">
                        <i class="fa-solid fa-triangle-exclamation me-2"></i>
                        <span>Allergies & Intolerances</span>
                    </div>
                    <div class="clinical-badge-container">
                        <span class="clinical-badge mandatory">⚠️ Mandatory</span>
                    </div>
                </div>
                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
            </label>
            <div class="collapsible-content-title">
                <div class="content-inner-title">
                    {% if allergies and allergies|length > 0 %}
                        <p class="mb-3 text-muted">Known allergies: {{ allergies|length }} items found</p>
                        {# Allergies table would go here #}
                    {% else %}
                        <div class="alert alert-info" role="alert">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            No allergies or intolerances data available in the patient record.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Medical Procedures Section #}
    <div class="clinical-section">
        <div class="collapsible-wrapper">
            <input id="toggle-procedures" class="toggle-input" type="checkbox">
            <label for="toggle-procedures" class="collapsible-label-title">
                <div class="clinical-section-title-row">
                    <div class="clinical-section-title">
                        <i class="fa-solid fa-user-md me-2"></i>
                        <span>Medical Procedures</span>
                    </div>
                    <div class="clinical-badge-container">
                        <span class="clinical-badge mandatory">⚠️ Mandatory</span>
                    </div>
                </div>
                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
            </label>
            <div class="collapsible-content-title">
                <div class="content-inner-title">
                    {% if procedures and procedures|length > 0 %}
                        <p class="mb-3 text-muted">Medical procedures: {{ procedures|length }} items found</p>
                        {# Procedures table would go here #}
                    {% else %}
                        <div class="alert alert-info" role="alert">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            No medical procedures data available in the patient record.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Medical Devices Section #}
    <div class="clinical-section">
        <div class="collapsible-wrapper">
            <input id="toggle-devices" class="toggle-input" type="checkbox">
            <label for="toggle-devices" class="collapsible-label-title">
                <div class="clinical-section-title-row">
                    <div class="clinical-section-title">
                        <i class="fa-solid fa-stethoscope me-2"></i>
                        <span>Medical Devices</span>
                    </div>
                    <div class="clinical-badge-container">
                        <span class="clinical-badge mandatory">⚠️ Mandatory</span>
                    </div>
                </div>
                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
            </label>
            <div class="collapsible-content-title">
                <div class="content-inner-title">
                    <div class="alert alert-info" role="alert">
                        <i class="fa-solid fa-info-circle me-2"></i>
                        No medical device usage documented in the patient record.
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Vital Signs Section #}
    {% if vital_signs and vital_signs.has_entries %}
    <div class="clinical-section">
        <div class="collapsible-wrapper">
            <input id="toggle-vital-signs" class="toggle-input" type="checkbox">
            <label for="toggle-vital-signs" class="collapsible-label-title">
                <div class="clinical-section-title-row">
                    <div class="clinical-section-title">
                        <i class="fa-solid fa-heartbeat me-2"></i>
                        <span>Vital Signs</span>
                    </div>  
                    <div class="clinical-badge-container">
                        <span class="clinical-badge populated">✓ {{ vital_signs|length }} Found</span>
                    </div>
                </div>
                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
            </label>
            <div class="collapsible-content-title">
                <div class="content-inner-title">
                    <p class="mb-3 text-muted">Vital Signs: {{ vital_signs|length }} items found</p>
                    {% for vital_sign_entry in vital_signs.entries %}
                        <h6>Vital Sign (Code: {{ vital_sign_entry.code|default:"Unknown" }})</h6>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# Extended Clinical Information Header #}
    {% if history_of_past_illness or immunizations or pregnancy_history or social_history or physical_findings or laboratory_results or advance_directives or additional_sections %}
    <div class="extended-clinical-header">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-3">
                <h5 class="card-title text-healthcare-teal mb-1">
                    <i class="fa-solid fa-microscope me-2"></i>Extended Clinical Information
                </h5>
                <p class="card-text text-muted mb-0">Additional clinical data available in this patient summary</p>
            </div>
        </div>
    </div>

    {# History of Past Illness Section #}
    {% if history_of_past_illness and history_of_past_illness.has_entries %}
    <div class="clinical-section">
        <div class="collapsible-wrapper">
            <input id="toggle-history-past-illness" class="toggle-input" type="checkbox">
            <label for="toggle-history-past-illness" class="collapsible-label-title">
                <div class="clinical-section-title-row">
                    <div class="clinical-section-title">
                        <i class="fa-solid fa-history me-2"></i>
                        <span>History of Past Illness</span>
                    </div>
                    <div class="clinical-badge-container">
                        <span class="clinical-badge populated">✓ {{ history_of_past_illness|length }} Found</span>
                    </div>
                </div>
                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
            </label>
            <div class="collapsible-content-title">
                <div class="content-inner-title">
                    <p class="mb-3 text-muted">History of Past Illness: {{ history_of_past_illness|length }} closed/inactive conditions</p>
                    <div class="history-table-container bg-white border rounded-3 shadow-sm overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-secondary">
                                    <tr>
                                        <th scope="col">Closed/Inactive Problem</th>
                                        <th scope="col">Problem Type</th>
                                        <th scope="col">Time</th>
                                        <th scope="col">Problem Status</th>
                                        <th scope="col">Health Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for illness_entry in history_of_past_illness_entry.entries %}
                                    <tr>
                                        <td>
                                            <div class="problem-name text-muted">
                                                {{ illness_entry.name|default:illness_entry.problem.text|default:"Past Medical Condition" }}
                                            </div>
                                            {% if illness_entry.code %}
                                                <div class="problem-code text-muted small">
                                                    <i class="fa-solid fa-barcode me-1"></i>{{ illness_entry.code }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>{{ illness_entry.type|default:"-" }}</td>
                                        <td>
                                            {% if illness_entry.time_display %}
                                                <div class="time-info text-muted">{{ illness_entry.time_display }}</div>
                                            {% else %}
                                                <div class="time-info text-muted">
                                                    <i class="fa-solid fa-clock me-1"></i>Time not specified
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>{{ illness_entry.status|default:"-" }}</td>
                                        <td>
                                            {% if illness_entry.health_status %}
                                                <span class="badge bg-secondary">{{ illness_entry.health_status }}</span>
                                            {% else %}
                                                <div class="health-status text-muted">
                                                    <i class="fa-solid fa-heart me-1"></i>Health status not specified
                                                </div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# Immunizations/Vaccinations Section #}
    {% if immunizations and immunizations.has_entries %}
    <div class="clinical-section">
        <div class="collapsible-wrapper">
            <input id="toggle-immunizations" class="toggle-input" type="checkbox">
            <label for="toggle-immunizations" class="collapsible-label-title">
                <div class="clinical-section-title-row">
                    <div class="clinical-section-title">
                        <i class="fa-solid fa-syringe me-2"></i>
                        <span>Immunizations & Vaccinations</span>
                    </div>
                    <div class="clinical-badge-container">
                        <span class="clinical-badge extended">✓ ⊕ {{ immunizations|length }} Found</span>
                    </div>
                </div>
                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
            </label>
            <div class="collapsible-content-title">
                <div class="content-inner-title">
                    <p class="mb-3 text-muted">
                        <i class="fa-solid fa-syringe me-1"></i>
                        Vaccination history: {{ immunizations|length }} immunization records
                    </p>
                    
                    <div class="immunizations-table-container bg-white border rounded-3 shadow-sm overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-success">
                                    <tr>
                                        <th scope="col">Vaccination</th>
                                        <th scope="col">Brand Name</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Agent/Target</th>
                                        <th scope="col">Manufacturer</th>
                                        <th scope="col">Dose #</th>
                                        <th scope="col">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for immunization_entry in immunizations.entries %}
                                    <tr>
                                        <td>
                                            <div class="vaccination-name text-primary fw-bold">
                                                {{ immunization_entry.vaccination_name|default:immunization_entry.vaccine_name|default:"Vaccination Record" }}
                                            </div>
                                            {% if immunization_entry.code %}
                                                <div class="vaccination-code text-muted small">
                                                    <i class="fa-solid fa-barcode me-1"></i>{{ immunization_entry.code }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if immunization_entry.brand_name %}
                                                <div class="brand-name text-primary">
                                                    <i class="fa-solid fa-tag me-1"></i>
                                                    {{ immunization_entry.brand_name }}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">Not specified</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if immunization_entry.date %}
                                                <div class="vaccination-date text-success fw-bold">{{ immunization_entry.date }}</div>
                                            {% else %}
                                                <span class="text-muted">Not specified</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if immunization_entry.agent %}
                                                <div class="vaccination-agent text-info fw-bold">{{ immunization_entry.agent }}</div>
                                            {% else %}
                                                <span class="text-muted">Not specified</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if immunization_entry.manufacturer %}
                                                <span class="text-primary">{{ immunization_entry.manufacturer }}</span>
                                            {% else %}
                                                <span class="text-muted">Not specified</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if immunization_entry.dose_number %}
                                                <span class="badge bg-primary">{{ immunization_entry.dose_number }}</span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if immunization_entry.status %}
                                                {% if "completed" in immunization_entry.status|lower %}
                                                    <span class="badge bg-success">{{ immunization_entry.status }}</span>
                                                {% elif "active" in immunization_entry.status|lower %}
                                                    <span class="badge bg-warning">{{ immunization_entry.status }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ immunization_entry.status }}</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-secondary">Unknown</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# Physical Findings Section #}
    {% if physical_findings and physical_findings.has_entries %}
    <div class="clinical-section">
        <div class="collapsible-wrapper">
            <input id="toggle-physical-findings" class="toggle-input" type="checkbox">
            <label for="toggle-physical-findings" class="collapsible-label-title">
                <div class="clinical-section-title-row">
                    <div class="clinical-section-title">
                        <i class="fa-solid fa-stethoscope me-2"></i>
                        <span>Physical Findings</span>
                    </div>
                    <div class="clinical-badge-container">
                        <span class="clinical-badge populated">✓ {{ physical_findings|length }} Found</span>
                    </div>
                </div>
                <i class="fas fa-chevron-down toggle-icon" aria-hidden="true"></i>
            </label>
            <div class="collapsible-content-title">
                <div class="content-inner-title">
                    <p class="mb-3 text-muted">Physical Findings: {{ physical_findings|length }} observations found</p>
                    <div class="physical-findings-table-container bg-white border rounded-3 shadow-sm overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-info">
                                    <tr>
                                        <th scope="col">
                                            <i class="fa-solid fa-stethoscope me-2"></i>Observation Type
                                        </th>
                                        <th scope="col">
                                            <i class="fa-solid fa-chart-line me-2"></i>Observation Value
                                        </th>
                                        <th scope="col">
                                            <i class="fa-solid fa-clock me-2"></i>Observation Time
                                        </th>
                                        <th scope="col">
                                            <i class="fa-solid fa-barcode me-2"></i>Clinical Code
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for finding_entry in physical_findings.entries %}
                                    <tr>
                                        <td>
                                            <strong class="text-info">{{ finding_entry.observation_type|default:finding_entry.finding_type|default:"Physical Finding" }}</strong>
                                            {% if finding_entry.status %}
                                                <div class="finding-status text-muted small">Status: {{ finding_entry.status }}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if finding_entry.value %}
                                                <span class="text-primary fw-bold">{{ finding_entry.value }}</span>
                                                {% if finding_entry.unit %}
                                                    <span class="text-muted"> {{ finding_entry.unit }}</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">No value recorded</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if finding_entry.time %}
                                                <span class="text-success">{{ finding_entry.time }}</span>
                                            {% else %}
                                                <span class="text-muted">Time not specified</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if finding_entry.code %}
                                                <code class="text-primary">{{ finding_entry.code }}</code>
                                            {% else %}
                                                <span class="text-muted">No code available</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

{% else %}
    <div class="alert alert-info" role="alert">
        <i class="fa-solid fa-info-circle me-2"></i>
        No clinical information available for this patient.
    </div>
{% endif %}