{% extends 'patient_data/base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">ðŸ”„ EADC Integration Dashboard</h1>
                <div class="d-flex align-items-center">
                    <!-- User Role Badge -->
                    {% if user_is_admin %}
                    <span class="badge bg-danger me-2">
                        <i class="fas fa-user-shield"></i> EADC Administrator
                    </span>
                    {% elif user_is_operator %}
                    <span class="badge bg-warning me-2">
                        <i class="fas fa-user-cog"></i> EADC Operator
                    </span>
                    {% endif %}

                    <div class="btn-group">
                        <a href="{% url 'patient_search' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-search"></i> Patient Search
                        </a>
                        <a href="{% url 'eadc_transformation_history' %}" class="btn btn-outline-info">
                            <i class="fas fa-history"></i> History
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Access Control Notice -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Administrative Service Notice:</strong>
                EADC (Epsos Automatic Data Collector) is a restricted service for clinical document transformation and
                validation.
                {% if user_is_admin %}
                As an administrator, you have full access to all EADC functions including document transformation and
                processing.
                {% elif user_is_operator %}
                As an operator, you can view documents and perform basic validation. Document transformation requires
                administrator privileges.
                {% endif %}
                All activities are logged for audit purposes.
            </div>
        </div>
    </div>

    <!-- EADC Status Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="card-title h5">Document Types</div>
                            <div class="display-4">{{ supported_transformations|length }}</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-medical fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="card-title h5">Demo Documents</div>
                            <div class="display-4">{{ demo_documents|length }}</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-vial fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="card-title h5">Recent Documents</div>
                            <div class="display-4">{{ recent_documents|length }}</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="card-title h5">EADC Status</div>
                            <div class="h6">
                                {% if eadc_config_path %}
                                <i class="fas fa-check-circle"></i> Active
                                {% else %}
                                <i class="fas fa-exclamation-triangle"></i> Inactive
                                {% endif %}
                            </div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cogs fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supported Transformations -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exchange-alt"></i> Supported Document Transformations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for code, info in supported_transformations.items %}
                        <div class="col-md-4 mb-3">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <span class="badge badge-primary">{{ code }}</span>
                                        {{ info.name }}
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            Template ID: {{ info.template_id }}
                                        </small>
                                    </p>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary"
                                            onclick="validateSampleDocument('{{ code }}')">
                                            <i class="fas fa-check"></i> Validate
                                        </button>
                                        {% if user_is_admin %}
                                        <button class="btn btn-outline-success"
                                            onclick="transformSampleDocument('{{ code }}')">
                                            <i class="fas fa-exchange-alt"></i> Transform
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-secondary" disabled
                                            title="Administrator privileges required">
                                            <i class="fas fa-lock"></i> Transform
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Demo Documents Section -->
    {% if demo_documents %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-vial"></i> Demo Documents
                    </h5>
                </div>
                <div class="card-body">
                    {% for demo in demo_documents %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        {{ demo.name }}
                                        <span class="badge badge-info">{{ demo.type }}</span>
                                    </h6>
                                    <p class="card-text">{{ demo.description }}</p>
                                    <small class="text-muted">
                                        Source: {{ demo.source }} |
                                        Size: {{ demo.content|length|filesizeformat }}
                                    </small>
                                </div>
                                <div class="col-md-4 text-right">
                                    <div class="btn-group">
                                        {% if user_is_operator %}
                                        <a href="{% url 'process_demo_document' demo.type %}" class="btn btn-success">
                                            <i class="fas fa-play"></i> Process Demo
                                        </a>
                                        {% else %}
                                        <button class="btn btn-secondary" disabled
                                            title="EADC operator privileges required">
                                            <i class="fas fa-lock"></i> Process Demo
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-outline-info"
                                            onclick="viewDemoContent('{{ demo.name }}', '{{ demo.content|escapejs }}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Documents -->
    {% if recent_documents %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock"></i> Recent Clinical Documents
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Document Type</th>
                                    <th>Format</th>
                                    <th>Country</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in recent_documents %}
                                <tr>
                                    <td>
                                        <a href="{% url 'eadc_patient_documents' doc.patient.patient_id %}">
                                            {{ doc.patient.given_name }} {{ doc.patient.family_name }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge badge-secondary">{{ doc.document_type }}</span>
                                    </td>
                                    <td>{{ doc.document_format }}</td>
                                    <td>
                                        <img src="https://flagcdn.com/16x12/{{ doc.country_code|lower }}.png"
                                            alt="{{ doc.country_code }}" class="me-1">
                                        {{ doc.country_code }}
                                    </td>
                                    <td>
                                        {% if doc.status == 'available' %}
                                        <span class="badge badge-success">Available</span>
                                        {% elif doc.status == 'processing' %}
                                        <span class="badge badge-warning">Processing</span>
                                        {% else %}
                                        <span class="badge badge-secondary">{{ doc.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ doc.created_at|date:"M d, Y H:i" }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'view_clinical_document' doc.id %}"
                                                class="btn btn-outline-primary" title="View Document">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if doc.metadata.eadc_processing_id %}
                                            <span class="badge badge-success" title="EADC Processed">
                                                <i class="fas fa-check"></i>
                                            </span>
                                            {% elif user_is_admin %}
                                            <button class="btn btn-outline-warning"
                                                onclick="processDocumentEADC({{ doc.id }})"
                                                title="Process through EADC">
                                                <i class="fas fa-cogs"></i>
                                            </button>
                                            {% else %}
                                            <button class="btn btn-outline-secondary" disabled
                                                title="Administrator privileges required">
                                                <i class="fas fa-lock"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Document Validator Tool -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle"></i> CDA Document Validator
                    </h5>
                </div>
                <div class="card-body">
                    <form id="validationForm">
                        <div class="form-group">
                            <label for="documentType">Document Type:</label>
                            <select class="form-control" id="documentType" name="document_type">
                                {% for code, info in supported_transformations.items %}
                                <option value="{{ code }}">{{ info.name }} ({{ code }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="documentContent">CDA Document Content:</label>
                            <textarea class="form-control" id="documentContent" name="document_content" rows="10"
                                placeholder="Paste your CDA document XML here..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Validate Document
                        </button>
                    </form>

                    <div id="validationResult" class="mt-3" style="display: none;">
                        <!-- Validation results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Demo Content Modal -->
<div class="modal fade" id="demoContentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Demo Document Content</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre id="demoContentDisplay" class="bg-light p-3" style="max-height: 500px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Document validation
    document.getElementById('validationForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = {
            document_content: document.getElementById('documentContent').value,
            document_type: document.getElementById('documentType').value
        };

        if (!formData.document_content.trim()) {
            alert('Please enter document content to validate');
            return;
        }

        fetch('{% url "validate_cda_document" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                displayValidationResult(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error validating document: ' + error.message);
            });
    });

    function displayValidationResult(data) {
        const resultDiv = document.getElementById('validationResult');

        if (data.success) {
            const validation = data.validation;
            let html = '<div class="card">';
            html += '<div class="card-header">';
            html += validation.is_valid ?
                '<h6 class="text-success"><i class="fas fa-check-circle"></i> Document Valid</h6>' :
                '<h6 class="text-danger"><i class="fas fa-times-circle"></i> Document Invalid</h6>';
            html += '</div>';
            html += '<div class="card-body">';

            // Basic info
            html += '<div class="row mb-3">';
            html += '<div class="col-md-6">';
            html += '<strong>Document Type:</strong> ' + validation.document_type + '<br>';
            html += '<strong>Template ID:</strong> ' + (validation.template_id || 'Not found') + '<br>';
            html += '<strong>epSOS Compliant:</strong> ' +
                (validation.epsos_compliant ?
                    '<span class="badge badge-success">Yes</span>' :
                    '<span class="badge badge-warning">No</span>');
            html += '</div>';
            html += '</div>';

            // Errors
            if (validation.errors && validation.errors.length > 0) {
                html += '<div class="alert alert-danger">';
                html += '<strong>Errors:</strong><ul class="mb-0">';
                validation.errors.forEach(error => {
                    html += '<li>' + error + '</li>';
                });
                html += '</ul></div>';
            }

            // Warnings
            if (validation.warnings && validation.warnings.length > 0) {
                html += '<div class="alert alert-warning">';
                html += '<strong>Warnings:</strong><ul class="mb-0">';
                validation.warnings.forEach(warning => {
                    html += '<li>' + warning + '</li>';
                });
                html += '</ul></div>';
            }

            html += '</div></div>';
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + data.error + '</div>';
        }

        resultDiv.style.display = 'block';
    }

    function viewDemoContent(name, content) {
        document.querySelector('#demoContentModal .modal-title').textContent = name;
        document.getElementById('demoContentDisplay').textContent = content;
        $('#demoContentModal').modal('show');
    }

    function processDocumentEADC(documentId) {
        if (confirm('Process this document through EADC transformation pipeline?')) {
            fetch(`/patient_data/eadc/process_document/${documentId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Document processed successfully through EADC');
                        location.reload();
                    } else {
                        alert('Error processing document: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error processing document: ' + error.message);
                });
        }
    }
</script>
{% endblock %}