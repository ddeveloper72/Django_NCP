{% extends "base.html" %}
{% load static %}

{% block title %}Patient Summary - EU eHealth NCP{% endblock %}

{% block content %}
<div class="forms-page">
    <!-- Document Header -->
    <div class="page-header">
        <h1 class="document-title">üìã Patient Medical Summary</h1>
        <p class="page-subtitle">European Cross-Border Healthcare Document</p>
    </div>

    <div class="container">
        <!-- Patient Information Section -->
        <div class="card mb-lg">
            <div class="card-header">
                <h3>üë§ Patient Information</h3>
            </div>
            <div class="card-body">
                {% if patient_data %}
                <div class="row">
                    <div class="col col-md-6">
                        <div class="form-group">
                            <label class="form-label">Full Name:</label>
                            <p class="text-lg font-medium">{{ patient_data.name|default:"Not provided" }}</p>
                        </div>
                    </div>
                    <div class="col col-md-6">
                        <div class="form-group">
                            <label class="form-label">Date of Birth:</label>
                            <p class="text-lg">{{ patient_data.birth_date|default:"Not provided" }}</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col col-md-6">
                        <div class="form-group">
                            <label class="form-label">Gender:</label>
                            <p>{{ patient_data.gender|default:"Not provided" }}</p>
                        </div>
                    </div>
                    <div class="col col-md-6">
                        <div class="form-group">
                            <label class="form-label">Patient ID:</label>
                            <p class="font-mono">{{ patient_data.patient_id|default:"Not provided" }}</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <div class="alert-content">
                        <strong>No Patient Data Available</strong><br>
                        Patient information could not be retrieved from the European health network.
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Medical Summary Section -->
        {% if medical_summary %}
        <div class="card mb-lg">
            <div class="card-header">
                <h3>üè• Medical Summary</h3>
            </div>
            <div class="card-body">
                <div class="grid-auto-lg">
                    {% for section_name, section_data in medical_summary.items %}
                    <div class="info-card">
                        <h4>{{ section_name|title }}</h4>
                        {% if section_data %}
                        {% if section_data|length > 1 %}
                        <ul class="mt-md">
                            {% for item in section_data %}
                            <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="mt-sm">{{ section_data.0 }}</p>
                        {% endif %}
                        {% else %}
                        <p class="text-muted mt-sm">No information available</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Document Metadata -->
        <div class="card mb-lg">
            <div class="card-header">
                <h3>üìÑ Document Information</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col col-md-4">
                        <div class="form-group">
                            <label class="form-label">Country:</label>
                            <p>{{ country|default:"Unknown" }}</p>
                        </div>
                    </div>
                    <div class="col col-md-4">
                        <div class="form-group">
                            <label class="form-label">Document Type:</label>
                            <p>{{ document_type|default:"Patient Summary" }}</p>
                        </div>
                    </div>
                    <div class="col col-md-4">
                        <div class="form-group">
                            <label class="form-label">Retrieved:</label>
                            <p>{{ retrieved_date|default:"Just now" }}</p>
                        </div>
                    </div>
                </div>

                {% if source_url %}
                <div class="alert alert-info mt-lg">
                    <div class="alert-content">
                        <strong>Source System:</strong>
                        <a href="{{ source_url }}" target="_blank" rel="noopener" class="text-primary">{{ source_url
                            }}</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
            <div class="form-actions-left">
                <a href="{% url 'patients:search' %}" class="btn btn-secondary">‚Üê Back to Search</a>
            </div>
            <div class="form-actions-right">
                <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Print Summary</button>
                {% if can_export %}
                <a href="?export=pdf" class="btn btn-primary">üìÑ Export PDF</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
<h1 class="document-title">Patient Summary Document</h1>
</div>

<!-- Access Information -->
<div class="access-info {% if patient_data.break_glass_access %}access-break-glass{% endif %}">
    <div class="access-header">
        <div>
            <strong>Access Type:</strong> {{ patient_data.get_access_type }}
            {% if patient_data.break_glass_access %}
            - <strong>Emergency Access</strong>
            {% endif %}
        </div>
        <div>
            <strong>Accessed:</strong> {{ patient_data.access_timestamp|date:"Y-m-d H:i:s T" }}
        </div>
    </div>
    {% if patient_data.break_glass_reason %}
    <div class="emergency-reason">
        <strong>Emergency Reason:</strong> {{ patient_data.break_glass_reason }}
    </div>
    {% endif %}
</div>

<!-- Patient Information Section -->
<div class="patient-section">
    <div class="section-header">
        <span>‚ñº</span> Patient
    </div>
    <div class="patient-details-grid">
        <div class="detail-row">
            <div class="detail-label">Prefix</div>
            <div class="detail-value">{{ patient_data.prefix|default:"-" }}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Family Name</div>
            <div class="detail-value">{{ patient_data.family_name|default:"-" }}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Given Name</div>
            <div class="detail-value">{{ patient_data.given_name|default:"-" }}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Primary Patient Identifier</div>
            <div class="detail-value">{{ patient_data.patient_identifier.patient_id }}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Gender</div>
            <div class="detail-value">{{ patient_data.get_gender_display|default:"-" }}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Date of Birth</div>
            <div class="detail-value">
                {% if patient_data.birth_date %}
                {{ patient_data.birth_date|date:"Y-m-d H:i:s T" }}
                {% else %}
                -
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Expandable Details Section -->
    <div class="section-header expandable" onclick="toggleSection('patientDetails')">
        <span class="expand-icon" id="patientDetailsIcon">‚ñ∂</span> See details
    </div>
    <div class="collapsible-content" id="patientDetailsContent">
        <div class="section-content">
            <div class="detail-row">
                <div class="detail-label">Address</div>
                <div class="detail-value">{{ patient_data.address_line|default:"-" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">City</div>
                <div class="detail-value">{{ patient_data.city|default:"-" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Postal Code</div>
                <div class="detail-value">{{ patient_data.postal_code|default:"-" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Country</div>
                <div class="detail-value">{{ patient_data.country|default:member_state.country_name }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Document Metadata -->
<div class="document-metadata">
    <div class="metadata-item">
        <div class="metadata-label">Creation Date of the Document</div>
        <div class="metadata-value">{{ patient_data.access_timestamp|date:"Y-m-d H:i:s T" }}</div>
    </div>
    <div class="metadata-item">
        <div class="metadata-label">Last Update of the Information</div>
        <div class="metadata-value">{{ patient_data.access_timestamp|date:"Y-m-d H:i:s T" }}</div>
    </div>
    <div class="metadata-item">
        <div class="metadata-label">Original Document Language</div>
        <div class="metadata-value">
            <span class="language-indicator">
                {{ member_state.language_code|upper }} - {{ member_state.country_name }}
            </span>
        </div>
    </div>
</div>

<!-- Clinical Sections -->
{% if patient_data.raw_patient_summary %}
<!-- Allergies and Adverse Reactions -->
<div class="clinical-section">
    <div class="clinical-header">
        <span>‚ñº Allergies and adverse reactions Document</span>
    </div>

    <!-- Original Narrative -->
    <div class="subsection">
        <div class="subsection-header" onclick="toggleSection('allergiesOriginal')">
            <span class="expand-icon" id="allergiesOriginalIcon">‚ñ∂</span> Original narrative
        </div>
        <div class="collapsible-content" id="allergiesOriginalContent">
            <div class="subsection-content">
                <div class="original-narrative">
                    <p><strong>Original Language:</strong> {{ member_state.language_code|upper }}</p>
                    <p>{{ patient_data.allergies_narrative|default:"No allergies information available in original
                        language." }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Translated Coded -->
    <div class="subsection">
        <div class="subsection-header" onclick="toggleSection('allergiesTranslated')">
            <span class="expand-icon" id="allergiesTranslatedIcon">‚ñ∂</span> Translated coded
        </div>
        <div class="collapsible-content" id="allergiesTranslatedContent">
            <div class="subsection-content">
                <div class="translated-coded">
                    <table class="coded-data-table">
                        <thead>
                            <tr>
                                <th>Reaction Type</th>
                                <th>Clinical Manifestation</th>
                                <th>Agent</th>
                                <th>Duration</th>
                                <th>Severity</th>
                                <th>Criticality</th>
                                <th>Allergy Status</th>
                                <th>Certainty</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Allergic disposition</td>
                                <td>-</td>
                                <td>BETA-LACTAM ANTIBACTERIALS, PENICILLINS</td>
                                <td>From 2018-01-12 00:00:00 (CET)</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                            <!-- Additional allergy records would be rendered here -->
                        </tbody>
                    </table>
                    <p class="translation-note">
                        <em>Translated from {{ member_state.language_code|upper }} to English using EU terminology
                            mapping services.</em>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Problem List -->
<div class="clinical-section">
    <div class="clinical-header">
        <span>‚ñº Problem list - Reported Problem list - Reported</span>
    </div>

    <!-- Original Narrative -->
    <div class="subsection">
        <div class="subsection-header" onclick="toggleSection('problemsOriginal')">
            <span class="expand-icon" id="problemsOriginalIcon">‚ñ∂</span> Original narrative
        </div>
        <div class="collapsible-content" id="problemsOriginalContent">
            <div class="subsection-content">
                <div class="original-narrative">
                    <p><strong>Original Language:</strong> {{ member_state.language_code|upper }}</p>
                    <p>{{ patient_data.problems_narrative|default:"No problems information available in original
                        language." }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Translated Coded -->
    <div class="subsection">
        <div class="subsection-header" onclick="toggleSection('problemsTranslated')">
            <span class="expand-icon" id="problemsTranslatedIcon">‚ñ∂</span> Translated coded
        </div>
        <div class="collapsible-content" id="problemsTranslatedContent">
            <div class="subsection-content">
                <div class="translated-coded">
                    <p>Structured problem list data would be displayed here after translation processing.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="no-data-message">
    <p>No clinical data available for this patient.</p>
</div>
{% endif %}
</div>

<script>
    function toggleSection(sectionId) {
        const content = document.getElementById(sectionId + 'Content');
        const icon = document.getElementById(sectionId + 'Icon');

        if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            icon.classList.remove('expanded');
            icon.textContent = '‚ñ∂';
        } else {
            content.classList.add('expanded');
            icon.classList.add('expanded');
            icon.textContent = '‚ñº';
        }
    }

    // Initialize some sections as expanded
    document.addEventListener('DOMContentLoaded', function () {
        // You can auto-expand certain sections here if needed
    });
</script>
{% endblock %}