{% extends "base.html" %}

{% load static %}
{% block title %}Patient Details - EU NCP Portal{% endblock %}

{% block extra_css %}
<link href="{% static 'css/patient_cda_ps_guidelines.css' %}?v=20250804" rel="stylesheet" media="screen">
{% endblock %}

{% block page_context %}
<div class="page-context-content">
    <div class="page-info">
        <span class="page-location">
            <i class="fa fa-user"></i> Patient Details
        </span>
    </div>
    <div class="page-actions">
        <a href="{% url 'patient_data:patient_data_form' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-arrow-left"></i> Back to Search
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="patient-details-container">
    <div class="patient-details-header">
        <h1 class="page-title">Patient Details</h1>

        {% if has_cda_match %}
        <div class="match-confidence-badge success">
            <i class="icon-check-circle"></i>
            Match Found: {{ match_confidence }}% Confidence
        </div>
        {% else %}
        <div class="match-confidence-badge warning">
            <i class="icon-alert-circle"></i>
            No Matching Records Found
        </div>
        {% endif %}
    </div>

    {% if session_error %}
    <div class="alert alert-warning session-error-alert">
        <div class="session-error-content">
            <i class="fa fa-exclamation-triangle session-error-icon"></i>
            <div class="session-error-text">
                <strong>Session Expired</strong>
                <p class="session-error-message">{{ session_error }}</p>
                <p class="session-error-action">
                    <a href="{% url 'patient_data:patient_data_form' %}" class="session-error-link">
                        <i class="fa fa-search"></i> Search Again
                    </a>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="patient-details-grid">
        <!-- Patient Information -->
        <div class="patient-info-card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="icon-user"></i>
                    Patient Information
                    {% if has_cda_match %}
                    <span class="match-indicator">
                        <i class="icon-check-circle"></i>
                        {{ match_confidence }}% Match
                    </span>
                    {% endif %}
                </h2>
                {% if has_cda_match %}
                <div class="card-subtitle">
                    Source: {{ source_country }} â€¢ Document: Patient Summary ({{ preferred_cda_type|default:"L3" }})
                </div>
                {% endif %}
            </div>

            <div class="card-content">
                <div class="info-grid">
                    <div class="info-item">
                        <label class="info-label">Full Name:</label>
                        <span class="info-value">{{ patient_data.given_name }} {{ patient_data.family_name }}</span>
                    </div>

                    <div class="info-item">
                        <label class="info-label">Date of Birth:</label>
                        <span class="info-value">
                            {% if patient_data.birth_date %}
                            {{ patient_data.birth_date|date:"d F Y" }}
                            {% else %}
                            Not provided
                            {% endif %}
                        </span>
                    </div>

                    <div class="info-item">
                        <label class="info-label">Gender:</label>
                        <span class="info-value">{{ patient_data.get_gender_display|default:"Not specified" }}</span>
                    </div>

                    <div class="info-item">
                        <label class="info-label">Country:</label>
                        <span class="info-value">{% if source_country_display %}{{ source_country_display }}{% else %}Not specified{% endif %}</span>
                    </div>

                    {% if has_cda_match and patient_summary.patient_identifiers %}
                    {% for identifier in patient_summary.patient_identifiers %}
                    <div class="info-item">
                        <label class="info-label">Patient ID{% if identifier.assigningAuthorityName %} ({{ identifier.assigningAuthorityName }}){% elif identifier.root %} ({{ identifier.root }}){% endif %}:</label>
                        <span class="info-value">{{ identifier.extension }}</span>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if patient_data.patient_id %}
                    <div class="info-item">
                        <label class="info-label">Patient ID:</label>
                        <span class="info-value">{{ patient_id }}</span>
                    </div>
                    {% endif %}

                    <div class="info-item">
                        <label class="info-label">Submitted:</label>
                        <span class="info-value">
                            {% if patient_data.access_timestamp %}
                            {{ patient_data.access_timestamp|date:"j F Y, g:i:s A O" }}
                            {% elif patient_data.patient_identifier.created_at %}
                            {{ patient_data.patient_identifier.created_at|date:"j F Y, g:i:s A O" }}
                            {% else %}
                            Not available
                            {% endif %}
                        </span>
                    </div>

                    {% if has_cda_match and patient_summary.file_path %}
                    <div class="info-item">
                        <label class="info-label">Source File:</label>
                        <span class="info-value">{{ patient_summary.file_path|default:"Unknown" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if has_cda_match %}
        <!-- Document Actions -->
        <div class="document-actions-card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="icon-download"></i>
                    Document Actions
                </h2>
            </div>

            <div class="card-content">
                <div class="action-buttons">
                    <!-- View CDA Document - Dynamic type based on user selection -->
                    {% with selected_cda_type=preferred_cda_type|default:"L3" %}
                    <a href="{% url 'patient_data:patient_cda_view_typed' patient_id selected_cda_type %}"
                        class="action-button primary">
                        <i class="icon-eye"></i>
                        View CDA Document
                        <span class="button-subtitle">{{ selected_cda_type }} Browser View</span>
                    </a>

                    <!-- Document Selection - Multiple Documents Available -->
                    {% if l1_available and l3_available %}
                    {% with total_docs=2 %}
                    <a href="{% url 'patient_data:select_document' patient_id %}" class="action-button selection">
                        <i class="icon-list"></i>
                        Select Document
                        <span class="button-subtitle">
                            {{ total_docs }} Available
                        </span>
                    </a>
                    {% endwith %}
                    {% endif %}

                    <!-- CDA Download - Always uses L1 for better PDF structure when available -->
                    <a href="{% url 'patient_data:download_cda_pdf' patient_id %}" class="action-button secondary">
                        <i class="icon-download"></i>
                        CDA Download
                        <span class="button-subtitle">
                            {% if l1_available %}L1 Document (PDF Structure){% else %}{{ preferred_cda_type|default:"L3" }} Document{% endif %}
                        </span>
                    </a>

                    <!-- Patient Summary PDF Download -->
                    <a href="{% url 'patient_data:download_patient_summary_pdf' patient_id %}"
                        class="action-button pdf-download" download>
                        <i class="icon-file-pdf"></i>
                        Patient Summary PDF
                        <span class="button-subtitle">Healthcare Professional</span>
                    </a>

                    <!-- ORCD - PDF Preview and Download -->
                    <a href="{% url 'patient_data:patient_orcd_view' patient_id %}" class="action-button accent">
                        <i class="icon-file-text"></i>
                        ORCD
                        <span class="button-subtitle">PDF Preview & Download</span>
                    </a>
                </div>
                {% endwith %}

                <div class="document-metadata">
                    <div class="metadata-item">
                        <i class="icon-file"></i>
                        <span>Source File: {{ cda_file_name }}</span>
                    </div>
                    <div class="metadata-item">
                        <i class="icon-folder"></i>
                        <span>File Path: {{ patient_summary.file_path }}</span>
                    </div>
                    <div class="metadata-item">
                        <i class="icon-globe"></i>
                        <span>Country: {{ source_country }}</span>
                    </div>
                    <div class="metadata-item">
                        <i class="icon-check"></i>
                        <span>Match Confidence: {{ match_confidence }}%</span>
                    </div>
                    <div class="metadata-item">
                        <i class="icon-layers"></i>
                        <span>Available Types:
                            {% if l1_available %}L1 CDA{% endif %}
                            {% if l1_available and l3_available %}, {% endif %}
                            {% if l3_available %}L3 CDA{% endif %}
                            {% if not l1_available and not l3_available %}Unknown{% endif %}
                        </span>
                    </div>
                    <div class="metadata-item">
                        <i class="icon-eye"></i>
                        <span>Rendering: {{ preferred_cda_type }} CDA ({% if preferred_cda_type == 'L3' %}Structured Clinical Content{% else %}Unstructured Document Content{% endif %})</span>
                    </div>
                </div>
                <span>Document Type: {{ preferred_cda_type }} CDA {% if l1_available %}with L1 ORCD{% endif %}</span>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- No Match Found -->
<div class="no-match-card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="icon-search"></i>
            Search Results
        </h2>
    </div>

    <div class="card-content">
        <div class="no-match-message">
            <i class="icon-alert-circle"></i>
            <h3>No Matching Records Found</h3>
            <p>We could not find any patient records in the EU member states database that match the provided
                credentials.</p>

            <div class="search-suggestions">
                <h4>Suggestions:</h4>
                <ul>
                    <li>Verify the patient name spelling</li>
                    <li>Check the date of birth format</li>
                    <li>Ensure the correct country is selected</li>
                    <li>Try providing additional patient identifiers</li>
                </ul>
            </div>

            <a href="{% url 'patient_data:patient_data_form' %}" class="action-button primary">
                <i class="icon-search"></i>
                Try Another Search
            </a>
        </div>
    </div>
</div>
{% endif %}
</div>
</div>
{% endblock %}