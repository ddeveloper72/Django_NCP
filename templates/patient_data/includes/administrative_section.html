{% comment %}
Administrative Information Section for CDA Patient Display
Displays comprehensive administrative contacts including participants (emergency contacts, next of kin, PCPs)
{% endcomment %}

{% load static %}

{% if administrative_data and has_administrative_data %}
<div class="wrap-collapsible">
    <input id="collapsible-administrative" class="toggle" type="checkbox" checked>
    <label for="collapsible-administrative" class="lbl-toggle-main">
        <i class="fa-solid fa-users"></i> Administrative Information
        <span class="indicator">
            {% if administrative_data.other_contacts %}
            {{ administrative_data.other_contacts|length }}
            Contact
            {{ administrative_data.other_contacts|length|pluralize }}
            {% endif %}
        </span>
    </label>
    <div class="collapsible-content-main">
        <div class="content-inner">

            {% comment %} Patient Contact Information {% endcomment %}
            {% if administrative_data.patient_contact_info and (administrative_data.patient_contact_info.addresses or administrative_data.patient_contact_info.telecoms) %}
            <div class="admin-section">
                <h4 class="admin-section-title">
                    <i class="fa-solid fa-user"></i> Patient Contact Information
                </h4>
                <div class="admin-contact-card patient-contact">
                    <div class="admin-card-header">
                        <i class="fa-solid fa-user"></i> Patient Contact Information
                    </div>
                    {% if administrative_data.patient_contact_info.addresses %}
                    {% for address in administrative_data.patient_contact_info.addresses %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-map-marker-alt"></i> Address:
                        </div>
                        <div class="admin-value">
                            {% if address.street %}
                            {{ address.street }}
                            {% endif %}
                            {% if address.city %},
                            {{ address.city }}
                            {% endif %}
                            {% if address.postalCode %}
                            {{ address.postalCode }}
                            {% endif %}
                            {% if address.country %},
                            {{ address.country }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if administrative_data.patient_contact_info.telecoms %}
                    {% for telecom in administrative_data.patient_contact_info.telecoms %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            {% if telecom.type == 'email' %}
                            <i class="fa-solid fa-envelope"></i> Email:
                            {% elif telecom.type == 'phone' %}
                            <i class="fa-solid fa-phone"></i> Phone:
                            {% else %}
                            <i class="fa-solid fa-info-circle"></i>
                            {{ telecom.type|title }}:
                            {% endif %}
                        </div>
                        <div class="admin-value">
                            {{ telecom.value|replace:"mailto:",""|replace:"tel:",'' }}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% comment %} Authors Information {% endcomment %}
            {% if administrative_data.author_information %}
            <div class="admin-section">
                <h4 class="admin-section-title">
                    <i class="fa-solid fa-user-md"></i> Document Authors
                </h4>
                {% for author in administrative_data.author_information %}
                <div class="admin-contact-card author-contact">
                    <div class="admin-card-header">
                        <i class="fa-solid fa-user-md"></i> Document Author
                    </div>
                    {% if author.person.full_name %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-user"></i> Name:
                        </div>
                        <div class="admin-value">
                            {{ author.person.full_name }}
                            {% if author.person.role %}
                            <span class="role-badge">
                                {{ author.person.role }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if author.organization.name %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-building"></i> Organization:
                        </div>
                        <div class="admin-value organization-name">
                            {{ author.organization.name }}
                        </div>
                    </div>
                    {% endif %}

                    {% if author.organization.addresses %}
                    {% for address in author.organization.addresses %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-map-marker-alt"></i> Address:
                        </div>
                        <div class="admin-value">
                            {% if address.street %}
                            {{ address.street }}
                            {% endif %}
                            {% if address.city %},
                            {{ address.city }}
                            {% endif %}
                            {% if address.postalCode %}
                            {{ address.postalCode }}
                            {% endif %}
                            {% if address.country %},
                            {{ address.country }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if author.organization.telecoms %}
                    {% for telecom in author.organization.telecoms %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            {% if telecom.type == 'email' %}
                            <i class="fa-solid fa-envelope"></i> Email:
                            {% elif telecom.type == 'phone' %}
                            <i class="fa-solid fa-phone"></i> Phone:
                            {% else %}
                            <i class="fa-solid fa-info-circle"></i>
                            {{ telecom.type|title }}:
                            {% endif %}
                        </div>
                        <div class="admin-value">
                            {{ telecom.value|replace:"mailto:",""|replace:"tel:",'' }}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% comment %} Legal Authenticator {% endcomment %}
            {% if administrative_data.legal_authenticator and administrative_data.legal_authenticator.full_name %}
            <div class="admin-section">
                <h4 class="admin-section-title">
                    <i class="fa-solid fa-certificate"></i> Legal Authenticator
                </h4>
                <div class="admin-contact-card legal-authenticator">
                    <div class="admin-card-header">
                        <i class="fa-solid fa-certificate"></i> Legal Authenticator
                    </div>
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-user"></i> Name:
                        </div>
                        <div class="admin-value">
                            {{ administrative_data.legal_authenticator.full_name }}
                            {% if administrative_data.legal_authenticator.title %}
                            <span class="role-badge legal-authenticator">
                                {{ administrative_data.legal_authenticator.title }}</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if administrative_data.legal_authenticator.organization.name %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-building"></i> Organization:
                        </div>
                        <div class="admin-value organization-name">
                            {{ administrative_data.legal_authenticator.organization.name }}
                        </div>
                    </div>
                    {% endif %}

                    {% if administrative_data.legal_authenticator.organization.addresses %}
                    {% for address in administrative_data.legal_authenticator.organization.addresses %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-map-marker-alt"></i> Address:
                        </div>
                        <div class="admin-value">
                            {% if address.street %}
                            {{ address.street }}
                            {% endif %}
                            {% if address.city %},
                            {{ address.city }}
                            {% endif %}
                            {% if address.postalCode %}
                            {{ address.postalCode }}
                            {% endif %}
                            {% if address.country %},
                            {{ address.country }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if administrative_data.legal_authenticator.organization.telecoms %}
                    {% for telecom in administrative_data.legal_authenticator.organization.telecoms %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            {% if telecom.type == 'email' %}
                            <i class="fa-solid fa-envelope"></i> Email:
                            {% elif telecom.type == 'phone' %}
                            <i class="fa-solid fa-phone"></i> Phone:
                            {% else %}
                            <i class="fa-solid fa-info-circle"></i>
                            {{ telecom.type|title }}:
                            {% endif %}
                        </div>
                        <div class="admin-value">
                            {{ telecom.value|replace:"mailto:",""|replace:"tel:",'' }}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% comment %} Custodian Organization {% endcomment %}
            {% if administrative_data.custodian_organization and administrative_data.custodian_organization.name %}
            <div class="admin-section">
                <h4 class="admin-section-title">
                    <i class="fa-solid fa-university"></i> Custodian Organization
                </h4>
                <div class="admin-contact-card custodian">
                    <div class="admin-card-header">
                        <i class="fa-solid fa-university"></i> Custodian Organization
                    </div>
                    <div class="contact-name">
                        <strong>
                            {{ administrative_data.custodian_organization.name }}</strong>
                    </div>

                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-building"></i> Organization:
                        </div>
                        <div class="admin-value organization-name">
                            {{ administrative_data.custodian_organization.name }}
                        </div>
                    </div>

                    {% if administrative_data.custodian_organization.addresses %}
                    {% for address in administrative_data.custodian_organization.addresses %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-map-marker-alt"></i> Organization Address:
                        </div>
                        <div class="admin-value">
                            {% comment %} Handle multiple street address formats {% endcomment %}
                            {% if address.streetAddressLine %}
                                {% for line in address.streetAddressLine %}
                                    {{ line }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            {% elif address.street_lines %}
                                {% for line in address.street_lines %}
                                    {{ line }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            {% elif address.street %}
                                {{ address.street }}
                            {% endif %}
                            {% if address.city %}
                                {% if address.streetAddressLine or address.street_lines or address.street %}<br>{% endif %}
                                {{ address.city }}
                            {% endif %}
                            {% if address.state %}
                                {{ address.state }}
                            {% endif %}
                            {% if address.postalCode %}
                                {{ address.postalCode }}
                            {% endif %}
                            {% if address.country %}
                                <br>{{ address.country }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% comment %} Add organization identifiers if available {% endcomment %}
                    {% if administrative_data.custodian_organization.identifiers %}
                    {% for identifier in administrative_data.custodian_organization.identifiers %}
                    {% if identifier.value and identifier.value != '0' %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-id-card"></i> {{ identifier.type|default:"Organization ID" }}:
                        </div>
                        <div class="admin-value">
                            {{ identifier.value }}
                            {% if identifier.system %}
                            <small class="text-muted">({{ identifier.system }})</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}

                    {% if administrative_data.custodian_organization.telecoms %}
                    {% for telecom in administrative_data.custodian_organization.telecoms %}
                    {% if telecom.value and telecom.value != '0' %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            {% if telecom.system == 'email' or telecom.type == 'email' %}
                            <i class="fa-solid fa-envelope"></i> Email:
                            {% elif telecom.system == 'phone' or telecom.type == 'phone' %}
                            <i class="fa-solid fa-phone"></i> Phone:
                            {% elif telecom.system == 'url' or telecom.type == 'url' %}
                            <i class="fa-solid fa-globe"></i> Website:
                            {% else %}
                            <i class="fa-solid fa-info-circle"></i>
                            {{ telecom.system|default:telecom.type|title }}:
                            {% endif %}
                        </div>
                        <div class="admin-value">
                            {% if telecom.system == 'email' or telecom.type == 'email' %}
                            <a href="mailto:{{ telecom.value }}">{{ telecom.value }}</a>
                            {% elif telecom.system == 'phone' or telecom.type == 'phone' %}
                            <a href="tel:{{ telecom.value }}">{{ telecom.value }}</a>
                            {% elif telecom.system == 'url' or telecom.type == 'url' %}
                            <a href="{{ telecom.value }}" target="_blank">{{ telecom.value }}</a>
                            {% else %}
                            {{ telecom.value }}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% comment %} Participants (Emergency Contacts, Next of Kin, PCPs) {% endcomment %}
            {% if administrative_data.other_contacts %}
            <div class="admin-section">
                <h4 class="admin-section-title">
                    <i class="fa-solid fa-users"></i> Additional Contacts
                    <span class="contact-count">(
                        {{ administrative_data.other_contacts|length }})</span>
                </h4>

                {% for contact in administrative_data.other_contacts %}
                <div class="admin-contact-card participant-contact">
                    <div class="admin-card-header">
                        <i class="fa-solid fa-user-friends"></i>
                        {% if contact.role %}
                        {{ contact.role }}
                        {% else %}
                        Contact
                        {% endif %}
                    </div>
                    {% if contact.full_name %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-user"></i> Name:
                        </div>
                        <div class="admin-value">
                            {{ contact.full_name }}
                            {% if contact.role %}
                            <span class="role-badge {{ contact.role|lower|slugify }}">
                                {{ contact.role }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if contact.specialty %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-calendar"></i> Period:
                        </div>
                        <div class="admin-value">
                            {{ contact.specialty }}
                        </div>
                    </div>
                    {% endif %}

                    {% if contact.organization.name %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-building"></i> Organization:
                        </div>
                        <div class="admin-value organization-name">
                            {{ contact.organization.name }}
                        </div>
                    </div>
                    {% endif %}

                    {% if contact.contact_info.addresses %}
                    {% for address in contact.contact_info.addresses %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            <i class="fa-solid fa-map-marker-alt"></i> Address:
                        </div>
                        <div class="admin-value">
                            {% if address.street %}
                            {{ address.street }}
                            {% endif %}
                            {% if address.city %},
                            {{ address.city }}
                            {% endif %}
                            {% if address.postalCode %}
                            {{ address.postalCode }}
                            {% endif %}
                            {% if address.country %},
                            {{ address.country }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if contact.contact_info.telecoms %}
                    {% for telecom in contact.contact_info.telecoms %}
                    <div class="admin-info-row">
                        <div class="admin-label">
                            {% if telecom.type == 'email' %}
                            <i class="fa-solid fa-envelope"></i> Email:
                            {% elif telecom.type == 'phone' %}
                            <i class="fa-solid fa-phone"></i> Phone:
                            {% else %}
                            <i class="fa-solid fa-info-circle"></i>
                            {{ telecom.type|title }}:
                            {% endif %}
                        </div>
                        <div class="admin-value">
                            {{ telecom.value|replace:"mailto:",""|replace:"tel:",'' }}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

        </div>
    </div>
</div>

{% endif %}
