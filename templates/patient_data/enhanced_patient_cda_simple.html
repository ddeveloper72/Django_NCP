{% extends "base.html" %}

{# Django template doesn't support macros - date formatting moved to Python view or template filters #}

{% block title %}Enhanced CDA Display - {{ patient_identity.given_name }} {{ patient_identity.family_name }}{% endblock %}

{% block extra_css %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    .patient-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .debug-info {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 1rem;
        margin: 1rem 0;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }

    .success-badge {
        background: #d4edda;
        color: #155724;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-weight: bold;
    }

    .data-field {
        margin-bottom: 0.5rem;
    }

    .data-field strong {
        color: #495057;
        font-weight: 600;
    }

    /* Clinical Section Styles - Migrated from enhanced_patient_cda.html */
    .medical-section {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
        height: auto;
        min-height: fit-content;
    }

    .medical-section .card {
        height: auto;
        min-height: fit-content;
    }

    .medical-section .card-body {
        height: auto;
        min-height: fit-content;
        overflow: visible;
    }

    /* Clinical table styles for medical data */
    .clinical-table {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .clinical-table .table {
        margin-bottom: 0;
    }

    .clinical-table .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 0.75rem;
    }

    .clinical-table .table td {
        padding: 0.75rem;
        vertical-align: middle;
        border-bottom: 1px solid #f8f9fa;
    }

    .clinical-table .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .primary-field {
        font-weight: 600;
        color: #212529;
    }

    .medical-code {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        background-color: #e9ecef;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        margin: 0.125rem;
        display: inline-block;
    }

    /* Medical terminology styling */
    .medical-terminology .badge {
        font-size: 0.75rem;
        margin: 0.125rem;
    }

    /* Section Tabs Styles */
    .section-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        border-radius: 0.375rem 0.375rem 0 0;
    }

    .tab-button {
        background: none;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 0.9em;
        color: #6c757d;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .tab-button:hover {
        background: #e9ecef;
        color: #495057;
    }

    .tab-button.active {
        color: #0d6efd;
        border-bottom-color: #0d6efd;
        background: white;
        font-weight: 600;
    }

    .clinical-tab-content {
        display: none;
        padding: 20px;
        background: white;
        border-radius: 0 0 0.375rem 0.375rem;
        height: auto;
        min-height: fit-content;
        overflow: visible;
    }

    .clinical-tab-content.active {
        display: block;
        height: auto;
        min-height: fit-content;
        overflow: visible;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- STEP 1: Basic Patient Header Information -->
            <div class="patient-header">
                <h1 class="mb-3">
                    <i class="fas fa-user-injured me-2 text-primary"></i>
                    Patient CDA Display Tool
                </h1>

                <div class="row">
                    <div class="col-md-8">
                        <h2 class="text-primary mb-3">
                            {{ patient_identity.given_name }} {{ patient_identity.family_name }}
                        </h2>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="data-field">
                                    <strong>Patient ID:</strong>
                                    <span class="success-badge">{{ patient_identity.patient_id }}</span>
                                </div>
                                <div class="data-field">
                                    <strong>Birth Date:</strong> {% firstof patient_identity.birth_date_formatted patient_identity.birth_date "Unknown" %}
                                </div>
                                <div class="data-field">
                                    <strong>Gender:</strong> {{ patient_identity.gender }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="data-field">
                                    <strong>Primary Patient ID:</strong> {{ patient_identity.primary_patient_id }}
                                </div>
                                <div class="data-field">
                                    <strong>Full Name:</strong>
                                    {% if patient_identity.full_name %}
                                    {{ patient_identity.full_name }}
                                    {% elif patient_identity.given_name and patient_identity.family_name %}
                                    {{ patient_identity.given_name }} {{ patient_identity.family_name }}
                                    {% else %}
                                    Not Available
                                    {% endif %}
                                </div>
                                <div class="data-field">
                                    <strong>URL Patient ID:</strong> {% firstof patient_identity.url_patient_id patient_identity.patient_id "Unknown" %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="text-end">
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check-circle me-1"></i>
                                Patient Header Loaded
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Include Debug Modal Component -->
            {% include 'patient_data/components/debug_modal.html' %}

            {% include 'patient_data/components/extended_patient_info.html' %}

            {# OLD INLINE IMPLEMENTATION REPLACED WITH MODULAR COMPONENTS - REMOVED #}

            <!-- STEP 3: Enhanced Clinical Sections with Dual-Language Support -->
            {% if processed_sections and processed_sections|length > 0 %}
            <div class="card mt-4">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Clinical Sections ({{ processed_sections|length }} sections)
                    </h3>
                </div>
                <div class="card-body">
                    {% for section in processed_sections %}
                    {# Django template uses forloop.counter0 instead of Jinja2's loop.index0 #}

                    <!-- Modular Clinical Section Router - Re-enabled after fixing format_medical_date -->
                    {% include 'patient_data/sections/clinical_section_router.html' %}

                    {% endfor %}

                    <div class="text-end mt-3">
                        <span class="badge bg-success fs-6">
                            <i class="fas fa-check-circle me-1"></i>
                            Enhanced Clinical Sections Loaded ({{ processed_sections|length }})
                        </span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Clinical Sections
                    </h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">No clinical sections available</p>
                </div>
            </div>
            {% endif %}

            <!-- DEBUG INFORMATION -->
            <div class="debug-info">
                <h4><i class="fas fa-bug me-2"></i>Debug Information</h4>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Patient Identity Keys:</strong></p>
                        <ul>
                            {% for key, value in patient_identity.items %}
                            <li>{{ key }}: {{ value }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Context Variables Available:</strong></p>
                        <ul>
                            <li>patient_identity: {% if patient_identity %}✅ Available{% else %}❌ Missing{% endif %}
                            </li>
                            <li>patient_extended_data: {% if patient_extended_data %}✅ Available{% else %}❌ Missing{% endif %}</li>
                            <li>processed_sections: {% if processed_sections %}✅ Available ({{ processed_sections|length }} sections){% else %}❌ Missing{% endif %}</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- PLACEHOLDER FOR NEXT STEPS -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-road me-2"></i>
                        Next Steps
                    </h4>
                </div>
                <div class="card-body">
                    <ol>
                        <li><strong>✅ Step 1:</strong> Basic Patient Header Information (Complete)</li>
                        <li><strong>✅ Step 2:</strong> Extended Header Information (Complete)</li>
                        <li><strong>✅ Step 3:</strong> Clinical Sections (Complete)</li>
                        <li><strong>🎉 Status:</strong> All core components working! Ready to enhance further.</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Enhanced Clinical Section Tabs JavaScript -->
<script>
    // Function to show clinical tabs for enhanced medical sections
    function showClinicalTab(sectionId, tabType) {
        // Hide all tab contents for this section
        const allTabs = document.querySelectorAll(`[id^="${sectionId}_"]`);
        allTabs.forEach(tab => {
            tab.classList.remove('active');
        });

        // Remove active class from all tab buttons for this section
        const sectionContainer = document.querySelector(`[id*="${sectionId}"]`).closest('.medical-section');
        const allButtons = sectionContainer.querySelectorAll('.tab-button');
        allButtons.forEach(button => {
            button.classList.remove('active');
        });

        // Show the selected tab content
        const selectedTab = document.getElementById(`${sectionId}_${tabType}`);
        if (selectedTab) {
            selectedTab.classList.add('active');
        }

        // Add active class to the clicked button
        const clickedButton = event.target;
        clickedButton.classList.add('active');

        console.log(`Switched to ${tabType} tab for ${sectionId}`);
    }

    // Initialize enhanced clinical sections on page load
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Enhanced Clinical Sections with tabs initialized successfully');

        // Initialize any tooltips or other Bootstrap components
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        console.log('Enhanced CDA Display with clinical tables and dual-language support ready');
    });
</script>
{% endblock %}
