{% extends "base.html" %}

{% block title %}Patient CDA Document - EU NCP Portal{% endblock %}

{% block content %}
<div class="cda-document-container">
    <div class="page-header">
        <div class="breadcrumb-nav">
            <a href="{{ url('patient_data:patient_details', patient_data.id) }}" class="breadcrumb-link">
                <i class="icon-arrow-left"></i> Back to Patient Details
            </a>
        </div>

        <h1 class="page-title">CDA Document Viewer</h1>
        <div class="page-subtitle">
            Patient: {{ patient_data.given_name }} {{ patient_data.family_name }} |
            Source: {{ source_country }} |
            Confidence: {{ confidence }}%
        </div>
    </div>

    <div class="cda-content-wrapper">
        <!-- Document Metadata -->
        <div class="cda-metadata">
            <h3>Document Information</h3>
            <div class="metadata-grid">
                <div class="metadata-item">
                    <span class="metadata-label">File Name:</span>
                    <span class="metadata-value">{{ file_name }}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Source Country:</span>
                    <span class="metadata-value">{{ source_country }}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Match Confidence:</span>
                    <span class="metadata-value">{{ confidence }}%</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Document Type:</span>
                    <span class="metadata-value">{{ cda_type }} CDA Patient Summary</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Rendering:</span>
                    <span class="metadata-value">
                        {% if is_l3_rendering %}
                            L3 CDA (Structured Clinical Content)
                        {% else %}
                            L1 CDA (Original Document Headers)
                        {% endif %}
                    </span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Available Types:</span>
                    <span class="metadata-value">
                        {% if l1_available %}L1 CDA{% endif %}
                        {% if l1_available and l3_available %}, {% endif %}
                        {% if l3_available %}L3 CDA{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- CDA Document Viewer -->
        <div class="cda-viewer">
            <div class="cda-toolbar">
                <div class="toolbar-left">
                    <h3>Clinical Document Architecture ({{ cda_type }} CDA)</h3>
                    {% if is_l3_rendering %}
                    <span class="cda-type-badge l3">L3 - Structured Clinical Content</span>
                    {% else %}
                    <span class="cda-type-badge l1">L1 - Original Document Headers</span>
                    {% endif %}
                </div>
                <div class="toolbar-right">
                    <button class="btn btn-secondary" onclick="toggleView()">
                        <i class="icon-code"></i> Toggle Source View
                    </button>
                    <a href="{{ url('patient_data:download_cda_html', patient_data.id) }}" class="btn btn-primary"
                        download>
                        <i class="icon-download"></i> Download HTML
                    </a>
                </div>
            </div>

            <!-- Rendered HTML View -->
            <div class="cda-rendered-view" id="renderedView">
                <div class="cda-iframe-container">
                    <iframe id="cdaFrame" srcdoc="{{ cda_content|escape }}"
                        style="width: 100%; height: 700px; border: none; background: white;">
                    </iframe>
                </div>
            </div>

            <!-- Source XML View (hidden by default) -->
            <div class="cda-source-view" id="sourceView" style="display: none;">
                <div class="cda-content">
                    <pre id="xmlContent">{{ cda_content|escape }}</pre>
                </div>
            </div>
        </div>

        <!-- Navigation Actions -->
        <div class="document-actions">
            <a href="{{ url('patient_data:patient_details', patient_data.id) }}" class="action-button secondary">
                <i class="icon-arrow-left"></i>
                Back to Patient Details
            </a>

            <a href="{{ url('patient_data:download_cda_html', patient_data.id) }}" class="action-button primary"
                download>
                <i class="icon-download"></i>
                Download HTML Document
            </a>

            <a href="{{ url('patient_data:patient_orcd_view', patient_data.id) }}" class="action-button accent">
                <i class="icon-file-text"></i>
                View ORCD
            </a>

            <a href="{{ url('patient_data:patient_data_form') }}" class="action-button outline">
                <i class="icon-search"></i>
                New Search
            </a>
        </div>
    </div>

    <style>
        /* CDA Type Badge Styling */
        .cda-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 10px;
        }
        
        .cda-type-badge.l3 {
            background: #e6f3ff;
            color: #0066cc;
            border: 1px solid #99ccff;
        }
        
        .cda-type-badge.l1 {
            background: #fff3e6;
            color: #cc6600;
            border: 1px solid #ffcc99;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-left h3 {
            margin: 0;
        }

        .cda-iframe-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .cda-rendered-view {
            margin-top: 20px;
        }

        .cda-source-view {
            margin-top: 20px;
        }

        .action-button.accent {
            background: var(--accent-color, #6f42c1);
            color: white;
        }

        .action-button.accent:hover {
            background: var(--accent-color-dark, #5a32a3);
        }
    </style>

    <script>
        let showingSource = false;

        function toggleView() {
            const renderedView = document.getElementById('renderedView');
            const sourceView = document.getElementById('sourceView');
            const toggleButton = document.querySelector('.btn-secondary');

            if (showingSource) {
                // Show rendered view
                renderedView.style.display = 'block';
                sourceView.style.display = 'none';
                toggleButton.innerHTML = '<i class="icon-code"></i> Toggle Source View';
                showingSource = false;
            } else {
                // Show source view
                renderedView.style.display = 'none';
                sourceView.style.display = 'block';
                toggleButton.innerHTML = '<i class="icon-eye"></i> Toggle Rendered View';
                formatXML();
                showingSource = true;
            }
        }

        function formatXML() {
            const xmlContent = document.getElementById('xmlContent');
            if (xmlContent && !xmlContent.classList.contains('formatted')) {
                const content = xmlContent.textContent;

                // Add basic XML syntax highlighting
                let formatted = content
                    .replace(/(&lt;[^&]*&gt;)/g, '<span class="xml-tag">$1</span>')
                    .replace(/(\w+)=&quot;([^&]*)&quot;/g, '<span class="xml-attribute">$1</span>=<span class="xml-value">&quot;$2&quot;</span>')
                    .replace(/(&lt;!--.*?--&gt;)/gs, '<span class="xml-comment">$1</span>');

                xmlContent.innerHTML = formatted;
                xmlContent.classList.add('formatted');
            }
        }
    </script>
    {% endblock %}