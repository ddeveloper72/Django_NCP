{% extends 'base.html' %}

{% block title %}Clinical Document - {{ clinical_doc.title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-3">
            <!-- Document Information Panel -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-file-medical"></i> Document Info</h5>
                </div>
                <div class="card-body">
                    <h6>{{ clinical_doc.title }}</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Type:</strong></td>
                            <td>{{ clinical_doc.document_type }}</td>
                        </tr>
                        <tr>
                            <td><strong>Document ID:</strong></td>
                            <td><small>{{ clinical_doc.document_id }}</small></td>
                        </tr>
                        <tr>
                            <td><strong>Created:</strong></td>
                            <td>{{ clinical_doc.creation_date|date:"d/m/Y H:i" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>
                                <span class="badge bg-success">{{ doc_request.status }}</span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Patient Information -->
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-user"></i> Patient</h5>
                </div>
                <div class="card-body">
                    <h6>{{ doc_request.patient_data.given_name }} {{ doc_request.patient_data.family_name }}</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Birth Date:</strong></td>
                            <td>{{ doc_request.patient_data.birth_date|date:"d/m/Y" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Gender:</strong></td>
                            <td>{{ doc_request.patient_data.gender }}</td>
                        </tr>
                        <tr>
                            <td><strong>Member State:</strong></td>
                            <td>{{ doc_request.patient_data.patient_identifier.home_member_state.country_name }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Actions -->
            <div class="card mt-3">
                <div class="card-header bg-secondary text-white">
                    <h5><i class="fas fa-download"></i> Downloads</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if can_download_pdf %}
                        <a href="{% url 'download_document_pdf' doc_request.id %}" class="btn btn-danger btn-sm">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </a>
                        {% endif %}
                        <a href="{% url 'download_document_raw' doc_request.id %}"
                            class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-code"></i> Download Raw Data
                        </a>
                    </div>
                </div>
            </div>

            <!-- Translation Controls -->
            <div class="card mt-3">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-language"></i> Translation</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label for="target_language" class="form-label small">Translate to:</label>
                        <select class="form-select form-select-sm" id="target_language">
                            <option value="en">English</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="es">Spanish</option>
                            <option value="it">Italian</option>
                            <option value="pt">Portuguese</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-warning btn-sm" id="translate_document">
                        <i class="fas fa-language"></i> Translate Sections
                    </button>
                </div>
            </div>

            <!-- Navigation -->
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'patient_data:patient_search_results' doc_request.patient_data.patient_identifier.id %}"
                            class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to Patient
                        </a>
                        <a href="{% url 'patient_data:clinical_document_history' doc_request.patient_data.id %}"
                            class="btn btn-outline-info btn-sm">
                            <i class="fas fa-history"></i> Document History
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <!-- Document Content -->
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>{{ clinical_doc.title }}</h4>
                        <div>
                            <span class="badge bg-primary">{{ clinical_doc.document_type }}</span>
                            {% if clinical_doc.has_embedded_pdf %}
                            <span class="badge bg-info">PDF Available</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if rendered_html %}
                    <div id="document_content">
                        {{ rendered_html|safe }}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Document content could not be rendered for display.
                        You can download the raw document using the controls on the left.
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if document_metadata %}
            <!-- Document Metadata -->
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h5><i class="fas fa-info"></i> Document Metadata</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if document_metadata.document_id %}
                        <div class="col-md-6">
                            <strong>Document ID:</strong> {{ document_metadata.document_id }}
                        </div>
                        {% endif %}
                        {% if document_metadata.creation_time %}
                        <div class="col-md-6">
                            <strong>Creation Time:</strong> {{ document_metadata.creation_time }}
                        </div>
                        {% endif %}
                        {% if document_metadata.author %}
                        <div class="col-md-6">
                            <strong>Author:</strong> {{ document_metadata.author.name }}
                        </div>
                        {% endif %}
                        {% if document_metadata.author.institution %}
                        <div class="col-md-6">
                            <strong>Institution:</strong> {{ document_metadata.author.institution }}
                        </div>
                        {% endif %}
                    </div>

                    {% if document_metadata.sections %}
                    <h6 class="mt-3">Document Sections ({{ document_metadata.sections|length }})</h6>
                    <ul class="list-group list-group-flush">
                        {% for section in document_metadata.sections %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ section.title|default:"Untitled Section" }}
                            {% if section.code %}
                            <span class="badge bg-secondary">{{ section.code }}</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if document_metadata.entries %}
                    <h6 class="mt-3">FHIR Resources ({{ document_metadata.entries|length }})</h6>
                    <ul class="list-group list-group-flush">
                        {% for entry in document_metadata.entries %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ entry.resourceType }}
                            <span class="badge bg-info">{{ entry.id|default:"No ID" }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Translation Modal -->
<div class="modal fade" id="translationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Translation Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="translation_content">
                <!-- Translation content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Translation functionality
        document.getElementById('translate_document').addEventListener('click', function () {
            const targetLanguage = document.getElementById('target_language').value;
            const button = this;
            const originalText = button.innerHTML;

            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';
            button.disabled = true;

            // Find translatable sections
            const sections = document.querySelectorAll('.cda-section-content, .fhir-resource');
            let translationsCompleted = 0;

            sections.forEach(function (section) {
                const text = section.textContent.trim();
                if (text.length > 20) { // Only translate substantial content

                    fetch('{% url "patient_data:translate_document_section" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            text: text,
                            target_language: targetLanguage
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.translated_text) {
                                // Store original text if not already stored
                                if (!section.dataset.originalText) {
                                    section.dataset.originalText = section.innerHTML;
                                }

                                // Create translation notice
                                const translationNotice = `
                            <div class="alert alert-info alert-sm mb-2">
                                <small><i class="fas fa-language"></i> Translated to ${targetLanguage.toUpperCase()}</small>
                            </div>
                        `;

                                section.innerHTML = translationNotice + data.translated_text;
                            }
                        })
                        .catch(error => {
                            console.error('Translation error:', error);
                        })
                        .finally(() => {
                            translationsCompleted++;
                            if (translationsCompleted === sections.length) {
                                button.innerHTML = originalText;
                                button.disabled = false;
                            }
                        });
                } else {
                    translationsCompleted++;
                    if (translationsCompleted === sections.length) {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }
                }
            });

            if (sections.length === 0) {
                button.innerHTML = originalText;
                button.disabled = false;
                alert('No translatable content found in this document.');
            }
        });
    });
</script>
{% endblock %}