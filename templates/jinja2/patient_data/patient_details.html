{% extends "base.html" %}

{% block title %}Patient Details - EU NCP Portal{% endblock %}

{% block extra_css %}
<link href="{{ static('css/patient_cda_ps_guidelines.css') }}?v=20250804" rel="stylesheet" media="screen">
{% endblock %}

{% block content %}
<div class="patient-details-container">
    <div class="patient-details-header">
        <div class="breadcrumb-nav">
            <a href="{{ url('patient_data:patient_data_form') }}" class="breadcrumb-link">
                <i class="fas fa-arrow-left"></i> Back to Search
            </a>
        </div>

        <h1 class="page-title">Patient Details</h1>

        {% if has_cda_match %}
        <div class="match-confidence-badge success">
            <i class="icon-check-circle"></i>
            Match Found: {{ match_confidence }}% Confidence
        </div>
        {% else %}
        <div class="match-confidence-badge warning">
            <i class="icon-alert-circle"></i>
            No Matching Records Found
        </div>
        {% endif %}
    </div>

    {% if session_error %}
    <div class="alert alert-warning session-error-alert">
        <div class="session-error-content">
            <i class="fas fa-exclamation-triangle session-error-icon"></i>
            <div class="session-error-text">
                <strong>Session Expired</strong>
                <p class="session-error-message">{{ session_error }}</p>
                <p class="session-error-action">
                    <a href="{{ url('patient_data:patient_data_form') }}" class="session-error-link">
                        <i class="fas fa-search"></i> Search Again
                    </a>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="patient-details-grid">
        <!-- Patient Information -->
        <div class="patient-info-card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="icon-user"></i>
                    Patient Information
                    {% if has_cda_match %}
                    <span class="match-indicator">
                        <i class="icon-check-circle"></i>
                        {{ match_confidence }}% Match
                    </span>
                    {% endif %}
                </h2>
                {% if has_cda_match %}
                <div class="card-subtitle">
                    Source: {{ source_country }} â€¢ Document: Patient Summary ({{ patient_summary.cda_type|default("L3")
                    }})
                </div>
                {% endif %}
            </div>

            <div class="card-content">
                <div class="info-grid">
                    <div class="info-item">
                        <label class="info-label">Full Name:</label>
                        <span class="info-value">{{ patient_data.given_name }} {{ patient_data.family_name }}</span>
                    </div>

                    <div class="info-item">
                        <label class="info-label">Date of Birth:</label>
                        <span class="info-value">
                            {% if patient_data.birth_date %}
                            {{ patient_data.birth_date|date_format("%d %B %Y") }}
                            {% else %}
                            Not provided
                            {% endif %}
                        </span>
                    </div>

                    <div class="info-item">
                        <label class="info-label">Gender:</label>
                        <span class="info-value">{{ patient_data.get_gender_display()|default("Not specified") }}</span>
                    </div>

                    <div class="info-item">
                        <label class="info-label">Country:</label>
                        <span class="info-value">{% if source_country_display %}{{ source_country_display }}{% else
                            %}Not specified{% endif %}</span>
                    </div>

                    {% if has_cda_match and patient_summary.patient_identifiers %}
                    {% for identifier in patient_summary.patient_identifiers %}
                    <div class="info-item">
                        <label class="info-label">Patient ID{% if identifier.root %} ({{ identifier.root }}){% endif
                            %}:</label>
                        <span class="info-value">{{ identifier.extension }}</span>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if patient_data.patient_id %}
                    <div class="info-item">
                        <label class="info-label">Internal ID:</label>
                        <span class="info-value">{{ patient_data.patient_id }}</span>
                    </div>
                    {% endif %}

                    <div class="info-item">
                        <label class="info-label">Submitted:</label>
                        <span class="info-value">{{ patient_data.created_at|date_format("%d %B %Y %H:%M") }}</span>
                    </div>

                    {% if has_cda_match and patient_summary.file_path %}
                    <div class="info-item">
                        <label class="info-label">Source File:</label>
                        <span class="info-value">{{ (patient_summary.file_path|basename) or "Unknown" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if has_cda_match %}
        <!-- Document Actions -->
        <div class="document-actions-card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="icon-download"></i>
                    Document Actions
                </h2>
            </div>

            <div class="card-content">
                <div class="action-buttons">
                    <!-- View CDA Document - L3 Browser View -->
                    <a href="{{ url('patient_data:patient_cda_view', patient_data.id) }}" class="action-button primary">
                        <i class="icon-eye"></i>
                        View CDA Document
                        <span class="button-subtitle">L3 Browser View</span>
                    </a>

                    <!-- CDA Download - HTML Transcoded View -->
                    <a href="{{ url('patient_data:download_cda_html', patient_data.id) }}"
                        class="action-button secondary" download>
                        <i class="icon-download"></i>
                        CDA Download
                        <span class="button-subtitle">HTML Document</span>
                    </a>

                    <!-- Patient Summary PDF Download -->
                    <a href="{{ url('patient_data:download_patient_summary_pdf', patient_data.id) }}"
                        class="action-button pdf-download" download>
                        <i class="icon-file-pdf"></i>
                        Patient Summary PDF
                        <span class="button-subtitle">Healthcare Professional</span>
                    </a>

                    <!-- ORCD - PDF Preview and Download -->
                    <a href="{{ url('patient_data:patient_orcd_view', patient_data.id) }}" class="action-button accent">
                        <i class="icon-file-text"></i>
                        ORCD
                        <span class="button-subtitle">PDF Preview & Download</span>
                    </a>
                </div>

                <div class="document-metadata">
                    <div class="metadata-item">
                        <i class="icon-file"></i>
                        <span>Source File: {{ cda_file_name }}</span>
                    </div>
                    <div class="metadata-item">
                        <i class="icon-globe"></i>
                        <span>Country: {{ source_country }}</span>
                    </div>
                    <div class="metadata-item">
                        <i class="icon-check"></i>
                        <span>Match Confidence: {{ match_confidence }}%</span>
                    </div>
                    <div class="metadata-item">
                        <i class="icon-layers"></i>
                        <span>Available Types:
                            {% if l1_available %}L1 CDA{% endif %}
                            {% if l1_available and l3_available %}, {% endif %}
                            {% if l3_available %}L3 CDA{% endif %}
                            {% if not l1_available and not l3_available %}Unknown{% endif %}
                        </span>
                    </div>
                    <div class="metadata-item">
                        <i class="icon-eye"></i>
                        <span>Rendering: {{ preferred_cda_type }} CDA ({{ 'Structured Clinical Content' if
                            preferred_cda_type == 'L3' else 'Original Document Headers' }})</span>
                    </div>
                </div>
                <span>Document Type: L3 CDA with L1 ORCD</span>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- No Match Found -->
<div class="no-match-card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="icon-search"></i>
            Search Results
        </h2>
    </div>

    <div class="card-content">
        <div class="no-match-message">
            <i class="icon-alert-circle"></i>
            <h3>No Matching Records Found</h3>
            <p>We could not find any patient records in the EU member states database that match the provided
                credentials.</p>

            <div class="search-suggestions">
                <h4>Suggestions:</h4>
                <ul>
                    <li>Verify the patient name spelling</li>
                    <li>Check the date of birth format</li>
                    <li>Ensure the correct country is selected</li>
                    <li>Try providing additional patient identifiers</li>
                </ul>
            </div>

            <a href="{{ url('patient_data:patient_data_form') }}" class="action-button primary">
                <i class="icon-search"></i>
                Try Another Search
            </a>
        </div>
    </div>
</div>
{% endif %}
</div>
</div>
{% endblock %}