{% extends "base.html" %}

{% load static %}
{% block title %}Patient Data - {% if patient %}{{ patient.name }}{% else %}Unknown Patient{% endif %} {% endblock %}

{% block content %}
<div class="container">
    <!-- Enhanced Navigation Breadcrumb -->
    <!-- <div class="cda-navigation">
        <div class="breadcrumb-nav">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/" class="breadcrumb-link">
                            <i class="fa-solid fa-home"></i> Home
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/portal/" class="breadcrumb-link">
                            <i class="fa-solid fa-globe"></i> Country Selection
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/portal/country/{{ country_code }}/search/" class="breadcrumb-link">
                            <i class="fa-solid fa-search"></i> {{ country.name }} Search
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <i class="fa-solid fa-user"></i> Patient Data
                    </li>
                </ol>
            </nav> -->

    <!-- Quick Actions -->
    <!-- <div class="quick-actions">
                <a href="/portal/country/{{ country_code }}/search/" class="btn btn-secondary btn-sm">
                    <i class="fa-solid fa-arrow-left"></i> Back to Search
                </a>
                <a href="/portal/" class="btn btn-outline-primary btn-sm">
                    <i class="fa-solid fa-search"></i> New Search
                </a>
            </div>
        </div>
    </div> -->

    <div class="results-header">
        <h1>🏥 Patient Data</h1>
        <div class="country-info">
            <strong>Country:</strong> {{ country.name }} ({{ country_code }})
        </div>
    </div>

    {% if patient %}
    <!-- Patient Information -->
    <div class="patient-info-card">
        <div class="card-header">
            <h3>👤 Patient Information</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item">
                        <strong>Name:</strong> {{ patient.name }}
                    </div>
                    <div class="info-item">
                        <strong>Birth Date:</strong> {{ patient.birth_date }}
                    </div>
                    <div class="info-item">
                        <strong>Gender:</strong> {{ patient.gender }}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <strong>Address:</strong> {% if patient.address %}{{ patient.address }}{% else %}Not provided{%
                        endif %}
                    </div>
                    <div class="info-item">
                        {% if patient.patient_identifiers %}
                        {% for identifier in patient.patient_identifiers %}
                        <strong>{% if identifier.assigningAuthorityName %}{{ identifier.assigningAuthorityName }}{% else
                            %}Patient ID ({{ identifier.root|truncate(15, True) }}){% endif %}:</strong> {{
                        identifier.extension }}<br>
                        {% endfor %}
                        {% else %}
                        <strong>Patient ID:</strong> No CDA identifiers available
                        {% endif %}
                    </div>
                    <div class="info-item">
                        <strong>Last Updated:</strong> {{ patient.last_updated }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Documents -->
    <div class="documents-section">
        <h4>📋 Available Documents</h4>
        {% if documents %}
        <div class="documents-grid">
            {% for document in documents %}
            <div class="document-card">
                <div class="document-header">
                    <h5>{{ document.title|default:document.type }}</h5>
                    <span class="document-type">{{ document.type }}</span>
                </div>
                <div class="document-details">
                    <div class="document-date">
                        <strong>Date:</strong> {{ document.date }}
                    </div>
                    <div class="document-format">
                        <strong>Format:</strong>
                        {% if document.type == 'PS' %}
                        CDA L1 (Patient Summary)
                        {% elif document.type == 'eP' %}
                        CDA L3 (ePrescription)
                        {% else %}
                        {{ document.format|default:"CDA" }}
                        {% endif %}
                    </div>
                    <div class="document-status">
                        {% if document.available %}
                        <span class="status-available">✅ Available</span>
                        {% else %}
                        <span class="status-unavailable">❌ Not Available</span>
                        {% endif %}
                    </div>
                </div>
                {% if document.available %}
                <div class="document-actions">
                    <button class="btn btn-primary btn-sm"
                        onclick="viewDocument('{{ document.type }}', '{{ patient.id }}')">
                        👁️ View
                    </button>
                    <button class="btn btn-secondary btn-sm"
                        onclick="downloadDocument('{{ document.type }}', '{{ patient.id }}')">
                        💾 Download
                    </button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-documents">
            <p>No documents available for this patient.</p>
        </div>
        {% endif %}
    </div>

    <!-- Actions Section -->
    <div class="actions-section">
        <h4>Available Actions</h4>
        <div class="action-buttons">
            <a href="{{ url('patient_search', country_code) }}" class="btn btn-secondary">
                🔍 New Search
            </a>
            <a href="{% url 'country_selection' %}" class="btn btn-outline-secondary">
                🌍 Change Country
            </a>
            {% if patient %}
            <button class="btn btn-primary" onclick="requestServices('{{ patient.id }}')">
                📄 Request Services
            </button>
            <button class="btn btn-info" onclick="exportPatientData('{{ patient.id }}')">
                💾 Export Data
            </button>
            {% endif %}
        </div>
    </div>
    {% else %}
    <!-- No Patient Found -->
    <div class="no-patient">
        <h3>❌ Patient Not Found</h3>
        <p>No patient data available for the requested ID.</p>
        <a href="{{ url('patient_search', country_code) }}" class="btn btn-primary">
            🔍 Try Another Search
        </a>
    </div>
    {% endif %}
</div>

<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .results-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        text-align: center;
    }

    .results-header h1 {
        margin: 0 0 10px 0;
        font-size: 2.5rem;
    }

    .country-info {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .patient-info-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
        border-radius: 12px 12px 0 0;
    }

    .card-header h3 {
        margin: 0;
        color: #495057;
    }

    .card-body {
        padding: 25px;
    }

    .info-item {
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
    }

    .info-item strong {
        color: #495057;
        display: inline-block;
        min-width: 120px;
    }

    .documents-section {
        margin-bottom: 30px;
    }

    .documents-section h4 {
        color: #495057;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .document-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .document-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .document-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .document-header h5 {
        margin: 0;
        color: #495057;
    }

    .document-type {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .document-details {
        margin-bottom: 15px;
    }

    .document-details>div {
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .status-available {
        color: #28a745;
        font-weight: bold;
    }

    .status-unavailable {
        color: #dc3545;
        font-weight: bold;
    }

    .document-actions {
        display: flex;
        gap: 10px;
    }

    .actions-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        margin-top: 30px;
    }

    .actions-section h4 {
        color: #495057;
        margin-bottom: 20px;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
    }

    .btn-outline-secondary:hover {
        background: #6c757d;
        color: white;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-info:hover {
        background: #117a8b;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    .no-documents {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .no-patient {
        text-align: center;
        padding: 60px;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .no-patient h3 {
        color: #dc3545;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
        }

        .documents-grid {
            grid-template-columns: 1fr;
        }

        .results-header h1 {
            font-size: 2rem;
        }
    }
</style>

<script>
    function viewDocument(documentType, patientId) {
        const url = `{{ url('document_viewer', country_code, 'PATIENT_ID', 'DOCUMENT_TYPE') }}`.replace('PATIENT_ID', patientId).replace('DOCUMENT_TYPE', documentType);
        window.open(url, '_blank');
    }

    function downloadDocument(documentType, patientId) {
        alert(`Downloading ${documentType} document for patient ${patientId}...`);
        // Implementation would go here
    }

    function requestServices(patientId) {
        alert(`Requesting services for patient ${patientId}...`);
        // Implementation would go here
    }

    function exportPatientData(patientId) {
        alert(`Exporting data for patient ${patientId}...`);
        // Implementation would go here
    }
</script>
{% endblock %}
