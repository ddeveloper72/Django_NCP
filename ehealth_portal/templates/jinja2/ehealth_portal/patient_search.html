{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="{% url 'country_selection' %}">‚Üê Back to Country Selection</a>
    </div>

    <div class="search-container">
        <!-- Country Header -->
        <div class="country-header">
            <h1>
                <img src="{% static country.flag_image %}" alt="{{ country.name }}" class="country-flag"
                    onerror="this.style.display='none'">
                {{ country.name }}
            </h1>
            <p>{{ step }} - International Search Mask</p>
        </div>

        <!-- ISM Information -->
        {% if search_mask %}
        <div class="search-form">
            <div class="ism-info">
                <h4>üîç {{ search_mask.mask_name }}</h4>
                <small>
                    Version {{ search_mask.mask_version }} ‚Ä¢
                    Last updated: {{ ism_last_updated|date:"M d, Y H:i" }} ‚Ä¢
                    {{ form_fields|length }} search field{{ form_fields|length|pluralize }}
                </small>
            </div>

            <!-- Validation Summary -->
            <div class="validation-summary" id="validationSummary">
                <h4>Please correct the following errors:</h4>
                <ul id="validationErrors"></ul>
            </div>

            <!-- Search Form -->
            <form method="post" id="patientSearchForm" novalidate>
                {% csrf_token %}

                {% for group_name, fields in grouped_fields.items %}
                <div class="field-group">
                    {% if group_name != 'main' %}
                    <div class="field-group-title">
                        {% if group_name == 'identity' %}üë§ Identity Information
                        {% elif group_name == 'demographics' %}üìä Demographics
                        {% elif group_name == 'healthcare' %}üè• Healthcare Information
                        {% elif group_name == 'identification' %}üÜî Identification
                        {% elif group_name == 'additional' %}‚ûï Additional Information
                        {% elif group_name == 'test' %}üß™ Test Configuration
                        {% elif group_name == 'testing' %}‚öôÔ∏è Testing Options
                        {% else %}{{ group_name|title }}
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Determine layout based on field count -->
                    {% if fields|length > 3 %}
                    <div class="three-column">
                        {% elif fields|length > 1 and group_name != 'main' %}
                        <div class="two-column">
                            {% else %}
                            <div>
                                {% endif %}
                                {% for field in fields %}
                                <div class="form-field">
                                    <label for="{{ field.code }}" {% if field.required %} class="required" {% endif %}>
                                        {{ field.label }}
                                    </label>

                                    {% if field.type == 'select' %}
                                    <select name="{{ field.code }}" id="{{ field.code }}" {% if field.required
                                        %}required{% endif %} data-validation-pattern="{{ field.validation_pattern }}"
                                        data-error-message="{{ field.error_message }}">
                                        <option value="">Choose {{ field.label|lower }}...</option>
                                        {% for option_value, option_label in field.options %}
                                        <option value="{{ option_value }}" {% if option_value==field.default_value
                                            %}selected{% endif %}>
                                            {{ option_label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% elif field.type == 'date' %}
                                    <input type="date" name="{{ field.code }}" id="{{ field.code }}"
                                        value="{{ field.default_value }}" {% if field.required %}required{% endif %}
                                        data-validation-pattern="{{ field.validation_pattern }}"
                                        data-error-message="{{ field.error_message }}">
                                    {% elif field.type == 'number' %}
                                    <input type="number" name="{{ field.code }}" id="{{ field.code }}"
                                        placeholder="{{ field.placeholder }}" value="{{ field.default_value }}" {% if
                                        field.required %}required{% endif %}
                                        data-validation-pattern="{{ field.validation_pattern }}"
                                        data-error-message="{{ field.error_message }}">
                                    {% else %}
                                    <input type="{{ field.html_type }}" name="{{ field.code }}" id="{{ field.code }}"
                                        placeholder="{{ field.placeholder }}" value="{{ field.default_value }}" {% if
                                        field.required %}required{% endif %}
                                        data-validation-pattern="{{ field.validation_pattern }}"
                                        data-error-message="{{ field.error_message }}" class="{{ field.css_classes }}">
                                    {% endif %}

                                    {% if field.help_text %}
                                    <div class="help-text">{{ field.help_text }}</div>
                                    {% endif %}

                                    <div class="error-message" id="error-{{ field.code }}"></div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}

                            <button type="submit" class="search-button" id="searchButton">
                                üîç Search Patient
                            </button>
            </form>
        </div>
        {% else %}
        <div class="search-form">
            <div class="alert alert-warning">
                <h4>‚ö†Ô∏è ISM Not Available</h4>
                <p>The International Search Mask for {{ country.name }} is not currently available. Please try again
                    later or contact the system administrator.</p>
                <a href="{% url 'country_selection' %}" class="btn btn-primary">‚Üê Back to Country Selection</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('patientSearchForm');
        const submitButton = document.getElementById('searchButton');
        const validationSummary = document.getElementById('validationSummary');
        const validationErrors = document.getElementById('validationErrors');

        // Real-time validation
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('blur', () => validateField(input));
            input.addEventListener('input', () => clearFieldError(input));
        });

        // Form submission
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            if (validateForm()) {
                submitButton.disabled = true;
                submitButton.textContent = 'üîç Searching...';

                // Submit the form
                form.submit();
            }
        });

        function validateField(field) {
            const value = field.value.trim();
            const required = field.hasAttribute('required');
            const pattern = field.getAttribute('data-validation-pattern');
            const errorMessage = field.getAttribute('data-error-message') || 'Invalid format';

            let isValid = true;
            let error = '';

            // Required validation
            if (required && !value) {
                isValid = false;
                error = 'This field is required';
            }

            // Pattern validation
            else if (value && pattern) {
                try {
                    const regex = new RegExp(pattern);
                    if (!regex.test(value)) {
                        isValid = false;
                        error = errorMessage;
                    }
                } catch (e) {
                    console.warn('Invalid regex pattern:', pattern);
                }
            }

            // Update field appearance
            if (isValid) {
                field.classList.remove('invalid');
                hideFieldError(field);
            } else {
                field.classList.add('invalid');
                showFieldError(field, error);
            }

            return isValid;
        }

        function validateForm() {
            let isValid = true;
            const errors = [];

            inputs.forEach(input => {
                if (!validateField(input)) {
                    isValid = false;
                    const label = document.querySelector(`label[for="${input.id}"]`);
                    const fieldName = label ? label.textContent.replace(' *', '') : input.name;
                    const errorDiv = document.getElementById(`error-${input.id}`);
                    if (errorDiv && errorDiv.textContent) {
                        errors.push(`${fieldName}: ${errorDiv.textContent}`);
                    }
                }
            });

            // Update validation summary
            if (errors.length > 0) {
                validationErrors.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
                validationSummary.style.display = 'block';
                validationSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                validationSummary.style.display = 'none';
            }

            return isValid;
        }

        function showFieldError(field, message) {
            const errorDiv = document.getElementById(`error-${field.id}`);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function hideFieldError(field) {
            const errorDiv = document.getElementById(`error-${field.id}`);
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        function clearFieldError(field) {
            field.classList.remove('invalid');
            hideFieldError(field);
            validationSummary.style.display = 'none';
        }
    });
</script>
{% endblock %}