{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .country-header {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .country-header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        font-weight: 300;
    }

    .country-header .country-flag {
        width: 48px;
        height: 32px;
        border-radius: 4px;
        margin-right: 15px;
        vertical-align: middle;
    }

    .ism-info {
        background: #e8f5e8;
        padding: 15px;
        margin: 20px 0;
        border-radius: 8px;
        border-left: 4px solid #27ae60;
    }

    .ism-info h4 {
        color: #27ae60;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .ism-info small {
        color: #2c3e50;
    }

    .search-form {
        padding: 30px;
    }

    .field-group {
        margin-bottom: 30px;
    }

    .field-group-title {
        font-size: 1.1rem;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 2px solid #3498db;
        text-transform: uppercase;
        font-weight: 600;
    }

    .form-field {
        margin-bottom: 20px;
    }

    .form-field label {
        display: block;
        margin-bottom: 5px;
        color: #2c3e50;
        font-weight: 500;
    }

    .form-field label.required:after {
        content: " *";
        color: #e74c3c;
    }

    .form-field input,
    .form-field select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .form-field input:focus,
    .form-field select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-field input.invalid {
        border-color: #e74c3c;
    }

    .help-text {
        font-size: 0.85rem;
        color: #7f8c8d;
        margin-top: 5px;
    }

    .error-message {
        color: #e74c3c;
        font-size: 0.85rem;
        margin-top: 5px;
        display: none;
    }

    .search-button {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 20px;
    }

    .search-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
    }

    .search-button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .validation-summary {
        background: #ffebee;
        border: 1px solid #ffcdd2;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        display: none;
    }

    .validation-summary h4 {
        color: #c62828;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }

    .validation-summary ul {
        color: #c62828;
        margin: 0;
        padding-left: 20px;
    }

    .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .three-column {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
    }

    @media (max-width: 768px) {

        .two-column,
        .three-column {
            grid-template-columns: 1fr;
        }

        .search-container {
            margin: 10px;
            border-radius: 10px;
        }

        .country-header,
        .search-form {
            padding: 20px;
        }
    }

    .breadcrumb {
        background: #f8f9fa;
        padding: 15px 30px;
        border-bottom: 1px solid #e9ecef;
    }

    .breadcrumb a {
        color: #3498db;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="{% url 'country_selection' %}">‚Üê Back to Country Selection</a>
    </div>

    <div class="search-container">
        <!-- Country Header -->
        <div class="country-header">
            <h1>
                <img src="{% static country.flag_image %}" alt="{{ country.name }}" class="country-flag"
                    onerror="this.style.display='none'">
                {{ country.name }}
            </h1>
            <p>{{ step }} - International Search Mask</p>
        </div>

        <!-- ISM Information -->
        {% if search_mask %}
        <div class="search-form">
            <div class="ism-info">
                <h4>üîç {{ search_mask.mask_name }}</h4>
                <small>
                    Version {{ search_mask.mask_version }} ‚Ä¢
                    Last updated: {{ ism_last_updated|date:"M d, Y H:i" }} ‚Ä¢
                    {{ form_fields|length }} search field{{ form_fields|length|pluralize }}
                </small>
            </div>

            <!-- Validation Summary -->
            <div class="validation-summary" id="validationSummary">
                <h4>Please correct the following errors:</h4>
                <ul id="validationErrors"></ul>
            </div>

            <!-- Search Form -->
            <form method="post" id="patientSearchForm" novalidate>
                {% csrf_token %}

                {% for group_name, fields in grouped_fields.items %}
                <div class="field-group">
                    {% if group_name != 'main' %}
                    <div class="field-group-title">
                        {% if group_name == 'identity' %}üë§ Identity Information
                        {% elif group_name == 'demographics' %}üìä Demographics
                        {% elif group_name == 'healthcare' %}üè• Healthcare Information
                        {% elif group_name == 'identification' %}üÜî Identification
                        {% elif group_name == 'additional' %}‚ûï Additional Information
                        {% elif group_name == 'test' %}üß™ Test Configuration
                        {% elif group_name == 'testing' %}‚öôÔ∏è Testing Options
                        {% else %}{{ group_name|title }}
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Determine layout based on field count -->
                    {% if fields|length > 3 %}
                    <div class="three-column">
                        {% elif fields|length > 1 and group_name != 'main' %}
                        <div class="two-column">
                            {% else %}
                            <div>
                                {% endif %}
                                {% for field in fields %}
                                <div class="form-field">
                                    <label for="{{ field.code }}" {% if field.required %} class="required" {% endif %}>
                                        {{ field.label }}
                                    </label>

                                    {% if field.type == 'select' %}
                                    <select name="{{ field.code }}" id="{{ field.code }}" {% if field.required
                                        %}required{% endif %} data-validation-pattern="{{ field.validation_pattern }}"
                                        data-error-message="{{ field.error_message }}">
                                        <option value="">Choose {{ field.label|lower }}...</option>
                                        {% for option_value, option_label in field.options %}
                                        <option value="{{ option_value }}" {% if option_value==field.default_value
                                            %}selected{% endif %}>
                                            {{ option_label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% elif field.type == 'date' %}
                                    <input type="date" name="{{ field.code }}" id="{{ field.code }}"
                                        value="{{ field.default_value }}" {% if field.required %}required{% endif %}
                                        data-validation-pattern="{{ field.validation_pattern }}"
                                        data-error-message="{{ field.error_message }}">
                                    {% elif field.type == 'number' %}
                                    <input type="number" name="{{ field.code }}" id="{{ field.code }}"
                                        placeholder="{{ field.placeholder }}" value="{{ field.default_value }}" {% if
                                        field.required %}required{% endif %}
                                        data-validation-pattern="{{ field.validation_pattern }}"
                                        data-error-message="{{ field.error_message }}">
                                    {% else %}
                                    <input type="{{ field.html_type }}" name="{{ field.code }}" id="{{ field.code }}"
                                        placeholder="{{ field.placeholder }}" value="{{ field.default_value }}" {% if
                                        field.required %}required{% endif %}
                                        data-validation-pattern="{{ field.validation_pattern }}"
                                        data-error-message="{{ field.error_message }}" class="{{ field.css_classes }}">
                                    {% endif %}

                                    {% if field.help_text %}
                                    <div class="help-text">{{ field.help_text }}</div>
                                    {% endif %}

                                    <div class="error-message" id="error-{{ field.code }}"></div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}

                            <button type="submit" class="search-button" id="searchButton">
                                üîç Search Patient
                            </button>
            </form>
        </div>
        {% else %}
        <div class="search-form">
            <div class="alert alert-warning">
                <h4>‚ö†Ô∏è ISM Not Available</h4>
                <p>The International Search Mask for {{ country.name }} is not currently available. Please try again
                    later or contact the system administrator.</p>
                <a href="{% url 'country_selection' %}" class="btn btn-primary">‚Üê Back to Country Selection</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('patientSearchForm');
        const submitButton = document.getElementById('searchButton');
        const validationSummary = document.getElementById('validationSummary');
        const validationErrors = document.getElementById('validationErrors');

        // Real-time validation
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('blur', () => validateField(input));
            input.addEventListener('input', () => clearFieldError(input));
        });

        // Form submission
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            if (validateForm()) {
                submitButton.disabled = true;
                submitButton.textContent = 'üîç Searching...';

                // Submit the form
                form.submit();
            }
        });

        function validateField(field) {
            const value = field.value.trim();
            const required = field.hasAttribute('required');
            const pattern = field.getAttribute('data-validation-pattern');
            const errorMessage = field.getAttribute('data-error-message') || 'Invalid format';

            let isValid = true;
            let error = '';

            // Required validation
            if (required && !value) {
                isValid = false;
                error = 'This field is required';
            }

            // Pattern validation
            else if (value && pattern) {
                try {
                    const regex = new RegExp(pattern);
                    if (!regex.test(value)) {
                        isValid = false;
                        error = errorMessage;
                    }
                } catch (e) {
                    console.warn('Invalid regex pattern:', pattern);
                }
            }

            // Update field appearance
            if (isValid) {
                field.classList.remove('invalid');
                hideFieldError(field);
            } else {
                field.classList.add('invalid');
                showFieldError(field, error);
            }

            return isValid;
        }

        function validateForm() {
            let isValid = true;
            const errors = [];

            inputs.forEach(input => {
                if (!validateField(input)) {
                    isValid = false;
                    const label = document.querySelector(`label[for="${input.id}"]`);
                    const fieldName = label ? label.textContent.replace(' *', '') : input.name;
                    const errorDiv = document.getElementById(`error-${input.id}`);
                    if (errorDiv && errorDiv.textContent) {
                        errors.push(`${fieldName}: ${errorDiv.textContent}`);
                    }
                }
            });

            // Update validation summary
            if (errors.length > 0) {
                validationErrors.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
                validationSummary.style.display = 'block';
                validationSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                validationSummary.style.display = 'none';
            }

            return isValid;
        }

        function showFieldError(field, message) {
            const errorDiv = document.getElementById(`error-${field.id}`);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function hideFieldError(field) {
            const errorDiv = document.getElementById(`error-${field.id}`);
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        function clearFieldError(field) {
            field.classList.remove('invalid');
            hideFieldError(field);
            validationSummary.style.display = 'none';
        }
    });
</script>
{% endblock %}