{% extends "base.html" %}
{% load static %}

{% block title %}Document Viewer - {{ document.type }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>
                <i class="fas fa-file-medical"></i> Document Viewer
            </h1>
            <p class="mb-0">{{ document.type }} Document</p>
        </div>
        <a href="{% url 'patient_data' country_code patient_id %}" class="btn btn-light">
            <i class="fas fa-arrow-left"></i> Back to Patient
        </a>
    </div>
</div>

<div class="p-4">
    <div class="row">
        <!-- Document Info -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i> Document Information
                    </h6>
                </div>
                <div class="card-body">
                    <p><strong>Type:</strong> {{ document.type }}</p>
                    <p><strong>Format:</strong> {{ document.format }}</p>
                    <p><strong>Patient ID:</strong> {{ patient_id }}</p>
                    <p><strong>Country:</strong> {{ country_code|upper }}</p>

                    <div class="mt-3">
                        {% if document.processing_success %}
                        <span class="badge bg-success">
                            <i class="fas fa-check"></i> Enhanced Processing
                        </span>
                        {% elif document.error_message %}
                        <span class="badge bg-danger">
                            <i class="fas fa-exclamation-triangle"></i> Processing Error
                        </span>
                        {% else %}
                        <span class="badge bg-warning">
                            <i class="fas fa-info-circle"></i> Basic Mode
                        </span>
                        {% endif %}
                        <span class="badge bg-primary">
                            <i class="fas fa-lock"></i> Encrypted
                        </span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-tools"></i> Actions
                    </h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-primary btn-sm mb-2 w-100">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                    <button class="btn btn-outline-secondary btn-sm mb-2 w-100">
                        <i class="fas fa-print"></i> Print Document
                    </button>
                    <button class="btn btn-outline-info btn-sm w-100">
                        <i class="fas fa-share"></i> Share Securely
                    </button>
                </div>
            </div>
        </div>

        <!-- Document Content -->
        <div class="col-md-8">
            <!-- Language Selection for CDA Processing -->
            {% if document.type == "PS" %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-language"></i> Language & Processing Options
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="language-select" class="form-label">Display Language:</label>
                            <select id="language-select" class="form-select" onchange="changeLanguage()">
                                <option value="en" {% if target_language=="en" %}selected{% endif %}>English</option>
                                <option value="de" {% if target_language=="de" %}selected{% endif %}>Deutsch</option>
                                <option value="fr" {% if target_language=="fr" %}selected{% endif %}>Français</option>
                                <option value="es" {% if target_language=="es" %}selected{% endif %}>Español</option>
                                <option value="it" {% if target_language=="it" %}selected{% endif %}>Italiano</option>
                                <option value="pt" {% if target_language=="pt" %}selected{% endif %}>Português</option>
                                <option value="nl" {% if target_language=="nl" %}selected{% endif %}>Nederlands</option>
                                <option value="pl" {% if target_language=="pl" %}selected{% endif %}>Polski</option>
                                <option value="cs" {% if target_language=="cs" %}selected{% endif %}>Čeština</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            {% if document.processing_success %}
                            <span class="badge bg-success mt-4">
                                <i class="fas fa-check"></i> Enhanced CDA Processing Active
                            </span>
                            {% elif document.error_message %}
                            <span class="badge bg-danger mt-4">
                                <i class="fas fa-exclamation-triangle"></i> Processing Error
                            </span>
                            {% else %}
                            <span class="badge bg-warning mt-4">
                                <i class="fas fa-info-circle"></i> Basic Mode
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-file-alt"></i> Document Content
                    </h6>
                </div>
                <div class="card-body">
                    {% if document.type == "PS" %}
                    <!-- Enhanced Patient Summary with CDA Processing -->
                    <div class="document-content">
                        <h5 class="text-primary">Patient Summary</h5>
                        <hr>

                        {% if document.error_message %}
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle"></i> Processing Error</h6>
                            <p>{{ document.error_message }}</p>
                        </div>
                        {% endif %}

                        {% if document.processing_success and document.sections %}
                        <!-- Enhanced CDA Sections -->
                        <div class="alert alert-success">
                            <h6><i class="fas fa-magic"></i> Enhanced CDA Display</h6>
                            <p>Displaying {{ document.sections|length }} processed clinical sections with multi-language
                                support.</p>
                        </div>

                        {% for section in document.sections %}
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-stethoscope"></i>
                                    {{ section.translated_title|default:section.title|default:"Clinical Section" }}
                                    <small class="text-muted">({{ section.section_code }})</small>
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if section.structured_data %}
                                <!-- Structured Clinical Data -->
                                <h6>Structured Clinical Data</h6>
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>Item</th>
                                                <th>Code</th>
                                                <th>Display Name</th>
                                                <th>Value</th>
                                                <th>Unit</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in section.structured_data %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>
                                                    {% if item.condition_code or item.medication_code or
                                                    item.observation_code %}
                                                    <small class="text-monospace">
                                                        {{
                                                        item.condition_code|default:item.medication_code|default:item.observation_code|default:"N/A"
                                                        }}
                                                    </small>
                                                    {% else %}
                                                    <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <strong>{{
                                                        item.condition_display|default:item.medication_display|default:item.observation_display|default:"Unknown"
                                                        }}</strong>
                                                </td>
                                                <td>
                                                    {{ item.value|default:item.dosage|default:item.status|default:"N/A"
                                                    }}
                                                </td>
                                                <td>
                                                    {{ item.unit|default:"N/A" }}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}

                                {% if section.table_rows %}
                                <!-- PS-Compliant Table Rendering -->
                                <h6 class="mt-3">PS-Compliant Clinical Table</h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        {% for row in section.table_rows %}
                                        <tr>
                                            {% for cell in row %}
                                            <td>{{ cell|safe }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                                {% endif %}

                                {% if section.html_content %}
                                <!-- Original HTML Content -->
                                <h6 class="mt-3">Original HTML Content</h6>
                                <div class="border p-3">
                                    {{ section.html_content|safe }}
                                </div>
                                {% endif %}

                                {% if not section.structured_data and not section.table_rows and not
                                section.html_content %}
                                <div class="alert alert-info">
                                    <p class="mb-0">No displayable content available for this section.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}

                        {% else %}
                        <!-- Fallback Content -->
                        <div class="alert alert-info">
                            <h6>Document Information</h6>
                            <p>{{ document.content }}</p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h6>Patient Demographics</h6>
                                <p><strong>Name:</strong> {{ patient_identity.given_name|default:"Unknown" }} {{ patient_identity.family_name|default:"Patient" }}</p>
                                <p><strong>DOB:</strong> {{ patient_identity.birth_date|default:"Not available" }}</p>
                                <p><strong>Gender:</strong> {{ patient_identity.gender|default:"Unknown" }}</p>
                                <p><strong>Address:</strong> {{ patient_identity.address|default:"Not available" }}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Document Status</h6>
                                <p><strong>Processing:</strong>
                                    {% if document.processing_success %}
                                    <span class="text-success">Enhanced CDA Active</span>
                                    {% else %}
                                    <span class="text-warning">Basic Mode</span>
                                    {% endif %}
                                </p>
                                <p><strong>Language:</strong> {{ target_language|upper }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {% elif document.type == "EP" %}
                    <!-- ePrescription -->
                    <div class="document-content">
                        <h5 class="text-success">ePrescription</h5>
                        <hr>
                        <div class="alert alert-info">
                            <p>ePrescription content would be displayed here...</p>
                        </div>
                    </div>

                    {% elif document.type == "LAB" %}
                    <!-- Laboratory Results -->
                    <div class="document-content">
                        <h5 class="text-warning">Laboratory Results</h5>
                        <hr>
                        <div class="alert alert-info">
                            <p>Laboratory results would be displayed here...</p>
                        </div>
                    </div>
                    {% else %}
                    <!-- Generic Document -->
                    <div class="document-content">
                        <h5>{{ document.type }} Document</h5>
                        <hr>
                        <div class="alert alert-info">
                            <p>{{ document.content|default:"Document content is not available for preview." }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Digital Signature -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6><i class="fas fa-certificate text-primary"></i> Digital Signature</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small><strong>Signed by:</strong> Dr. Medical Professional</small><br>
                                <small><strong>Date:</strong> {% now "Y-m-d" %}</small>
                            </div>
                            <div class="col-md-6">
                                <small><strong>Certificate:</strong> Valid</small><br>
                                <small><strong>Algorithm:</strong> SHA-256 with RSA</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .document-content {
        font-family: 'Times New Roman', serif;
        line-height: 1.6;
    }

    .document-content h5 {
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 10px;
    }

    .document-content .table {
        font-size: 0.9rem;
    }

    .badge {
        font-size: 0.75rem;
    }

    .text-monospace {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
    }

    .card-header h6 {
        margin-bottom: 0;
    }

    .clinical-section {
        border-left: 4px solid #007bff;
        padding-left: 15px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function changeLanguage() {
        const select = document.getElementById('language-select');
        const newLang = select.value;
        const url = new URL(window.location);
        url.searchParams.set('lang', newLang);
        window.location.href = url.toString();
    }
</script>
{% endblock %}
