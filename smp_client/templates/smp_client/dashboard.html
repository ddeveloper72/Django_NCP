{% extends "base.html" %}
{% load static %}

{% block title %}SMP Management Dashboard{% endblock %}

{% block extra_css %}
<!-- SMP Dashboard styles are now in main.css via SASS -->
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="smp-dashboard-header">
        <h1><i class="fa fa-globe" aria-hidden="true"></i> SMP Management Dashboard</h1>
        <p>Service Metadata Publishing for EU eHealth Network</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ participant_count }}</div>
            <div class="stat-label">Active Participants</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ service_count }}</div>
            <div class="stat-label">Active Services</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ endpoint_count }}</div>
            <div class="stat-label">Service Endpoints</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ domain_count }}</div>
            <div class="stat-label">SMP Domains</div>
        </div>
    </div>

    <div class="smp-content-section">
        <h2 class="smp-section-title"><i class="fa fa-rocket" aria-hidden="true"></i> Quick Actions</h2>
        <div class="actions-grid">
            <div class="action-card">
                <h3><i class="fa fa-search" aria-hidden="true"></i> Search Participants</h3>
                <p>Find and manage SMP participants across all domains</p>
                <a href="{% url 'smp_client:participant_search' %}" class="action-btn">Search Participants</a>
            </div>
            <div class="action-card">
                <h3><i class="fa fa-edit" aria-hidden="true"></i> SMP Editor</h3>
                <p>Generate, sign, and upload SMP documents</p>
                <a href="{% url 'smp_client:smp_editor' %}" class="action-btn">SMP Editor</a>
            </div>
            <div class="action-card">
                <h3><i class="fa fa-file-text" aria-hidden="true"></i> Documents</h3>
                <p>Manage generated and signed SMP documents</p>
                <a href="{% url 'smp_client:list_documents' %}" class="action-btn">View Documents</a>
            </div>
            <div class="action-card">
                <h3><i class="fa fa-cogs" aria-hidden="true"></i> Manage Services</h3>
                <p>Configure service metadata and endpoints</p>
                <a href="/admin/smp_client/" class="action-btn">Admin Interface</a>
            </div>
        </div>
    </div>

    <div class="european-smp-section">
        <h3><i class="fa fa-globe" style="color: #005f5f;" aria-hidden="true"></i> European SMP Integration</h3>
        <p>Sync with the official European test SMP server</p>
        <div class="sync-status">
            <strong>European SMP Server:</strong> https://smp-ehealth-trn.acc.edelivery.tech.ec.europa.eu/
        </div>
        <button type="button" class="action-btn sync-btn" aria-describedby="sync-description">
            <i class="fa fa-sync" aria-hidden="true"></i> Sync with European SMP
        </button>
        <div id="sync-description" class="sr-only">
            Synchronize participant and service data with the European SMP test server
        </div>
        <div id="sync-result" class="sync-result" aria-live="polite"></div>
    </div>

    <div class="smp-content-section">
        <h2 class="smp-section-title"><i class="fa fa-list" aria-hidden="true"></i> Recent Activity</h2>
        <div class="recent-list">
            {% if recent_queries %}
                {% for query in recent_queries %}
                <div class="recent-item">
                    <div>
                        <strong>{{ query.query_type|title }}</strong>: {{ query.participant_id }}
                        <br><small>{{ query.participant_scheme }}</small>
                    </div>
                    <div class="recent-time">
                        <time datetime="{{ query.timestamp|date:'c' }}">{{ query.timestamp|timesince }} ago</time>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="recent-item">
                <div>No recent SMP queries found</div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="smp-content-section">
        <h2 class="smp-section-title"><i class="fa fa-users" aria-hidden="true"></i> Recent Participants</h2>
        <div class="recent-list">
            {% if recent_participants %}
                {% for participant in recent_participants %}
                <div class="recent-item">
                    <div>
                        <span class="country-flag-compact" aria-hidden="true">
                            {% if participant.country_code %}
                                <img src="{% load static %}{% static 'flags/' %}{{ participant.country_code }}.webp" 
                                     alt="{{ participant.country_code }} flag" 
                                     class="flag-image"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                <i class="fa fa-flag flag-fallback" style="display: none;" aria-hidden="true"></i>
                            {% else %}
                                <i class="fa fa-globe flag-fallback" aria-hidden="true"></i>
                            {% endif %}
                        </span>
                        <strong>{{ participant.participant_name|default:participant.participant_identifier }}</strong>
                        <br><small>{{ participant.participant_scheme.scheme_name }}</small>
                    </div>
                    <div class="recent-time">
                        <time datetime="{{ participant.created_at|date:'c' }}">{{ participant.created_at|timesince }} ago</time>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="recent-item">
                <div>No participants found</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SMP Dashboard functionality -->
<script>
    // Configuration for SMP dashboard
    window.dashboardConfig = {
        europeanSmpSyncUrl: '{% url "smp_client:european_smp_sync" %}',
        csrfToken: '{{ csrf_token }}'
    };
</script>
<script src="{% static 'js/smp_dashboard.js' %}"></script>
{% endblock %}
