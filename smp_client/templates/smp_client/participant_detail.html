{% extends "base.html" %}
{% load static %}

{% block title %}{{ participant.participant_name|default:participant.participant_identifier }} - SMP{% endblock %}

{% block extra_css %}
<!-- Participant detail styles are now in main.css via SASS -->
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="smp-dashboard-header">
        <div class="header-navigation">
            <a href="{% url 'smp_client:participant_search' %}" class="btn btn-secondary" aria-label="Return to participant search">
                ‚Üê Back to Search
            </a>
        </div>
        
        <div class="participant-header">
            <span class="flag-icon" aria-hidden="true">
                {% if participant.country_code == 'IE' %}<i class="fa fa-flag" style="color: #009639;"></i>
                {% elif participant.country_code == 'BE' %}<i class="fa fa-flag" style="color: #ed2939;"></i>
                {% elif participant.country_code == 'AT' %}<i class="fa fa-flag" style="color: #ed2939;"></i>
                {% elif participant.country_code == 'HU' %}<i class="fa fa-flag" style="color: #477050;"></i>
                {% else %}<i class="fa fa-globe" style="color: #005f5f;"></i>{% endif %}
            </span>
            <div class="participant-title">
                <h1 class="participant-name">
                    {{ participant.participant_name|default:participant.participant_identifier }}
                </h1>
                <p class="participant-id">
                    {{ participant.participant_scheme.scheme_id }}::{{ participant.participant_identifier }}
                </p>
            </div>
        </div>

        <div class="smp-url-section">
            <div class="detail-item">
                <div class="detail-label">SMP Service Group URL</div>
                <div class="detail-value smp-url">
                    <code>{{ request.build_absolute_uri }}{{ participant.participant_scheme.scheme_id }}::{{ participant.participant_identifier }}/</code>
                    <button class="btn btn-sm btn-outline-primary copy-btn" 
                            data-copy="{{ request.build_absolute_uri }}{{ participant.participant_scheme.scheme_id }}::{{ participant.participant_identifier }}/"
                            aria-label="Copy SMP URL to clipboard">
                        üìã Copy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="content-section">
        <h2 class="section-title">üìã Participant Information</h2>

        <div class="info-grid">
            <div class="info-card">
                <h3>üÜî Identity</h3>
                <div class="detail-group">
                    <div class="detail-item">
                        <div class="detail-label">Participant ID</div>
                        <div class="detail-value">{{ participant.participant_identifier }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Participant Scheme</div>
                        <div class="detail-value">{{ participant.participant_scheme.scheme_id }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Country</div>
                        <div class="detail-value">
                            {% if participant.country_code == 'IE' %}<i class="fa fa-flag" aria-hidden="true" style="color: #009639;"></i> Ireland
                            {% elif participant.country_code == 'BE' %}<i class="fa fa-flag" aria-hidden="true" style="color: #ed2939;"></i> Belgium
                            {% elif participant.country_code == 'AT' %}<i class="fa fa-flag" aria-hidden="true" style="color: #ed2939;"></i> Austria
                            {% elif participant.country_code == 'HU' %}<i class="fa fa-flag" aria-hidden="true" style="color: #477050;"></i> Hungary
                            {% else %}<i class="fa fa-globe" aria-hidden="true" style="color: #005f5f;"></i> {{ participant.country_code }}{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h3>üåê SMP Configuration</h3>
                <div class="detail-group">
                    <div class="detail-item">
                        <div class="detail-label">SMP URL</div>
                        <div class="detail-value">{{ participant.smp_url }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Registration Date</div>
                        <div class="detail-value">{{ participant.created_at|date:"Y-m-d H:i" }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Last Updated</div>
                        <div class="detail-value">{{ participant.updated_at|date:"Y-m-d H:i" }}</div>
                    </div>
                </div>
            </div>

            {% if participant.contact_email or participant.organization_type %}
            <div class="info-card">
                <h3>üìû Contact Information</h3>
                <div class="detail-group">
                    {% if participant.contact_email %}
                    <div class="detail-item">
                        <div class="detail-label">Contact Email</div>
                        <div class="detail-value">
                            <a href="mailto:{{ participant.contact_email }}" class="email-link">
                                {{ participant.contact_email }}
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    {% if participant.organization_type %}
                    <div class="detail-item">
                        <div class="detail-label">Organization Type</div>
                        <div class="detail-value">{{ participant.organization_type }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if service_group and services %}
    <div class="services-section">
        <h2 class="section-title">üõ†Ô∏è Services & Endpoints</h2>
        
        <div class="service-group-info">
            <div class="alert alert-info">
                <strong>Service Group:</strong> {{ service_group.document_identifier }}
            </div>
        </div>

        <div class="services-grid">
            {% for service in services %}
            <article class="service-card" role="article" aria-labelledby="service-{{ forloop.counter }}">
                <div class="service-header">
                    <h3 id="service-{{ forloop.counter }}" class="service-title">
                        üîß {{ service.document_identifier }}
                    </h3>
                    <div class="service-meta">
                        <span class="service-type">{{ service.process_identifier }}</span>
                    </div>
                </div>

                <div class="service-details">
                    <div class="detail-item">
                        <div class="detail-label">Document ID</div>
                        <div class="detail-value">{{ service.document_identifier }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Process ID</div>
                        <div class="detail-value">{{ service.process_identifier }}</div>
                    </div>
                </div>

                {% if service.endpoints.all %}
                <div class="endpoints-section">
                    <h4 class="endpoints-title">üîó Service Endpoints</h4>
                    <div class="endpoints-list">
                        {% for endpoint in service.endpoints.all %}
                        <div class="endpoint-item">
                            <div class="endpoint-header">
                                <span class="endpoint-transport">{{ endpoint.transport_profile }}</span>
                                <span class="endpoint-status active">Active</span>
                            </div>
                            <div class="endpoint-details">
                                <div class="detail-item">
                                    <div class="detail-label">Endpoint URL</div>
                                    <div class="detail-value">
                                        <a href="{{ endpoint.endpoint_url }}" target="_blank" 
                                           class="endpoint-link" rel="noopener noreferrer"
                                           aria-label="Open endpoint URL in new tab">
                                            {{ endpoint.endpoint_url }} ‚Üó
                                        </a>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Transport Profile</div>
                                    <div class="detail-value">{{ endpoint.transport_profile }}</div>
                                </div>
                                {% if endpoint.certificate %}
                                <div class="detail-item">
                                    <div class="detail-label">Certificate</div>
                                    <div class="detail-value certificate">
                                        <details>
                                            <summary>View Certificate</summary>
                                            <pre><code>{{ endpoint.certificate }}</code></pre>
                                        </details>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="no-endpoints">
                    <p>No endpoints configured for this service</p>
                </div>
                {% endif %}
            </article>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="no-services">
        <div class="alert alert-warning">
            <strong>No services found</strong> for this participant
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/smp_dashboard.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy to clipboard functionality
        const copyButtons = document.querySelectorAll('.copy-btn');
        copyButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const textToCopy = this.getAttribute('data-copy');
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalText = this.textContent;
                    this.textContent = '‚úÖ Copied!';
                    this.classList.add('btn-success');
                    this.classList.remove('btn-outline-primary');
                    
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.classList.remove('btn-success');
                        this.classList.add('btn-outline-primary');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy to clipboard');
                });
            });
        });

        // Expandable sections for long content
        const serviceCards = document.querySelectorAll('.service-card');
        serviceCards.forEach(card => {
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    const details = card.querySelector('details');
                    if (details && e.target === card) {
                        e.preventDefault();
                        details.open = !details.open;
                    }
                }
            });
        });

        // Enhanced accessibility for certificate details
        const certificateDetails = document.querySelectorAll('details');
        certificateDetails.forEach(details => {
            const summary = details.querySelector('summary');
            summary.addEventListener('click', function() {
                const isOpen = details.open;
                const action = isOpen ? 'collapsed' : 'expanded';
                
                // Announce state change to screen readers
                setTimeout(() => {
                    const announcement = document.createElement('div');
                    announcement.setAttribute('aria-live', 'polite');
                    announcement.setAttribute('aria-atomic', 'true');
                    announcement.className = 'sr-only';
                    announcement.textContent = `Certificate section ${action}`;
                    document.body.appendChild(announcement);
                    
                    setTimeout(() => announcement.remove(), 1000);
                }, 100);
            });
        });
    });
</script>
{% endblock %}